"use strict";var Mp4Muxer=(()=>{var Q=Object.defineProperty;var Rt=Object.getOwnPropertyDescriptor;var Nt=Object.getOwnPropertyNames,vt=Object.getOwnPropertySymbols;var St=Object.prototype.hasOwnProperty,Vt=Object.prototype.propertyIsEnumerable;var A=Math.pow,At=(r,t,e)=>t in r?Q(r,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):r[t]=e,Ut=(r,t)=>{for(var e in t||={})St.call(t,e)&&At(r,e,t[e]);if(vt)for(var e of vt(t))Vt.call(t,e)&&At(r,e,t[e]);return r};var Ht=(r,t)=>{for(var e in t)Q(r,e,{get:t[e],enumerable:!0})},Wt=(r,t,e,s)=>{if(t&&typeof t=="object"||typeof t=="function")for(let n of Nt(t))!St.call(r,n)&&n!==e&&Q(r,n,{get:()=>t[n],enumerable:!(s=Rt(t,n))||s.enumerable});return r};var $t=r=>Wt(Q({},"__esModule",{value:!0}),r);var yt=(r,t,e)=>{if(!t.has(r))throw TypeError("Cannot "+e)};var i=(r,t,e)=>(yt(r,t,"read from private field"),e?e.call(r):t.get(r)),u=(r,t,e)=>{if(t.has(r))throw TypeError("Cannot add the same private member more than once");t instanceof WeakSet?t.add(r):t.set(r,e)},w=(r,t,e,s)=>(yt(r,t,"write to private field"),s?s.call(r,e):t.set(r,e),e);var d=(r,t,e)=>(yt(r,t,"access private method"),e);var Te={};Ht(Te,{ArrayBufferTarget:()=>W,FileSystemWritableFileStreamTarget:()=>$,Muxer:()=>ht,StreamTarget:()=>O});var m=new Uint8Array(8),T=new DataView(m.buffer),C=r=>[(r%256+256)%256],l=r=>(T.setUint16(0,r,!1),[m[0],m[1]]),kt=r=>(T.setInt16(0,r,!1),[m[0],m[1]]),wt=r=>(T.setUint32(0,r,!1),[m[1],m[2],m[3]]),a=r=>(T.setUint32(0,r,!1),[m[0],m[1],m[2],m[3]]),Bt=r=>(T.setUint32(0,Math.floor(r/A(2,32)),!1),T.setUint32(4,r,!1),[m[0],m[1],m[2],m[3],m[4],m[5],m[6],m[7]]),bt=r=>(T.setUint8(0,r),T.setUint8(1,r<<8),[m[0],m[1]]),H=r=>(T.setUint16(0,r,!1),T.setUint16(2,r<<16,!1),[m[0],m[1],m[2],m[3]]),x=(r,t=!1)=>{let e=Array(r.length).fill(null).map((s,n)=>r.charCodeAt(n));return t&&e.push(0),e},D=r=>r&&r[r.length-1];var Mt=[65536,0,0,0,65536,0,0,0,1073741824].map(a),g=(r,t,e)=>({type:r,contents:t&&new Uint8Array(t.flat(10)),children:e}),y=(r,t,e,s,n)=>g(r,[C(t),wt(e),s!=null?s:[]],n),z=(r,t)=>Math.round(r*t),Et=r=>r?g("ftyp",[x("isom"),a(0),x("iso4"),x("hvc1")]):g("ftyp",[x("isom"),a(0),x("isom"),x("avc1"),x("mp41")]),Dt=()=>({type:"mdat",largeSize:!0}),zt=(r,t)=>g("moov",null,[Gt(t,r),...r.map(e=>Kt(e,t))]),Gt=(r,t)=>{let e=z(Math.max(0,...t.filter(n=>n.samples.length>0).map(n=>D(n.samples).timestamp+D(n.samples).duration)),tt),s=Math.max(...t.map(n=>n.id))+1;return y("mvhd",0,0,[a(r),a(r),a(tt),a(e),H(1),bt(1),Array(10).fill(0),Mt,Array(24).fill(0),a(s)])},Kt=(r,t)=>g("trak",null,[Xt(r,t),Yt(r,t)]),Xt=(r,t)=>{let e=D(r.samples),s=z(e?e.timestamp+e.duration:0,tt);return y("tkhd",0,3,[a(t),a(t),a(r.id),a(0),a(s),Array(8).fill(0),l(0),l(0),bt(r.info.type==="audio"?1:0),l(0),Mt,H(r.info.type==="video"?r.info.width:0),H(r.info.type==="video"?r.info.height:0)])},Yt=(r,t)=>g("mdia",null,[Zt(r,t),jt(r.info.type==="video"?"vide":"soun"),qt(r)]),Zt=(r,t)=>{let e=D(r.samples),s=z(e?e.timestamp+e.duration:0,r.timescale);return y("mdhd",0,0,[a(t),a(t),a(r.timescale),a(s),l(21956),l(0)])},jt=r=>y("hdlr",0,0,[x("mhlr"),x(r),a(0),a(0),a(0),x("mp4-muxer-hdlr")]),qt=r=>g("minf",null,[r.info.type==="video"?Jt():Qt(),te(),ie(r)]),Jt=()=>y("vmhd",0,1,[l(0),l(0),l(0),l(0)]),Qt=()=>y("smhd",0,0,[l(0),l(0)]),te=()=>g("dinf",null,[ee()]),ee=()=>y("dref",0,0,[a(1)],[re()]),re=()=>y("url ",0,1),ie=r=>g("stbl",null,[se(r),le(r),me(r),de(r),fe(r),pe(r)]),se=r=>y("stsd",0,0,[a(1)],[r.info.type==="video"?ne(r.info.codec==="avc"?"avc1":"hvc1",r,r.info.codec==="avc"?ae(r):oe(r)):he("mp4a",r,ue(r))]),ne=(r,t,e)=>g(r,[Array(6).fill(0),l(1),l(0),l(0),Array(12).fill(0),l(t.info.width),l(t.info.height),a(4718592),a(4718592),a(0),l(1),Array(32).fill(0),l(24),kt(65535)],[e]),ae=r=>r.codecPrivate&&g("avcC",[...r.codecPrivate]),oe=r=>r.codecPrivate&&g("hvcC",[...r.codecPrivate]),he=(r,t,e)=>g(r,[Array(6).fill(0),l(1),l(0),l(0),a(0),l(t.info.numberOfChannels),l(16),l(0),l(0),H(t.info.sampleRate)],[e]),ue=r=>y("esds",0,0,[a(58753152),C(32+r.codecPrivate.byteLength),l(1),C(0),a(75530368),C(18+r.codecPrivate.byteLength),C(64),C(21),wt(0),a(130071),a(130071),a(92307584),C(r.codecPrivate.byteLength),...r.codecPrivate,a(109084800),C(1),C(2)]),le=r=>{let t=[],e=[];for(let s of r.samples){if(t.push(s),t.length<=2)continue;let n=z(t[1].timestamp-t[0].timestamp,r.timescale);z(s.timestamp-t[t.length-2].timestamp,r.timescale)!==n&&(e.push({sampleCount:t.length-1,sampleDelta:n}),t=t.slice(-2))}return t.length>0&&e.push({sampleCount:t.length,sampleDelta:t.length===1?z(t[0].duration,r.timescale):z(t[1].timestamp-t[0].timestamp,r.timescale)}),y("stts",0,0,[a(e.length),e.map(s=>[a(s.sampleCount),a(s.sampleDelta)])])},me=r=>{if(r.samples.every(e=>e.type==="key"))return null;let t=[...r.samples.entries()].filter(([,e])=>e.type==="key");return y("stss",0,0,[a(t.length),t.map(([e])=>a(e+1))])},de=r=>{let t=[];for(let e=0;e<r.writtenChunks.length;e++){let s=r.writtenChunks[e];(t.length===0||D(t).samplesPerChunk!==s.sampleCount)&&t.push({firstChunk:e+1,samplesPerChunk:s.sampleCount})}return y("stsc",0,0,[a(t.length),t.map(e=>[a(e.firstChunk),a(e.samplesPerChunk),a(1)])])},fe=r=>y("stsz",0,0,[a(0),a(r.samples.length),r.samples.map(t=>a(t.size))]),pe=r=>r.writtenChunks.length>0&&D(r.writtenChunks).offset>=A(2,32)?y("co64",0,0,[a(r.writtenChunks.length),r.writtenChunks.map(t=>Bt(t.offset))]):y("stco",0,0,[a(r.writtenChunks.length),r.writtenChunks.map(t=>a(t.offset))]);var W=class{constructor(){this.buffer=null}},O=class{constructor(t,e,s){this.onData=t;this.onDone=e;this.options=s}},$=class{constructor(t){this.stream=t}};var S,P,G=class{constructor(){this.pos=0;u(this,S,new Uint8Array(8));u(this,P,new DataView(i(this,S).buffer));this.offsets=new WeakMap}seek(t){this.pos=t}writeU32(t){i(this,P).setUint32(0,t,!1),this.write(i(this,S).subarray(0,4))}writeU64(t){i(this,P).setUint32(0,Math.floor(t/A(2,32)),!1),i(this,P).setUint32(4,t,!1),this.write(i(this,S).subarray(0,8))}writeAscii(t){for(let e=0;e<t.length;e++)i(this,P).setUint8(e%8,t.charCodeAt(e)),e%8===7&&this.write(i(this,S));t.length%8!==0&&this.write(i(this,S).subarray(0,t.length%8))}writeBox(t){var e,s;if(this.offsets.set(t,this.pos),t.contents&&!t.children)this.writeBoxHeader(t,(e=t.size)!=null?e:t.contents.byteLength+8),this.write(t.contents);else{let n=this.pos;if(this.writeBoxHeader(t,0),t.contents&&this.write(t.contents),t.children)for(let f of t.children)f&&this.writeBox(f);let o=this.pos,h=(s=t.size)!=null?s:o-n;this.pos=n,this.writeBoxHeader(t,h),this.pos=o}}writeBoxHeader(t,e){this.writeU32(t.largeSize?1:e),this.writeAscii(t.type),t.largeSize&&this.writeU64(e)}patchBox(t){let e=this.pos;this.pos=this.offsets.get(t),this.writeBox(t),this.pos=e}};S=new WeakMap,P=new WeakMap;var Y,U,L,Z,gt,rt=class extends G{constructor(e){super();u(this,Z);u(this,Y,void 0);u(this,U,new ArrayBuffer(A(2,16)));u(this,L,new Uint8Array(i(this,U)));w(this,Y,e)}write(e){d(this,Z,gt).call(this,this.pos+e.byteLength),i(this,L).set(e,this.pos),this.pos+=e.byteLength}finalize(){d(this,Z,gt).call(this,this.pos),i(this,Y).buffer=i(this,U).slice(0,this.pos)}};Y=new WeakMap,U=new WeakMap,L=new WeakMap,Z=new WeakSet,gt=function(e){let s=i(this,U).byteLength;for(;s<e;)s*=2;if(s===i(this,U).byteLength)return;let n=new ArrayBuffer(s),o=new Uint8Array(n);o.set(i(this,L),0),w(this,U,n),w(this,L,o)};var _,k,K=class extends G{constructor(e){super();u(this,_,void 0);u(this,k,[]);w(this,_,e)}write(e){i(this,k).push({data:e.slice(),start:this.pos}),this.pos+=e.byteLength}flush(){if(i(this,k).length===0)return;let e=[],s=[...i(this,k)].sort((n,o)=>n.start-o.start);e.push({start:s[0].start,size:s[0].data.byteLength});for(let n=1;n<s.length;n++){let o=e[e.length-1],h=s[n];h.start<=o.start+o.size?o.size=Math.max(o.size,h.start+h.data.byteLength-o.start):e.push({start:h.start,size:h.data.byteLength})}for(let n of e){n.data=new Uint8Array(n.size);for(let o of i(this,k))n.start<=o.start&&o.start<n.start+n.size&&n.data.set(o.data,o.start-n.start);i(this,_).onData(n.data,n.start)}i(this,k).length=0}finalize(){var e,s;(s=(e=i(this,_)).onDone)==null||s.call(e)}};_=new WeakMap,k=new WeakMap;var I=A(2,24),ce=2,F,b,j,xt,st,Ot,nt,Pt,R,et,X=class extends G{constructor(e){super();u(this,j);u(this,st);u(this,nt);u(this,R);u(this,F,void 0);u(this,b,[]);w(this,F,e)}write(e){d(this,j,xt).call(this,e,this.pos),d(this,R,et).call(this),this.pos+=e.byteLength}finalize(){var e,s;d(this,R,et).call(this,!0),(s=(e=i(this,F)).onDone)==null||s.call(e)}};F=new WeakMap,b=new WeakMap,j=new WeakSet,xt=function(e,s){let n=i(this,b).findIndex(v=>v.start<=s&&s<v.start+I);n===-1&&(n=d(this,nt,Pt).call(this,s));let o=i(this,b)[n],h=s-o.start,f=e.subarray(0,Math.min(I-h,e.byteLength));o.data.set(f,h);let ct={start:h,end:h+f.byteLength};if(d(this,st,Ot).call(this,o,ct),o.written[0].start===0&&o.written[0].end===I&&(o.shouldFlush=!0),i(this,b).length>ce){for(let v=0;v<i(this,b).length-1;v++)i(this,b)[v].shouldFlush=!0;d(this,R,et).call(this)}f.byteLength<e.byteLength&&d(this,j,xt).call(this,e.subarray(f.byteLength),s+f.byteLength)},st=new WeakSet,Ot=function(e,s){let n=0,o=e.written.length-1,h=-1;for(;n<=o;){let f=Math.floor(n+(o-n+1)/2);e.written[f].start<=s.start?(n=f+1,h=f):o=f-1}for(e.written.splice(h+1,0,s),(h===-1||e.written[h].end<s.start)&&h++;h<e.written.length-1&&e.written[h].end>=e.written[h+1].start;)e.written[h].end=Math.max(e.written[h].end,e.written[h+1].end),e.written.splice(h+1,1)},nt=new WeakSet,Pt=function(e){let n={start:Math.floor(e/I)*I,data:new Uint8Array(I),written:[],shouldFlush:!1};return i(this,b).push(n),i(this,b).sort((o,h)=>o.start-h.start),i(this,b).indexOf(n)},R=new WeakSet,et=function(e=!1){for(let s=0;s<i(this,b).length;s++){let n=i(this,b)[s];if(!(!n.shouldFlush&&!e)){for(let o of n.written)i(this,F).onData(n.data.subarray(o.start,o.end),n.start+o.start);i(this,b).splice(s--,1)}}};var it=class extends X{constructor(t){super(new O((e,s)=>t.stream.write({type:"write",data:e,position:s})))}};var tt=1e3,ye=2082844800,we=.5,be=["avc","hevc"],ge=["aac"],xe=["strict","offset","permissive"],p,c,B,M,E,ut,lt,mt,It,dt,Lt,ft,_t,q,Tt,pt,Ft,N,at,V,ot,J,Ct,ht=class{constructor(t){u(this,mt);u(this,dt);u(this,ft);u(this,q);u(this,pt);u(this,N);u(this,V);u(this,J);u(this,p,void 0);u(this,c,void 0);u(this,B,void 0);u(this,M,null);u(this,E,null);u(this,ut,Math.floor(Date.now()/1e3)+ye);u(this,lt,!1);var e;if(d(this,mt,It).call(this,t),this.target=t.target,w(this,p,Ut({firstTimestampBehavior:"strict"},t)),t.target instanceof W)w(this,c,new rt(t.target));else if(t.target instanceof O)w(this,c,(e=t.target.options)!=null&&e.chunked?new X(t.target):new K(t.target));else if(t.target instanceof $)w(this,c,new it(t.target));else throw new Error(`Invalid target: ${t.target}`);d(this,dt,Lt).call(this),d(this,ft,_t).call(this)}addVideoChunk(t,e){let s=new Uint8Array(t.byteLength);t.copyTo(s),this.addVideoChunkRaw(s,t.type,t.timestamp,t.duration,e)}addVideoChunkRaw(t,e,s,n,o){if(d(this,J,Ct).call(this),!i(this,p).video)throw new Error("No video track declared.");d(this,q,Tt).call(this,i(this,M),t,e,s,n,o)}addAudioChunk(t,e){let s=new Uint8Array(t.byteLength);t.copyTo(s),this.addAudioChunkRaw(s,t.type,t.timestamp,t.duration,e)}addAudioChunkRaw(t,e,s,n,o){if(d(this,J,Ct).call(this),!i(this,p).audio)throw new Error("No audio track declared.");d(this,q,Tt).call(this,i(this,E),t,e,s,n,o)}finalize(){i(this,M)&&d(this,N,at).call(this,i(this,M)),i(this,E)&&d(this,N,at).call(this,i(this,E));let t=i(this,c).offsets.get(i(this,B)),e=i(this,c).pos-t;i(this,B).size=e,i(this,c).patchBox(i(this,B));let s=zt([i(this,M),i(this,E)].filter(Boolean),i(this,ut));i(this,c).writeBox(s),d(this,V,ot).call(this),i(this,c).finalize()}};p=new WeakMap,c=new WeakMap,B=new WeakMap,M=new WeakMap,E=new WeakMap,ut=new WeakMap,lt=new WeakMap,mt=new WeakSet,It=function(t){if(t.video&&!be.includes(t.video.codec))throw new Error(`Unsupported video codec: ${t.video.codec}`);if(t.audio&&!ge.includes(t.audio.codec))throw new Error(`Unsupported audio codec: ${t.audio.codec}`);if(t.firstTimestampBehavior&&!xe.includes(t.firstTimestampBehavior))throw new Error(`Invalid first timestamp behavior: ${t.firstTimestampBehavior}`)},dt=new WeakSet,Lt=function(){var e;let t=((e=i(this,p).video)==null?void 0:e.codec)==="hevc";i(this,c).writeBox(Et(t)),w(this,B,Dt()),i(this,c).writeBox(i(this,B)),d(this,V,ot).call(this)},ft=new WeakSet,_t=function(){i(this,p).video&&w(this,M,{id:1,info:{type:"video",codec:i(this,p).video.codec,width:i(this,p).video.width,height:i(this,p).video.height},timescale:720,codecPrivate:new Uint8Array(0),samples:[],writtenChunks:[],currentChunk:null,firstTimestamp:void 0,lastTimestamp:-1}),i(this,p).audio&&w(this,E,{id:i(this,p).video?2:1,info:{type:"audio",codec:i(this,p).audio.codec,numberOfChannels:i(this,p).audio.numberOfChannels,sampleRate:i(this,p).audio.sampleRate},timescale:i(this,p).audio.sampleRate,codecPrivate:new Uint8Array(0),samples:[],writtenChunks:[],currentChunk:null,firstTimestamp:void 0,lastTimestamp:-1})},q=new WeakSet,Tt=function(t,e,s,n,o,h){var v;let f=n/1e6,ct=o/1e6;t.firstTimestamp===void 0&&(t.firstTimestamp=f),f=d(this,pt,Ft).call(this,f,t),(!t.currentChunk||f-t.currentChunk.startTimestamp>=we)&&(t.currentChunk&&d(this,N,at).call(this,t),t.currentChunk={startTimestamp:f,sampleData:[],sampleCount:0}),t.currentChunk.sampleData.push(e),t.currentChunk.sampleCount++,(v=h==null?void 0:h.decoderConfig)!=null&&v.description&&(t.codecPrivate=new Uint8Array(h.decoderConfig.description)),t.samples.push({timestamp:f,duration:ct,size:e.byteLength,type:s})},pt=new WeakSet,Ft=function(t,e){if(i(this,p).firstTimestampBehavior==="strict"&&e.lastTimestamp===-1&&t!==0)throw new Error(`The first chunk for your media track must have a timestamp of 0 (received ${t}). Non-zero first timestamps are often caused by directly piping frames or audio data from a MediaStreamTrack into the encoder. Their timestamps are typically relative to the age of the document, which is probably what you want.

If you want to offset all timestamps of a track such that the first one is zero, set firstTimestampBehavior: 'offset' in the options.
If you want to allow non-zero first timestamps, set firstTimestampBehavior: 'permissive'.
`);if(i(this,p).firstTimestampBehavior==="offset"&&(t-=e.firstTimestamp),t<e.lastTimestamp)throw new Error(`Timestamps must be monotonically increasing (went from ${e.lastTimestamp*1e6} to ${t*1e6}).`);return t},N=new WeakSet,at=function(t){if(t.currentChunk){t.currentChunk.offset=i(this,c).pos;for(let e of t.currentChunk.sampleData)i(this,c).write(e);t.currentChunk.sampleData=null,t.writtenChunks.push(t.currentChunk),d(this,V,ot).call(this)}},V=new WeakSet,ot=function(){i(this,c)instanceof K&&i(this,c).flush()},J=new WeakSet,Ct=function(){if(i(this,lt))throw new Error("Cannot add new video or audio chunks after the file has been finalized.")};return $t(Te);})();
if (typeof module === "object" && typeof module.exports === "object") module.exports = Mp4Muxer;
