"use strict";var Mp4Muxer=(()=>{var K=Object.defineProperty;var ve=Object.getOwnPropertyDescriptor;var Ae=Object.getOwnPropertyNames,le=Object.getOwnPropertySymbols;var me=Object.prototype.hasOwnProperty,ke=Object.prototype.propertyIsEnumerable;var X=Math.pow,de=(r,e,t)=>e in r?K(r,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):r[e]=t,fe=(r,e)=>{for(var t in e||={})me.call(e,t)&&de(r,t,e[t]);if(le)for(var t of le(e))ke.call(e,t)&&de(r,t,e[t]);return r};var Se=(r,e)=>{for(var t in e)K(r,t,{get:e[t],enumerable:!0})},Ue=(r,e,t,s)=>{if(e&&typeof e=="object"||typeof e=="function")for(let n of Ae(e))!me.call(r,n)&&n!==t&&K(r,n,{get:()=>e[n],enumerable:!(s=ve(e,n))||s.enumerable});return r};var Be=r=>Ue(K({},"__esModule",{value:!0}),r);var ae=(r,e,t)=>{if(!e.has(r))throw TypeError("Cannot "+t)};var i=(r,e,t)=>(ae(r,e,"read from private field"),t?t.call(r):e.get(r)),u=(r,e,t)=>{if(e.has(r))throw TypeError("Cannot add the same private member more than once");e instanceof WeakSet?e.add(r):e.set(r,t)},p=(r,e,t,s)=>(ae(r,e,"write to private field"),s?s.call(r,t):e.set(r,t),t);var w=(r,e,t)=>(ae(r,e,"access private method"),t);var nt={};Se(nt,{ArrayBufferTarget:()=>F,FileSystemWritableFileStreamTarget:()=>R,Muxer:()=>Q,StreamTarget:()=>U});var d=r=>{let e=new Uint8Array(2);return new DataView(e.buffer).setUint16(0,r,!1),[...e]},ce=r=>{let e=new Uint8Array(2);return new DataView(e.buffer).setInt16(0,r,!1),[...e]},pe=r=>{let e=new Uint8Array(4);return new DataView(e.buffer).setUint32(0,r,!1),[...e].slice(1)},o=r=>{let e=new Uint8Array(4);return new DataView(e.buffer).setUint32(0,r,!1),[...e]},oe=r=>{let e=new Uint8Array(2),t=new DataView(e.buffer);return t.setUint8(0,r),t.setUint8(1,r<<8),[...e]},_=r=>{let e=new Uint8Array(4),t=new DataView(e.buffer);return t.setUint16(0,r,!1),t.setUint16(2,r<<16,!1),[...e]},b=(r,e=!1)=>{let t=Array(r.length).fill(null).map((s,n)=>r.charCodeAt(n));return e&&t.push(0),t},D=r=>r&&r[r.length-1];var we=[65536,0,0,0,65536,0,0,0,1073741824].map(o),x=(r,e,t)=>({type:r,contents:e&&new Uint8Array(e.flat(10)),children:t}),c=(r,e,t,s,n)=>x(r,[e,pe(t),s!=null?s:[]],n),M=(r,e)=>Math.round(r*e),ye=r=>r?x("ftyp",[b("isom"),o(0),b("iso4"),b("hvc1")]):x("ftyp",[b("isom"),o(0),b("isom"),b("avc1"),b("mp41")]),xe=()=>({type:"mdat",largeSize:!0}),be=(r,e)=>x("moov",null,[De(e,r),...r.map(t=>Me(t,e))]),De=(r,e)=>{let t=M(Math.max(...e.map(n=>D(n.samples).timestamp+D(n.samples).duration)),Y),s=Math.max(...e.map(n=>n.id))+1;return c("mvhd",0,0,[o(r),o(r),o(Y),o(t),_(1),oe(1),Array(10).fill(0),we,Array(24).fill(0),o(s)])},Me=(r,e)=>x("trak",null,[Ee(r,e),ze(r,e)]),Ee=(r,e)=>{let t=D(r.samples),s=M(t.timestamp+t.duration,Y);return c("tkhd",0,3,[o(e),o(e),o(r.id),o(0),o(s),Array(8).fill(0),0,0,0,0,oe(r.info.type==="audio"?1:0),0,0,we,_(r.info.type==="video"?r.info.width:0),_(r.info.type==="video"?r.info.height:0)])},ze=(r,e)=>x("mdia",null,[Ie(r,e),Oe(r.info.type==="video"?"vide":"soun"),Pe(r)]),Ie=(r,e)=>{let t=D(r.samples),s=M(t.timestamp+t.duration,r.timescale);return c("mdhd",0,0,[o(e),o(e),o(r.timescale),o(s),85,196,d(0)])},Oe=r=>c("hdlr",0,0,[b("mhlr"),b(r),o(0),o(0),o(0),b("mp4-muxer-hdlr")]),Pe=r=>x("minf",null,[r.info.type==="video"?Le():_e(),Fe(),Ne(r)]),Le=()=>c("vmhd",0,1,[d(0),d(0),d(0),d(0)]),_e=()=>c("smhd",0,0,[0,0,0,0]),Fe=()=>x("dinf",null,[Re()]),Re=()=>c("dref",0,0,[o(1)],[Ve()]),Ve=()=>c("url ",0,1),Ne=r=>x("stbl",null,[He(r),Ye(r),Ze(r),je(r),qe(r),Je(r)]),He=r=>c("stsd",0,0,[o(1)],[r.info.type==="video"?We(r.info.codec==="avc"?"avc1":"hvc1",r,r.info.codec==="avc"?$e(r):Ge(r)):Ke("mp4a",r,Xe(r))]),We=(r,e,t)=>x(r,[Array(6).fill(0),0,1,0,0,0,0,Array(12).fill(0),d(e.info.width),d(e.info.height),o(4718592),o(4718592),o(0),d(1),Array(32).fill(0),d(24),ce(65535)],[t]),$e=r=>x("avcC",[...r.codecPrivate]),Ge=r=>x("hvcC",[...r.codecPrivate]),Ke=(r,e,t)=>x(r,[Array(6).fill(0),d(1),d(0),d(0),o(0),d(e.info.numberOfChannels),d(16),d(0),d(0),_(e.info.sampleRate)],[t]),Xe=r=>c("esds",0,0,[o(58753152),34,d(1),0,o(75530368),20,64,21,0,0,0,o(130071),o(130071),o(92307584),2,r.codecPrivate[0],r.codecPrivate[1],o(109084800),1,2]),Ye=r=>{var s,n;let e=[],t=[];for(let a of r.samples){if(e.push(a),e.length===1)continue;let h=M(e[1].timestamp-e[0].timestamp,r.timescale);M(a.timestamp-e[e.length-2].timestamp,r.timescale)!==h&&(t.push({sampleCount:e.length-1,sampleDelta:h}),e=e.slice(-2))}return t.push({sampleCount:e.length,sampleDelta:M(((n=(s=e[1])==null?void 0:s.timestamp)!=null?n:e[0].timestamp)-e[0].timestamp,r.timescale)}),c("stts",0,0,[o(t.length),t.map(a=>[o(a.sampleCount),o(a.sampleDelta)])])},Ze=r=>{if(r.samples.every(t=>t.type==="key"))return null;let e=[...r.samples.entries()].filter(([,t])=>t.type==="key");return c("stss",0,0,[o(e.length),e.map(([t])=>o(t+1))])},je=r=>{let e=[];for(let t=0;t<r.writtenChunks.length;t++){let s=r.writtenChunks[t];(e.length===0||D(e).samplesPerChunk!==s.sampleCount)&&e.push({firstChunk:t+1,samplesPerChunk:s.sampleCount})}return c("stsc",0,0,[o(e.length),e.map(t=>[o(t.firstChunk),o(t.samplesPerChunk),o(1)])])},qe=r=>c("stsz",0,0,[o(0),o(r.samples.length),r.samples.map(e=>o(e.size))]),Je=r=>c("stco",0,0,[o(r.writtenChunks.length),r.writtenChunks.map(e=>o(e.offset))]);var F=class{constructor(){this.buffer=null}},U=class{constructor(e,t,s){this.onData=e;this.onDone=t;this.options=s}},R=class{constructor(e){this.stream=e}};var g,B,V=class{constructor(){this.pos=0;u(this,g,new Uint8Array(8));u(this,B,new DataView(i(this,g).buffer));this.offsets=new WeakMap}seek(e){this.pos=e}writeU32(e){i(this,B).setUint32(0,e,!1),this.write(i(this,g).subarray(0,4))}writeU64(e){i(this,B).setUint32(0,Math.floor(e/X(2,32)),!1),i(this,B).setUint32(4,e,!1),this.write(i(this,g).subarray(0,8))}writeAscii(e){for(let t=0;t<e.length;t++)i(this,B).setUint8(t%8,e.charCodeAt(t)),t%8===7&&this.write(i(this,g));e.length%8!==0&&this.write(i(this,g).subarray(0,e.length%8))}writeBox(e){var t,s;if(this.offsets.set(e,this.pos),e.contents&&!e.children)this.writeBoxHeader(e,(t=e.size)!=null?t:e.contents.byteLength+8),this.write(e.contents);else{let n=this.pos;if(this.writeBoxHeader(e,0),e.contents&&this.write(e.contents),e.children)for(let l of e.children)l&&this.writeBox(l);let a=this.pos,h=(s=e.size)!=null?s:a-n;this.pos=n,this.writeBoxHeader(e,h),this.pos=a}}writeBoxHeader(e,t){this.writeU32(e.largeSize?1:t),this.writeAscii(e.type),e.largeSize&&this.writeU64(t)}patchBox(e){let t=this.pos;this.pos=this.offsets.get(e),this.writeBox(e),this.pos=t}};g=new WeakMap,B=new WeakMap;var W,T,z,Z=class extends V{constructor(t){super();u(this,W,void 0);u(this,T,new ArrayBuffer(X(2,16)));u(this,z,new Uint8Array(i(this,T)));p(this,W,t)}ensureSize(t){let s=i(this,T).byteLength;for(;s<t;)s*=2;if(s===i(this,T).byteLength)return;let n=new ArrayBuffer(s),a=new Uint8Array(n);a.set(i(this,z),0),p(this,T,n),p(this,z,a)}write(t){this.ensureSize(this.pos+t.byteLength),i(this,z).set(t,this.pos),this.pos+=t.byteLength}finalize(){this.ensureSize(this.pos),i(this,W).buffer=i(this,T).slice(0,this.pos)}};W=new WeakMap,T=new WeakMap,z=new WeakMap;var I,v,N=class extends V{constructor(t){super();u(this,I,void 0);u(this,v,[]);p(this,I,t)}write(t){i(this,v).push({data:t.slice(),start:this.pos}),this.pos+=t.byteLength}flush(){if(i(this,v).length===0)return;let t=[],s=[...i(this,v)].sort((n,a)=>n.start-a.start);t.push({start:s[0].start,size:s[0].data.byteLength});for(let n=1;n<s.length;n++){let a=t[t.length-1],h=s[n];h.start<=a.start+a.size?a.size=Math.max(a.size,h.start+h.data.byteLength-a.start):t.push({start:h.start,size:h.data.byteLength})}for(let n of t){n.data=new Uint8Array(n.size);for(let a of i(this,v))n.start<=a.start&&a.start<n.start+n.size&&n.data.set(a.data,a.start-n.start);i(this,I).onData(n.data,n.start)}i(this,v).length=0}finalize(){var t,s;(s=(t=i(this,I)).onDone)==null||s.call(t)}};I=new WeakMap,v=new WeakMap;var E=X(2,24),Qe=2,O,y,H=class extends V{constructor(t){super();u(this,O,void 0);u(this,y,[]);p(this,O,t)}write(t){this.writeDataIntoChunks(t,this.pos),this.flushChunks(),this.pos+=t.byteLength}writeDataIntoChunks(t,s){let n=i(this,y).findIndex(C=>C.start<=s&&s<C.start+E);n===-1&&(n=this.createChunk(s));let a=i(this,y)[n],h=s-a.start,l=t.subarray(0,Math.min(E-h,t.byteLength));a.data.set(l,h);let ne={start:h,end:h+l.byteLength};if(this.insertSectionIntoChunk(a,ne),a.written[0].start===0&&a.written[0].end===E&&(a.shouldFlush=!0),i(this,y).length>Qe){for(let C=0;C<i(this,y).length-1;C++)i(this,y)[C].shouldFlush=!0;this.flushChunks()}l.byteLength<t.byteLength&&this.writeDataIntoChunks(t.subarray(l.byteLength),s+l.byteLength)}insertSectionIntoChunk(t,s){let n=0,a=t.written.length-1,h=-1;for(;n<=a;){let l=Math.floor(n+(a-n+1)/2);t.written[l].start<=s.start?(n=l+1,h=l):a=l-1}for(t.written.splice(h+1,0,s),(h===-1||t.written[h].end<s.start)&&h++;h<t.written.length-1&&t.written[h].end>=t.written[h+1].start;)t.written[h].end=Math.max(t.written[h].end,t.written[h+1].end),t.written.splice(h+1,1)}createChunk(t){let n={start:Math.floor(t/E)*E,data:new Uint8Array(E),written:[],shouldFlush:!1};return i(this,y).push(n),i(this,y).sort((a,h)=>a.start-h.start),i(this,y).indexOf(n)}flushChunks(t=!1){for(let s=0;s<i(this,y).length;s++){let n=i(this,y)[s];if(!(!n.shouldFlush&&!t)){for(let a of n.written)i(this,O).onData(n.data.subarray(a.start,a.end),n.start+a.start);i(this,y).splice(s--,1)}}}finalize(){var t,s;this.flushChunks(!0),(s=(t=i(this,O)).onDone)==null||s.call(t)}};O=new WeakMap,y=new WeakMap;var j=class extends H{constructor(e){super(new U((t,s)=>e.stream.write({type:"write",data:t,position:s})))}};var Y=1e3,et=2082848400,tt=.5,rt=["avc","hevc"],it=["aac"],st=["strict","offset","permissive"],m,f,A,k,S,ee,te,re,Ce,ie,ge,se,Te,$,he,P,q,L,J,G,ue,Q=class{constructor(e){u(this,re);u(this,ie);u(this,se);u(this,$);u(this,P);u(this,L);u(this,G);u(this,m,void 0);u(this,f,void 0);u(this,A,void 0);u(this,k,null);u(this,S,null);u(this,ee,Math.floor(Date.now()/1e3)+et);u(this,te,!1);var t;if(w(this,re,Ce).call(this,e),this.target=e.target,p(this,m,fe({firstTimestampBehavior:"strict"},e)),e.target instanceof F)p(this,f,new Z(e.target));else if(e.target instanceof U)p(this,f,(t=e.target.options)!=null&&t.chunked?new H(e.target):new N(e.target));else if(e.target instanceof R)p(this,f,new j(e.target));else throw new Error(`Invalid target: ${e.target}`);w(this,ie,ge).call(this),w(this,se,Te).call(this)}addVideoChunk(e,t){let s=new Uint8Array(e.byteLength);e.copyTo(s),this.addVideoChunkRaw(s,e.type,e.timestamp,e.duration,t)}addVideoChunkRaw(e,t,s,n,a){if(w(this,G,ue).call(this),!i(this,m).video)throw new Error("No video track declared.");w(this,$,he).call(this,i(this,k),e,t,s,n,a)}addAudioChunk(e,t){let s=new Uint8Array(e.byteLength);e.copyTo(s),this.addAudioChunkRaw(s,e.type,e.timestamp,e.duration,t)}addAudioChunkRaw(e,t,s,n,a){if(w(this,G,ue).call(this),!i(this,m).audio)throw new Error("No audio track declared.");w(this,$,he).call(this,i(this,S),e,t,s,n,a)}finalize(){i(this,k)&&w(this,P,q).call(this,i(this,k)),i(this,S)&&w(this,P,q).call(this,i(this,S));let e=i(this,f).offsets.get(i(this,A)),t=i(this,f).pos-e;i(this,A).size=t,i(this,f).patchBox(i(this,A));let s=be([i(this,k),i(this,S)].filter(Boolean),i(this,ee));i(this,f).writeBox(s),w(this,L,J).call(this),i(this,f).finalize()}};m=new WeakMap,f=new WeakMap,A=new WeakMap,k=new WeakMap,S=new WeakMap,ee=new WeakMap,te=new WeakMap,re=new WeakSet,Ce=function(e){if(e.video&&!rt.includes(e.video.codec))throw new Error(`Unsupported video codec: ${e.video.codec}`);if(e.audio&&!it.includes(e.audio.codec))throw new Error(`Unsupported audio codec: ${e.audio.codec}`);if(e.firstTimestampBehavior&&!st.includes(e.firstTimestampBehavior))throw new Error(`Invalid first timestamp behavior: ${e.firstTimestampBehavior}`)},ie=new WeakSet,ge=function(){var t;let e=((t=i(this,m).video)==null?void 0:t.codec)==="hevc";i(this,f).writeBox(ye(e)),p(this,A,xe()),i(this,f).writeBox(i(this,A)),w(this,L,J).call(this)},se=new WeakSet,Te=function(){i(this,m).video&&p(this,k,{id:1,info:{type:"video",codec:i(this,m).video.codec,width:i(this,m).video.width,height:i(this,m).video.height},timescale:720,codecPrivate:null,samples:[],writtenChunks:[],currentChunk:null}),i(this,m).audio&&p(this,S,{id:i(this,m).video?2:1,info:{type:"audio",codec:i(this,m).audio.codec,numberOfChannels:i(this,m).audio.numberOfChannels,sampleRate:i(this,m).audio.sampleRate},timescale:i(this,m).audio.sampleRate,codecPrivate:null,samples:[],writtenChunks:[],currentChunk:null})},$=new WeakSet,he=function(e,t,s,n,a,h){var C;let l=n/1e6,ne=a/1e6;(!e.currentChunk||l-e.currentChunk.startTimestamp>=tt)&&(e.currentChunk&&w(this,P,q).call(this,e),e.currentChunk={startTimestamp:l,sampleData:[],sampleCount:0}),e.currentChunk.sampleData.push(t),e.currentChunk.sampleCount++,(C=h==null?void 0:h.decoderConfig)!=null&&C.description&&(e.codecPrivate=new Uint8Array(h.decoderConfig.description)),e.samples.push({timestamp:l,duration:ne,size:t.byteLength,type:s})},P=new WeakSet,q=function(e){if(e.currentChunk){e.currentChunk.offset=i(this,f).pos;for(let t of e.currentChunk.sampleData)i(this,f).write(t);e.currentChunk.sampleData=null,e.writtenChunks.push(e.currentChunk),w(this,L,J).call(this)}},L=new WeakSet,J=function(){i(this,f)instanceof N&&i(this,f).flush()},G=new WeakSet,ue=function(){if(i(this,te))throw new Error("Cannot add new video or audio chunks after the file has been finalized.")};return Be(nt);})();
if (typeof module === "object" && typeof module.exports === "object") module.exports = Mp4Muxer;
