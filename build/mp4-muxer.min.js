"use strict";var Mp4Muxer=(()=>{var se=Object.defineProperty;var qe=Object.getOwnPropertyDescriptor;var Ke=Object.getOwnPropertyNames,ke=Object.getOwnPropertySymbols;var Be=Object.prototype.hasOwnProperty,Ye=Object.prototype.propertyIsEnumerable;var x=Math.pow,De=(t,e,r)=>e in t?se(t,e,{enumerable:!0,configurable:!0,writable:!0,value:r}):t[e]=r,Ie=(t,e)=>{for(var r in e||={})Be.call(e,r)&&De(t,r,e[r]);if(ke)for(var r of ke(e))Ye.call(e,r)&&De(t,r,e[r]);return t};var Ze=(t,e)=>{for(var r in e)se(t,r,{get:e[r],enumerable:!0})},je=(t,e,r,s)=>{if(e&&typeof e=="object"||typeof e=="function")for(let n of Ke(e))!Be.call(t,n)&&n!==r&&se(t,n,{get:()=>e[n],enumerable:!(s=qe(e,n))||s.enumerable});return t};var Je=t=>je(se({},"__esModule",{value:!0}),t);var ge=(t,e,r)=>{if(!e.has(t))throw TypeError("Cannot "+r)};var i=(t,e,r)=>(ge(t,e,"read from private field"),r?r.call(t):e.get(t)),u=(t,e,r)=>{if(e.has(t))throw TypeError("Cannot add the same private member more than once");e instanceof WeakSet?e.add(t):e.set(t,r)},T=(t,e,r,s)=>(ge(t,e,"write to private field"),s?s.call(t,r):e.set(t,r),r);var c=(t,e,r)=>(ge(t,e,"access private method"),r);var Rt={};Ze(Rt,{ArrayBufferTarget:()=>G,FileSystemWritableFileStreamTarget:()=>q,Muxer:()=>fe,StreamTarget:()=>z});var d=new Uint8Array(8),O=new DataView(d.buffer),w=t=>[(t%256+256)%256],m=t=>(O.setUint16(0,t,!1),[d[0],d[1]]),Me=t=>(O.setInt16(0,t,!1),[d[0],d[1]]),ve=t=>(O.setUint32(0,t,!1),[d[1],d[2],d[3]]),a=t=>(O.setUint32(0,t,!1),[d[0],d[1],d[2],d[3]]),Pe=t=>(O.setUint32(0,Math.floor(t/x(2,32)),!1),O.setUint32(4,t,!1),[d[0],d[1],d[2],d[3],d[4],d[5],d[6],d[7]]),ne=t=>(O.setInt16(0,x(2,8)*t,!1),[d[0],d[1]]),S=t=>(O.setInt32(0,x(2,16)*t,!1),[d[0],d[1],d[2],d[3]]),xe=t=>(O.setInt32(0,x(2,30)*t,!1),[d[0],d[1],d[2],d[3]]),A=(t,e=!1)=>{let r=Array(t.length).fill(null).map((s,n)=>t.charCodeAt(n));return e&&r.push(0),r},U=t=>t&&t[t.length-1],P=(t,e,r=!0)=>{let s=t*e;return r?Math.round(s):s},Se=t=>{let e=t*(Math.PI/180),r=Math.cos(e),s=Math.sin(e);return[r,s,0,-s,r,0,0,0,1]},ze=Se(0),Ae=t=>[S(t[0]),S(t[1]),xe(t[2]),S(t[3]),S(t[4]),xe(t[5]),S(t[6]),S(t[7]),xe(t[8])];var b=(t,e,r)=>({type:t,contents:e&&new Uint8Array(e.flat(10)),children:r}),y=(t,e,r,s,n)=>b(t,[w(e),ve(r),s!=null?s:[]],n),Re=t=>t?b("ftyp",[A("isom"),a(0),A("iso4"),A("hvc1")]):b("ftyp",[A("isom"),a(0),A("isom"),A("avc1"),A("mp41")]),Le=()=>({type:"mdat",largeSize:!0}),Ne=(t,e)=>b("moov",null,[Qe(e,t),...t.map(r=>et(r,e))]),Qe=(t,e)=>{let r=P(Math.max(0,...e.filter(n=>n.samples.length>0).map(n=>U(n.samples).timestamp+U(n.samples).duration)),ae),s=Math.max(...e.map(n=>n.id))+1;return y("mvhd",0,0,[a(t),a(t),a(ae),a(r),S(1),ne(1),Array(10).fill(0),Ae(ze),Array(24).fill(0),a(s)])},et=(t,e)=>b("trak",null,[tt(t,e),rt(t,e)]),tt=(t,e)=>{let r=U(t.samples),s=P(r?r.timestamp+r.duration:0,ae);return y("tkhd",0,3,[a(e),a(e),a(t.id),a(0),a(s),Array(8).fill(0),m(0),m(0),ne(t.info.type==="audio"?1:0),m(0),Ae(Se(t.info.type==="video"?t.info.rotation:0)),S(t.info.type==="video"?t.info.width:0),S(t.info.type==="video"?t.info.height:0)])},rt=(t,e)=>b("mdia",null,[it(t,e),st(t.info.type==="video"?"vide":"soun"),nt(t)]),it=(t,e)=>{let r=U(t.samples),s=P(r?r.timestamp+r.duration:0,t.timescale);return y("mdhd",0,0,[a(e),a(e),a(t.timescale),a(s),m(21956),m(0)])},st=t=>y("hdlr",0,0,[A("mhlr"),A(t),a(0),a(0),a(0),A("mp4-muxer-hdlr")]),nt=t=>b("minf",null,[t.info.type==="video"?at():ot(),ht(),dt(t)]),at=()=>y("vmhd",0,1,[m(0),m(0),m(0),m(0)]),ot=()=>y("smhd",0,0,[m(0),m(0)]),ht=()=>b("dinf",null,[lt()]),lt=()=>y("dref",0,0,[a(1)],[ut()]),ut=()=>y("url ",0,1),dt=t=>b("stbl",null,[mt(t),gt(t),xt(t),vt(t),St(t),At(t)]),mt=t=>y("stsd",0,0,[a(1)],[t.info.type==="video"?ct(Ot[t.info.codec],t):yt(Et[t.info.codec],t)]),ct=(t,e)=>b(t,[Array(6).fill(0),m(1),m(0),m(0),Array(12).fill(0),m(e.info.width),m(e.info.height),a(4718592),a(4718592),a(0),m(1),Array(32).fill(0),m(24),Me(65535)],[Ut[e.info.codec](e)]),ft=t=>t.codecPrivate&&b("avcC",[...t.codecPrivate]),pt=t=>t.codecPrivate&&b("hvcC",[...t.codecPrivate]),Tt=t=>t.codecPrivate&&b("vpcC",[...t.codecPrivate]),bt=t=>t.codecPrivate&&b("av1C",[...t.codecPrivate]),yt=(t,e)=>b(t,[Array(6).fill(0),m(1),m(0),m(0),a(0),m(e.info.numberOfChannels),m(16),m(0),m(0),S(e.info.sampleRate)],[_t[e.info.codec](e)]),Ct=t=>y("esds",0,0,[a(58753152),w(32+t.codecPrivate.byteLength),m(1),w(0),a(75530368),w(18+t.codecPrivate.byteLength),w(64),w(21),ve(0),a(130071),a(130071),a(92307584),w(t.codecPrivate.byteLength),...t.codecPrivate,a(109084800),w(1),w(2)]),wt=t=>b("dOps",[w(0),w(t.info.numberOfChannels),m(3840),a(t.info.sampleRate),ne(0),w(0)]),gt=t=>y("stts",0,0,[a(t.timeToSampleTable.length),t.timeToSampleTable.map(e=>[a(e.sampleCount),a(e.sampleDelta)])]),xt=t=>{if(t.samples.every(r=>r.type==="key"))return null;let e=[...t.samples.entries()].filter(([,r])=>r.type==="key");return y("stss",0,0,[a(e.length),e.map(([r])=>a(r+1))])},vt=t=>y("stsc",0,0,[a(t.compactlyCodedChunkTable.length),t.compactlyCodedChunkTable.map(e=>[a(e.firstChunk),a(e.samplesPerChunk),a(1)])]),St=t=>y("stsz",0,0,[a(0),a(t.samples.length),t.samples.map(e=>a(e.size))]),At=t=>t.writtenChunks.length>0&&U(t.writtenChunks).offset>=x(2,32)?y("co64",0,0,[a(t.writtenChunks.length),t.writtenChunks.map(e=>Pe(e.offset))]):y("stco",0,0,[a(t.writtenChunks.length),t.writtenChunks.map(e=>a(e.offset))]),Ot={avc:"avc1",hevc:"hvc1",vp9:"vp09",av1:"av01"},Ut={avc:ft,hevc:pt,vp9:Tt,av1:bt},Et={aac:"mp4a",opus:"opus"},_t={aac:Ct,opus:wt};var G=class{constructor(){this.buffer=null}},z=class{constructor(e,r,s){this.onData=e;this.onDone=r;this.options=s}},q=class{constructor(e,r){this.stream=e;this.options=r}};var E,R,K=class{constructor(){this.pos=0;u(this,E,new Uint8Array(8));u(this,R,new DataView(i(this,E).buffer));this.offsets=new WeakMap}seek(e){this.pos=e}writeU32(e){i(this,R).setUint32(0,e,!1),this.write(i(this,E).subarray(0,4))}writeU64(e){i(this,R).setUint32(0,Math.floor(e/x(2,32)),!1),i(this,R).setUint32(4,e,!1),this.write(i(this,E).subarray(0,8))}writeAscii(e){for(let r=0;r<e.length;r++)i(this,R).setUint8(r%8,e.charCodeAt(r)),r%8===7&&this.write(i(this,E));e.length%8!==0&&this.write(i(this,E).subarray(0,e.length%8))}writeBox(e){var r,s;if(this.offsets.set(e,this.pos),e.contents&&!e.children)this.writeBoxHeader(e,(r=e.size)!=null?r:e.contents.byteLength+8),this.write(e.contents);else{let n=this.pos;if(this.writeBoxHeader(e,0),e.contents&&this.write(e.contents),e.children)for(let l of e.children)l&&this.writeBox(l);let o=this.pos,h=(s=e.size)!=null?s:o-n;this.seek(n),this.writeBoxHeader(e,h),this.seek(o)}}writeBoxHeader(e,r){this.writeU32(e.largeSize?1:r),this.writeAscii(e.type),e.largeSize&&this.writeU64(r)}patchBox(e){let r=this.pos;this.seek(this.offsets.get(e)),this.writeBox(e),this.seek(r)}};E=new WeakMap,R=new WeakMap;var j,_,F,J,Oe,he=class extends K{constructor(r){super();u(this,J);u(this,j,void 0);u(this,_,new ArrayBuffer(x(2,16)));u(this,F,new Uint8Array(i(this,_)));T(this,j,r)}write(r){c(this,J,Oe).call(this,this.pos+r.byteLength),i(this,F).set(r,this.pos),this.pos+=r.byteLength}finalize(){c(this,J,Oe).call(this,this.pos),i(this,j).buffer=i(this,_).slice(0,this.pos)}};j=new WeakMap,_=new WeakMap,F=new WeakMap,J=new WeakSet,Oe=function(r){let s=i(this,_).byteLength;for(;s<r;)s*=2;if(s===i(this,_).byteLength)return;let n=new ArrayBuffer(s),o=new Uint8Array(n);o.set(i(this,F),0),T(this,_,n),T(this,F,o)};var V,k,Y=class extends K{constructor(r){super();u(this,V,void 0);u(this,k,[]);T(this,V,r)}write(r){i(this,k).push({data:r.slice(),start:this.pos}),this.pos+=r.byteLength}flush(){if(i(this,k).length===0)return;let r=[],s=[...i(this,k)].sort((n,o)=>n.start-o.start);r.push({start:s[0].start,size:s[0].data.byteLength});for(let n=1;n<s.length;n++){let o=r[r.length-1],h=s[n];h.start<=o.start+o.size?o.size=Math.max(o.size,h.start+h.data.byteLength-o.start):r.push({start:h.start,size:h.data.byteLength})}for(let n of r){n.data=new Uint8Array(n.size);for(let o of i(this,k))n.start<=o.start&&o.start<n.start+n.size&&n.data.set(o.data,o.start-n.start);i(this,V).onData(n.data,n.start)}i(this,k).length=0}finalize(){var r,s;(s=(r=i(this,V)).onDone)==null||s.call(r)}};V=new WeakMap,k=new WeakMap;var kt=x(2,24),Dt=2,H,v,C,Q,Ue,ue,Fe,de,Ve,W,oe,Z=class extends K{constructor(r){var s,n;super();u(this,Q);u(this,ue);u(this,de);u(this,W);u(this,H,void 0);u(this,v,void 0);u(this,C,[]);if(T(this,H,r),T(this,v,(n=(s=r.options)==null?void 0:s.chunkSize)!=null?n:kt),!Number.isInteger(i(this,v))||i(this,v)<x(2,10))throw new Error("Invalid StreamTarget options: chunkSize must be an integer not smaller than 1024.")}write(r){c(this,Q,Ue).call(this,r,this.pos),c(this,W,oe).call(this),this.pos+=r.byteLength}finalize(){var r,s;c(this,W,oe).call(this,!0),(s=(r=i(this,H)).onDone)==null||s.call(r)}};H=new WeakMap,v=new WeakMap,C=new WeakMap,Q=new WeakSet,Ue=function(r,s){let n=i(this,C).findIndex(g=>g.start<=s&&s<g.start+i(this,v));n===-1&&(n=c(this,de,Ve).call(this,s));let o=i(this,C)[n],h=s-o.start,l=r.subarray(0,Math.min(i(this,v)-h,r.byteLength));o.data.set(l,h);let L={start:h,end:h+l.byteLength};if(c(this,ue,Fe).call(this,o,L),o.written[0].start===0&&o.written[0].end===i(this,v)&&(o.shouldFlush=!0),i(this,C).length>Dt){for(let g=0;g<i(this,C).length-1;g++)i(this,C)[g].shouldFlush=!0;c(this,W,oe).call(this)}l.byteLength<r.byteLength&&c(this,Q,Ue).call(this,r.subarray(l.byteLength),s+l.byteLength)},ue=new WeakSet,Fe=function(r,s){let n=0,o=r.written.length-1,h=-1;for(;n<=o;){let l=Math.floor(n+(o-n+1)/2);r.written[l].start<=s.start?(n=l+1,h=l):o=l-1}for(r.written.splice(h+1,0,s),(h===-1||r.written[h].end<s.start)&&h++;h<r.written.length-1&&r.written[h].end>=r.written[h+1].start;)r.written[h].end=Math.max(r.written[h].end,r.written[h+1].end),r.written.splice(h+1,1)},de=new WeakSet,Ve=function(r){let n={start:Math.floor(r/i(this,v))*i(this,v),data:new Uint8Array(i(this,v)),written:[],shouldFlush:!1};return i(this,C).push(n),i(this,C).sort((o,h)=>o.start-h.start),i(this,C).indexOf(n)},W=new WeakSet,oe=function(r=!1){for(let s=0;s<i(this,C).length;s++){let n=i(this,C)[s];if(!(!n.shouldFlush&&!r)){for(let o of n.written)i(this,H).onData(n.data.subarray(o.start,o.end),n.start+o.start);i(this,C).splice(s--,1)}}};var le=class extends Z{constructor(e){var r;super(new z((s,n)=>e.stream.write({type:"write",data:s,position:n}),void 0,{chunkSize:(r=e.options)==null?void 0:r.chunkSize}))}};var ae=1e3,Bt=["avc","hevc","vp9","av1"],It=["aac","opus"],Mt=2082844800,Pt=.5,zt=["strict","offset"],f,p,D,B,I,pe,ee,Te,He,be,We,ye,Xe,Ce,$e,te,Ee,we,Ge,X,me,$,ce,re,_e,fe=class{constructor(e){u(this,Te);u(this,be);u(this,ye);u(this,Ce);u(this,te);u(this,we);u(this,X);u(this,$);u(this,re);u(this,f,void 0);u(this,p,void 0);u(this,D,void 0);u(this,B,null);u(this,I,null);u(this,pe,Math.floor(Date.now()/1e3)+Mt);u(this,ee,!1);var r;if(c(this,Te,He).call(this,e),this.target=e.target,T(this,f,Ie({firstTimestampBehavior:"strict"},e)),e.target instanceof G)T(this,p,new he(e.target));else if(e.target instanceof z)T(this,p,(r=e.target.options)!=null&&r.chunked?new Z(e.target):new Y(e.target));else if(e.target instanceof q)T(this,p,new le(e.target));else throw new Error(`Invalid target: ${e.target}`);c(this,be,We).call(this),c(this,ye,Xe).call(this)}addVideoChunk(e,r,s){let n=new Uint8Array(e.byteLength);e.copyTo(n),this.addVideoChunkRaw(n,e.type,s!=null?s:e.timestamp,e.duration,r)}addVideoChunkRaw(e,r,s,n,o){if(c(this,re,_e).call(this),!i(this,f).video)throw new Error("No video track declared.");c(this,te,Ee).call(this,i(this,B),e,r,s,n,o)}addAudioChunk(e,r,s){let n=new Uint8Array(e.byteLength);e.copyTo(n),this.addAudioChunkRaw(n,e.type,s!=null?s:e.timestamp,e.duration,r)}addAudioChunkRaw(e,r,s,n,o){if(c(this,re,_e).call(this),!i(this,f).audio)throw new Error("No audio track declared.");c(this,te,Ee).call(this,i(this,I),e,r,s,n,o)}finalize(){i(this,B)&&c(this,X,me).call(this,i(this,B)),i(this,I)&&c(this,X,me).call(this,i(this,I));let e=i(this,p).offsets.get(i(this,D)),r=i(this,p).pos-e;i(this,D).size=r,i(this,p).patchBox(i(this,D));let s=Ne([i(this,B),i(this,I)].filter(Boolean),i(this,pe));i(this,p).writeBox(s),c(this,$,ce).call(this),i(this,p).finalize(),T(this,ee,!0)}};f=new WeakMap,p=new WeakMap,D=new WeakMap,B=new WeakMap,I=new WeakMap,pe=new WeakMap,ee=new WeakMap,Te=new WeakSet,He=function(e){if(e.video){if(!Bt.includes(e.video.codec))throw new Error(`Unsupported video codec: ${e.video.codec}`);if(e.video.rotation!==void 0&&![0,90,180,270].includes(e.video.rotation))throw new Error(`Invalid video rotation: ${e.video.rotation}. Has to be 0, 90, 180 or 270.`)}if(e.audio&&!It.includes(e.audio.codec))throw new Error(`Unsupported audio codec: ${e.audio.codec}`);if(e.firstTimestampBehavior&&!zt.includes(e.firstTimestampBehavior))throw new Error(`Invalid first timestamp behavior: ${e.firstTimestampBehavior}`)},be=new WeakSet,We=function(){var r;let e=((r=i(this,f).video)==null?void 0:r.codec)==="hevc";i(this,p).writeBox(Re(e)),T(this,D,Le()),i(this,p).writeBox(i(this,D)),c(this,$,ce).call(this)},ye=new WeakSet,Xe=function(){var e;if(i(this,f).video&&T(this,B,{id:1,info:{type:"video",codec:i(this,f).video.codec,width:i(this,f).video.width,height:i(this,f).video.height,rotation:(e=i(this,f).video.rotation)!=null?e:0},timescale:720,codecPrivate:new Uint8Array(0),samples:[],writtenChunks:[],currentChunk:null,firstTimestamp:void 0,lastTimestamp:-1,timeToSampleTable:[],lastTimescaleUnits:null,compactlyCodedChunkTable:[]}),i(this,f).audio){let r=c(this,Ce,$e).call(this,2,i(this,f).audio.sampleRate,i(this,f).audio.numberOfChannels);T(this,I,{id:i(this,f).video?2:1,info:{type:"audio",codec:i(this,f).audio.codec,numberOfChannels:i(this,f).audio.numberOfChannels,sampleRate:i(this,f).audio.sampleRate},timescale:i(this,f).audio.sampleRate,codecPrivate:r,samples:[],writtenChunks:[],currentChunk:null,firstTimestamp:void 0,lastTimestamp:-1,timeToSampleTable:[],lastTimescaleUnits:null,compactlyCodedChunkTable:[]})}},Ce=new WeakSet,$e=function(e,r,s){let o=[96e3,88200,64e3,48e3,44100,32e3,24e3,22050,16e3,12e3,11025,8e3,7350].indexOf(r),h=s,l="";l+=e.toString(2).padStart(5,"0"),l+=o.toString(2).padStart(4,"0"),o===15&&(l+=r.toString(2).padStart(24,"0")),l+=h.toString(2).padStart(4,"0");let L=Math.ceil(l.length/8)*8;l=l.padEnd(L,"0");let g=new Uint8Array(l.length/8);for(let M=0;M<l.length;M+=8)g[M/8]=parseInt(l.slice(M,M+8),2);return g},te=new WeakSet,Ee=function(e,r,s,n,o,h){var g;let l=n/1e6,L=o/1e6;if(e.firstTimestamp===void 0&&(e.firstTimestamp=l),l=c(this,we,Ge).call(this,l,e),e.lastTimestamp=l,(!e.currentChunk||l-e.currentChunk.startTimestamp>=Pt)&&(e.currentChunk&&c(this,X,me).call(this,e),e.currentChunk={startTimestamp:l,sampleData:[],sampleCount:0}),e.currentChunk.sampleData.push(r),e.currentChunk.sampleCount++,(g=h==null?void 0:h.decoderConfig)!=null&&g.description&&(e.codecPrivate=new Uint8Array(h.decoderConfig.description)),e.samples.push({timestamp:l,duration:L,size:r.byteLength,type:s}),e.lastTimescaleUnits!==null){let M=P(l,e.timescale,!1),ie=Math.round(M-e.lastTimescaleUnits);e.lastTimescaleUnits+=ie;let N=U(e.timeToSampleTable);N.sampleCount===1?(N.sampleDelta=ie,N.sampleCount++):N.sampleDelta===ie?N.sampleCount++:(N.sampleCount--,e.timeToSampleTable.push({sampleCount:2,sampleDelta:ie}))}else e.lastTimescaleUnits=0,e.timeToSampleTable.push({sampleCount:1,sampleDelta:P(L,e.timescale)})},we=new WeakSet,Ge=function(e,r){if(i(this,f).firstTimestampBehavior==="strict"&&r.lastTimestamp===-1&&e!==0)throw new Error(`The first chunk for your media track must have a timestamp of 0 (received ${e}). Non-zero first timestamps are often caused by directly piping frames or audio data from a MediaStreamTrack into the encoder. Their timestamps are typically relative to the age of the document, which is probably what you want.

If you want to offset all timestamps of a track such that the first one is zero, set firstTimestampBehavior: 'offset' in the options.
`);if(i(this,f).firstTimestampBehavior==="offset"&&(e-=r.firstTimestamp),e<r.lastTimestamp)throw new Error(`Timestamps must be monotonically increasing (went from ${r.lastTimestamp*1e6} to ${e*1e6}).`);return e},X=new WeakSet,me=function(e){if(e.currentChunk){e.currentChunk.offset=i(this,p).pos;for(let r of e.currentChunk.sampleData)i(this,p).write(r);e.currentChunk.sampleData=null,(e.compactlyCodedChunkTable.length===0||U(e.compactlyCodedChunkTable).samplesPerChunk!==e.currentChunk.sampleCount)&&e.compactlyCodedChunkTable.push({firstChunk:e.writtenChunks.length+1,samplesPerChunk:e.currentChunk.sampleCount}),e.writtenChunks.push(e.currentChunk),c(this,$,ce).call(this)}},$=new WeakSet,ce=function(){i(this,p)instanceof Y&&i(this,p).flush()},re=new WeakSet,_e=function(){if(i(this,ee))throw new Error("Cannot add new video or audio chunks after the file has been finalized.")};return Je(Rt);})();
if (typeof module === "object" && typeof module.exports === "object") Object.assign(module.exports, Mp4Muxer)
