"use strict";var Mp4Muxer=(()=>{var se=Object.defineProperty;var $e=Object.getOwnPropertyDescriptor;var qe=Object.getOwnPropertyNames,ke=Object.getOwnPropertySymbols;var Me=Object.prototype.hasOwnProperty,Ge=Object.prototype.propertyIsEnumerable;var A=Math.pow,Be=(i,e,t)=>e in i?se(i,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):i[e]=t,Ee=(i,e)=>{for(var t in e||={})Me.call(e,t)&&Be(i,t,e[t]);if(ke)for(var t of ke(e))Ge.call(e,t)&&Be(i,t,e[t]);return i};var Ke=(i,e)=>{for(var t in e)se(i,t,{get:e[t],enumerable:!0})},Xe=(i,e,t,s)=>{if(e&&typeof e=="object"||typeof e=="function")for(let n of qe(e))!Me.call(i,n)&&n!==t&&se(i,n,{get:()=>e[n],enumerable:!(s=$e(e,n))||s.enumerable});return i};var Ye=i=>Xe(se({},"__esModule",{value:!0}),i);var Ce=(i,e,t)=>{if(!e.has(i))throw TypeError("Cannot "+t)};var r=(i,e,t)=>(Ce(i,e,"read from private field"),t?t.call(i):e.get(i)),u=(i,e,t)=>{if(e.has(i))throw TypeError("Cannot add the same private member more than once");e instanceof WeakSet?e.add(i):e.set(i,t)},b=(i,e,t,s)=>(Ce(i,e,"write to private field"),s?s.call(i,t):e.set(i,t),t);var m=(i,e,t)=>(Ce(i,e,"access private method"),t);var kt={};Ke(kt,{ArrayBufferTarget:()=>G,FileSystemWritableFileStreamTarget:()=>K,Muxer:()=>fe,StreamTarget:()=>P});var f=new Uint8Array(8),v=new DataView(f.buffer),S=i=>[(i%256+256)%256],d=i=>(v.setUint16(0,i,!1),[f[0],f[1]]),ze=i=>(v.setInt16(0,i,!1),[f[0],f[1]]),ge=i=>(v.setUint32(0,i,!1),[f[1],f[2],f[3]]),a=i=>(v.setUint32(0,i,!1),[f[0],f[1],f[2],f[3]]),De=i=>(v.setUint32(0,Math.floor(i/A(2,32)),!1),v.setUint32(4,i,!1),[f[0],f[1],f[2],f[3],f[4],f[5],f[6],f[7]]),xe=i=>(v.setUint8(0,i),v.setUint8(1,i<<8),[f[0],f[1]]),q=i=>(v.setUint16(0,i,!1),v.setUint16(2,i<<16,!1),[f[0],f[1],f[2],f[3]]),x=(i,e=!1)=>{let t=Array(i.length).fill(null).map((s,n)=>i.charCodeAt(n));return e&&t.push(0),t},U=i=>i&&i[i.length-1],O=(i,e,t=!0)=>{let s=i*e;return t?Math.round(s):s};var Ie=[65536,0,0,0,65536,0,0,0,1073741824].map(a),w=(i,e,t)=>({type:i,contents:e&&new Uint8Array(e.flat(10)),children:t}),y=(i,e,t,s,n)=>w(i,[S(e),ge(t),s!=null?s:[]],n),Oe=i=>i?w("ftyp",[x("isom"),a(0),x("iso4"),x("hvc1")]):w("ftyp",[x("isom"),a(0),x("isom"),x("avc1"),x("mp41")]),Pe=()=>({type:"mdat",largeSize:!0}),Le=(i,e)=>w("moov",null,[Ze(e,i),...i.map(t=>je(t,e))]),Ze=(i,e)=>{let t=O(Math.max(0,...e.filter(n=>n.samples.length>0).map(n=>U(n.samples).timestamp+U(n.samples).duration)),ne),s=Math.max(...e.map(n=>n.id))+1;return y("mvhd",0,0,[a(i),a(i),a(ne),a(t),q(1),xe(1),Array(10).fill(0),Ie,Array(24).fill(0),a(s)])},je=(i,e)=>w("trak",null,[Je(i,e),Qe(i,e)]),Je=(i,e)=>{let t=U(i.samples),s=O(t?t.timestamp+t.duration:0,ne);return y("tkhd",0,3,[a(e),a(e),a(i.id),a(0),a(s),Array(8).fill(0),d(0),d(0),xe(i.info.type==="audio"?1:0),d(0),Ie,q(i.info.type==="video"?i.info.width:0),q(i.info.type==="video"?i.info.height:0)])},Qe=(i,e)=>w("mdia",null,[et(i,e),tt(i.info.type==="video"?"vide":"soun"),it(i)]),et=(i,e)=>{let t=U(i.samples),s=O(t?t.timestamp+t.duration:0,i.timescale);return y("mdhd",0,0,[a(e),a(e),a(i.timescale),a(s),d(21956),d(0)])},tt=i=>y("hdlr",0,0,[x("mhlr"),x(i),a(0),a(0),a(0),x("mp4-muxer-hdlr")]),it=i=>w("minf",null,[i.info.type==="video"?rt():st(),nt(),ht(i)]),rt=()=>y("vmhd",0,1,[d(0),d(0),d(0),d(0)]),st=()=>y("smhd",0,0,[d(0),d(0)]),nt=()=>w("dinf",null,[at()]),at=()=>y("dref",0,0,[a(1)],[ot()]),ot=()=>y("url ",0,1),ht=i=>w("stbl",null,[lt(i),pt(i),bt(i),yt(i),Tt(i),wt(i)]),lt=i=>y("stsd",0,0,[a(1)],[i.info.type==="video"?ut(i.info.codec==="avc"?"avc1":"hvc1",i,i.info.codec==="avc"?dt(i):mt(i)):ft("mp4a",i,ct(i))]),ut=(i,e,t)=>w(i,[Array(6).fill(0),d(1),d(0),d(0),Array(12).fill(0),d(e.info.width),d(e.info.height),a(4718592),a(4718592),a(0),d(1),Array(32).fill(0),d(24),ze(65535)],[t]),dt=i=>i.codecPrivate&&w("avcC",[...i.codecPrivate]),mt=i=>i.codecPrivate&&w("hvcC",[...i.codecPrivate]),ft=(i,e,t)=>w(i,[Array(6).fill(0),d(1),d(0),d(0),a(0),d(e.info.numberOfChannels),d(16),d(0),d(0),q(e.info.sampleRate)],[t]),ct=i=>y("esds",0,0,[a(58753152),S(32+i.codecPrivate.byteLength),d(1),S(0),a(75530368),S(18+i.codecPrivate.byteLength),S(64),S(21),ge(0),a(130071),a(130071),a(92307584),S(i.codecPrivate.byteLength),...i.codecPrivate,a(109084800),S(1),S(2)]),pt=i=>y("stts",0,0,[a(i.timeToSampleTable.length),i.timeToSampleTable.map(e=>[a(e.sampleCount),a(e.sampleDelta)])]),bt=i=>{if(i.samples.every(t=>t.type==="key"))return null;let e=[...i.samples.entries()].filter(([,t])=>t.type==="key");return y("stss",0,0,[a(e.length),e.map(([t])=>a(t+1))])},yt=i=>y("stsc",0,0,[a(i.compactlyCodedChunkTable.length),i.compactlyCodedChunkTable.map(e=>[a(e.firstChunk),a(e.samplesPerChunk),a(1)])]),Tt=i=>y("stsz",0,0,[a(0),a(i.samples.length),i.samples.map(e=>a(e.size))]),wt=i=>i.writtenChunks.length>0&&U(i.writtenChunks).offset>=A(2,32)?y("co64",0,0,[a(i.writtenChunks.length),i.writtenChunks.map(e=>De(e.offset))]):y("stco",0,0,[a(i.writtenChunks.length),i.writtenChunks.map(e=>a(e.offset))]);var G=class{constructor(){this.buffer=null}},P=class{constructor(e,t,s){this.onData=e;this.onDone=t;this.options=s}},K=class{constructor(e,t){this.stream=e;this.options=t}};var k,L,X=class{constructor(){this.pos=0;u(this,k,new Uint8Array(8));u(this,L,new DataView(r(this,k).buffer));this.offsets=new WeakMap}seek(e){this.pos=e}writeU32(e){r(this,L).setUint32(0,e,!1),this.write(r(this,k).subarray(0,4))}writeU64(e){r(this,L).setUint32(0,Math.floor(e/A(2,32)),!1),r(this,L).setUint32(4,e,!1),this.write(r(this,k).subarray(0,8))}writeAscii(e){for(let t=0;t<e.length;t++)r(this,L).setUint8(t%8,e.charCodeAt(t)),t%8===7&&this.write(r(this,k));e.length%8!==0&&this.write(r(this,k).subarray(0,e.length%8))}writeBox(e){var t,s;if(this.offsets.set(e,this.pos),e.contents&&!e.children)this.writeBoxHeader(e,(t=e.size)!=null?t:e.contents.byteLength+8),this.write(e.contents);else{let n=this.pos;if(this.writeBoxHeader(e,0),e.contents&&this.write(e.contents),e.children)for(let l of e.children)l&&this.writeBox(l);let o=this.pos,h=(s=e.size)!=null?s:o-n;this.seek(n),this.writeBoxHeader(e,h),this.seek(o)}}writeBoxHeader(e,t){this.writeU32(e.largeSize?1:t),this.writeAscii(e.type),e.largeSize&&this.writeU64(t)}patchBox(e){let t=this.pos;this.seek(this.offsets.get(e)),this.writeBox(e),this.seek(t)}};k=new WeakMap,L=new WeakMap;var j,B,R,J,ve,oe=class extends X{constructor(t){super();u(this,J);u(this,j,void 0);u(this,B,new ArrayBuffer(A(2,16)));u(this,R,new Uint8Array(r(this,B)));b(this,j,t)}write(t){m(this,J,ve).call(this,this.pos+t.byteLength),r(this,R).set(t,this.pos),this.pos+=t.byteLength}finalize(){m(this,J,ve).call(this,this.pos),r(this,j).buffer=r(this,B).slice(0,this.pos)}};j=new WeakMap,B=new WeakMap,R=new WeakMap,J=new WeakSet,ve=function(t){let s=r(this,B).byteLength;for(;s<t;)s*=2;if(s===r(this,B).byteLength)return;let n=new ArrayBuffer(s),o=new Uint8Array(n);o.set(r(this,R),0),b(this,B,n),b(this,R,o)};var N,M,Y=class extends X{constructor(t){super();u(this,N,void 0);u(this,M,[]);b(this,N,t)}write(t){r(this,M).push({data:t.slice(),start:this.pos}),this.pos+=t.byteLength}flush(){if(r(this,M).length===0)return;let t=[],s=[...r(this,M)].sort((n,o)=>n.start-o.start);t.push({start:s[0].start,size:s[0].data.byteLength});for(let n=1;n<s.length;n++){let o=t[t.length-1],h=s[n];h.start<=o.start+o.size?o.size=Math.max(o.size,h.start+h.data.byteLength-o.start):t.push({start:h.start,size:h.data.byteLength})}for(let n of t){n.data=new Uint8Array(n.size);for(let o of r(this,M))n.start<=o.start&&o.start<n.start+n.size&&n.data.set(o.data,o.start-n.start);r(this,N).onData(n.data,n.start)}r(this,M).length=0}finalize(){var t,s;(s=(t=r(this,N)).onDone)==null||s.call(t)}};N=new WeakMap,M=new WeakMap;var Ct=A(2,24),gt=2,V,g,T,Q,Se,le,_e,ue,Fe,H,ae,Z=class extends X{constructor(t){var s,n;super();u(this,Q);u(this,le);u(this,ue);u(this,H);u(this,V,void 0);u(this,g,void 0);u(this,T,[]);if(b(this,V,t),b(this,g,(n=(s=t.options)==null?void 0:s.chunkSize)!=null?n:Ct),!Number.isInteger(r(this,g))||r(this,g)<A(2,10))throw new Error("Invalid StreamTarget options: chunkSize must be an integer not smaller than 1024.")}write(t){m(this,Q,Se).call(this,t,this.pos),m(this,H,ae).call(this),this.pos+=t.byteLength}finalize(){var t,s;m(this,H,ae).call(this,!0),(s=(t=r(this,V)).onDone)==null||s.call(t)}};V=new WeakMap,g=new WeakMap,T=new WeakMap,Q=new WeakSet,Se=function(t,s){let n=r(this,T).findIndex(C=>C.start<=s&&s<C.start+r(this,g));n===-1&&(n=m(this,ue,Fe).call(this,s));let o=r(this,T)[n],h=s-o.start,l=t.subarray(0,Math.min(r(this,g)-h,t.byteLength));o.data.set(l,h);let _={start:h,end:h+l.byteLength};if(m(this,le,_e).call(this,o,_),o.written[0].start===0&&o.written[0].end===r(this,g)&&(o.shouldFlush=!0),r(this,T).length>gt){for(let C=0;C<r(this,T).length-1;C++)r(this,T)[C].shouldFlush=!0;m(this,H,ae).call(this)}l.byteLength<t.byteLength&&m(this,Q,Se).call(this,t.subarray(l.byteLength),s+l.byteLength)},le=new WeakSet,_e=function(t,s){let n=0,o=t.written.length-1,h=-1;for(;n<=o;){let l=Math.floor(n+(o-n+1)/2);t.written[l].start<=s.start?(n=l+1,h=l):o=l-1}for(t.written.splice(h+1,0,s),(h===-1||t.written[h].end<s.start)&&h++;h<t.written.length-1&&t.written[h].end>=t.written[h+1].start;)t.written[h].end=Math.max(t.written[h].end,t.written[h+1].end),t.written.splice(h+1,1)},ue=new WeakSet,Fe=function(t){let n={start:Math.floor(t/r(this,g))*r(this,g),data:new Uint8Array(r(this,g)),written:[],shouldFlush:!1};return r(this,T).push(n),r(this,T).sort((o,h)=>o.start-h.start),r(this,T).indexOf(n)},H=new WeakSet,ae=function(t=!1){for(let s=0;s<r(this,T).length;s++){let n=r(this,T)[s];if(!(!n.shouldFlush&&!t)){for(let o of n.written)r(this,V).onData(n.data.subarray(o.start,o.end),n.start+o.start);r(this,T).splice(s--,1)}}};var he=class extends Z{constructor(e){var t;super(new P((s,n)=>e.stream.write({type:"write",data:s,position:n}),void 0,{chunkSize:(t=e.options)==null?void 0:t.chunkSize}))}};var ne=1e3,xt=2082844800,vt=.5,St=["avc","hevc"],At=["aac"],Ut=["strict","offset"],c,p,E,z,D,ce,ee,pe,Re,be,Ne,ye,Ve,Te,He,te,Ae,we,We,W,de,$,me,ie,Ue,fe=class{constructor(e){u(this,pe);u(this,be);u(this,ye);u(this,Te);u(this,te);u(this,we);u(this,W);u(this,$);u(this,ie);u(this,c,void 0);u(this,p,void 0);u(this,E,void 0);u(this,z,null);u(this,D,null);u(this,ce,Math.floor(Date.now()/1e3)+xt);u(this,ee,!1);var t;if(m(this,pe,Re).call(this,e),this.target=e.target,b(this,c,Ee({firstTimestampBehavior:"strict"},e)),e.target instanceof G)b(this,p,new oe(e.target));else if(e.target instanceof P)b(this,p,(t=e.target.options)!=null&&t.chunked?new Z(e.target):new Y(e.target));else if(e.target instanceof K)b(this,p,new he(e.target));else throw new Error(`Invalid target: ${e.target}`);m(this,be,Ne).call(this),m(this,ye,Ve).call(this)}addVideoChunk(e,t,s){let n=new Uint8Array(e.byteLength);e.copyTo(n),this.addVideoChunkRaw(n,e.type,s!=null?s:e.timestamp,e.duration,t)}addVideoChunkRaw(e,t,s,n,o){if(m(this,ie,Ue).call(this),!r(this,c).video)throw new Error("No video track declared.");m(this,te,Ae).call(this,r(this,z),e,t,s,n,o)}addAudioChunk(e,t,s){let n=new Uint8Array(e.byteLength);e.copyTo(n),this.addAudioChunkRaw(n,e.type,s!=null?s:e.timestamp,e.duration,t)}addAudioChunkRaw(e,t,s,n,o){if(m(this,ie,Ue).call(this),!r(this,c).audio)throw new Error("No audio track declared.");m(this,te,Ae).call(this,r(this,D),e,t,s,n,o)}finalize(){r(this,z)&&m(this,W,de).call(this,r(this,z)),r(this,D)&&m(this,W,de).call(this,r(this,D));let e=r(this,p).offsets.get(r(this,E)),t=r(this,p).pos-e;r(this,E).size=t,r(this,p).patchBox(r(this,E));let s=Le([r(this,z),r(this,D)].filter(Boolean),r(this,ce));r(this,p).writeBox(s),m(this,$,me).call(this),r(this,p).finalize(),b(this,ee,!0)}};c=new WeakMap,p=new WeakMap,E=new WeakMap,z=new WeakMap,D=new WeakMap,ce=new WeakMap,ee=new WeakMap,pe=new WeakSet,Re=function(e){if(e.video&&!St.includes(e.video.codec))throw new Error(`Unsupported video codec: ${e.video.codec}`);if(e.audio&&!At.includes(e.audio.codec))throw new Error(`Unsupported audio codec: ${e.audio.codec}`);if(e.firstTimestampBehavior&&!Ut.includes(e.firstTimestampBehavior))throw new Error(`Invalid first timestamp behavior: ${e.firstTimestampBehavior}`)},be=new WeakSet,Ne=function(){var t;let e=((t=r(this,c).video)==null?void 0:t.codec)==="hevc";r(this,p).writeBox(Oe(e)),b(this,E,Pe()),r(this,p).writeBox(r(this,E)),m(this,$,me).call(this)},ye=new WeakSet,Ve=function(){if(r(this,c).video&&b(this,z,{id:1,info:{type:"video",codec:r(this,c).video.codec,width:r(this,c).video.width,height:r(this,c).video.height},timescale:720,codecPrivate:new Uint8Array(0),samples:[],writtenChunks:[],currentChunk:null,firstTimestamp:void 0,lastTimestamp:-1,timeToSampleTable:[],lastTimescaleUnits:null,compactlyCodedChunkTable:[]}),r(this,c).audio){let e=m(this,Te,He).call(this,2,r(this,c).audio.sampleRate,r(this,c).audio.numberOfChannels);b(this,D,{id:r(this,c).video?2:1,info:{type:"audio",codec:r(this,c).audio.codec,numberOfChannels:r(this,c).audio.numberOfChannels,sampleRate:r(this,c).audio.sampleRate},timescale:r(this,c).audio.sampleRate,codecPrivate:e,samples:[],writtenChunks:[],currentChunk:null,firstTimestamp:void 0,lastTimestamp:-1,timeToSampleTable:[],lastTimescaleUnits:null,compactlyCodedChunkTable:[]})}},Te=new WeakSet,He=function(e,t,s){let o=[96e3,88200,64e3,48e3,44100,32e3,24e3,22050,16e3,12e3,11025,8e3,7350].indexOf(t),h=s,l="";l+=e.toString(2).padStart(5,"0"),l+=o.toString(2).padStart(4,"0"),o===15&&(l+=t.toString(2).padStart(24,"0")),l+=h.toString(2).padStart(4,"0");let _=Math.ceil(l.length/8)*8;l=l.padEnd(_,"0");let C=new Uint8Array(l.length/8);for(let I=0;I<l.length;I+=8)C[I/8]=parseInt(l.slice(I,I+8),2);return C},te=new WeakSet,Ae=function(e,t,s,n,o,h){var C;let l=n/1e6,_=o/1e6;if(e.firstTimestamp===void 0&&(e.firstTimestamp=l),l=m(this,we,We).call(this,l,e),e.lastTimestamp=l,(!e.currentChunk||l-e.currentChunk.startTimestamp>=vt)&&(e.currentChunk&&m(this,W,de).call(this,e),e.currentChunk={startTimestamp:l,sampleData:[],sampleCount:0}),e.currentChunk.sampleData.push(t),e.currentChunk.sampleCount++,(C=h==null?void 0:h.decoderConfig)!=null&&C.description&&(e.codecPrivate=new Uint8Array(h.decoderConfig.description)),e.samples.push({timestamp:l,duration:_,size:t.byteLength,type:s}),e.lastTimescaleUnits!==null){let I=O(l,e.timescale,!1),re=Math.round(I-e.lastTimescaleUnits);e.lastTimescaleUnits+=re;let F=U(e.timeToSampleTable);F.sampleCount===1?(F.sampleDelta=re,F.sampleCount++):F.sampleDelta===re?F.sampleCount++:(F.sampleCount--,e.timeToSampleTable.push({sampleCount:2,sampleDelta:re}))}else e.lastTimescaleUnits=0,e.timeToSampleTable.push({sampleCount:1,sampleDelta:O(_,e.timescale)})},we=new WeakSet,We=function(e,t){if(r(this,c).firstTimestampBehavior==="strict"&&t.lastTimestamp===-1&&e!==0)throw new Error(`The first chunk for your media track must have a timestamp of 0 (received ${e}). Non-zero first timestamps are often caused by directly piping frames or audio data from a MediaStreamTrack into the encoder. Their timestamps are typically relative to the age of the document, which is probably what you want.

If you want to offset all timestamps of a track such that the first one is zero, set firstTimestampBehavior: 'offset' in the options.
`);if(r(this,c).firstTimestampBehavior==="offset"&&(e-=t.firstTimestamp),e<t.lastTimestamp)throw new Error(`Timestamps must be monotonically increasing (went from ${t.lastTimestamp*1e6} to ${e*1e6}).`);return e},W=new WeakSet,de=function(e){if(e.currentChunk){e.currentChunk.offset=r(this,p).pos;for(let t of e.currentChunk.sampleData)r(this,p).write(t);e.currentChunk.sampleData=null,(e.compactlyCodedChunkTable.length===0||U(e.compactlyCodedChunkTable).samplesPerChunk!==e.currentChunk.sampleCount)&&e.compactlyCodedChunkTable.push({firstChunk:e.writtenChunks.length+1,samplesPerChunk:e.currentChunk.sampleCount}),e.writtenChunks.push(e.currentChunk),m(this,$,me).call(this)}},$=new WeakSet,me=function(){r(this,p)instanceof Y&&r(this,p).flush()},ie=new WeakSet,Ue=function(){if(r(this,ee))throw new Error("Cannot add new video or audio chunks after the file has been finalized.")};return Ye(kt);})();
if (typeof module === "object" && typeof module.exports === "object") {
	module.exports.Muxer = Mp4Muxer.Muxer;
	module.exports.ArrayBufferTarget = Mp4Muxer.ArrayBufferTarget;
	module.exports.StreamTarget = Mp4Muxer.StreamTarget;
	module.exports.FileSystemWritableFileStreamTarget = Mp4Muxer.FileSystemWritableFileStreamTarget;
}
