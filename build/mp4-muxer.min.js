"use strict";var Mp4Muxer=(()=>{var V=Object.defineProperty;var wt=Object.getOwnPropertyDescriptor;var bt=Object.getOwnPropertyNames,st=Object.getOwnPropertySymbols;var rt=Object.prototype.hasOwnProperty,yt=Object.prototype.propertyIsEnumerable;var R=Math.pow,it=(e,t,s)=>t in e?V(e,t,{enumerable:!0,configurable:!0,writable:!0,value:s}):e[t]=s,nt=(e,t)=>{for(var s in t||={})rt.call(t,s)&&it(e,s,t[s]);if(st)for(var s of st(t))yt.call(t,s)&&it(e,s,t[s]);return e};var xt=(e,t)=>{for(var s in t)V(e,s,{get:t[s],enumerable:!0})},Ct=(e,t,s,r)=>{if(t&&typeof t=="object"||typeof t=="function")for(let n of bt(t))!rt.call(e,n)&&n!==s&&V(e,n,{get:()=>t[n],enumerable:!(r=wt(t,n))||r.enumerable});return e};var gt=e=>Ct(V({},"__esModule",{value:!0}),e);var q=(e,t,s)=>{if(!t.has(e))throw TypeError("Cannot "+s)};var i=(e,t,s)=>(q(e,t,"read from private field"),s?s.call(e):t.get(e)),h=(e,t,s)=>{if(t.has(e))throw TypeError("Cannot add the same private member more than once");t instanceof WeakSet?t.add(e):t.set(e,s)},w=(e,t,s,r)=>(q(e,t,"write to private field"),r?r.call(e,s):t.set(e,s),s);var b=(e,t,s)=>(q(e,t,"access private method"),s);var qt={};xt(qt,{GLOBAL_TIMESCALE:()=>L,default:()=>jt});var m=e=>{let t=new Uint8Array(2);return new DataView(t.buffer).setUint16(0,e,!1),[...t]},at=e=>{let t=new Uint8Array(2);return new DataView(t.buffer).setInt16(0,e,!1),[...t]},ot=e=>{let t=new Uint8Array(4);return new DataView(t.buffer).setUint32(0,e,!1),[...t].slice(1)},o=e=>{let t=new Uint8Array(4);return new DataView(t.buffer).setUint32(0,e,!1),[...t]},J=e=>{let t=new Uint8Array(2),s=new DataView(t.buffer);return s.setUint8(0,e),s.setUint8(1,e<<8),[...t]},E=e=>{let t=new Uint8Array(4),s=new DataView(t.buffer);return s.setUint16(0,e,!1),s.setUint16(2,e<<16,!1),[...t]},x=(e,t=!1)=>{let s=Array(e.length).fill(null).map((r,n)=>e.charCodeAt(n));return t&&s.push(0),s},U=(e,t)=>Math.round(e*t),z=e=>e&&e[e.length-1];var ht=[65536,0,0,0,65536,0,0,0,1073741824].map(o),y=(e,t,s)=>({type:e,contents:t&&new Uint8Array(t.flat(10)),children:s}),f=(e,t,s,r,n)=>y(e,[t,ot(s),r!=null?r:[]],n),lt=()=>y("ftyp",[x("isom"),o(0),x("isom"),x("avc1"),x("mp41")]),ut=()=>({type:"mdat",largeSize:!0}),mt=(e,t)=>y("moov",null,[At(t,e),...e.map(s=>vt(s,t))]),At=(e,t)=>{let s=U(Math.max(...t.map(n=>z(n.samples).timestamp+z(n.samples).duration)),L),r=Math.max(...t.map(n=>n.id))+1;return f("mvhd",0,0,[o(e),o(e),o(L),o(s),E(1),J(1),Array(10).fill(0),ht,Array(24).fill(0),o(r)])},vt=(e,t)=>y("trak",null,[kt(e,t),Tt(e,t)]),kt=(e,t)=>{let s=z(e.samples),r=U(s.timestamp+s.duration,L);return f("tkhd",0,3,[o(t),o(t),o(e.id),o(0),o(r),Array(8).fill(0),0,0,0,0,J(e.info.type==="audio"?1:0),0,0,ht,E(e.info.type==="video"?e.info.width:0),E(e.info.type==="video"?e.info.height:0)])},Tt=(e,t)=>y("mdia",null,[Ut(e,t),Bt(e.info.type==="video"?"vide":"soun"),St(e)]),Ut=(e,t)=>{let s=z(e.samples),r=U(s.timestamp+s.duration,e.timescale);return f("mdhd",0,0,[o(t),o(t),o(e.timescale),o(r),85,196,m(0)])},Bt=e=>f("hdlr",0,0,[x("mhlr"),x(e),o(0),o(0),o(0),x("mp4-muxer-hdlr")]),St=e=>y("minf",null,[e.info.type==="video"?zt():Ft(),Mt(),Lt(e)]),zt=()=>f("vmhd",0,1,[m(0),m(0),m(0),m(0)]),Ft=()=>f("smhd",0,0,[0,0,0,0]),Mt=()=>y("dinf",null,[Dt()]),Dt=()=>f("dref",0,0,[o(1)],[Et()]),Et=()=>f("url ",0,1),Lt=e=>y("stbl",null,[It(e),Vt(e),Rt(e),Ht(e),Wt(e),Gt(e)]),It=e=>f("stsd",0,0,[o(1)],[e.info.type==="video"?Pt(e):Nt(e)]),Pt=e=>y("avc1",[Array(6).fill(0),0,1,0,0,0,0,Array(12).fill(0),m(e.info.width),m(e.info.height),o(4718592),o(4718592),o(0),m(1),Array(32).fill(0),m(24),at(65535)],[_t(e)]),_t=e=>y("avcC",[...e.codecPrivate]),Nt=e=>y("mp4a",[Array(6).fill(0),m(1),m(0),m(0),o(0),m(e.info.numberOfChannels),m(e.info.bitDepth),m(0),m(0),E(e.info.sampleRate)],[Ot(e)]),Ot=e=>f("esds",0,0,[o(58753152),34,m(1),0,o(75530368),20,64,21,0,0,0,o(130071),o(130071),o(92307584),2,e.codecPrivate[0],e.codecPrivate[1],o(109084800),1,2]),Vt=e=>{var r,n;let t=[],s=[];for(let a of e.samples){if(t.push(a),t.length===1)continue;let l=U(t[1].timestamp-t[0].timestamp,e.timescale);U(a.timestamp-t[t.length-2].timestamp,e.timescale)!==l&&(s.push({sampleCount:t.length-1,sampleDelta:l}),t=t.slice(-2))}return s.push({sampleCount:t.length,sampleDelta:U(((n=(r=t[1])==null?void 0:r.timestamp)!=null?n:t[0].timestamp)-t[0].timestamp,e.timescale)}),f("stts",0,0,[o(s.length),s.map(a=>[o(a.sampleCount),o(a.sampleDelta)])])},Rt=e=>{if(e.samples.every(s=>s.type==="key"))return null;let t=[...e.samples.entries()].filter(([,s])=>s.type==="key");return f("stss",0,0,[o(t.length),t.map(([s])=>o(s+1))])},Ht=e=>{let t=[];for(let s=0;s<e.writtenChunks.length;s++){let r=e.writtenChunks[s];(t.length===0||z(t).samplesPerChunk!==r.sampleCount)&&t.push({firstChunk:s+1,samplesPerChunk:r.sampleCount})}return f("stsc",0,0,[o(t.length),t.map(s=>[o(s.firstChunk),o(s.samplesPerChunk),o(1)])])},Wt=e=>f("stsz",0,0,[o(0),o(e.samples.length),e.samples.map(t=>o(t.size))]),Gt=e=>f("stco",0,0,[o(e.writtenChunks.length),e.writtenChunks.map(t=>o(t.offset))]);var C,B,I=class{constructor(){this.pos=0;h(this,C,new Uint8Array(8));h(this,B,new DataView(i(this,C).buffer));this.offsets=new WeakMap}writeU32(t){i(this,B).setUint32(0,t,!1),this.write(i(this,C).subarray(0,4))}writeU64(t){i(this,B).setUint32(0,Math.floor(t/R(2,32)),!1),i(this,B).setUint32(4,t,!1),this.write(i(this,C).subarray(0,8))}writeAscii(t){for(let s=0;s<t.length;s++)i(this,B).setUint8(s%8,t.charCodeAt(s)),s%8===7&&this.write(i(this,C));t.length%8!==0&&this.write(i(this,C).subarray(0,t.length%8))}writeBox(t){var s,r;if(this.offsets.set(t,this.pos),t.contents&&!t.children)this.writeBoxHeader(t,(s=t.size)!=null?s:t.contents.byteLength+8),this.write(t.contents);else{let n=this.pos;if(this.writeBoxHeader(t,0),t.contents&&this.write(t.contents),t.children)for(let u of t.children)u&&this.writeBox(u);let a=this.pos,l=(r=t.size)!=null?r:a-n;this.pos=n,this.writeBoxHeader(t,l),this.pos=a}}writeBoxHeader(t,s){this.writeU32(t.largeSize?1:s),this.writeAscii(t.type),t.largeSize&&this.writeU64(s)}patchBox(t){let s=this.pos;this.pos=this.offsets.get(t),this.writeBox(t),this.pos=s}};C=new WeakMap,B=new WeakMap;var g,M,H=class extends I{constructor(){super();h(this,g,new ArrayBuffer(R(2,16)));h(this,M,new Uint8Array(i(this,g)))}ensureSize(s){let r=i(this,g).byteLength;for(;r<s;)r*=2;if(r===i(this,g).byteLength)return;let n=new ArrayBuffer(r),a=new Uint8Array(n);a.set(i(this,M),0),w(this,g,n),w(this,M,a)}write(s){this.ensureSize(this.pos+s.byteLength),i(this,M).set(s,this.pos),this.pos+=s.byteLength}seek(s){this.pos=s}finalize(){return this.ensureSize(this.pos),i(this,g).slice(0,this.pos)}};g=new WeakMap,M=new WeakMap;var F=R(2,24),Kt=2,P,c,W=class extends I{constructor(s){super();h(this,P,void 0);h(this,c,[]);w(this,P,s)}write(s){this.writeDataIntoChunks(s,this.pos),this.flushChunks(),this.pos+=s.byteLength}writeDataIntoChunks(s,r){let n=i(this,c).findIndex(S=>S.start<=r&&r<S.start+F);n===-1&&(n=this.createChunk(r));let a=i(this,c)[n],l=r-a.start,u=s.subarray(0,Math.min(F-l,s.byteLength));a.data.set(u,l);let ct={start:l,end:l+u.byteLength};if(Xt(a,ct),a.written[0].start===0&&a.written[0].end===F&&(a.shouldFlush=!0),i(this,c).length>Kt){for(let S=0;S<i(this,c).length-1;S++)i(this,c)[S].shouldFlush=!0;this.flushChunks()}u.byteLength<s.byteLength&&this.writeDataIntoChunks(s.subarray(u.byteLength),r+u.byteLength)}createChunk(s){let n={start:Math.floor(s/F)*F,data:new Uint8Array(F),written:[],shouldFlush:!1};return i(this,c).push(n),i(this,c).sort((a,l)=>a.start-l.start),i(this,c).indexOf(n)}flushChunks(s=!1){for(let r=0;r<i(this,c).length;r++){let n=i(this,c)[r];if(!(!n.shouldFlush&&!s)){for(let a of n.written)i(this,P).write({type:"write",data:n.data.subarray(a.start,a.end),position:n.start+a.start});i(this,c).splice(r--,1)}}}seek(s){this.pos=s}finalize(){this.flushChunks(!0)}};P=new WeakMap,c=new WeakMap;var Xt=(e,t)=>{let s=0,r=e.written.length-1,n=-1;for(;s<=r;){let a=Math.floor(s+(r-s+1)/2);e.written[a].start<=t.start?(s=a+1,n=a):r=a-1}for(e.written.splice(n+1,0,t),(n===-1||e.written[n].end<t.start)&&n++;n<e.written.length-1&&e.written[n].end>=e.written[n+1].start;)e.written[n].end=Math.max(e.written[n].end,e.written[n+1].end),e.written.splice(n+1,1)},A,_,G=class extends I{constructor(s){super();h(this,A,[]);h(this,_,void 0);w(this,_,s)}write(s){i(this,A).push({data:s.slice(),start:this.pos}),this.pos+=s.byteLength}seek(s){this.pos=s}flush(s){if(i(this,A).length===0)return;let r=[],n=[...i(this,A)].sort((a,l)=>a.start-l.start);r.push({start:n[0].start,size:n[0].data.byteLength});for(let a=1;a<n.length;a++){let l=r[r.length-1],u=n[a];u.start<=l.start+l.size?l.size=Math.max(l.size,u.start+u.data.byteLength-l.start):r.push({start:u.start,size:u.data.byteLength})}for(let a of r){a.data=new Uint8Array(a.size);for(let u of i(this,A))a.start<=u.start&&u.start<a.start+a.size&&a.data.set(u.data,u.start-a.start);let l=s&&a===r[r.length-1];i(this,_).call(this,a.data,a.start,l)}i(this,A).length=0}};A=new WeakMap,_=new WeakMap;var $t=2082848400,Yt=5e5,Zt=["strict","offset","permissive"],L=1e3,p,d,v,k,T,X,$,Y,ft,Z,pt,j,dt,N,tt,D,K,O,et,Q=class{constructor(t){h(this,Y);h(this,Z);h(this,j);h(this,N);h(this,D);h(this,O);h(this,p,void 0);h(this,d,void 0);h(this,v,void 0);h(this,k,null);h(this,T,null);h(this,X,Math.floor(Date.now()/1e3)+$t);h(this,$,!1);if(b(this,Y,ft).call(this,t),w(this,p,nt({firstTimestampBehavior:"strict"},t)),t.target==="buffer")w(this,d,new H);else if(t.target instanceof FileSystemWritableFileStream)w(this,d,new W(t.target));else if(typeof t.target=="function")w(this,d,new G(t.target));else throw new Error(`Invalid target: ${t.target}`);b(this,Z,pt).call(this),b(this,j,dt).call(this)}addVideoChunk(t,s){if(b(this,O,et).call(this),!i(this,p).video)throw new Error("No video track declared.");b(this,N,tt).call(this,i(this,k),t,s)}addAudioChunk(t,s){if(b(this,O,et).call(this),!i(this,p).audio)throw new Error("No audio track declared.");b(this,N,tt).call(this,i(this,T),t,s)}finalize(){i(this,k)&&b(this,D,K).call(this,i(this,k)),i(this,T)&&b(this,D,K).call(this,i(this,T));let t=i(this,d).offsets.get(i(this,v)),s=i(this,d).pos-t;i(this,v).size=s,i(this,d).patchBox(i(this,v));let r=mt([i(this,k),i(this,T)].filter(Boolean),i(this,X));return i(this,d).writeBox(r),i(this,d).finalize()}};p=new WeakMap,d=new WeakMap,v=new WeakMap,k=new WeakMap,T=new WeakMap,X=new WeakMap,$=new WeakMap,Y=new WeakSet,ft=function(t){if(t.firstTimestampBehavior&&!Zt.includes(t.firstTimestampBehavior))throw new Error(`Invalid first timestamp behavior: ${t.firstTimestampBehavior}`)},Z=new WeakSet,pt=function(){i(this,d).writeBox(lt()),w(this,v,ut()),i(this,d).writeBox(i(this,v))},j=new WeakSet,dt=function(){var t;i(this,p).video&&w(this,k,{id:1,info:{type:"video",width:i(this,p).video.width,height:i(this,p).video.height},timescale:720,codecPrivate:null,samples:[],writtenChunks:[],currentChunk:null}),i(this,p).audio&&w(this,T,{id:i(this,p).video?2:1,info:{type:"audio",numberOfChannels:i(this,p).audio.numberOfChannels,sampleRate:i(this,p).audio.sampleRate,bitDepth:(t=i(this,p).audio.bitDepth)!=null?t:16},timescale:i(this,p).audio.sampleRate,codecPrivate:null,samples:[],writtenChunks:[],currentChunk:null})},N=new WeakSet,tt=function(t,s,r){var a;(!t.currentChunk||s.timestamp-t.currentChunk.startTimestamp>=Yt)&&(t.currentChunk&&b(this,D,K).call(this,t),t.currentChunk={startTimestamp:s.timestamp,sampleData:[],sampleCount:0});let n=new Uint8Array(s.byteLength);s.copyTo(n),t.currentChunk.sampleData.push(n),t.currentChunk.sampleCount++,(a=r.decoderConfig)!=null&&a.description&&(t.codecPrivate=new Uint8Array(r.decoderConfig.description)),t.samples.push({timestamp:s.timestamp/1e6,duration:s.duration/1e6,size:n.byteLength,type:s.type})},D=new WeakSet,K=function(t){if(t.currentChunk){t.currentChunk.offset=i(this,d).pos;for(let s of t.currentChunk.sampleData)i(this,d).write(s);t.currentChunk.sampleData=null,t.writtenChunks.push(t.currentChunk)}},O=new WeakSet,et=function(){if(i(this,$))throw new Error("Cannot add new video or audio chunks after the file has been finalized.")};var jt=Q;return gt(qt);})();
Mp4Muxer = Mp4Muxer.default;
if (typeof module === "object" && typeof module.exports === "object") module.exports = Mp4Muxer;
