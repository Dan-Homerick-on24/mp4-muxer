"use strict";var Mp4Muxer=(()=>{var se=Object.defineProperty;var Xe=Object.getOwnPropertyDescriptor;var $e=Object.getOwnPropertyNames,Oe=Object.getOwnPropertySymbols;var Ee=Object.prototype.hasOwnProperty,Ge=Object.prototype.propertyIsEnumerable;var A=Math.pow,ke=(t,e,r)=>e in t?se(t,e,{enumerable:!0,configurable:!0,writable:!0,value:r}):t[e]=r,De=(t,e)=>{for(var r in e||={})Ee.call(e,r)&&ke(t,r,e[r]);if(Oe)for(var r of Oe(e))Ge.call(e,r)&&ke(t,r,e[r]);return t};var qe=(t,e)=>{for(var r in e)se(t,r,{get:e[r],enumerable:!0})},Ke=(t,e,r,s)=>{if(e&&typeof e=="object"||typeof e=="function")for(let n of $e(e))!Ee.call(t,n)&&n!==r&&se(t,n,{get:()=>e[n],enumerable:!(s=Xe(e,n))||s.enumerable});return t};var Ye=t=>Ke(se({},"__esModule",{value:!0}),t);var ge=(t,e,r)=>{if(!e.has(t))throw TypeError("Cannot "+r)};var i=(t,e,r)=>(ge(t,e,"read from private field"),r?r.call(t):e.get(t)),u=(t,e,r)=>{if(e.has(t))throw TypeError("Cannot add the same private member more than once");e instanceof WeakSet?e.add(t):e.set(t,r)},T=(t,e,r,s)=>(ge(t,e,"write to private field"),s?s.call(t,r):e.set(t,r),r);var m=(t,e,r)=>(ge(t,e,"access private method"),r);var Pt={};qe(Pt,{ArrayBufferTarget:()=>G,FileSystemWritableFileStreamTarget:()=>q,Muxer:()=>pe,StreamTarget:()=>M});var c=new Uint8Array(8),S=new DataView(c.buffer),w=t=>[(t%256+256)%256],d=t=>(S.setUint16(0,t,!1),[c[0],c[1]]),Be=t=>(S.setInt16(0,t,!1),[c[0],c[1]]),xe=t=>(S.setUint32(0,t,!1),[c[1],c[2],c[3]]),a=t=>(S.setUint32(0,t,!1),[c[0],c[1],c[2],c[3]]),_e=t=>(S.setUint32(0,Math.floor(t/A(2,32)),!1),S.setUint32(4,t,!1),[c[0],c[1],c[2],c[3],c[4],c[5],c[6],c[7]]),ne=t=>(S.setUint8(0,t),S.setUint8(1,t<<8),[c[0],c[1]]),$=t=>(S.setUint16(0,t,!1),S.setUint16(2,t<<16,!1),[c[0],c[1],c[2],c[3]]),v=(t,e=!1)=>{let r=Array(t.length).fill(null).map((s,n)=>t.charCodeAt(n));return e&&r.push(0),r},U=t=>t&&t[t.length-1],P=(t,e,r=!0)=>{let s=t*e;return r?Math.round(s):s};var Ie=[65536,0,0,0,65536,0,0,0,1073741824].map(a),b=(t,e,r)=>({type:t,contents:e&&new Uint8Array(e.flat(10)),children:r}),y=(t,e,r,s,n)=>b(t,[w(e),xe(r),s!=null?s:[]],n),Pe=t=>t?b("ftyp",[v("isom"),a(0),v("iso4"),v("hvc1")]):b("ftyp",[v("isom"),a(0),v("isom"),v("avc1"),v("mp41")]),Me=()=>({type:"mdat",largeSize:!0}),ze=(t,e)=>b("moov",null,[Ze(e,t),...t.map(r=>je(r,e))]),Ze=(t,e)=>{let r=P(Math.max(0,...e.filter(n=>n.samples.length>0).map(n=>U(n.samples).timestamp+U(n.samples).duration)),ae),s=Math.max(...e.map(n=>n.id))+1;return y("mvhd",0,0,[a(t),a(t),a(ae),a(r),$(1),ne(1),Array(10).fill(0),Ie,Array(24).fill(0),a(s)])},je=(t,e)=>b("trak",null,[Je(t,e),Qe(t,e)]),Je=(t,e)=>{let r=U(t.samples),s=P(r?r.timestamp+r.duration:0,ae);return y("tkhd",0,3,[a(e),a(e),a(t.id),a(0),a(s),Array(8).fill(0),d(0),d(0),ne(t.info.type==="audio"?1:0),d(0),Ie,$(t.info.type==="video"?t.info.width:0),$(t.info.type==="video"?t.info.height:0)])},Qe=(t,e)=>b("mdia",null,[et(t,e),tt(t.info.type==="video"?"vide":"soun"),rt(t)]),et=(t,e)=>{let r=U(t.samples),s=P(r?r.timestamp+r.duration:0,t.timescale);return y("mdhd",0,0,[a(e),a(e),a(t.timescale),a(s),d(21956),d(0)])},tt=t=>y("hdlr",0,0,[v("mhlr"),v(t),a(0),a(0),a(0),v("mp4-muxer-hdlr")]),rt=t=>b("minf",null,[t.info.type==="video"?it():st(),nt(),ht(t)]),it=()=>y("vmhd",0,1,[d(0),d(0),d(0),d(0)]),st=()=>y("smhd",0,0,[d(0),d(0)]),nt=()=>b("dinf",null,[at()]),at=()=>y("dref",0,0,[a(1)],[ot()]),ot=()=>y("url ",0,1),ht=t=>b("stbl",null,[lt(t),yt(t),Ct(t),wt(t),gt(t),xt(t)]),lt=t=>y("stsd",0,0,[a(1)],[t.info.type==="video"?ut(vt[t.info.codec],t):ft(At[t.info.codec],t)]),ut=(t,e)=>b(t,[Array(6).fill(0),d(1),d(0),d(0),Array(12).fill(0),d(e.info.width),d(e.info.height),a(4718592),a(4718592),a(0),d(1),Array(32).fill(0),d(24),Be(65535)],[St[e.info.codec](e)]),dt=t=>t.codecPrivate&&b("avcC",[...t.codecPrivate]),mt=t=>t.codecPrivate&&b("hvcC",[...t.codecPrivate]),ct=t=>t.codecPrivate&&b("vpcC",[...t.codecPrivate]),pt=t=>t.codecPrivate&&b("av1C",[...t.codecPrivate]),ft=(t,e)=>b(t,[Array(6).fill(0),d(1),d(0),d(0),a(0),d(e.info.numberOfChannels),d(16),d(0),d(0),$(e.info.sampleRate)],[Ut[e.info.codec](e)]),Tt=t=>y("esds",0,0,[a(58753152),w(32+t.codecPrivate.byteLength),d(1),w(0),a(75530368),w(18+t.codecPrivate.byteLength),w(64),w(21),xe(0),a(130071),a(130071),a(92307584),w(t.codecPrivate.byteLength),...t.codecPrivate,a(109084800),w(1),w(2)]),bt=t=>b("dOps",[w(0),w(t.info.numberOfChannels),d(3840),a(t.info.sampleRate),ne(0),w(0)]),yt=t=>y("stts",0,0,[a(t.timeToSampleTable.length),t.timeToSampleTable.map(e=>[a(e.sampleCount),a(e.sampleDelta)])]),Ct=t=>{if(t.samples.every(r=>r.type==="key"))return null;let e=[...t.samples.entries()].filter(([,r])=>r.type==="key");return y("stss",0,0,[a(e.length),e.map(([r])=>a(r+1))])},wt=t=>y("stsc",0,0,[a(t.compactlyCodedChunkTable.length),t.compactlyCodedChunkTable.map(e=>[a(e.firstChunk),a(e.samplesPerChunk),a(1)])]),gt=t=>y("stsz",0,0,[a(0),a(t.samples.length),t.samples.map(e=>a(e.size))]),xt=t=>t.writtenChunks.length>0&&U(t.writtenChunks).offset>=A(2,32)?y("co64",0,0,[a(t.writtenChunks.length),t.writtenChunks.map(e=>_e(e.offset))]):y("stco",0,0,[a(t.writtenChunks.length),t.writtenChunks.map(e=>a(e.offset))]),vt={avc:"avc1",hevc:"hvc1",vp9:"vp09",av1:"av01"},St={avc:dt,hevc:mt,vp9:ct,av1:pt},At={aac:"mp4a",opus:"opus"},Ut={aac:Tt,opus:bt};var G=class{constructor(){this.buffer=null}},M=class{constructor(e,r,s){this.onData=e;this.onDone=r;this.options=s}},q=class{constructor(e,r){this.stream=e;this.options=r}};var O,z,K=class{constructor(){this.pos=0;u(this,O,new Uint8Array(8));u(this,z,new DataView(i(this,O).buffer));this.offsets=new WeakMap}seek(e){this.pos=e}writeU32(e){i(this,z).setUint32(0,e,!1),this.write(i(this,O).subarray(0,4))}writeU64(e){i(this,z).setUint32(0,Math.floor(e/A(2,32)),!1),i(this,z).setUint32(4,e,!1),this.write(i(this,O).subarray(0,8))}writeAscii(e){for(let r=0;r<e.length;r++)i(this,z).setUint8(r%8,e.charCodeAt(r)),r%8===7&&this.write(i(this,O));e.length%8!==0&&this.write(i(this,O).subarray(0,e.length%8))}writeBox(e){var r,s;if(this.offsets.set(e,this.pos),e.contents&&!e.children)this.writeBoxHeader(e,(r=e.size)!=null?r:e.contents.byteLength+8),this.write(e.contents);else{let n=this.pos;if(this.writeBoxHeader(e,0),e.contents&&this.write(e.contents),e.children)for(let l of e.children)l&&this.writeBox(l);let o=this.pos,h=(s=e.size)!=null?s:o-n;this.seek(n),this.writeBoxHeader(e,h),this.seek(o)}}writeBoxHeader(e,r){this.writeU32(e.largeSize?1:r),this.writeAscii(e.type),e.largeSize&&this.writeU64(r)}patchBox(e){let r=this.pos;this.seek(this.offsets.get(e)),this.writeBox(e),this.seek(r)}};O=new WeakMap,z=new WeakMap;var j,k,N,J,ve,he=class extends K{constructor(r){super();u(this,J);u(this,j,void 0);u(this,k,new ArrayBuffer(A(2,16)));u(this,N,new Uint8Array(i(this,k)));T(this,j,r)}write(r){m(this,J,ve).call(this,this.pos+r.byteLength),i(this,N).set(r,this.pos),this.pos+=r.byteLength}finalize(){m(this,J,ve).call(this,this.pos),i(this,j).buffer=i(this,k).slice(0,this.pos)}};j=new WeakMap,k=new WeakMap,N=new WeakMap,J=new WeakSet,ve=function(r){let s=i(this,k).byteLength;for(;s<r;)s*=2;if(s===i(this,k).byteLength)return;let n=new ArrayBuffer(s),o=new Uint8Array(n);o.set(i(this,N),0),T(this,k,n),T(this,N,o)};var F,E,Y=class extends K{constructor(r){super();u(this,F,void 0);u(this,E,[]);T(this,F,r)}write(r){i(this,E).push({data:r.slice(),start:this.pos}),this.pos+=r.byteLength}flush(){if(i(this,E).length===0)return;let r=[],s=[...i(this,E)].sort((n,o)=>n.start-o.start);r.push({start:s[0].start,size:s[0].data.byteLength});for(let n=1;n<s.length;n++){let o=r[r.length-1],h=s[n];h.start<=o.start+o.size?o.size=Math.max(o.size,h.start+h.data.byteLength-o.start):r.push({start:h.start,size:h.data.byteLength})}for(let n of r){n.data=new Uint8Array(n.size);for(let o of i(this,E))n.start<=o.start&&o.start<n.start+n.size&&n.data.set(o.data,o.start-n.start);i(this,F).onData(n.data,n.start)}i(this,E).length=0}finalize(){var r,s;(s=(r=i(this,F)).onDone)==null||s.call(r)}};F=new WeakMap,E=new WeakMap;var Ot=A(2,24),kt=2,V,x,C,Q,Se,ue,Re,de,Le,H,oe,Z=class extends K{constructor(r){var s,n;super();u(this,Q);u(this,ue);u(this,de);u(this,H);u(this,V,void 0);u(this,x,void 0);u(this,C,[]);if(T(this,V,r),T(this,x,(n=(s=r.options)==null?void 0:s.chunkSize)!=null?n:Ot),!Number.isInteger(i(this,x))||i(this,x)<A(2,10))throw new Error("Invalid StreamTarget options: chunkSize must be an integer not smaller than 1024.")}write(r){m(this,Q,Se).call(this,r,this.pos),m(this,H,oe).call(this),this.pos+=r.byteLength}finalize(){var r,s;m(this,H,oe).call(this,!0),(s=(r=i(this,V)).onDone)==null||s.call(r)}};V=new WeakMap,x=new WeakMap,C=new WeakMap,Q=new WeakSet,Se=function(r,s){let n=i(this,C).findIndex(g=>g.start<=s&&s<g.start+i(this,x));n===-1&&(n=m(this,de,Le).call(this,s));let o=i(this,C)[n],h=s-o.start,l=r.subarray(0,Math.min(i(this,x)-h,r.byteLength));o.data.set(l,h);let R={start:h,end:h+l.byteLength};if(m(this,ue,Re).call(this,o,R),o.written[0].start===0&&o.written[0].end===i(this,x)&&(o.shouldFlush=!0),i(this,C).length>kt){for(let g=0;g<i(this,C).length-1;g++)i(this,C)[g].shouldFlush=!0;m(this,H,oe).call(this)}l.byteLength<r.byteLength&&m(this,Q,Se).call(this,r.subarray(l.byteLength),s+l.byteLength)},ue=new WeakSet,Re=function(r,s){let n=0,o=r.written.length-1,h=-1;for(;n<=o;){let l=Math.floor(n+(o-n+1)/2);r.written[l].start<=s.start?(n=l+1,h=l):o=l-1}for(r.written.splice(h+1,0,s),(h===-1||r.written[h].end<s.start)&&h++;h<r.written.length-1&&r.written[h].end>=r.written[h+1].start;)r.written[h].end=Math.max(r.written[h].end,r.written[h+1].end),r.written.splice(h+1,1)},de=new WeakSet,Le=function(r){let n={start:Math.floor(r/i(this,x))*i(this,x),data:new Uint8Array(i(this,x)),written:[],shouldFlush:!1};return i(this,C).push(n),i(this,C).sort((o,h)=>o.start-h.start),i(this,C).indexOf(n)},H=new WeakSet,oe=function(r=!1){for(let s=0;s<i(this,C).length;s++){let n=i(this,C)[s];if(!(!n.shouldFlush&&!r)){for(let o of n.written)i(this,V).onData(n.data.subarray(o.start,o.end),n.start+o.start);i(this,C).splice(s--,1)}}};var le=class extends Z{constructor(e){var r;super(new M((s,n)=>e.stream.write({type:"write",data:s,position:n}),void 0,{chunkSize:(r=e.options)==null?void 0:r.chunkSize}))}};var ae=1e3,Et=["avc","hevc","vp9","av1"],Dt=["aac","opus"],Bt=2082844800,_t=.5,It=["strict","offset"],p,f,D,B,_,fe,ee,Te,Ne,be,Fe,ye,Ve,Ce,He,te,Ae,we,We,W,me,X,ce,re,Ue,pe=class{constructor(e){u(this,Te);u(this,be);u(this,ye);u(this,Ce);u(this,te);u(this,we);u(this,W);u(this,X);u(this,re);u(this,p,void 0);u(this,f,void 0);u(this,D,void 0);u(this,B,null);u(this,_,null);u(this,fe,Math.floor(Date.now()/1e3)+Bt);u(this,ee,!1);var r;if(m(this,Te,Ne).call(this,e),this.target=e.target,T(this,p,De({firstTimestampBehavior:"strict"},e)),e.target instanceof G)T(this,f,new he(e.target));else if(e.target instanceof M)T(this,f,(r=e.target.options)!=null&&r.chunked?new Z(e.target):new Y(e.target));else if(e.target instanceof q)T(this,f,new le(e.target));else throw new Error(`Invalid target: ${e.target}`);m(this,be,Fe).call(this),m(this,ye,Ve).call(this)}addVideoChunk(e,r,s){let n=new Uint8Array(e.byteLength);e.copyTo(n),this.addVideoChunkRaw(n,e.type,s!=null?s:e.timestamp,e.duration,r)}addVideoChunkRaw(e,r,s,n,o){if(m(this,re,Ue).call(this),!i(this,p).video)throw new Error("No video track declared.");m(this,te,Ae).call(this,i(this,B),e,r,s,n,o)}addAudioChunk(e,r,s){let n=new Uint8Array(e.byteLength);e.copyTo(n),this.addAudioChunkRaw(n,e.type,s!=null?s:e.timestamp,e.duration,r)}addAudioChunkRaw(e,r,s,n,o){if(m(this,re,Ue).call(this),!i(this,p).audio)throw new Error("No audio track declared.");m(this,te,Ae).call(this,i(this,_),e,r,s,n,o)}finalize(){i(this,B)&&m(this,W,me).call(this,i(this,B)),i(this,_)&&m(this,W,me).call(this,i(this,_));let e=i(this,f).offsets.get(i(this,D)),r=i(this,f).pos-e;i(this,D).size=r,i(this,f).patchBox(i(this,D));let s=ze([i(this,B),i(this,_)].filter(Boolean),i(this,fe));i(this,f).writeBox(s),m(this,X,ce).call(this),i(this,f).finalize(),T(this,ee,!0)}};p=new WeakMap,f=new WeakMap,D=new WeakMap,B=new WeakMap,_=new WeakMap,fe=new WeakMap,ee=new WeakMap,Te=new WeakSet,Ne=function(e){if(e.video&&!Et.includes(e.video.codec))throw new Error(`Unsupported video codec: ${e.video.codec}`);if(e.audio&&!Dt.includes(e.audio.codec))throw new Error(`Unsupported audio codec: ${e.audio.codec}`);if(e.firstTimestampBehavior&&!It.includes(e.firstTimestampBehavior))throw new Error(`Invalid first timestamp behavior: ${e.firstTimestampBehavior}`)},be=new WeakSet,Fe=function(){var r;let e=((r=i(this,p).video)==null?void 0:r.codec)==="hevc";i(this,f).writeBox(Pe(e)),T(this,D,Me()),i(this,f).writeBox(i(this,D)),m(this,X,ce).call(this)},ye=new WeakSet,Ve=function(){if(i(this,p).video&&T(this,B,{id:1,info:{type:"video",codec:i(this,p).video.codec,width:i(this,p).video.width,height:i(this,p).video.height},timescale:720,codecPrivate:new Uint8Array(0),samples:[],writtenChunks:[],currentChunk:null,firstTimestamp:void 0,lastTimestamp:-1,timeToSampleTable:[],lastTimescaleUnits:null,compactlyCodedChunkTable:[]}),i(this,p).audio){let e=m(this,Ce,He).call(this,2,i(this,p).audio.sampleRate,i(this,p).audio.numberOfChannels);T(this,_,{id:i(this,p).video?2:1,info:{type:"audio",codec:i(this,p).audio.codec,numberOfChannels:i(this,p).audio.numberOfChannels,sampleRate:i(this,p).audio.sampleRate},timescale:i(this,p).audio.sampleRate,codecPrivate:e,samples:[],writtenChunks:[],currentChunk:null,firstTimestamp:void 0,lastTimestamp:-1,timeToSampleTable:[],lastTimescaleUnits:null,compactlyCodedChunkTable:[]})}},Ce=new WeakSet,He=function(e,r,s){let o=[96e3,88200,64e3,48e3,44100,32e3,24e3,22050,16e3,12e3,11025,8e3,7350].indexOf(r),h=s,l="";l+=e.toString(2).padStart(5,"0"),l+=o.toString(2).padStart(4,"0"),o===15&&(l+=r.toString(2).padStart(24,"0")),l+=h.toString(2).padStart(4,"0");let R=Math.ceil(l.length/8)*8;l=l.padEnd(R,"0");let g=new Uint8Array(l.length/8);for(let I=0;I<l.length;I+=8)g[I/8]=parseInt(l.slice(I,I+8),2);return g},te=new WeakSet,Ae=function(e,r,s,n,o,h){var g;let l=n/1e6,R=o/1e6;if(e.firstTimestamp===void 0&&(e.firstTimestamp=l),l=m(this,we,We).call(this,l,e),e.lastTimestamp=l,(!e.currentChunk||l-e.currentChunk.startTimestamp>=_t)&&(e.currentChunk&&m(this,W,me).call(this,e),e.currentChunk={startTimestamp:l,sampleData:[],sampleCount:0}),e.currentChunk.sampleData.push(r),e.currentChunk.sampleCount++,(g=h==null?void 0:h.decoderConfig)!=null&&g.description&&(e.codecPrivate=new Uint8Array(h.decoderConfig.description)),e.samples.push({timestamp:l,duration:R,size:r.byteLength,type:s}),e.lastTimescaleUnits!==null){let I=P(l,e.timescale,!1),ie=Math.round(I-e.lastTimescaleUnits);e.lastTimescaleUnits+=ie;let L=U(e.timeToSampleTable);L.sampleCount===1?(L.sampleDelta=ie,L.sampleCount++):L.sampleDelta===ie?L.sampleCount++:(L.sampleCount--,e.timeToSampleTable.push({sampleCount:2,sampleDelta:ie}))}else e.lastTimescaleUnits=0,e.timeToSampleTable.push({sampleCount:1,sampleDelta:P(R,e.timescale)})},we=new WeakSet,We=function(e,r){if(i(this,p).firstTimestampBehavior==="strict"&&r.lastTimestamp===-1&&e!==0)throw new Error(`The first chunk for your media track must have a timestamp of 0 (received ${e}). Non-zero first timestamps are often caused by directly piping frames or audio data from a MediaStreamTrack into the encoder. Their timestamps are typically relative to the age of the document, which is probably what you want.

If you want to offset all timestamps of a track such that the first one is zero, set firstTimestampBehavior: 'offset' in the options.
`);if(i(this,p).firstTimestampBehavior==="offset"&&(e-=r.firstTimestamp),e<r.lastTimestamp)throw new Error(`Timestamps must be monotonically increasing (went from ${r.lastTimestamp*1e6} to ${e*1e6}).`);return e},W=new WeakSet,me=function(e){if(e.currentChunk){e.currentChunk.offset=i(this,f).pos;for(let r of e.currentChunk.sampleData)i(this,f).write(r);e.currentChunk.sampleData=null,(e.compactlyCodedChunkTable.length===0||U(e.compactlyCodedChunkTable).samplesPerChunk!==e.currentChunk.sampleCount)&&e.compactlyCodedChunkTable.push({firstChunk:e.writtenChunks.length+1,samplesPerChunk:e.currentChunk.sampleCount}),e.writtenChunks.push(e.currentChunk),m(this,X,ce).call(this)}},X=new WeakSet,ce=function(){i(this,f)instanceof Y&&i(this,f).flush()},re=new WeakSet,Ue=function(){if(i(this,ee))throw new Error("Cannot add new video or audio chunks after the file has been finalized.")};return Ye(Pt);})();
if (typeof module === "object" && typeof module.exports === "object") {
	module.exports.Muxer = Mp4Muxer.Muxer;
	module.exports.ArrayBufferTarget = Mp4Muxer.ArrayBufferTarget;
	module.exports.StreamTarget = Mp4Muxer.StreamTarget;
	module.exports.FileSystemWritableFileStreamTarget = Mp4Muxer.FileSystemWritableFileStreamTarget;
}
