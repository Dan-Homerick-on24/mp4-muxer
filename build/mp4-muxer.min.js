"use strict";var Mp4Muxer=(()=>{var V=Object.defineProperty;var we=Object.getOwnPropertyDescriptor;var ye=Object.getOwnPropertyNames,se=Object.getOwnPropertySymbols;var re=Object.prototype.hasOwnProperty,be=Object.prototype.propertyIsEnumerable;var R=Math.pow,ie=(t,e,s)=>e in t?V(t,e,{enumerable:!0,configurable:!0,writable:!0,value:s}):t[e]=s,ne=(t,e)=>{for(var s in e||={})re.call(e,s)&&ie(t,s,e[s]);if(se)for(var s of se(e))be.call(e,s)&&ie(t,s,e[s]);return t};var xe=(t,e)=>{for(var s in e)V(t,s,{get:e[s],enumerable:!0})},Ce=(t,e,s,r)=>{if(e&&typeof e=="object"||typeof e=="function")for(let n of ye(e))!re.call(t,n)&&n!==s&&V(t,n,{get:()=>e[n],enumerable:!(r=we(e,n))||r.enumerable});return t};var ve=t=>Ce(V({},"__esModule",{value:!0}),t);var q=(t,e,s)=>{if(!e.has(t))throw TypeError("Cannot "+s)};var i=(t,e,s)=>(q(t,e,"read from private field"),s?s.call(t):e.get(t)),u=(t,e,s)=>{if(e.has(t))throw TypeError("Cannot add the same private member more than once");e instanceof WeakSet?e.add(t):e.set(t,s)},w=(t,e,s,r)=>(q(t,e,"write to private field"),r?r.call(t,s):e.set(t,s),s);var b=(t,e,s)=>(q(t,e,"access private method"),s);var et={};xe(et,{GLOBAL_TIMESCALE:()=>I,default:()=>Qe});var d=t=>{let e=new Uint8Array(2);return new DataView(e.buffer).setUint16(0,t,!1),[...e]},ae=t=>{let e=new Uint8Array(2);return new DataView(e.buffer).setInt16(0,t,!1),[...e]},oe=t=>{let e=new Uint8Array(4);return new DataView(e.buffer).setUint32(0,t,!1),[...e].slice(1)},o=t=>{let e=new Uint8Array(4);return new DataView(e.buffer).setUint32(0,t,!1),[...e]},J=t=>{let e=new Uint8Array(2),s=new DataView(e.buffer);return s.setUint8(0,t),s.setUint8(1,t<<8),[...e]},F=t=>{let e=new Uint8Array(4),s=new DataView(e.buffer);return s.setUint16(0,t,!1),s.setUint16(2,t<<16,!1),[...e]},x=(t,e=!1)=>{let s=Array(t.length).fill(null).map((r,n)=>t.charCodeAt(n));return e&&s.push(0),s},U=(t,e)=>Math.round(t*e),D=t=>t&&t[t.length-1];var he=[65536,0,0,0,65536,0,0,0,1073741824].map(o),y=(t,e,s)=>({type:t,contents:e&&new Uint8Array(e.flat(10)),children:s}),f=(t,e,s,r,n)=>y(t,[e,oe(s),r!=null?r:[]],n),le=t=>t?y("ftyp",[x("isom"),o(0),x("iso4"),x("hvc1")]):y("ftyp",[x("isom"),o(0),x("isom"),x("avc1"),x("mp41")]),ue=()=>({type:"mdat",largeSize:!0}),de=(t,e)=>y("moov",null,[ge(e,t),...t.map(s=>Ae(s,e))]),ge=(t,e)=>{let s=U(Math.max(...e.map(n=>D(n.samples).timestamp+D(n.samples).duration)),I),r=Math.max(...e.map(n=>n.id))+1;return f("mvhd",0,0,[o(t),o(t),o(I),o(s),F(1),J(1),Array(10).fill(0),he,Array(24).fill(0),o(r)])},Ae=(t,e)=>y("trak",null,[Te(t,e),ke(t,e)]),Te=(t,e)=>{let s=D(t.samples),r=U(s.timestamp+s.duration,I);return f("tkhd",0,3,[o(e),o(e),o(t.id),o(0),o(r),Array(8).fill(0),0,0,0,0,J(t.info.type==="audio"?1:0),0,0,he,F(t.info.type==="video"?t.info.width:0),F(t.info.type==="video"?t.info.height:0)])},ke=(t,e)=>y("mdia",null,[Ue(t,e),Se(t.info.type==="video"?"vide":"soun"),Be(t)]),Ue=(t,e)=>{let s=D(t.samples),r=U(s.timestamp+s.duration,t.timescale);return f("mdhd",0,0,[o(e),o(e),o(t.timescale),o(r),85,196,d(0)])},Se=t=>f("hdlr",0,0,[x("mhlr"),x(t),o(0),o(0),o(0),x("mp4-muxer-hdlr")]),Be=t=>y("minf",null,[t.info.type==="video"?De():Ee(),Me(),Ie(t)]),De=()=>f("vmhd",0,1,[d(0),d(0),d(0),d(0)]),Ee=()=>f("smhd",0,0,[0,0,0,0]),Me=()=>y("dinf",null,[ze()]),ze=()=>f("dref",0,0,[o(1)],[Fe()]),Fe=()=>f("url ",0,1),Ie=t=>y("stbl",null,[Oe(t),Re(t),He(t),We(t),$e(t),Ge(t)]),Oe=t=>f("stsd",0,0,[o(1)],[t.info.type==="video"?Pe(t.info.codec==="avc"?"avc1":"hvc1",t,t.info.codec==="avc"?Le(t):_e(t)):Ne("mp4a",t,Ve(t))]),Pe=(t,e,s)=>y(t,[Array(6).fill(0),0,1,0,0,0,0,Array(12).fill(0),d(e.info.width),d(e.info.height),o(4718592),o(4718592),o(0),d(1),Array(32).fill(0),d(24),ae(65535)],[s]),Le=t=>y("avcC",[...t.codecPrivate]),_e=t=>y("hvcC",[...t.codecPrivate]),Ne=(t,e,s)=>y("compressionType",[Array(6).fill(0),d(1),d(0),d(0),o(0),d(e.info.numberOfChannels),d(16),d(0),d(0),F(e.info.sampleRate)],[s]),Ve=t=>f("esds",0,0,[o(58753152),34,d(1),0,o(75530368),20,64,21,0,0,0,o(130071),o(130071),o(92307584),2,t.codecPrivate[0],t.codecPrivate[1],o(109084800),1,2]),Re=t=>{var r,n;let e=[],s=[];for(let a of t.samples){if(e.push(a),e.length===1)continue;let h=U(e[1].timestamp-e[0].timestamp,t.timescale);U(a.timestamp-e[e.length-2].timestamp,t.timescale)!==h&&(s.push({sampleCount:e.length-1,sampleDelta:h}),e=e.slice(-2))}return s.push({sampleCount:e.length,sampleDelta:U(((n=(r=e[1])==null?void 0:r.timestamp)!=null?n:e[0].timestamp)-e[0].timestamp,t.timescale)}),f("stts",0,0,[o(s.length),s.map(a=>[o(a.sampleCount),o(a.sampleDelta)])])},He=t=>{if(t.samples.every(s=>s.type==="key"))return null;let e=[...t.samples.entries()].filter(([,s])=>s.type==="key");return f("stss",0,0,[o(e.length),e.map(([s])=>o(s+1))])},We=t=>{let e=[];for(let s=0;s<t.writtenChunks.length;s++){let r=t.writtenChunks[s];(e.length===0||D(e).samplesPerChunk!==r.sampleCount)&&e.push({firstChunk:s+1,samplesPerChunk:r.sampleCount})}return f("stsc",0,0,[o(e.length),e.map(s=>[o(s.firstChunk),o(s.samplesPerChunk),o(1)])])},$e=t=>f("stsz",0,0,[o(0),o(t.samples.length),t.samples.map(e=>o(e.size))]),Ge=t=>f("stco",0,0,[o(t.writtenChunks.length),t.writtenChunks.map(e=>o(e.offset))]);var C,S,O=class{constructor(){this.pos=0;u(this,C,new Uint8Array(8));u(this,S,new DataView(i(this,C).buffer));this.offsets=new WeakMap}writeU32(e){i(this,S).setUint32(0,e,!1),this.write(i(this,C).subarray(0,4))}writeU64(e){i(this,S).setUint32(0,Math.floor(e/R(2,32)),!1),i(this,S).setUint32(4,e,!1),this.write(i(this,C).subarray(0,8))}writeAscii(e){for(let s=0;s<e.length;s++)i(this,S).setUint8(s%8,e.charCodeAt(s)),s%8===7&&this.write(i(this,C));e.length%8!==0&&this.write(i(this,C).subarray(0,e.length%8))}writeBox(e){var s,r;if(this.offsets.set(e,this.pos),e.contents&&!e.children)this.writeBoxHeader(e,(s=e.size)!=null?s:e.contents.byteLength+8),this.write(e.contents);else{let n=this.pos;if(this.writeBoxHeader(e,0),e.contents&&this.write(e.contents),e.children)for(let l of e.children)l&&this.writeBox(l);let a=this.pos,h=(r=e.size)!=null?r:a-n;this.pos=n,this.writeBoxHeader(e,h),this.pos=a}}writeBoxHeader(e,s){this.writeU32(e.largeSize?1:s),this.writeAscii(e.type),e.largeSize&&this.writeU64(s)}patchBox(e){let s=this.pos;this.pos=this.offsets.get(e),this.writeBox(e),this.pos=s}};C=new WeakMap,S=new WeakMap;var v,M,H=class extends O{constructor(){super();u(this,v,new ArrayBuffer(R(2,16)));u(this,M,new Uint8Array(i(this,v)))}ensureSize(s){let r=i(this,v).byteLength;for(;r<s;)r*=2;if(r===i(this,v).byteLength)return;let n=new ArrayBuffer(r),a=new Uint8Array(n);a.set(i(this,M),0),w(this,v,n),w(this,M,a)}write(s){this.ensureSize(this.pos+s.byteLength),i(this,M).set(s,this.pos),this.pos+=s.byteLength}seek(s){this.pos=s}finalize(){return this.ensureSize(this.pos),i(this,v).slice(0,this.pos)}};v=new WeakMap,M=new WeakMap;var E=R(2,24),Ke=2,P,c,W=class extends O{constructor(s){super();u(this,P,void 0);u(this,c,[]);w(this,P,s)}write(s){this.writeDataIntoChunks(s,this.pos),this.flushChunks(),this.pos+=s.byteLength}writeDataIntoChunks(s,r){let n=i(this,c).findIndex(B=>B.start<=r&&r<B.start+E);n===-1&&(n=this.createChunk(r));let a=i(this,c)[n],h=r-a.start,l=s.subarray(0,Math.min(E-h,s.byteLength));a.data.set(l,h);let ce={start:h,end:h+l.byteLength};if(Xe(a,ce),a.written[0].start===0&&a.written[0].end===E&&(a.shouldFlush=!0),i(this,c).length>Ke){for(let B=0;B<i(this,c).length-1;B++)i(this,c)[B].shouldFlush=!0;this.flushChunks()}l.byteLength<s.byteLength&&this.writeDataIntoChunks(s.subarray(l.byteLength),r+l.byteLength)}createChunk(s){let n={start:Math.floor(s/E)*E,data:new Uint8Array(E),written:[],shouldFlush:!1};return i(this,c).push(n),i(this,c).sort((a,h)=>a.start-h.start),i(this,c).indexOf(n)}flushChunks(s=!1){for(let r=0;r<i(this,c).length;r++){let n=i(this,c)[r];if(!(!n.shouldFlush&&!s)){for(let a of n.written)i(this,P).write({type:"write",data:n.data.subarray(a.start,a.end),position:n.start+a.start});i(this,c).splice(r--,1)}}}seek(s){this.pos=s}finalize(){this.flushChunks(!0)}};P=new WeakMap,c=new WeakMap;var Xe=(t,e)=>{let s=0,r=t.written.length-1,n=-1;for(;s<=r;){let a=Math.floor(s+(r-s+1)/2);t.written[a].start<=e.start?(s=a+1,n=a):r=a-1}for(t.written.splice(n+1,0,e),(n===-1||t.written[n].end<e.start)&&n++;n<t.written.length-1&&t.written[n].end>=t.written[n+1].start;)t.written[n].end=Math.max(t.written[n].end,t.written[n+1].end),t.written.splice(n+1,1)},g,L,$=class extends O{constructor(s){super();u(this,g,[]);u(this,L,void 0);w(this,L,s)}write(s){i(this,g).push({data:s.slice(),start:this.pos}),this.pos+=s.byteLength}seek(s){this.pos=s}flush(s){if(i(this,g).length===0)return;let r=[],n=[...i(this,g)].sort((a,h)=>a.start-h.start);r.push({start:n[0].start,size:n[0].data.byteLength});for(let a=1;a<n.length;a++){let h=r[r.length-1],l=n[a];l.start<=h.start+h.size?h.size=Math.max(h.size,l.start+l.data.byteLength-h.start):r.push({start:l.start,size:l.data.byteLength})}for(let a of r){a.data=new Uint8Array(a.size);for(let l of i(this,g))a.start<=l.start&&l.start<a.start+a.size&&a.data.set(l.data,l.start-a.start);let h=s&&a===r[r.length-1];i(this,L).call(this,a.data,a.start,h)}i(this,g).length=0}};g=new WeakMap,L=new WeakMap;var Ye=2082848400,Ze=.5,je=["avc","hevc"],qe=["aac"],Je=["strict","offset","permissive"],I=1e3,m,p,A,T,k,K,X,Y,me,Z,fe,j,pe,_,ee,z,G,N,te,Q=class{constructor(e){u(this,Y);u(this,Z);u(this,j);u(this,_);u(this,z);u(this,N);u(this,m,void 0);u(this,p,void 0);u(this,A,void 0);u(this,T,null);u(this,k,null);u(this,K,Math.floor(Date.now()/1e3)+Ye);u(this,X,!1);if(b(this,Y,me).call(this,e),w(this,m,ne({firstTimestampBehavior:"strict"},e)),e.target==="buffer")w(this,p,new H);else if(e.target instanceof FileSystemWritableFileStream)w(this,p,new W(e.target));else if(typeof e.target=="function")w(this,p,new $(e.target));else throw new Error(`Invalid target: ${e.target}`);b(this,Z,fe).call(this),b(this,j,pe).call(this)}addVideoChunk(e,s){if(b(this,N,te).call(this),!i(this,m).video)throw new Error("No video track declared.");b(this,_,ee).call(this,i(this,T),e,s)}addAudioChunk(e,s){if(b(this,N,te).call(this),!i(this,m).audio)throw new Error("No audio track declared.");b(this,_,ee).call(this,i(this,k),e,s)}finalize(){i(this,T)&&b(this,z,G).call(this,i(this,T)),i(this,k)&&b(this,z,G).call(this,i(this,k));let e=i(this,p).offsets.get(i(this,A)),s=i(this,p).pos-e;i(this,A).size=s,i(this,p).patchBox(i(this,A));let r=de([i(this,T),i(this,k)].filter(Boolean),i(this,K));return i(this,p).writeBox(r),i(this,p).finalize()}};m=new WeakMap,p=new WeakMap,A=new WeakMap,T=new WeakMap,k=new WeakMap,K=new WeakMap,X=new WeakMap,Y=new WeakSet,me=function(e){if(e.video&&!je.includes(e.video.codec))throw new Error(`Unsupported video codec: ${e.video.codec}`);if(e.audio&&!qe.includes(e.audio.codec))throw new Error(`Unsupported audio codec: ${e.audio.codec}`);if(e.firstTimestampBehavior&&!Je.includes(e.firstTimestampBehavior))throw new Error(`Invalid first timestamp behavior: ${e.firstTimestampBehavior}`)},Z=new WeakSet,fe=function(){var s;let e=((s=i(this,m).video)==null?void 0:s.codec)==="hevc";i(this,p).writeBox(le(e)),w(this,A,ue()),i(this,p).writeBox(i(this,A))},j=new WeakSet,pe=function(){i(this,m).video&&w(this,T,{id:1,info:{type:"video",codec:i(this,m).video.codec,width:i(this,m).video.width,height:i(this,m).video.height},timescale:720,codecPrivate:null,samples:[],writtenChunks:[],currentChunk:null}),i(this,m).audio&&w(this,k,{id:i(this,m).video?2:1,info:{type:"audio",codec:i(this,m).audio.codec,numberOfChannels:i(this,m).audio.numberOfChannels,sampleRate:i(this,m).audio.sampleRate},timescale:i(this,m).audio.sampleRate,codecPrivate:null,samples:[],writtenChunks:[],currentChunk:null})},_=new WeakSet,ee=function(e,s,r){var l;let n=s.timestamp/1e6,a=s.duration/1e6;(!e.currentChunk||n-e.currentChunk.startTimestamp>=Ze)&&(e.currentChunk&&b(this,z,G).call(this,e),e.currentChunk={startTimestamp:n,sampleData:[],sampleCount:0});let h=new Uint8Array(s.byteLength);s.copyTo(h),e.currentChunk.sampleData.push(h),e.currentChunk.sampleCount++,(l=r.decoderConfig)!=null&&l.description&&(e.codecPrivate=new Uint8Array(r.decoderConfig.description)),e.samples.push({timestamp:n,duration:a,size:h.byteLength,type:s.type})},z=new WeakSet,G=function(e){if(e.currentChunk){e.currentChunk.offset=i(this,p).pos;for(let s of e.currentChunk.sampleData)i(this,p).write(s);e.currentChunk.sampleData=null,e.writtenChunks.push(e.currentChunk)}},N=new WeakSet,te=function(){if(i(this,X))throw new Error("Cannot add new video or audio chunks after the file has been finalized.")};var Qe=Q;return ve(et);})();
Mp4Muxer = Mp4Muxer.default;
if (typeof module === "object" && typeof module.exports === "object") module.exports = Mp4Muxer;
