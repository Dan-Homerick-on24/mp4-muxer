"use strict";var Mp4Muxer=(()=>{var N=Object.defineProperty;var Te=Object.getOwnPropertyDescriptor;var ze=Object.getOwnPropertyNames,he=Object.getOwnPropertySymbols;var fe=Object.prototype.hasOwnProperty,Fe=Object.prototype.propertyIsEnumerable;var W=Math.pow,ue=(n,e,t)=>e in n?N(n,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):n[e]=t,de=(n,e)=>{for(var t in e||={})fe.call(e,t)&&ue(n,t,e[t]);if(he)for(var t of he(e))Fe.call(e,t)&&ue(n,t,e[t]);return n};var Ie=(n,e)=>{for(var t in e)N(n,t,{get:e[t],enumerable:!0})},He=(n,e,t,r)=>{if(e&&typeof e=="object"||typeof e=="function")for(let s of ze(e))!fe.call(n,s)&&s!==t&&N(n,s,{get:()=>e[s],enumerable:!(r=Te(e,s))||r.enumerable});return n};var Ee=n=>He(N({},"__esModule",{value:!0}),n);var Y=(n,e,t)=>{if(!e.has(n))throw TypeError("Cannot "+t)};var i=(n,e,t)=>(Y(n,e,"read from private field"),t?t.call(n):e.get(n)),h=(n,e,t)=>{if(e.has(n))throw TypeError("Cannot add the same private member more than once");e instanceof WeakSet?e.add(n):e.set(n,t)},c=(n,e,t,r)=>(Y(n,e,"write to private field"),r?r.call(n,t):e.set(n,t),t);var p=(n,e,t)=>(Y(n,e,"access private method"),t);var Re={};Ie(Re,{default:()=>_e});var w=n=>{let e=new Uint8Array(2);return new DataView(e.buffer).setUint16(0,n,!1),[...e]},me=n=>{let e=new Uint8Array(2);return new DataView(e.buffer).setInt16(0,n,!1),[...e]},o=n=>{let e=new Uint8Array(4);return new DataView(e.buffer).setUint32(0,n,!1),[...e]},ee=n=>{let e=new Uint8Array(2),t=new DataView(e.buffer);return t.setUint8(0,n),t.setUint8(1,n<<8),[...e]},I=n=>{let e=new Uint8Array(4),t=new DataView(e.buffer);return t.setUint16(0,n,!1),t.setUint16(2,n<<16,!1),[...e]},te=(n,e=!1)=>{let t=Array(n.length).fill(null).map((r,s)=>n.charCodeAt(s));return e&&t.push(0),t},S=(n,e)=>Math.round(n*e),H=n=>n&&n[n.length-1];var g,M,E=class{constructor(){this.pos=0;h(this,g,new Uint8Array(8));h(this,M,new DataView(i(this,g).buffer));this.offsets=new WeakMap}writeU32(e){i(this,M).setUint32(0,e,!1),this.write(i(this,g).subarray(0,4))}writeU64(e){i(this,M).setUint32(0,Math.floor(e/W(2,32)),!1),i(this,M).setUint32(4,e,!1),this.write(i(this,g).subarray(0,8))}writeAscii(e){for(let t=0;t<e.length;t++)i(this,M).setUint8(t%8,e.charCodeAt(t)),t%8===7&&this.write(i(this,g));e.length%8!==0&&this.write(i(this,g).subarray(0,e.length%8))}writeBox(e){var t,r;if(this.offsets.set(e,this.pos),e.contents&&!e.children)this.writeBoxHeader(e,(t=e.size)!=null?t:e.contents.byteLength+8),this.write(e.contents);else{let s=this.pos;if(this.writeBoxHeader(e,0),e.contents&&this.write(e.contents),e.children)for(let l of e.children)l&&this.writeBox(l);let a=this.pos,u=(r=e.size)!=null?r:a-s;this.pos=s,this.writeBoxHeader(e,u),this.pos=a}}writeBoxHeader(e,t){this.writeU32(e.largeSize?1:t),this.writeAscii(e.type),e.largeSize&&this.writeU64(t)}patchBox(e){let t=this.pos;this.pos=this.offsets.get(e),this.writeBox(e),this.pos=t}};g=new WeakMap,M=new WeakMap;var v,T,K=class extends E{constructor(){super();h(this,v,new ArrayBuffer(W(2,16)));h(this,T,new Uint8Array(i(this,v)))}ensureSize(t){let r=i(this,v).byteLength;for(;r<t;)r*=2;if(r===i(this,v).byteLength)return;let s=new ArrayBuffer(r),a=new Uint8Array(s);a.set(i(this,T),0),c(this,v,s),c(this,T,a)}write(t){this.ensureSize(this.pos+t.byteLength),i(this,T).set(t,this.pos),this.pos+=t.byteLength}seek(t){this.pos=t}finalize(){return this.ensureSize(this.pos),i(this,v).slice(0,this.pos)}};v=new WeakMap,T=new WeakMap;var D=W(2,24),Le=2,L,x,G=class extends E{constructor(t){super();h(this,L,void 0);h(this,x,[]);c(this,L,t)}write(t){this.writeDataIntoChunks(t,this.pos),this.flushChunks(),this.pos+=t.byteLength}writeDataIntoChunks(t,r){let s=i(this,x).findIndex(y=>y.start<=r&&r<y.start+D);s===-1&&(s=this.createChunk(r));let a=i(this,x)[s],u=r-a.start,l=t.subarray(0,Math.min(D-u,t.byteLength));a.data.set(l,u);let B={start:u,end:u+l.byteLength};if(Pe(a,B),a.written[0].start===0&&a.written[0].end===D&&(a.shouldFlush=!0),i(this,x).length>Le){for(let y=0;y<i(this,x).length-1;y++)i(this,x)[y].shouldFlush=!0;this.flushChunks()}l.byteLength<t.byteLength&&this.writeDataIntoChunks(t.subarray(l.byteLength),r+l.byteLength)}createChunk(t){let s={start:Math.floor(t/D)*D,data:new Uint8Array(D),written:[],shouldFlush:!1};return i(this,x).push(s),i(this,x).sort((a,u)=>a.start-u.start),i(this,x).indexOf(s)}flushChunks(t=!1){for(let r=0;r<i(this,x).length;r++){let s=i(this,x)[r];if(!(!s.shouldFlush&&!t)){for(let a of s.written)i(this,L).write({type:"write",data:s.data.subarray(a.start,a.end),position:s.start+a.start});i(this,x).splice(r--,1)}}}seek(t){this.pos=t}finalize(){this.flushChunks(!0)}};L=new WeakMap,x=new WeakMap;var Pe=(n,e)=>{let t=0,r=n.written.length-1,s=-1;for(;t<=r;){let a=Math.floor(t+(r-t+1)/2);n.written[a].start<=e.start?(t=a+1,s=a):r=a-1}for(n.written.splice(s+1,0,e),(s===-1||n.written[s].end<e.start)&&s++;s<n.written.length-1&&n.written[s].end>=n.written[s+1].start;)n.written[s].end=Math.max(n.written[s].end,n.written[s+1].end),n.written.splice(s+1,1)},U,P,X=class extends E{constructor(t){super();h(this,U,[]);h(this,P,void 0);c(this,P,t)}write(t){i(this,U).push({data:t.slice(),start:this.pos}),this.pos+=t.byteLength}seek(t){this.pos=t}flush(t){if(i(this,U).length===0)return;let r=[],s=[...i(this,U)].sort((a,u)=>a.start-u.start);r.push({start:s[0].start,size:s[0].data.byteLength});for(let a=1;a<s.length;a++){let u=r[r.length-1],l=s[a];l.start<=u.start+u.size?u.size=Math.max(u.size,l.start+l.data.byteLength-u.start):r.push({start:l.start,size:l.data.byteLength})}for(let a of r){a.data=new Uint8Array(a.size);for(let l of i(this,U))a.start<=l.start&&l.start<a.start+a.size&&a.data.set(l.data,l.start-a.start);let u=t&&a===r[r.length-1];i(this,P).call(this,a.data,a.start,u)}i(this,U).length=0}};U=new WeakMap,P=new WeakMap;var z=2082848400,Oe=5e5,Ve=["strict","offset","permissive"],ie=1e3,d,m,k,b,C,Z,j,pe,q,xe,J,ce,O,re,F,$,V,se,Q,we,_,ae,ne=class{constructor(e){h(this,j);h(this,q);h(this,J);h(this,O);h(this,F);h(this,V);h(this,Q);h(this,_);h(this,d,void 0);h(this,m,void 0);h(this,k,void 0);h(this,b,null);h(this,C,null);h(this,Z,!1);if(p(this,j,pe).call(this,e),c(this,d,de({firstTimestampBehavior:"strict"},e)),e.target==="buffer")c(this,m,new K);else if(e.target instanceof FileSystemWritableFileStream)c(this,m,new G(e.target));else if(typeof e.target=="function")c(this,m,new X(e.target));else throw new Error(`Invalid target: ${e.target}`);p(this,q,xe).call(this),p(this,J,ce).call(this)}addVideoChunk(e,t){if(p(this,V,se).call(this),!i(this,d).video)throw new Error("No video track declared.");p(this,O,re).call(this,i(this,b),e,t)}addAudioChunk(e,t){if(p(this,V,se).call(this),!i(this,d).audio)throw new Error("No audio track declared.");p(this,O,re).call(this,i(this,C),e,t)}finalize(){i(this,b)&&p(this,F,$).call(this,i(this,b)),i(this,C)&&p(this,F,$).call(this,i(this,C));let e=i(this,m).offsets.get(i(this,k)),t=i(this,m).pos-e;i(this,k).size=t,i(this,m).patchBox(i(this,k));let r=p(this,Q,we).call(this);return i(this,m).writeBox(r),i(this,m).finalize()}};d=new WeakMap,m=new WeakMap,k=new WeakMap,b=new WeakMap,C=new WeakMap,Z=new WeakMap,j=new WeakSet,pe=function(e){if(e.firstTimestampBehavior&&!Ve.includes(e.firstTimestampBehavior))throw new Error(`Invalid first timestamp behavior: ${e.firstTimestampBehavior}`)},q=new WeakSet,xe=function(){i(this,m).writeBox({type:"ftyp",contents:new Uint8Array([105,115,111,109,0,0,0,0,105,115,111,109,97,118,99,49,109,112,52,49])}),c(this,k,{type:"mdat",largeSize:!0}),i(this,m).writeBox(i(this,k))},J=new WeakSet,ce=function(){var e;i(this,d).video&&c(this,b,{info:{type:"video",width:i(this,d).video.width,height:i(this,d).video.height},codecPrivate:null,samples:[],writtenChunks:[],currentChunk:null}),i(this,d).audio&&c(this,C,{info:{type:"audio",numberOfChannels:i(this,d).audio.numberOfChannels,sampleRate:i(this,d).audio.sampleRate,bitDepth:(e=i(this,d).audio.bitDepth)!=null?e:16},codecPrivate:null,samples:[],writtenChunks:[],currentChunk:null})},O=new WeakSet,re=function(e,t,r){var a;(!e.currentChunk||t.timestamp-e.currentChunk.startTimestamp>=Oe)&&(e.currentChunk&&p(this,F,$).call(this,e),e.currentChunk={startTimestamp:t.timestamp,sampleData:[],sampleCount:0});let s=new Uint8Array(t.byteLength);t.copyTo(s),e.currentChunk.sampleData.push(s),e.currentChunk.sampleCount++,(a=r.decoderConfig)!=null&&a.description&&(e.codecPrivate=new Uint8Array(r.decoderConfig.description)),e.samples.push({timestamp:t.timestamp/1e6,duration:t.duration/1e6,size:s.byteLength,type:t.type})},F=new WeakSet,$=function(e){if(e.currentChunk){e.currentChunk.offset=i(this,m).pos;for(let t of e.currentChunk.sampleData)i(this,m).write(t);e.currentChunk.sampleData=null,e.writtenChunks.push(e.currentChunk)}},V=new WeakSet,se=function(){if(i(this,Z))throw new Error("Cannot add new video or audio chunks after the file has been finalized.")},Q=new WeakSet,we=function(){var B,y;let e=H((B=i(this,b))==null?void 0:B.samples),t=H((y=i(this,C))==null?void 0:y.samples),r=S(Math.max(e?e.timestamp+e.duration:0,t?t.timestamp+t.duration:0),ie),s=i(this,b)&&p(this,_,ae).call(this,i(this,b)),a=i(this,C)&&p(this,_,ae).call(this,i(this,C)),u={type:"mvhd",contents:new Uint8Array([0,0,0,0,o(Math.floor(Date.now()/1e3)+z),o(Math.floor(Date.now()/1e3)+z),o(ie),o(r),I(1),ee(1),Array(10).fill(0),[65536,0,0,0,65536,0,0,0,1073741824].flatMap(o),Array(24).fill(0),o(+!!i(this,d).audio+ +!!i(this,d).video+1)].flat())};return{type:"moov",children:[u,s,a]}},_=new WeakSet,ae=function(e){var oe,le;let t=e.info.type==="video"?960:e.info.sampleRate,r=[],s=[];for(let f of e.samples){if(r.push(f),r.length===1)continue;let A=S(r[1].timestamp-r[0].timestamp,t);S(f.timestamp-r[r.length-2].timestamp,t)!==A&&(s.push({sampleCount:r.length-1,sampleDelta:A}),r=r.slice(-2))}s.push({sampleCount:r.length,sampleDelta:S(((le=(oe=r[1])==null?void 0:oe.timestamp)!=null?le:r[0].timestamp)-r[0].timestamp,t)});let a={type:"stts",contents:new Uint8Array([0,0,0,0,o(s.length),...s.flatMap(f=>[o(f.sampleCount),o(f.sampleDelta)])].flat())},u=null;if(!e.samples.every(f=>f.type==="key")){let f=[...e.samples.entries()].filter(([,A])=>A.type==="key");u={type:"stss",contents:new Uint8Array([0,0,0,0,o(f.length),f.flatMap(([A])=>o(A+1))].flat())}}let l=[];for(let f=0;f<e.writtenChunks.length;f++){let A=e.writtenChunks[f];(l.length===0||H(l).samplesPerChunk!==A.sampleCount)&&l.push({firstChunk:f+1,samplesPerChunk:A.sampleCount})}let B={type:"stsc",contents:new Uint8Array([0,0,0,0,o(l.length),...l.flatMap(f=>[o(f.firstChunk),o(f.samplesPerChunk),o(1)])].flat())},y={type:"stsz",contents:new Uint8Array([0,0,0,0,o(0),o(e.samples.length),e.samples.flatMap(f=>o(f.size))].flat())},ye={type:"stco",contents:new Uint8Array([0,0,0,0,o(e.writtenChunks.length),e.writtenChunks.flatMap(f=>o(f.offset))].flat())},R=H(e.samples),be=S(R.timestamp+R.duration,t),Ce=S(R.timestamp+R.duration,ie),Ae={type:"mdhd",contents:new Uint8Array([0,0,0,0,o(Math.floor(Date.now()/1e3)+z),o(Math.floor(Date.now()/1e3)+z),o(t),o(be),85,196,0,0].flat())},ge={type:"hdlr",contents:new Uint8Array([0,0,0,0,o(0),te(e.info.type==="video"?"vide":"soun"),Array(12).fill(0),te(e.info.type==="video"?"Video track":"Audio track",!0)].flat())},ve=e.info.type==="video"?{type:"vmhd",contents:new Uint8Array([0,0,0,1,0,0,0,0,0,0,0,0])}:{type:"smhd",contents:new Uint8Array([0,0,0,0,0,0,0,0])},Ue={type:"dinf",children:[{type:"dref",contents:new Uint8Array([0,0,0,0,o(1)].flat()),children:[{type:"url ",contents:new Uint8Array([0,0,0,1].flat())}]}]},ke={type:"stsd",contents:new Uint8Array([0,0,0,0,o(1)].flat()),children:[e.info.type==="video"?{type:"avc1",contents:new Uint8Array([Array(6).fill(0),0,1,0,0,0,0,Array(12).fill(0),w(i(this,d).video.width),w(i(this,d).video.height),o(4718592),o(4718592),o(0),w(1),Array(32).fill(0),w(24),me(65535)].flat()),children:[{type:"avcC",contents:e.codecPrivate}]}:{type:"mp4a",contents:new Uint8Array([Array(6).fill(0),w(1),w(0),w(0),o(0),w(e.info.numberOfChannels),w(e.info.bitDepth),w(0),w(0),I(e.info.sampleRate)].flat()),children:[{type:"esds",contents:new Uint8Array([0,0,0,0,o(58753152),34,w(1),0,o(75530368),20,64,21,0,0,0,o(130071),o(130071),o(92307584),2,e.codecPrivate[0],e.codecPrivate[1],o(109084800),1,2].flat())}]}]},Se={type:"stbl",children:[ke,a,u,B,y,ye]},Me={type:"minf",children:[ve,Ue,Se]},Be={type:"mdia",children:[Ae,ge,Me]},De={type:"tkhd",contents:new Uint8Array([0,0,0,3,o(Math.floor(Date.now()/1e3)+z),o(Math.floor(Date.now()/1e3)+z),o(e.info.type==="video"?1:1+ +!!i(this,d).video),o(0),o(Ce),Array(8).fill(0),0,0,0,0,ee(e.info.type==="audio"?1:0),0,0,[65536,0,0,0,65536,0,0,0,1073741824].flatMap(o),I(e.info.type==="video"?e.info.width:0),I(e.info.type==="video"?e.info.height:0)].flat())};return{type:"trak",children:[De,Be]}};var _e=ne;return Ee(Re);})();
Mp4Muxer = Mp4Muxer.default;
if (typeof module === "object" && typeof module.exports === "object") module.exports = Mp4Muxer;
