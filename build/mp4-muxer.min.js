"use strict";var Mp4Muxer=(()=>{var H=Object.defineProperty;var te=Object.getOwnPropertyDescriptor;var ie=Object.getOwnPropertyNames;var se=Object.prototype.hasOwnProperty;var N=Math.pow;var ne=(s,e)=>{for(var t in e)H(s,t,{get:e[t],enumerable:!0})},re=(s,e,t,r)=>{if(e&&typeof e=="object"||typeof e=="function")for(let a of ie(e))!se.call(s,a)&&a!==t&&H(s,a,{get:()=>e[a],enumerable:!(r=te(e,a))||r.enumerable});return s};var ae=s=>re(H({},"__esModule",{value:!0}),s);var _=(s,e,t)=>{if(!e.has(s))throw TypeError("Cannot "+t)};var i=(s,e,t)=>(_(s,e,"read from private field"),t?t.call(s):e.get(s)),l=(s,e,t)=>{if(e.has(s))throw TypeError("Cannot add the same private member more than once");e instanceof WeakSet?e.add(s):e.set(s,t)},x=(s,e,t,r)=>(_(s,e,"write to private field"),r?r.call(s,t):e.set(s,t),t);var U=(s,e,t)=>(_(s,e,"access private method"),t);var he={};ne(he,{ArrayBufferWriteTarget:()=>k,WriteTarget:()=>D,default:()=>le});var p,h,u,M,m,y,f,b,O,v,K,P=class{constructor(e){l(this,b);l(this,v);l(this,p,void 0);l(this,h,void 0);l(this,u,void 0);l(this,M,void 0);l(this,m,[]);l(this,y,[]);l(this,f,void 0);x(this,p,e),x(this,h,new k),i(this,h).writeBox({type:"ftyp",contents:new Uint8Array([109,112,52,50,0,0,0,0,105,115,111,109,97,118,99,49,109,112,52,50,109,112,52,49])}),x(this,u,{type:"mdat"}),i(this,h).writeBox(i(this,u))}addVideoChunk(e,t){var a;(!i(this,f)||e.timestamp-i(this,f).startTimestamp>=5e5)&&(i(this,f)&&U(this,b,O).call(this,i(this,f)),x(this,f,{startTimestamp:e.timestamp,sampleData:[],sampleCount:0}));let r=new Uint8Array(e.byteLength);e.copyTo(r),i(this,f).sampleData.push(r),i(this,f).sampleCount++,(a=t.decoderConfig)!=null&&a.description&&x(this,M,new Uint8Array(t.decoderConfig.description)),i(this,m).push({timestamp:e.timestamp/1e6,size:r.byteLength})}finalize(){U(this,b,O).call(this,i(this,f));let e=i(this,h).offsets.get(i(this,u)),t=i(this,h).pos-e;return i(this,u).size=t,i(this,h).patchBox(i(this,u)),U(this,v,K).call(this),i(this,h).finalize()}};p=new WeakMap,h=new WeakMap,u=new WeakMap,M=new WeakMap,m=new WeakMap,y=new WeakMap,f=new WeakMap,b=new WeakSet,O=function(e){e.offset=i(this,h).pos;for(let t of e.sampleData)i(this,h).write(t);e.sampleData=null,i(this,y).push(e)},v=new WeakSet,K=function(){var V,R;let t=[],r=[];for(let o of i(this,m)){if(t.push(o),t.length===1)continue;let A=g(t[1].timestamp-t[0].timestamp,1e3);g(o.timestamp-t[t.length-2].timestamp,1e3)!==A&&(r.push({sampleCount:t.length-1,sampleDelta:A}),t=t.slice(-2))}r.push({sampleCount:t.length,sampleDelta:Math.floor(g((R=(V=t[1])==null?void 0:V.timestamp)!=null?R:t[0].timestamp,1e3))});let a={type:"stts",contents:new Uint8Array([0,0,0,0,n(r.length),...r.flatMap(o=>[n(o.sampleCount),n(o.sampleDelta)])].flat())},d={type:"stss",contents:new Uint8Array([0,0,0,0,n(1),n(1)].flat())},S=i(this,y).reduce((o,A,L)=>o.length===0||o[o.length-1].samplesPerChunk!==A.sampleCount?[...o,{firstChunk:L+1,samplesPerChunk:A.sampleCount}]:o,[]),I={type:"stsc",contents:new Uint8Array([0,0,0,0,n(S.length),...S.flatMap(o=>[n(o.firstChunk),n(o.samplesPerChunk),n(1)])].flat())},X={type:"stsz",contents:new Uint8Array([0,0,0,0,n(0),n(i(this,m).length),i(this,m).flatMap(o=>n(o.size))].flat())},W={type:"stco",contents:new Uint8Array([0,0,0,0,n(i(this,y).length),i(this,y).flatMap(o=>n(o.offset))].flat())},E=g(i(this,m)[i(this,m).length-1].timestamp,1e3),j={type:"mdhd",contents:new Uint8Array([0,0,0,0,n(Math.floor(Date.now()/1e3)+2082848400),n(Math.floor(Date.now()/1e3)+2082848400),n(1e3),n(E),85,196,0,0].flat())},q={type:"hdlr",contents:new Uint8Array([0,0,0,0,n(0),F("vide"),Array(12).fill(0),F("Video track",!0)].flat())},J={type:"vmhd",contents:new Uint8Array([0,0,0,1,0,0,0,0,0,0,0,0])},Q={type:"dinf",children:[{type:"dref",contents:new Uint8Array([0,0,0,0,n(1)].flat()),children:[{type:"url ",contents:new Uint8Array([0,0,0,F("",!0)].flat())}]}]},Y={type:"stbl",children:[{type:"stsd",contents:new Uint8Array([0,0,0,0,n(1)].flat()),children:[{type:"avc1",contents:new Uint8Array([Array(6).fill(0),0,0,0,0,0,0,Array(12).fill(0),C(i(this,p).video.width),C(i(this,p).video.height),n(4718592),n(4718592),n(0),C(1),Array(32).fill(0),C(24),oe(65535)].flat()),children:[{type:"avcC",contents:i(this,M)}]}]},a,d,I,X,W]},Z={type:"mdia",children:[j,q,{type:"minf",children:[J,Q,Y]}]},$={type:"trak",children:[{type:"tkhd",contents:new Uint8Array([0,0,0,3,n(Math.floor(Date.now()/1e3)+2082848400),n(Math.floor(Date.now()/1e3)+2082848400),n(1),n(0),n(E),Array(8).fill(0),0,0,0,0,G(0),0,0,[65536,0,0,0,65536,0,0,0,1073741824].flatMap(n),z(i(this,p).video.width),z(i(this,p).video.height)].flat())},Z]},ee={type:"moov",children:[{type:"mvhd",contents:new Uint8Array([0,0,0,0,n(Math.floor(Date.now()/1e3)+2082848400),n(Math.floor(Date.now()/1e3)+2082848400),n(1e3),n(E),z(1),G(1),Array(10).fill(0),[65536,0,0,0,65536,0,0,0,1073741824].flatMap(n),Array(24).fill(0),n(2)].flat())},$]};i(this,h).writeBox(ee)};var C=s=>{let e=new Uint8Array(2);return new DataView(e.buffer).setUint16(0,s,!1),[...e]},oe=s=>{let e=new Uint8Array(2);return new DataView(e.buffer).setInt16(0,s,!1),[...e]},n=s=>{let e=new Uint8Array(4);return new DataView(e.buffer).setUint32(0,s,!1),[...e]},G=s=>{let e=new Uint8Array(2),t=new DataView(e.buffer);return t.setUint8(0,s),t.setUint8(1,s<<8),[...e]},z=s=>{let e=new Uint8Array(4),t=new DataView(e.buffer);return t.setUint16(0,s,!1),t.setUint16(2,s<<16,!1),[...e]},F=(s,e=!1)=>{let t=Array(s.length).fill(null).map((r,a)=>s.charCodeAt(a));return e&&t.push(0),t},g=(s,e)=>Math.floor(s*e);var w,T,D=class{constructor(){this.pos=0;l(this,w,new Uint8Array(8));l(this,T,new DataView(i(this,w).buffer));this.offsets=new WeakMap}writeU32(e){i(this,T).setUint32(0,e,!1),this.write(i(this,w).subarray(0,4))}writeAscii(e){for(let t=0;t<e.length;t++)i(this,T).setUint8(t%8,e.charCodeAt(t)),t%8===7&&this.write(i(this,w));e.length%8!==0&&this.write(i(this,w).subarray(0,e.length%8))}writeBox(e){var t,r;if(this.offsets.set(e,this.pos),e.contents&&!e.children)this.writeU32((t=e.size)!=null?t:e.contents.byteLength+8),this.writeAscii(e.type),this.write(e.contents);else{let a=this.pos;if(this.pos+=4,this.writeAscii(e.type),e.contents&&this.write(e.contents),e.children)for(let I of e.children)this.writeBox(I);let d=this.pos,S=(r=e.size)!=null?r:d-a;this.pos=a,this.writeU32(S),this.pos=d}}patchBox(e){let t=this.pos;this.pos=this.offsets.get(e),this.writeBox(e),this.pos=t}};w=new WeakMap,T=new WeakMap;var c,B,k=class extends D{constructor(){super();l(this,c,new ArrayBuffer(N(2,16)));l(this,B,new Uint8Array(i(this,c)))}ensureSize(t){let r=i(this,c).byteLength;for(;r<t;)r*=2;if(r===i(this,c).byteLength)return;let a=new ArrayBuffer(r),d=new Uint8Array(a);d.set(i(this,B),0),x(this,c,a),x(this,B,d)}write(t){this.ensureSize(this.pos+t.byteLength),i(this,B).set(t,this.pos),this.pos+=t.byteLength}seek(t){this.pos=t}finalize(){return this.ensureSize(this.pos),i(this,c).slice(0,this.pos)}};c=new WeakMap,B=new WeakMap;var le=P;return ae(he);})();
Mp4Muxer = Mp4Muxer.default;
if (typeof module === "object" && typeof module.exports === "object") module.exports = Mp4Muxer;
