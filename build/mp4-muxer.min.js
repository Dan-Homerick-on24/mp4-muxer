"use strict";var Mp4Muxer=(()=>{var Ee=Object.defineProperty;var rt=Object.getOwnPropertyDescriptor;var nt=Object.getOwnPropertyNames;var at=Object.prototype.hasOwnProperty;var ot=(t,e)=>{for(var s in e)Ee(t,s,{get:e[s],enumerable:!0})},ht=(t,e,s,r)=>{if(e&&typeof e=="object"||typeof e=="function")for(let n of nt(e))!at.call(t,n)&&n!==s&&Ee(t,n,{get:()=>e[n],enumerable:!(r=rt(e,n))||r.enumerable});return t};var lt=t=>ht(Ee({},"__esModule",{value:!0}),t);var _e=(t,e,s)=>{if(!e.has(t))throw TypeError("Cannot "+s)};var i=(t,e,s)=>(_e(t,e,"read from private field"),s?s.call(t):e.get(t)),m=(t,e,s)=>{if(e.has(t))throw TypeError("Cannot add the same private member more than once");e instanceof WeakSet?e.add(t):e.set(t,s)},b=(t,e,s,r)=>(_e(t,e,"write to private field"),r?r.call(t,s):e.set(t,s),s),je=(t,e,s,r)=>({set _(n){b(t,e,n,s)},get _(){return i(t,e,r)}}),d=(t,e,s)=>(_e(t,e,"access private method"),s);var si={};ot(si,{ArrayBufferTarget:()=>J,FileSystemWritableFileStreamTarget:()=>ee,Muxer:()=>we,StreamTarget:()=>F});var p=new Uint8Array(8),_=new DataView(p.buffer),A=t=>[(t%256+256)%256],c=t=>(_.setUint16(0,t,!1),[p[0],p[1]]),$e=t=>(_.setInt16(0,t,!1),[p[0],p[1]]),Ie=t=>(_.setUint32(0,t,!1),[p[1],p[2],p[3]]),o=t=>(_.setUint32(0,t,!1),[p[0],p[1],p[2],p[3]]),w=t=>(_.setUint32(0,Math.floor(t/2**32),!1),_.setUint32(4,t,!1),[p[0],p[1],p[2],p[3],p[4],p[5],p[6],p[7]]),pe=t=>(_.setInt16(0,2**8*t,!1),[p[0],p[1]]),O=t=>(_.setInt32(0,2**16*t,!1),[p[0],p[1],p[2],p[3]]),De=t=>(_.setInt32(0,2**30*t,!1),[p[0],p[1],p[2],p[3]]),z=(t,e=!1)=>{let s=Array(t.length).fill(null).map((r,n)=>t.charCodeAt(n));return e&&s.push(0),s},D=t=>t&&t[t.length-1],E=(t,e,s=!0)=>{let r=t*e;return s?Math.round(r):r},Me=t=>{let e=t*(Math.PI/180),s=Math.cos(e),r=Math.sin(e);return[s,r,0,-r,s,0,0,0,1]},We=Me(0),Pe=t=>[O(t[0]),O(t[1]),De(t[2]),O(t[3]),O(t[4]),De(t[5]),O(t[6]),O(t[7]),De(t[8])],X=t=>!t||typeof t!="object"?t:Array.isArray(t)?t.map(X):Object.fromEntries(Object.entries(t).map(([e,s])=>[e,X(s)]));var C=(t,e,s)=>({type:t,contents:e&&new Uint8Array(e.flat(10)),children:s}),T=(t,e,s,r,n)=>C(t,[A(e),Ie(s),r??[]],n),Xe=t=>t?C("ftyp",[z("isom"),o(0),z("iso4"),z("hvc1")]):C("ftyp",[z("isom"),o(0),z("isom"),z("avc1"),z("mp41")]),Te=t=>({type:"mdat",largeSize:t}),Ge=t=>({type:"free",size:t}),Z=(t,e,s=!1)=>C("moov",null,[ut(e,t),...t.map(r=>ft(r,e)),s?Lt(t):null]),ut=(t,e)=>{let s=E(Math.max(0,...e.filter(n=>n.samples.length>0).map(n=>D(n.samples).timestamp+D(n.samples).duration)),ce),r=Math.max(...e.map(n=>n.id))+1;return T("mvhd",1,0,[w(t),w(t),o(ce),w(s),O(1),pe(1),Array(10).fill(0),Pe(We),Array(24).fill(0),o(r)])},ft=(t,e)=>C("trak",null,[mt(t,e),dt(t,e)]),mt=(t,e)=>{let s=D(t.samples),r=E(s?s.timestamp+s.duration:0,ce);return T("tkhd",1,3,[w(e),w(e),o(t.id),o(0),w(r),Array(8).fill(0),c(0),c(0),pe(t.info.type==="audio"?1:0),c(0),Pe(Me(t.info.type==="video"?t.info.rotation:0)),O(t.info.type==="video"?t.info.width:0),O(t.info.type==="video"?t.info.height:0)])},dt=(t,e)=>C("mdia",null,[pt(t,e),ct(t.info.type==="video"?"vide":"soun"),Tt(t)]),pt=(t,e)=>{let s=D(t.samples),r=E(s?s.timestamp+s.duration:0,t.timescale);return T("mdhd",1,0,[w(e),w(e),o(t.timescale),w(r),c(21956),c(0)])},ct=t=>T("hdlr",0,0,[z("mhlr"),z(t),o(0),o(0),o(0),z("mp4-muxer-hdlr")]),Tt=t=>C("minf",null,[t.info.type==="video"?bt():Ct(),yt(),gt(t)]),bt=()=>T("vmhd",0,1,[c(0),c(0),c(0),c(0)]),Ct=()=>T("smhd",0,0,[c(0),c(0)]),yt=()=>C("dinf",null,[St()]),St=()=>T("dref",0,0,[o(1)],[xt()]),xt=()=>T("url ",0,1),gt=t=>C("stbl",null,[wt(t),_t(t),Dt(t),It(t),Mt(t),Pt(t)]),wt=t=>T("stsd",0,0,[o(1)],[t.info.type==="video"?vt(Gt[t.info.codec],t):zt(Kt[t.info.codec],t)]),vt=(t,e)=>C(t,[Array(6).fill(0),c(1),c(0),c(0),Array(12).fill(0),c(e.info.width),c(e.info.height),o(4718592),o(4718592),o(0),c(1),Array(32).fill(0),c(24),$e(65535)],[qt[e.info.codec](e)]),kt=t=>t.codecPrivate&&C("avcC",[...t.codecPrivate]),At=t=>t.codecPrivate&&C("hvcC",[...t.codecPrivate]),Bt=t=>t.codecPrivate&&C("vpcC",[...t.codecPrivate]),Ot=t=>t.codecPrivate&&C("av1C",[...t.codecPrivate]),zt=(t,e)=>C(t,[Array(6).fill(0),c(1),c(0),c(0),o(0),c(e.info.numberOfChannels),c(16),c(0),c(0),O(e.info.sampleRate)],[Qt[e.info.codec](e)]),Ut=t=>T("esds",0,0,[o(58753152),A(32+t.codecPrivate.byteLength),c(1),A(0),o(75530368),A(18+t.codecPrivate.byteLength),A(64),A(21),Ie(0),o(130071),o(130071),o(92307584),A(t.codecPrivate.byteLength),...t.codecPrivate,o(109084800),A(1),A(2)]),Et=t=>C("dOps",[A(0),A(t.info.numberOfChannels),c(3840),o(t.info.sampleRate),pe(0),A(0)]),_t=t=>T("stts",0,0,[o(t.timeToSampleTable.length),t.timeToSampleTable.map(e=>[o(e.sampleCount),o(e.sampleDelta)])]),Dt=t=>{if(t.samples.every(s=>s.type==="key"))return null;let e=[...t.samples.entries()].filter(([,s])=>s.type==="key");return T("stss",0,0,[o(e.length),e.map(([s])=>o(s+1))])},It=t=>T("stsc",0,0,[o(t.compactlyCodedChunkTable.length),t.compactlyCodedChunkTable.map(e=>[o(e.firstChunk),o(e.samplesPerChunk),o(1)])]),Mt=t=>T("stsz",0,0,[o(0),o(t.samples.length),t.samples.map(e=>o(e.size))]),Pt=t=>t.finalizedChunks.length>0&&D(t.finalizedChunks).offset>=2**32?T("co64",0,0,[o(t.finalizedChunks.length),t.finalizedChunks.map(e=>w(e.offset))]):T("stco",0,0,[o(t.finalizedChunks.length),t.finalizedChunks.map(e=>o(e.offset))]),Lt=t=>C("mvex",null,t.map(Rt)),Rt=t=>T("trex",0,0,[o(t.id),o(1),o(0),o(0),o(0)]),Le=(t,e)=>C("moof",null,[Vt(t),...e.map(Nt)]),Vt=t=>T("mfhd",0,0,[o(t)]),Nt=t=>C("traf",null,[Ft(t),$t(t),jt(t)]),Ft=t=>T("tfhd",0,1,[o(t.id),w(t.currentChunk.offset??0)]),Ht=t=>{let e=0,s=0,r=0,n=0,a=t.type==="delta";return s|=+a,e<<24|s<<16|r<<8|n},jt=t=>{let e=0;return e|=256,e|=512,e|=1024,T("trun",0,e,[o(t.currentChunk.samples.length),t.currentChunk.samples.map(s=>[o(s.timescaleUnitsToNextSample),o(s.size),o(Ht(s))])])},$t=t=>T("tfdt",1,0,[w(E(t.currentChunk.startTimestamp,t.timescale))]),qe=t=>C("mfra",null,[...t.map(Wt),Xt()]),Wt=(t,e)=>T("tfra",1,0,[o(t.id),o(63),o(t.finalizedChunks.length),t.finalizedChunks.map(r=>[w(E(r.startTimestamp,t.timescale)),w(r.moofOffset),o(e+1),o(1),o(1)])]),Xt=()=>T("mfro",0,0,[o(0)]),Gt={avc:"avc1",hevc:"hvc1",vp9:"vp09",av1:"av01"},qt={avc:kt,hevc:At,vp9:Bt,av1:Ot},Kt={aac:"mp4a",opus:"Opus"},Qt={aac:Ut,opus:Et};var J=class{constructor(){this.buffer=null}},F=class{constructor(e){this.options=e}},ee=class{constructor(e,s){this.stream=e;this.options=s}};var M,H,te=class{constructor(){this.pos=0;m(this,M,new Uint8Array(8));m(this,H,new DataView(i(this,M).buffer));this.offsets=new WeakMap}seek(e){this.pos=e}writeU32(e){i(this,H).setUint32(0,e,!1),this.write(i(this,M).subarray(0,4))}writeU64(e){i(this,H).setUint32(0,Math.floor(e/2**32),!1),i(this,H).setUint32(4,e,!1),this.write(i(this,M).subarray(0,8))}writeAscii(e){for(let s=0;s<e.length;s++)i(this,H).setUint8(s%8,e.charCodeAt(s)),s%8===7&&this.write(i(this,M));e.length%8!==0&&this.write(i(this,M).subarray(0,e.length%8))}writeBox(e){if(this.offsets.set(e,this.pos),e.contents&&!e.children)this.writeBoxHeader(e,e.size??e.contents.byteLength+8),this.write(e.contents);else{let s=this.pos;if(this.writeBoxHeader(e,0),e.contents&&this.write(e.contents),e.children)for(let a of e.children)a&&this.writeBox(a);let r=this.pos,n=e.size??r-s;this.seek(s),this.writeBoxHeader(e,n),this.seek(r)}}writeBoxHeader(e,s){this.writeU32(e.largeSize?1:s),this.writeAscii(e.type),e.largeSize&&this.writeU64(s)}measureBoxHeader(e){return 8+(e.largeSize?8:0)}patchBox(e){let s=this.pos;this.seek(this.offsets.get(e)),this.writeBox(e),this.seek(s)}measureBox(e){if(e.contents&&!e.children)return this.measureBoxHeader(e)+e.contents.byteLength;{let s=this.measureBoxHeader(e);if(e.contents&&(s+=e.contents.byteLength),e.children)for(let r of e.children)r&&(s+=this.measureBox(r));return s}}};M=new WeakMap,H=new WeakMap;var re,P,G,q,ne,Re,Ce=class extends te{constructor(s){super();m(this,ne);m(this,re,void 0);m(this,P,new ArrayBuffer(2**16));m(this,G,new Uint8Array(i(this,P)));m(this,q,0);b(this,re,s)}write(s){d(this,ne,Re).call(this,this.pos+s.byteLength),i(this,G).set(s,this.pos),this.pos+=s.byteLength,b(this,q,Math.max(i(this,q),this.pos))}finalize(){d(this,ne,Re).call(this,this.pos),i(this,re).buffer=i(this,P).slice(0,Math.max(i(this,q),this.pos))}};re=new WeakMap,P=new WeakMap,G=new WeakMap,q=new WeakMap,ne=new WeakSet,Re=function(s){let r=i(this,P).byteLength;for(;r<s;)r*=2;if(r===i(this,P).byteLength)return;let n=new ArrayBuffer(r),a=new Uint8Array(n);a.set(i(this,G),0),b(this,P,n),b(this,G,a)};var ae,L,ie=class extends te{constructor(s){super();m(this,ae,void 0);m(this,L,[]);b(this,ae,s)}write(s){i(this,L).push({data:s.slice(),start:this.pos}),this.pos+=s.byteLength}flush(){if(i(this,L).length===0)return;let s=[],r=[...i(this,L)].sort((n,a)=>n.start-a.start);s.push({start:r[0].start,size:r[0].data.byteLength});for(let n=1;n<r.length;n++){let a=s[s.length-1],h=r[n];h.start<=a.start+a.size?a.size=Math.max(a.size,h.start+h.data.byteLength-a.start):s.push({start:h.start,size:h.data.byteLength})}for(let n of s){n.data=new Uint8Array(n.size);for(let a of i(this,L))n.start<=a.start&&a.start<n.start+n.size&&n.data.set(a.data,a.start-n.start);i(this,ae).options.onData?.(n.data,n.start)}i(this,L).length=0}finalize(){}};ae=new WeakMap,L=new WeakMap;var Yt=2**24,Zt=2,oe,B,v,he,Ve,Se,Ke,xe,Qe,K,be,se=class extends te{constructor(s){super();m(this,he);m(this,Se);m(this,xe);m(this,K);m(this,oe,void 0);m(this,B,void 0);m(this,v,[]);if(b(this,oe,s),b(this,B,s.options?.chunkSize??Yt),!Number.isInteger(i(this,B))||i(this,B)<2**10)throw new Error("Invalid StreamTarget options: chunkSize must be an integer not smaller than 1024.")}write(s){d(this,he,Ve).call(this,s,this.pos),d(this,K,be).call(this),this.pos+=s.byteLength}finalize(){d(this,K,be).call(this,!0)}};oe=new WeakMap,B=new WeakMap,v=new WeakMap,he=new WeakSet,Ve=function(s,r){let n=i(this,v).findIndex(y=>y.start<=r&&r<y.start+i(this,B));n===-1&&(n=d(this,xe,Qe).call(this,r));let a=i(this,v)[n],h=r-a.start,l=s.subarray(0,Math.min(i(this,B)-h,s.byteLength));a.data.set(l,h);let g={start:h,end:h+l.byteLength};if(d(this,Se,Ke).call(this,a,g),a.written[0].start===0&&a.written[0].end===i(this,B)&&(a.shouldFlush=!0),i(this,v).length>Zt){for(let y=0;y<i(this,v).length-1;y++)i(this,v)[y].shouldFlush=!0;d(this,K,be).call(this)}l.byteLength<s.byteLength&&d(this,he,Ve).call(this,s.subarray(l.byteLength),r+l.byteLength)},Se=new WeakSet,Ke=function(s,r){let n=0,a=s.written.length-1,h=-1;for(;n<=a;){let l=Math.floor(n+(a-n+1)/2);s.written[l].start<=r.start?(n=l+1,h=l):a=l-1}for(s.written.splice(h+1,0,r),(h===-1||s.written[h].end<r.start)&&h++;h<s.written.length-1&&s.written[h].end>=s.written[h+1].start;)s.written[h].end=Math.max(s.written[h].end,s.written[h+1].end),s.written.splice(h+1,1)},xe=new WeakSet,Qe=function(s){let n={start:Math.floor(s/i(this,B))*i(this,B),data:new Uint8Array(i(this,B)),written:[],shouldFlush:!1};return i(this,v).push(n),i(this,v).sort((a,h)=>a.start-h.start),i(this,v).indexOf(n)},K=new WeakSet,be=function(s=!1){for(let r=0;r<i(this,v).length;r++){let n=i(this,v)[r];if(!(!n.shouldFlush&&!s)){for(let a of n.written)i(this,oe).options.onData?.(n.data.subarray(a.start,a.end),n.start+a.start);i(this,v).splice(r--,1)}}};var ye=class extends se{constructor(e){super(new F({onData:(s,r)=>e.stream.write({type:"write",data:s,position:r}),chunkSize:e.options?.chunkSize}))}};var ce=1e3,Jt=["avc","hevc","vp9","av1"],ei=["aac","opus"],ti=2082844800,ii=["strict","offset"],f,u,ue,k,S,x,j,$,ve,R,V,Q,ke,Ye,Ae,Ze,Be,Je,Oe,et,ze,tt,fe,Ne,U,I,Ue,it,Y,ge,me,Fe,W,le,de,He,we=class{constructor(e){m(this,ke);m(this,Ae);m(this,Be);m(this,Oe);m(this,ze);m(this,fe);m(this,U);m(this,Ue);m(this,Y);m(this,me);m(this,W);m(this,de);m(this,f,void 0);m(this,u,void 0);m(this,ue,void 0);m(this,k,void 0);m(this,S,null);m(this,x,null);m(this,j,Math.floor(Date.now()/1e3)+ti);m(this,$,[]);m(this,ve,1);m(this,R,[]);m(this,V,[]);m(this,Q,!1);if(d(this,ke,Ye).call(this,e),e.video=X(e.video),e.audio=X(e.audio),e.fastStart=X(e.fastStart),this.target=e.target,b(this,f,{firstTimestampBehavior:"strict",...e}),e.target instanceof J)b(this,u,new Ce(e.target));else if(e.target instanceof F)b(this,u,e.target.options?.chunked?new se(e.target):new ie(e.target));else if(e.target instanceof ee)b(this,u,new ye(e.target));else throw new Error(`Invalid target: ${e.target}`);d(this,Oe,et).call(this),d(this,Ae,Ze).call(this)}addVideoChunk(e,s,r){let n=new Uint8Array(e.byteLength);e.copyTo(n),this.addVideoChunkRaw(n,e.type,r??e.timestamp,e.duration,s)}addVideoChunkRaw(e,s,r,n,a){if(d(this,de,He).call(this),!i(this,f).video)throw new Error("No video track declared.");if(typeof i(this,f).fastStart=="object"&&i(this,S).samples.length===i(this,f).fastStart.expectedVideoChunks)throw new Error(`Cannot add more video chunks than specified in 'fastStart' (${i(this,f).fastStart.expectedVideoChunks}).`);let h=d(this,fe,Ne).call(this,i(this,S),e,s,r,n,a);if(i(this,f).fastStart==="fragmented"&&i(this,x)){for(;i(this,V).length>0&&i(this,V)[0].timestamp<=h.timestamp;){let l=i(this,V).shift();d(this,U,I).call(this,i(this,x),l)}h.timestamp<=i(this,x).lastTimestamp?d(this,U,I).call(this,i(this,S),h):i(this,R).push(h)}else d(this,U,I).call(this,i(this,S),h)}addAudioChunk(e,s,r){let n=new Uint8Array(e.byteLength);e.copyTo(n),this.addAudioChunkRaw(n,e.type,r??e.timestamp,e.duration,s)}addAudioChunkRaw(e,s,r,n,a){if(d(this,de,He).call(this),!i(this,f).audio)throw new Error("No audio track declared.");if(typeof i(this,f).fastStart=="object"&&i(this,x).samples.length===i(this,f).fastStart.expectedAudioChunks)throw new Error(`Cannot add more audio chunks than specified in 'fastStart' (${i(this,f).fastStart.expectedAudioChunks}).`);let h=d(this,fe,Ne).call(this,i(this,x),e,s,r,n,a);if(i(this,f).fastStart==="fragmented"&&i(this,S)){for(;i(this,R).length>0&&i(this,R)[0].timestamp<=h.timestamp;){let l=i(this,R).shift();d(this,U,I).call(this,i(this,S),l)}h.timestamp<=i(this,S).lastTimestamp?d(this,U,I).call(this,i(this,x),h):i(this,V).push(h)}else d(this,U,I).call(this,i(this,x),h)}finalize(){if(i(this,Q))throw new Error("Cannot finalize a muxer more than once.");if(i(this,f).fastStart==="fragmented"){for(let s of i(this,R))d(this,U,I).call(this,i(this,S),s);for(let s of i(this,V))d(this,U,I).call(this,i(this,x),s);d(this,me,Fe).call(this)}else i(this,S)&&d(this,Y,ge).call(this,i(this,S)),i(this,x)&&d(this,Y,ge).call(this,i(this,x));let e=[i(this,S),i(this,x)].filter(Boolean);if(i(this,f).fastStart==="in-memory"){let s;for(let n=0;n<2;n++){let a=Z(e,i(this,j)),h=i(this,u).measureBox(a);s=i(this,u).measureBox(i(this,k));let l=i(this,u).pos+h+s;for(let g of i(this,$)){g.offset=l;for(let{data:y}of g.samples)l+=y.byteLength,s+=y.byteLength}if(l<2**32)break;s>=2**32&&(i(this,k).largeSize=!0)}let r=Z(e,i(this,j));i(this,u).writeBox(r),i(this,k).size=s,i(this,u).writeBox(i(this,k));for(let n of i(this,$))for(let a of n.samples)i(this,u).write(a.data),a.data=null}else if(i(this,f).fastStart==="fragmented"){let s=i(this,u).pos,r=qe(e);i(this,u).writeBox(r);let n=i(this,u).pos-s;i(this,u).seek(i(this,u).pos-4),i(this,u).writeU32(n)}else{let s=i(this,u).offsets.get(i(this,k)),r=i(this,u).pos-s;i(this,k).size=r,i(this,k).largeSize=r>=2**32,i(this,u).patchBox(i(this,k));let n=Z(e,i(this,j));if(typeof i(this,f).fastStart=="object"){i(this,u).seek(i(this,ue)),i(this,u).writeBox(n);let a=s-i(this,u).pos;i(this,u).writeBox(Ge(a))}else i(this,u).writeBox(n)}d(this,W,le).call(this),i(this,u).finalize(),b(this,Q,!0)}};f=new WeakMap,u=new WeakMap,ue=new WeakMap,k=new WeakMap,S=new WeakMap,x=new WeakMap,j=new WeakMap,$=new WeakMap,ve=new WeakMap,R=new WeakMap,V=new WeakMap,Q=new WeakMap,ke=new WeakSet,Ye=function(e){if(e.video){if(!Jt.includes(e.video.codec))throw new Error(`Unsupported video codec: ${e.video.codec}`);if(e.video.rotation!==void 0&&![0,90,180,270].includes(e.video.rotation))throw new Error(`Invalid video rotation: ${e.video.rotation}. Has to be 0, 90, 180 or 270.`)}if(e.audio&&!ei.includes(e.audio.codec))throw new Error(`Unsupported audio codec: ${e.audio.codec}`);if(e.firstTimestampBehavior&&!ii.includes(e.firstTimestampBehavior))throw new Error(`Invalid first timestamp behavior: ${e.firstTimestampBehavior}`);if(typeof e.fastStart=="object"){if(e.video&&e.fastStart.expectedVideoChunks===void 0)throw new Error("'fastStart' is an object but is missing property 'expectedVideoChunks'.");if(e.audio&&e.fastStart.expectedAudioChunks===void 0)throw new Error("'fastStart' is an object but is missing property 'expectedAudioChunks'.")}else if(![!1,"in-memory","fragmented"].includes(e.fastStart))throw new Error("'fastStart' option must be false, 'in-memory', 'fragmented' or an object.")},Ae=new WeakSet,Ze=function(){let e=i(this,f).video?.codec==="hevc";if(i(this,u).writeBox(Xe(e)),b(this,ue,i(this,u).pos),i(this,f).fastStart==="in-memory")b(this,k,Te(!1));else if(i(this,f).fastStart!=="fragmented"){if(typeof i(this,f).fastStart=="object"){let s=d(this,Be,Je).call(this);i(this,u).seek(i(this,u).pos+s)}b(this,k,Te(!0)),i(this,u).writeBox(i(this,k))}d(this,W,le).call(this)},Be=new WeakSet,Je=function(){if(typeof i(this,f).fastStart!="object")return;let e=0,s=[i(this,f).fastStart.expectedVideoChunks,i(this,f).fastStart.expectedAudioChunks];for(let r of s)r&&(e+=(4+4)*Math.ceil(2/3*r),e+=4*r,e+=(4+4+4)*Math.ceil(2/3*r),e+=4*r,e+=8*r);return e+=4096,e},Oe=new WeakSet,et=function(){if(i(this,f).video&&b(this,S,{id:1,info:{type:"video",codec:i(this,f).video.codec,width:i(this,f).video.width,height:i(this,f).video.height,rotation:i(this,f).video.rotation??0},timescale:720,codecPrivate:new Uint8Array(0),samples:[],finalizedChunks:[],currentChunk:null,firstTimestamp:void 0,lastTimestamp:-1,timeToSampleTable:[],lastTimescaleUnits:null,lastSample:null,compactlyCodedChunkTable:[]}),i(this,f).audio){let e=d(this,ze,tt).call(this,2,i(this,f).audio.sampleRate,i(this,f).audio.numberOfChannels);b(this,x,{id:i(this,f).video?2:1,info:{type:"audio",codec:i(this,f).audio.codec,numberOfChannels:i(this,f).audio.numberOfChannels,sampleRate:i(this,f).audio.sampleRate},timescale:i(this,f).audio.sampleRate,codecPrivate:e,samples:[],finalizedChunks:[],currentChunk:null,firstTimestamp:void 0,lastTimestamp:-1,timeToSampleTable:[],lastTimescaleUnits:null,lastSample:null,compactlyCodedChunkTable:[]})}},ze=new WeakSet,tt=function(e,s,r){let a=[96e3,88200,64e3,48e3,44100,32e3,24e3,22050,16e3,12e3,11025,8e3,7350].indexOf(s),h=r,l="";l+=e.toString(2).padStart(5,"0"),l+=a.toString(2).padStart(4,"0"),a===15&&(l+=s.toString(2).padStart(24,"0")),l+=h.toString(2).padStart(4,"0");let g=Math.ceil(l.length/8)*8;l=l.padEnd(g,"0");let y=new Uint8Array(l.length/8);for(let N=0;N<l.length;N+=8)y[N/8]=parseInt(l.slice(N,N+8),2);return y},fe=new WeakSet,Ne=function(e,s,r,n,a,h){let l=n/1e6,g=a/1e6;return l=d(this,Ue,it).call(this,l,e),h?.decoderConfig?.description&&(e.codecPrivate=new Uint8Array(h.decoderConfig.description)),{timestamp:l,duration:g,data:s,size:s.byteLength,type:r,timescaleUnitsToNextSample:E(g,e.timescale)}},U=new WeakSet,I=function(e,s){if(i(this,f).fastStart!=="fragmented"&&e.samples.push(s),e.lastTimescaleUnits!==null){let n=E(s.timestamp,e.timescale,!1),a=Math.round(n-e.lastTimescaleUnits);if(e.lastTimescaleUnits+=a,e.lastSample.timescaleUnitsToNextSample=a,i(this,f).fastStart!=="fragmented"){let h=D(e.timeToSampleTable);h.sampleCount===1?(h.sampleDelta=a,h.sampleCount++):h.sampleDelta===a?h.sampleCount++:(h.sampleCount--,e.timeToSampleTable.push({sampleCount:2,sampleDelta:a}))}}else e.lastTimescaleUnits=0,i(this,f).fastStart!=="fragmented"&&e.timeToSampleTable.push({sampleCount:1,sampleDelta:E(s.duration,e.timescale)});e.lastSample=s;let r=!1;if(!e.currentChunk)r=!0;else{let n=s.timestamp-e.currentChunk.startTimestamp;if(i(this,f).fastStart==="fragmented"){let a=i(this,S)??i(this,x);e===a&&s.type==="key"&&n>=1&&(r=!0,d(this,me,Fe).call(this))}else r=n>=.5}r&&(e.currentChunk&&d(this,Y,ge).call(this,e),e.currentChunk={startTimestamp:s.timestamp,samples:[]}),e.currentChunk.samples.push(s)},Ue=new WeakSet,it=function(e,s){if(i(this,f).firstTimestampBehavior==="strict"&&s.lastTimestamp===-1&&e!==0)throw new Error(`The first chunk for your media track must have a timestamp of 0 (received ${e}). Non-zero first timestamps are often caused by directly piping frames or audio data from a MediaStreamTrack into the encoder. Their timestamps are typically relative to the age of the document, which is probably what you want.

If you want to offset all timestamps of a track such that the first one is zero, set firstTimestampBehavior: 'offset' in the options.
`);if(i(this,f).firstTimestampBehavior==="offset"&&(s.firstTimestamp===void 0&&(s.firstTimestamp=e),e-=s.firstTimestamp),e<s.lastTimestamp)throw new Error(`Timestamps must be monotonically increasing (went from ${s.lastTimestamp*1e6} to ${e*1e6}).`);return s.lastTimestamp=e,e},Y=new WeakSet,ge=function(e){if(i(this,f).fastStart==="fragmented")throw new Error("Can't finalize individual chunks 'fastStart' is set to 'fragmented'.");if(e.currentChunk){if(e.finalizedChunks.push(e.currentChunk),i(this,$).push(e.currentChunk),(e.compactlyCodedChunkTable.length===0||D(e.compactlyCodedChunkTable).samplesPerChunk!==e.currentChunk.samples.length)&&e.compactlyCodedChunkTable.push({firstChunk:e.finalizedChunks.length,samplesPerChunk:e.currentChunk.samples.length}),i(this,f).fastStart==="in-memory"){e.currentChunk.offset=0;return}e.currentChunk.offset=i(this,u).pos;for(let s of e.currentChunk.samples)i(this,u).write(s.data),s.data=null;d(this,W,le).call(this)}},me=new WeakSet,Fe=function(){if(i(this,f).fastStart!=="fragmented")throw new Error("Can't finalize a fragment unless 'fastStart' is set to 'fragmented'.");let e=[i(this,S),i(this,x)].filter(l=>l&&l.currentChunk);if(e.length===0)return;let s=je(this,ve)._++;if(s===1){let l=Z(e,i(this,j),!0);i(this,u).writeBox(l)}let r=i(this,u).pos,n=Le(s,e);i(this,u).writeBox(n);{let l=Te(!1),g=0;for(let N of e)for(let st of N.currentChunk.samples)g+=st.size;let y=i(this,u).measureBox(l)+g;y>=2**32&&(l.largeSize=!0,y=i(this,u).measureBox(l)+g),l.size=y,i(this,u).writeBox(l)}for(let l of e){l.currentChunk.offset=i(this,u).pos,l.currentChunk.moofOffset=r;for(let g of l.currentChunk.samples)i(this,u).write(g.data),g.data=null}let a=i(this,u).pos;i(this,u).seek(i(this,u).offsets.get(n));let h=Le(s,e);i(this,u).writeBox(h),i(this,u).seek(a);for(let l of e)l.finalizedChunks.push(l.currentChunk),i(this,$).push(l.currentChunk),l.currentChunk=null;d(this,W,le).call(this)},W=new WeakSet,le=function(){i(this,u)instanceof ie&&i(this,u).flush()},de=new WeakSet,He=function(){if(i(this,Q))throw new Error("Cannot add new video or audio chunks after the file has been finalized.")};return lt(si);})();
if (typeof module === "object" && typeof module.exports === "object") Object.assign(module.exports, Mp4Muxer)
