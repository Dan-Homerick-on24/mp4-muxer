"use strict";var Mp4Muxer=(()=>{var W=Object.defineProperty;var De=Object.getOwnPropertyDescriptor;var Te=Object.getOwnPropertyNames,ue=Object.getOwnPropertySymbols;var de=Object.prototype.hasOwnProperty,ze=Object.prototype.propertyIsEnumerable;var K=Math.pow,fe=(n,e,t)=>e in n?W(n,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):n[e]=t,me=(n,e)=>{for(var t in e||={})de.call(e,t)&&fe(n,t,e[t]);if(ue)for(var t of ue(e))ze.call(e,t)&&fe(n,t,e[t]);return n};var Fe=(n,e)=>{for(var t in e)W(n,t,{get:e[t],enumerable:!0})},Ie=(n,e,t,r)=>{if(e&&typeof e=="object"||typeof e=="function")for(let s of Te(e))!de.call(n,s)&&s!==t&&W(n,s,{get:()=>e[s],enumerable:!(r=De(e,s))||r.enumerable});return n};var He=n=>Ie(W({},"__esModule",{value:!0}),n);var te=(n,e,t)=>{if(!e.has(n))throw TypeError("Cannot "+t)};var i=(n,e,t)=>(te(n,e,"read from private field"),t?t.call(n):e.get(n)),h=(n,e,t)=>{if(e.has(n))throw TypeError("Cannot add the same private member more than once");e instanceof WeakSet?e.add(n):e.set(n,t)},c=(n,e,t,r)=>(te(n,e,"write to private field"),r?r.call(n,t):e.set(n,t),t);var p=(n,e,t)=>(te(n,e,"access private method"),t);var Ve={};Fe(Ve,{default:()=>_e});var k=n=>{let e=new Uint8Array(2);return new DataView(e.buffer).setUint16(0,n,!1),[...e]},pe=n=>{let e=new Uint8Array(2);return new DataView(e.buffer).setInt16(0,n,!1),[...e]},o=n=>{let e=new Uint8Array(4);return new DataView(e.buffer).setUint32(0,n,!1),[...e]},ie=n=>{let e=new Uint8Array(2),t=new DataView(e.buffer);return t.setUint8(0,n),t.setUint8(1,n<<8),[...e]},H=n=>{let e=new Uint8Array(4),t=new DataView(e.buffer);return t.setUint16(0,n,!1),t.setUint16(2,n<<16,!1),[...e]},G=(n,e=!1)=>{let t=Array(n.length).fill(null).map((r,s)=>n.charCodeAt(s));return e&&t.push(0),t},S=(n,e)=>Math.floor(n*e),E=n=>n&&n[n.length-1];var C,U,L=class{constructor(){this.pos=0;h(this,C,new Uint8Array(8));h(this,U,new DataView(i(this,C).buffer));this.offsets=new WeakMap}writeU32(e){i(this,U).setUint32(0,e,!1),this.write(i(this,C).subarray(0,4))}writeU64(e){i(this,U).setUint32(0,Math.floor(e/K(2,32)),!1),i(this,U).setUint32(4,e,!1),this.write(i(this,C).subarray(0,8))}writeAscii(e){for(let t=0;t<e.length;t++)i(this,U).setUint8(t%8,e.charCodeAt(t)),t%8===7&&this.write(i(this,C));e.length%8!==0&&this.write(i(this,C).subarray(0,e.length%8))}writeBox(e){var t,r;if(this.offsets.set(e,this.pos),e.contents&&!e.children)this.writeBoxHeader(e,(t=e.size)!=null?t:e.contents.byteLength+8),this.write(e.contents);else{let s=this.pos;if(this.writeBoxHeader(e,0),e.contents&&this.write(e.contents),e.children)for(let l of e.children)l&&this.writeBox(l);let a=this.pos,u=(r=e.size)!=null?r:a-s;this.pos=s,this.writeBoxHeader(e,u),this.pos=a}}writeBoxHeader(e,t){this.writeU32(e.largeSize?1:t),this.writeAscii(e.type),e.largeSize&&this.writeU64(t)}patchBox(e){let t=this.pos;this.pos=this.offsets.get(e),this.writeBox(e),this.pos=t}};C=new WeakMap,U=new WeakMap;var A,D,X=class extends L{constructor(){super();h(this,A,new ArrayBuffer(K(2,16)));h(this,D,new Uint8Array(i(this,A)))}ensureSize(t){let r=i(this,A).byteLength;for(;r<t;)r*=2;if(r===i(this,A).byteLength)return;let s=new ArrayBuffer(r),a=new Uint8Array(s);a.set(i(this,D),0),c(this,A,s),c(this,D,a)}write(t){this.ensureSize(this.pos+t.byteLength),i(this,D).set(t,this.pos),this.pos+=t.byteLength}seek(t){this.pos=t}finalize(){return this.ensureSize(this.pos),i(this,A).slice(0,this.pos)}};A=new WeakMap,D=new WeakMap;var B=K(2,24),Ee=2,O,x,$=class extends L{constructor(t){super();h(this,O,void 0);h(this,x,[]);c(this,O,t)}write(t){this.writeDataIntoChunks(t,this.pos),this.flushChunks(),this.pos+=t.byteLength}writeDataIntoChunks(t,r){let s=i(this,x).findIndex(w=>w.start<=r&&r<w.start+B);s===-1&&(s=this.createChunk(r));let a=i(this,x)[s],u=r-a.start,l=t.subarray(0,Math.min(B-u,t.byteLength));a.data.set(l,u);let M={start:u,end:u+l.byteLength};if(Le(a,M),a.written[0].start===0&&a.written[0].end===B&&(a.shouldFlush=!0),i(this,x).length>Ee){for(let w=0;w<i(this,x).length-1;w++)i(this,x)[w].shouldFlush=!0;this.flushChunks()}l.byteLength<t.byteLength&&this.writeDataIntoChunks(t.subarray(l.byteLength),r+l.byteLength)}createChunk(t){let s={start:Math.floor(t/B)*B,data:new Uint8Array(B),written:[],shouldFlush:!1};return i(this,x).push(s),i(this,x).sort((a,u)=>a.start-u.start),i(this,x).indexOf(s)}flushChunks(t=!1){for(let r=0;r<i(this,x).length;r++){let s=i(this,x)[r];if(!(!s.shouldFlush&&!t)){for(let a of s.written)i(this,O).write({type:"write",data:s.data.subarray(a.start,a.end),position:s.start+a.start});i(this,x).splice(r--,1)}}}seek(t){this.pos=t}finalize(){this.flushChunks(!0)}};O=new WeakMap,x=new WeakMap;var Le=(n,e)=>{let t=0,r=n.written.length-1,s=-1;for(;t<=r;){let a=Math.floor(t+(r-t+1)/2);n.written[a].start<=e.start?(t=a+1,s=a):r=a-1}for(n.written.splice(s+1,0,e),(s===-1||n.written[s].end<e.start)&&s++;s<n.written.length-1&&n.written[s].end>=n.written[s+1].start;)n.written[s].end=Math.max(n.written[s].end,n.written[s+1].end),n.written.splice(s+1,1)},g,P,Z=class extends L{constructor(t){super();h(this,g,[]);h(this,P,void 0);c(this,P,t)}write(t){i(this,g).push({data:t.slice(),start:this.pos}),this.pos+=t.byteLength}seek(t){this.pos=t}flush(t){if(i(this,g).length===0)return;let r=[],s=[...i(this,g)].sort((a,u)=>a.start-u.start);r.push({start:s[0].start,size:s[0].data.byteLength});for(let a=1;a<s.length;a++){let u=r[r.length-1],l=s[a];l.start<=u.start+u.size?u.size=Math.max(u.size,l.start+l.data.byteLength-u.start):r.push({start:l.start,size:l.data.byteLength})}for(let a of r){a.data=new Uint8Array(a.size);for(let l of i(this,g))a.start<=l.start&&l.start<a.start+a.size&&a.data.set(l.data,l.start-a.start);let u=t&&a===r[r.length-1];i(this,P).call(this,a.data,a.start,u)}i(this,g).length=0}};g=new WeakMap,P=new WeakMap;var T=2082848400,Oe=5e5,Pe=["strict","offset","permissive"],xe=1e3,d,m,v,y,b,q,J,ce,Q,we,Y,ye,_,re,z,j,V,se,ee,be,R,ae,ne=class{constructor(e){h(this,J);h(this,Q);h(this,Y);h(this,_);h(this,z);h(this,V);h(this,ee);h(this,R);h(this,d,void 0);h(this,m,void 0);h(this,v,void 0);h(this,y,null);h(this,b,null);h(this,q,!1);if(p(this,J,ce).call(this,e),c(this,d,me({firstTimestampBehavior:"strict"},e)),e.target==="buffer")c(this,m,new X);else if(e.target instanceof FileSystemWritableFileStream)c(this,m,new $(e.target));else if(typeof e.target=="function")c(this,m,new Z(e.target));else throw new Error(`Invalid target: ${e.target}`);p(this,Q,we).call(this),p(this,Y,ye).call(this)}addVideoChunk(e,t){if(p(this,V,se).call(this),!i(this,d).video)throw new Error("No video track declared.");p(this,_,re).call(this,i(this,y),e,t)}addAudioChunk(e,t){if(p(this,V,se).call(this),!i(this,d).audio)throw new Error("No audio track declared.");p(this,_,re).call(this,i(this,b),e,t)}finalize(){i(this,y)&&p(this,z,j).call(this,i(this,y)),i(this,b)&&p(this,z,j).call(this,i(this,b));let e=i(this,m).offsets.get(i(this,v)),t=i(this,m).pos-e;i(this,v).size=t,i(this,m).patchBox(i(this,v));let r=p(this,ee,be).call(this);return i(this,m).writeBox(r),i(this,m).finalize()}};d=new WeakMap,m=new WeakMap,v=new WeakMap,y=new WeakMap,b=new WeakMap,q=new WeakMap,J=new WeakSet,ce=function(e){if(e.firstTimestampBehavior&&!Pe.includes(e.firstTimestampBehavior))throw new Error(`Invalid first timestamp behavior: ${e.firstTimestampBehavior}`)},Q=new WeakSet,we=function(){i(this,m).writeBox({type:"ftyp",contents:new Uint8Array([109,112,52,50,0,0,0,0,105,115,111,109,97,118,99,49,109,112,52,50,109,112,52,49])}),c(this,v,{type:"mdat",largeSize:!0}),i(this,m).writeBox(i(this,v))},Y=new WeakSet,ye=function(){i(this,d).video&&c(this,y,{info:{type:"video",width:i(this,d).video.width,height:i(this,d).video.height},codecPrivate:null,samples:[],writtenChunks:[],currentChunk:null}),i(this,d).audio&&c(this,b,{info:{type:"audio",numberOfChannels:i(this,d).audio.numberOfChannels,sampleRate:i(this,d).audio.sampleRate,bitDepth:i(this,d).audio.bitDepth&&16},codecPrivate:null,samples:[],writtenChunks:[],currentChunk:null})},_=new WeakSet,re=function(e,t,r){var a;(!e.currentChunk||t.timestamp-e.currentChunk.startTimestamp>=Oe)&&(e.currentChunk&&p(this,z,j).call(this,e),e.currentChunk={startTimestamp:t.timestamp,sampleData:[],sampleCount:0});let s=new Uint8Array(t.byteLength);t.copyTo(s),e.currentChunk.sampleData.push(s),e.currentChunk.sampleCount++,(a=r.decoderConfig)!=null&&a.description&&(e.codecPrivate=new Uint8Array(r.decoderConfig.description)),e.samples.push({timestamp:t.timestamp/1e6,size:s.byteLength})},z=new WeakSet,j=function(e){e.currentChunk.offset=i(this,m).pos;for(let t of e.currentChunk.sampleData)i(this,m).write(t);e.currentChunk.sampleData=null,e.writtenChunks.push(e.currentChunk)},V=new WeakSet,se=function(){if(i(this,q))throw new Error("Cannot add new video or audio chunks after the file has been finalized.")},ee=new WeakSet,be=function(){var u,l,M,w,N,F;let e=S(Math.max((M=(l=E((u=i(this,y))==null?void 0:u.samples))==null?void 0:l.timestamp)!=null?M:0,(F=(N=E((w=i(this,b))==null?void 0:w.samples))==null?void 0:N.timestamp)!=null?F:0),xe),t=i(this,y)&&p(this,R,ae).call(this,i(this,y)),r=i(this,b)&&p(this,R,ae).call(this,i(this,b)),s={type:"mvhd",contents:new Uint8Array([0,0,0,0,o(Math.floor(Date.now()/1e3)+T),o(Math.floor(Date.now()/1e3)+T),o(xe),o(e),H(1),ie(1),Array(10).fill(0),[65536,0,0,0,65536,0,0,0,1073741824].flatMap(o),Array(24).fill(0),o(i(this,d).audio?3:2)].flat())};return{type:"moov",children:[s,t,r]}},R=new WeakSet,ae=function(e){var oe,le;let r=[],s=[];for(let f of e.samples){if(r.push(f),r.length===1)continue;let I=S(r[1].timestamp-r[0].timestamp,1e3);S(f.timestamp-r[r.length-2].timestamp,1e3)!==I&&(s.push({sampleCount:r.length-1,sampleDelta:I}),r=r.slice(-2))}s.push({sampleCount:r.length,sampleDelta:Math.floor(S(((le=(oe=r[1])==null?void 0:oe.timestamp)!=null?le:r[0].timestamp)-r[0].timestamp,1e3))});let a={type:"stts",contents:new Uint8Array([0,0,0,0,o(s.length),...s.flatMap(f=>[o(f.sampleCount),o(f.sampleDelta)])].flat())},u={type:"stss",contents:new Uint8Array([0,0,0,0,o(1),o(1)].flat())},l=e.writtenChunks.reduce((f,I,he)=>f.length===0||E(f).samplesPerChunk!==I.sampleCount?[...f,{firstChunk:he+1,samplesPerChunk:I.sampleCount}]:f,[]),M={type:"stsc",contents:new Uint8Array([0,0,0,0,o(l.length),...l.flatMap(f=>[o(f.firstChunk),o(f.samplesPerChunk),o(1)])].flat())},w={type:"stsz",contents:new Uint8Array([0,0,0,0,o(0),o(e.samples.length),e.samples.flatMap(f=>o(f.size))].flat())},N={type:"stco",contents:new Uint8Array([0,0,0,0,o(e.writtenChunks.length),e.writtenChunks.flatMap(f=>o(f.offset))].flat())},F=S(E(e.samples).timestamp,1e3),Ce={type:"mdhd",contents:new Uint8Array([0,0,0,0,o(Math.floor(Date.now()/1e3)+T),o(Math.floor(Date.now()/1e3)+T),o(1e3),o(F),85,196,0,0].flat())},Ae={type:"hdlr",contents:new Uint8Array([0,0,0,0,o(0),G(e.info.type==="video"?"vide":"soun"),Array(12).fill(0),G(e.info.type==="video"?"Video track":"Audio track",!0)].flat())},ge=e.info.type==="video"?{type:"vmhd",contents:new Uint8Array([0,0,0,1,0,0,0,0,0,0,0,0])}:{type:"smhd",contents:new Uint8Array([0,0,0,0,0,0,0,0])},ve={type:"dinf",children:[{type:"dref",contents:new Uint8Array([0,0,0,0,o(1)].flat()),children:[{type:"url ",contents:new Uint8Array([0,0,0,G("",!0)].flat())}]}]},ke={type:"stsd",contents:new Uint8Array([0,0,0,0,o(1)].flat()),children:[e.info.type==="video"?{type:"avc1",contents:new Uint8Array([Array(6).fill(0),0,0,0,0,0,0,Array(12).fill(0),k(i(this,d).video.width),k(i(this,d).video.height),o(4718592),o(4718592),o(0),k(1),Array(32).fill(0),k(24),pe(65535)].flat()),children:[{type:"avcC",contents:e.codecPrivate}]}:{type:"mp4a",contents:new Uint8Array([Array(6).fill(0),0,0,Array(8).fill(0),k(e.info.numberOfChannels),k(e.info.bitDepth),0,0,0,0,H(e.info.sampleRate)].flat()),children:[{type:"esds",contents:new Uint8Array([0,0,0,0,...e.codecPrivate])}]}]},Ue={type:"stbl",children:[ke,a,u,M,w,N]},Me={type:"minf",children:[ge,ve,Ue]},Se={type:"mdia",children:[Ce,Ae,Me]},Be={type:"tkhd",contents:new Uint8Array([0,0,0,3,o(Math.floor(Date.now()/1e3)+T),o(Math.floor(Date.now()/1e3)+T),o(e.info.type==="video"?1:2),o(0),o(F),Array(8).fill(0),0,0,0,0,ie(e.info.type==="audio"?1:0),0,0,[65536,0,0,0,65536,0,0,0,1073741824].flatMap(o),H(e.info.type==="video"?e.info.width:0),H(e.info.type==="video"?e.info.height:0)].flat())};return{type:"trak",children:[Be,Se]}};var _e=ne;return He(Ve);})();
Mp4Muxer = Mp4Muxer.default;
if (typeof module === "object" && typeof module.exports === "object") module.exports = Mp4Muxer;
