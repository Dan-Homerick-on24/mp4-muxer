"use strict";var Mp4Muxer=(()=>{var Le=Object.defineProperty;var mt=Object.getOwnPropertyDescriptor;var dt=Object.getOwnPropertyNames;var pt=Object.prototype.hasOwnProperty;var ct=(t,e)=>{for(var s in e)Le(t,s,{get:e[s],enumerable:!0})},Tt=(t,e,s,i)=>{if(e&&typeof e=="object"||typeof e=="function")for(let n of dt(e))!pt.call(t,n)&&n!==s&&Le(t,n,{get:()=>e[n],enumerable:!(i=mt(e,n))||i.enumerable});return t};var bt=t=>Tt(Le({},"__esModule",{value:!0}),t);var Fe=(t,e,s)=>{if(!e.has(t))throw TypeError("Cannot "+s)};var r=(t,e,s)=>(Fe(t,e,"read from private field"),s?s.call(t):e.get(t)),d=(t,e,s)=>{if(e.has(t))throw TypeError("Cannot add the same private member more than once");e instanceof WeakSet?e.add(t):e.set(t,s)},S=(t,e,s,i)=>(Fe(t,e,"write to private field"),i?i.call(t,s):e.set(t,s),s),Ye=(t,e,s,i)=>({set _(n){S(t,e,n,s)},get _(){return r(t,e,i)}}),p=(t,e,s)=>(Fe(t,e,"access private method"),s);var fs={};ct(fs,{ArrayBufferTarget:()=>ie,FileSystemWritableFileStreamTarget:()=>ne,Muxer:()=>ze,StreamTarget:()=>W});var c=new Uint8Array(8),E=new DataView(c.buffer),k=t=>[(t%256+256)%256],T=t=>(E.setUint16(0,t,!1),[c[0],c[1]]),Ze=t=>(E.setInt16(0,t,!1),[c[0],c[1]]),Ve=t=>(E.setUint32(0,t,!1),[c[1],c[2],c[3]]),o=t=>(E.setUint32(0,t,!1),[c[0],c[1],c[2],c[3]]),Je=t=>(E.setInt32(0,t,!1),[c[0],c[1],c[2],c[3]]),P=t=>(E.setUint32(0,Math.floor(t/2**32),!1),E.setUint32(4,t,!1),[c[0],c[1],c[2],c[3],c[4],c[5],c[6],c[7]]),xe=t=>(E.setInt16(0,2**8*t,!1),[c[0],c[1]]),U=t=>(E.setInt32(0,2**16*t,!1),[c[0],c[1],c[2],c[3]]),Re=t=>(E.setInt32(0,2**30*t,!1),[c[0],c[1],c[2],c[3]]),A=(t,e=!1)=>{let s=Array(t.length).fill(null).map((i,n)=>t.charCodeAt(n));return e&&s.push(0),s},_=t=>t&&t[t.length-1],B=(t,e,s=!0)=>{let i=t*e;return s?Math.round(i):i},Ne=t=>{let e=t*(Math.PI/180),s=Math.cos(e),i=Math.sin(e);return[s,i,0,-i,s,0,0,0,1]},je=Ne(0),He=t=>[U(t[0]),U(t[1]),Re(t[2]),U(t[3]),U(t[4]),Re(t[5]),U(t[6]),U(t[7]),Re(t[8])],Q=t=>!t||typeof t!="object"?t:Array.isArray(t)?t.map(Q):Object.fromEntries(Object.entries(t).map(([e,s])=>[e,Q(s)])),$=t=>t>=0&&t<2**32;var x=(t,e,s)=>({type:t,contents:e&&new Uint8Array(e.flat(10)),children:s}),C=(t,e,s,i,n)=>x(t,[k(e),Ve(s),i??[]],n),et=t=>{let e=512;return t.fragmented?x("ftyp",[A("iso5"),o(e),A("iso5"),A("iso6"),A("mp41")]):x("ftyp",[A("isom"),o(e),A("isom"),t.holdsAvc?A("avc1"):[],A("mp41")])},ge=t=>({type:"mdat",largeSize:t}),tt=t=>({type:"free",size:t}),re=(t,e,s=!1)=>x("moov",null,[Ct(e,t),...t.map(i=>St(i,e)),s?qt(t):null]),Ct=(t,e)=>{let s=B(Math.max(0,...e.filter(l=>l.samples.length>0).map(l=>_(l.samples).pts+_(l.samples).duration)),ye),i=Math.max(...e.map(l=>l.id))+1,n=!$(t)||!$(s),a=n?P:o;return C("mvhd",+n,0,[a(t),a(t),o(ye),a(s),U(1),xe(1),Array(10).fill(0),He(je),Array(24).fill(0),o(i)])},St=(t,e)=>x("trak",null,[xt(t,e),yt(t,e)]),xt=(t,e)=>{let s=_(t.samples),i=B(s?s.pts+s.duration:0,ye),n=!$(e)||!$(i),a=n?P:o,l;return t.info.type==="video"?l=typeof t.info.rotation=="number"?Ne(t.info.rotation):t.info.rotation:l=je,C("tkhd",+n,3,[a(e),a(e),o(t.id),o(0),a(i),Array(8).fill(0),T(0),T(0),xe(t.info.type==="audio"?1:0),T(0),He(l),U(t.info.type==="video"?t.info.width:0),U(t.info.type==="video"?t.info.height:0)])},yt=(t,e)=>x("mdia",null,[gt(t,e),wt(t.info.type==="video"?"vide":"soun"),vt(t)]),gt=(t,e)=>{let s=_(t.samples),i=B(s?s.pts+s.duration:0,t.timescale),n=!$(e)||!$(i),a=n?P:o;return C("mdhd",+n,0,[a(e),a(e),o(t.timescale),a(i),T(21956),T(0)])},wt=t=>C("hdlr",0,0,[A("mhlr"),A(t),o(0),o(0),o(0),A("mp4-muxer-hdlr",!0)]),vt=t=>x("minf",null,[t.info.type==="video"?Ot():kt(),At(),Ut(t)]),Ot=()=>C("vmhd",0,1,[T(0),T(0),T(0),T(0)]),kt=()=>C("smhd",0,0,[T(0),T(0)]),At=()=>x("dinf",null,[Bt()]),Bt=()=>C("dref",0,0,[o(1)],[zt()]),zt=()=>C("url ",0,1),Ut=t=>x("stbl",null,[Dt(t),Vt(t),Nt(t),jt(t),Ht(t),$t(t),Wt(t)]),Dt=t=>C("stsd",0,0,[o(1)],[t.info.type==="video"?Et(ts[t.info.codec],t):Lt(rs[t.info.codec],t)]),Et=(t,e)=>x(t,[Array(6).fill(0),T(1),T(0),T(0),Array(12).fill(0),T(e.info.width),T(e.info.height),o(4718592),o(4718592),o(0),T(1),Array(32).fill(0),T(24),Ze(65535)],[ss[e.info.codec](e)]),_t=t=>t.codecPrivate&&x("avcC",[...t.codecPrivate]),It=t=>t.codecPrivate&&x("hvcC",[...t.codecPrivate]),Mt=t=>t.codecPrivate&&x("vpcC",[...t.codecPrivate]),Pt=t=>t.codecPrivate&&x("av1C",[...t.codecPrivate]),Lt=(t,e)=>x(t,[Array(6).fill(0),T(1),T(0),T(0),o(0),T(e.info.numberOfChannels),T(16),T(0),T(0),U(e.info.sampleRate)],[is[e.info.codec](e)]),Ft=t=>C("esds",0,0,[o(58753152),k(32+t.codecPrivate.byteLength),T(1),k(0),o(75530368),k(18+t.codecPrivate.byteLength),k(64),k(21),Ve(0),o(130071),o(130071),o(92307584),k(t.codecPrivate.byteLength),...t.codecPrivate,o(109084800),k(1),k(2)]),Rt=t=>x("dOps",[k(0),k(t.info.numberOfChannels),T(3840),o(t.info.sampleRate),xe(0),k(0)]),Vt=t=>C("stts",0,0,[o(t.timeToSampleTable.length),t.timeToSampleTable.map(e=>[o(e.sampleCount),o(e.sampleDelta)])]),Nt=t=>{if(t.samples.every(s=>s.type==="key"))return null;let e=[...t.samples.entries()].filter(([,s])=>s.type==="key");return C("stss",0,0,[o(e.length),e.map(([s])=>o(s+1))])},jt=t=>C("stsc",0,0,[o(t.compactlyCodedChunkTable.length),t.compactlyCodedChunkTable.map(e=>[o(e.firstChunk),o(e.samplesPerChunk),o(1)])]),Ht=t=>C("stsz",0,0,[o(0),o(t.samples.length),t.samples.map(e=>o(e.size))]),$t=t=>t.finalizedChunks.length>0&&_(t.finalizedChunks).offset>=2**32?C("co64",0,0,[o(t.finalizedChunks.length),t.finalizedChunks.map(e=>P(e.offset))]):C("stco",0,0,[o(t.finalizedChunks.length),t.finalizedChunks.map(e=>o(e.offset))]),Wt=t=>C("ctts",0,0,[o(t.compositionTimeOffsetTable.length),t.compositionTimeOffsetTable.map(e=>[o(e.sampleCount),o(e.sampleCTO)])]),qt=t=>x("mvex",null,t.map(Xt)),Xt=t=>C("trex",0,0,[o(t.id),o(1),o(0),o(0),o(0)]),$e=(t,e)=>x("moof",null,[Gt(t),...e.map(Kt)]),Gt=t=>C("mfhd",0,0,[o(t)]),st=t=>{let e=0,s=0,i=0,n=0,a=t.type==="delta";return s|=+a,a?e|=1:e|=2,e<<24|s<<16|i<<8|n},Kt=t=>x("traf",null,[Qt(t),Yt(t),Zt(t)]),Qt=t=>{let e=0;e|=8,e|=16,e|=32,e|=131072;let s=t.currentChunk.samples[1]??t.currentChunk.samples[0],i={duration:s.timescaleUnitsToNextSample,size:s.size,flags:st(s)};return C("tfhd",0,e,[o(t.id),o(i.duration),o(i.size),o(i.flags)])},Yt=t=>C("tfdt",1,0,[P(B(t.currentChunk.startTimestamp,t.timescale))]),Zt=t=>{let e=t.currentChunk.samples.map(I=>I.timescaleUnitsToNextSample),s=t.currentChunk.samples.map(I=>I.size),i=t.currentChunk.samples.map(st),n=t.currentChunk.samples.map(I=>B(I.pts-I.dts,t.timescale)),a=new Set(e),l=new Set(s),u=new Set(i),m=new Set(n),b=u.size===2&&i[0]!==i[1],w=a.size>1,j=l.size>1,se=!b&&u.size>1,Qe=m.size>1||[...m].some(I=>I!==0),H=0;return H|=1,H|=4*+b,H|=256*+w,H|=512*+j,H|=1024*+se,H|=2048*+Qe,C("trun",1,H,[o(t.currentChunk.samples.length),o(t.currentChunk.offset-t.currentChunk.moofOffset||0),b?o(i[0]):[],t.currentChunk.samples.map((I,Se)=>[w?o(e[Se]):[],j?o(s[Se]):[],se?o(i[Se]):[],Qe?Je(n[Se]):[]])])},rt=t=>x("mfra",null,[...t.map(Jt),es()]),Jt=(t,e)=>C("tfra",1,0,[o(t.id),o(63),o(t.finalizedChunks.length),t.finalizedChunks.map(i=>[P(B(i.startTimestamp,t.timescale)),P(i.moofOffset),o(e+1),o(1),o(1)])]),es=()=>C("mfro",0,0,[o(0)]),ts={avc:"avc1",hevc:"hvc1",vp9:"vp09",av1:"av01"},ss={avc:_t,hevc:It,vp9:Mt,av1:Pt},rs={aac:"mp4a",opus:"Opus"},is={aac:Ft,opus:Rt};var ie=class{constructor(){this.buffer=null}},W=class{constructor(e){this.options=e}},ne=class{constructor(e,s){this.stream=e;this.options=s}};var L,q,ae=class{constructor(){this.pos=0;d(this,L,new Uint8Array(8));d(this,q,new DataView(r(this,L).buffer));this.offsets=new WeakMap}seek(e){this.pos=e}writeU32(e){r(this,q).setUint32(0,e,!1),this.write(r(this,L).subarray(0,4))}writeU64(e){r(this,q).setUint32(0,Math.floor(e/2**32),!1),r(this,q).setUint32(4,e,!1),this.write(r(this,L).subarray(0,8))}writeAscii(e){for(let s=0;s<e.length;s++)r(this,q).setUint8(s%8,e.charCodeAt(s)),s%8===7&&this.write(r(this,L));e.length%8!==0&&this.write(r(this,L).subarray(0,e.length%8))}writeBox(e){if(this.offsets.set(e,this.pos),e.contents&&!e.children)this.writeBoxHeader(e,e.size??e.contents.byteLength+8),this.write(e.contents);else{let s=this.pos;if(this.writeBoxHeader(e,0),e.contents&&this.write(e.contents),e.children)for(let a of e.children)a&&this.writeBox(a);let i=this.pos,n=e.size??i-s;this.seek(s),this.writeBoxHeader(e,n),this.seek(i)}}writeBoxHeader(e,s){this.writeU32(e.largeSize?1:s),this.writeAscii(e.type),e.largeSize&&this.writeU64(s)}measureBoxHeader(e){return 8+(e.largeSize?8:0)}patchBox(e){let s=this.pos;this.seek(this.offsets.get(e)),this.writeBox(e),this.seek(s)}measureBox(e){if(e.contents&&!e.children)return this.measureBoxHeader(e)+e.contents.byteLength;{let s=this.measureBoxHeader(e);if(e.contents&&(s+=e.contents.byteLength),e.children)for(let i of e.children)i&&(s+=this.measureBox(i));return s}}};L=new WeakMap,q=new WeakMap;var he,F,Y,Z,ue,We,ve=class extends ae{constructor(s){super();d(this,ue);d(this,he,void 0);d(this,F,new ArrayBuffer(2**16));d(this,Y,new Uint8Array(r(this,F)));d(this,Z,0);S(this,he,s)}write(s){p(this,ue,We).call(this,this.pos+s.byteLength),r(this,Y).set(s,this.pos),this.pos+=s.byteLength,S(this,Z,Math.max(r(this,Z),this.pos))}finalize(){p(this,ue,We).call(this,this.pos),r(this,he).buffer=r(this,F).slice(0,Math.max(r(this,Z),this.pos))}};he=new WeakMap,F=new WeakMap,Y=new WeakMap,Z=new WeakMap,ue=new WeakSet,We=function(s){let i=r(this,F).byteLength;for(;i<s;)i*=2;if(i===r(this,F).byteLength)return;let n=new ArrayBuffer(i),a=new Uint8Array(n);a.set(r(this,Y),0),S(this,F,n),S(this,Y,a)};var fe,R,oe=class extends ae{constructor(s){super();d(this,fe,void 0);d(this,R,[]);S(this,fe,s)}write(s){r(this,R).push({data:s.slice(),start:this.pos}),this.pos+=s.byteLength}flush(){if(r(this,R).length===0)return;let s=[],i=[...r(this,R)].sort((n,a)=>n.start-a.start);s.push({start:i[0].start,size:i[0].data.byteLength});for(let n=1;n<i.length;n++){let a=s[s.length-1],l=i[n];l.start<=a.start+a.size?a.size=Math.max(a.size,l.start+l.data.byteLength-a.start):s.push({start:l.start,size:l.data.byteLength})}for(let n of s){n.data=new Uint8Array(n.size);for(let a of r(this,R))n.start<=a.start&&a.start<n.start+n.size&&n.data.set(a.data,a.start-n.start);r(this,fe).options.onData?.(n.data,n.start)}r(this,R).length=0}finalize(){}};fe=new WeakMap,R=new WeakMap;var ns=2**24,as=2,me,z,v,de,qe,ke,it,Ae,nt,J,we,le=class extends ae{constructor(s){super();d(this,de);d(this,ke);d(this,Ae);d(this,J);d(this,me,void 0);d(this,z,void 0);d(this,v,[]);if(S(this,me,s),S(this,z,s.options?.chunkSize??ns),!Number.isInteger(r(this,z))||r(this,z)<2**10)throw new Error("Invalid StreamTarget options: chunkSize must be an integer not smaller than 1024.")}write(s){p(this,de,qe).call(this,s,this.pos),p(this,J,we).call(this),this.pos+=s.byteLength}finalize(){p(this,J,we).call(this,!0)}};me=new WeakMap,z=new WeakMap,v=new WeakMap,de=new WeakSet,qe=function(s,i){let n=r(this,v).findIndex(b=>b.start<=i&&i<b.start+r(this,z));n===-1&&(n=p(this,Ae,nt).call(this,i));let a=r(this,v)[n],l=i-a.start,u=s.subarray(0,Math.min(r(this,z)-l,s.byteLength));a.data.set(u,l);let m={start:l,end:l+u.byteLength};if(p(this,ke,it).call(this,a,m),a.written[0].start===0&&a.written[0].end===r(this,z)&&(a.shouldFlush=!0),r(this,v).length>as){for(let b=0;b<r(this,v).length-1;b++)r(this,v)[b].shouldFlush=!0;p(this,J,we).call(this)}u.byteLength<s.byteLength&&p(this,de,qe).call(this,s.subarray(u.byteLength),i+u.byteLength)},ke=new WeakSet,it=function(s,i){let n=0,a=s.written.length-1,l=-1;for(;n<=a;){let u=Math.floor(n+(a-n+1)/2);s.written[u].start<=i.start?(n=u+1,l=u):a=u-1}for(s.written.splice(l+1,0,i),(l===-1||s.written[l].end<i.start)&&l++;l<s.written.length-1&&s.written[l].end>=s.written[l+1].start;)s.written[l].end=Math.max(s.written[l].end,s.written[l+1].end),s.written.splice(l+1,1)},Ae=new WeakSet,nt=function(s){let n={start:Math.floor(s/r(this,z))*r(this,z),data:new Uint8Array(r(this,z)),written:[],shouldFlush:!1};return r(this,v).push(n),r(this,v).sort((a,l)=>a.start-l.start),r(this,v).indexOf(n)},J=new WeakSet,we=function(s=!1){for(let i=0;i<r(this,v).length;i++){let n=r(this,v)[i];if(!(!n.shouldFlush&&!s)){for(let a of n.written)r(this,me).options.onData?.(n.data.subarray(a.start,a.end),n.start+a.start);r(this,v).splice(i--,1)}}};var Oe=class extends le{constructor(e){super(new W({onData:(s,i)=>e.stream.write({type:"write",data:s,position:i}),chunkSize:e.options?.chunkSize}))}};var ye=1e3,os=["avc","hevc","vp9","av1"],ls=["aac","opus"],hs=2082844800,us=["strict","offset"],f,h,ce,O,y,g,X,G,Ue,V,N,ee,De,at,Ee,ot,_e,lt,Ie,ht,Me,ut,Te,Xe,D,M,Pe,ft,te,Be,be,Ge,K,pe,Ce,Ke,ze=class{constructor(e){d(this,De);d(this,Ee);d(this,_e);d(this,Ie);d(this,Me);d(this,Te);d(this,D);d(this,Pe);d(this,te);d(this,be);d(this,K);d(this,Ce);d(this,f,void 0);d(this,h,void 0);d(this,ce,void 0);d(this,O,void 0);d(this,y,null);d(this,g,null);d(this,X,Math.floor(Date.now()/1e3)+hs);d(this,G,[]);d(this,Ue,1);d(this,V,[]);d(this,N,[]);d(this,ee,!1);if(p(this,De,at).call(this,e),e.video=Q(e.video),e.audio=Q(e.audio),e.fastStart=Q(e.fastStart),this.target=e.target,S(this,f,{firstTimestampBehavior:"strict",...e}),e.target instanceof ie)S(this,h,new ve(e.target));else if(e.target instanceof W)S(this,h,e.target.options?.chunked?new le(e.target):new oe(e.target));else if(e.target instanceof ne)S(this,h,new Oe(e.target));else throw new Error(`Invalid target: ${e.target}`);p(this,Ie,ht).call(this),p(this,Ee,ot).call(this)}addVideoChunk(e,s,i,n){let a=new Uint8Array(e.byteLength);e.copyTo(a),this.addVideoChunkRaw(a,e.type,i??e.timestamp,n??0,e.duration,s)}addVideoChunkRaw(e,s,i,n,a,l){if(p(this,Ce,Ke).call(this),!r(this,f).video)throw new Error("No video track declared.");if(typeof r(this,f).fastStart=="object"&&r(this,y).samples.length===r(this,f).fastStart.expectedVideoChunks)throw new Error(`Cannot add more video chunks than specified in 'fastStart' (${r(this,f).fastStart.expectedVideoChunks}).`);let u=p(this,Te,Xe).call(this,r(this,y),e,s,i,n,a,l);if(r(this,f).fastStart==="fragmented"&&r(this,g)){for(;r(this,N).length>0&&r(this,N)[0].dts<=u.dts;){let m=r(this,N).shift();p(this,D,M).call(this,r(this,g),m)}u.dts<=r(this,g).lastDTS?p(this,D,M).call(this,r(this,y),u):r(this,V).push(u)}else p(this,D,M).call(this,r(this,y),u)}addAudioChunk(e,s,i){let n=new Uint8Array(e.byteLength);e.copyTo(n),this.addAudioChunkRaw(n,e.type,i??e.timestamp,e.duration,s)}addAudioChunkRaw(e,s,i,n,a){if(p(this,Ce,Ke).call(this),!r(this,f).audio)throw new Error("No audio track declared.");if(typeof r(this,f).fastStart=="object"&&r(this,g).samples.length===r(this,f).fastStart.expectedAudioChunks)throw new Error(`Cannot add more audio chunks than specified in 'fastStart' (${r(this,f).fastStart.expectedAudioChunks}).`);let l=p(this,Te,Xe).call(this,r(this,g),e,s,i,0,n,a);if(r(this,f).fastStart==="fragmented"&&r(this,y)){for(;r(this,V).length>0&&r(this,V)[0].dts<=l.dts;){let u=r(this,V).shift();p(this,D,M).call(this,r(this,y),u)}l.dts<=r(this,y).lastDTS?p(this,D,M).call(this,r(this,g),l):r(this,N).push(l)}else p(this,D,M).call(this,r(this,g),l)}finalize(){if(r(this,ee))throw new Error("Cannot finalize a muxer more than once.");if(r(this,f).fastStart==="fragmented"){for(let s of r(this,V))p(this,D,M).call(this,r(this,y),s);for(let s of r(this,N))p(this,D,M).call(this,r(this,g),s);p(this,be,Ge).call(this,!1)}else r(this,y)&&p(this,te,Be).call(this,r(this,y)),r(this,g)&&p(this,te,Be).call(this,r(this,g));let e=[r(this,y),r(this,g)].filter(Boolean);if(r(this,f).fastStart==="in-memory"){let s;for(let n=0;n<2;n++){let a=re(e,r(this,X)),l=r(this,h).measureBox(a);s=r(this,h).measureBox(r(this,O));let u=r(this,h).pos+l+s;for(let m of r(this,G)){m.offset=u;for(let{data:b}of m.samples)u+=b.byteLength,s+=b.byteLength}if(u<2**32)break;s>=2**32&&(r(this,O).largeSize=!0)}let i=re(e,r(this,X));r(this,h).writeBox(i),r(this,O).size=s,r(this,h).writeBox(r(this,O));for(let n of r(this,G))for(let a of n.samples)r(this,h).write(a.data),a.data=null}else if(r(this,f).fastStart==="fragmented"){let s=r(this,h).pos,i=rt(e);r(this,h).writeBox(i);let n=r(this,h).pos-s;r(this,h).seek(r(this,h).pos-4),r(this,h).writeU32(n)}else{let s=r(this,h).offsets.get(r(this,O)),i=r(this,h).pos-s;r(this,O).size=i,r(this,O).largeSize=i>=2**32,r(this,h).patchBox(r(this,O));let n=re(e,r(this,X));if(typeof r(this,f).fastStart=="object"){r(this,h).seek(r(this,ce)),r(this,h).writeBox(n);let a=s-r(this,h).pos;r(this,h).writeBox(tt(a))}else r(this,h).writeBox(n)}p(this,K,pe).call(this),r(this,h).finalize(),S(this,ee,!0)}};f=new WeakMap,h=new WeakMap,ce=new WeakMap,O=new WeakMap,y=new WeakMap,g=new WeakMap,X=new WeakMap,G=new WeakMap,Ue=new WeakMap,V=new WeakMap,N=new WeakMap,ee=new WeakMap,De=new WeakSet,at=function(e){if(e.video){if(!os.includes(e.video.codec))throw new Error(`Unsupported video codec: ${e.video.codec}`);let s=e.video.rotation;if(typeof s=="number"&&![0,90,180,270].includes(s))throw new Error(`Invalid video rotation: ${s}. Has to be 0, 90, 180 or 270.`);if(Array.isArray(s)&&(s.length!==9||s.some(i=>typeof i!="number")))throw new Error(`Invalid video transformation matrix: ${s.join()}`)}if(e.audio&&!ls.includes(e.audio.codec))throw new Error(`Unsupported audio codec: ${e.audio.codec}`);if(e.firstTimestampBehavior&&!us.includes(e.firstTimestampBehavior))throw new Error(`Invalid first timestamp behavior: ${e.firstTimestampBehavior}`);if(typeof e.fastStart=="object"){if(e.video&&e.fastStart.expectedVideoChunks===void 0)throw new Error("'fastStart' is an object but is missing property 'expectedVideoChunks'.");if(e.audio&&e.fastStart.expectedAudioChunks===void 0)throw new Error("'fastStart' is an object but is missing property 'expectedAudioChunks'.")}else if(![!1,"in-memory","fragmented"].includes(e.fastStart))throw new Error("'fastStart' option must be false, 'in-memory', 'fragmented' or an object.")},Ee=new WeakSet,ot=function(){if(r(this,h).writeBox(et({holdsAvc:r(this,f).video?.codec==="avc",fragmented:r(this,f).fastStart==="fragmented"})),S(this,ce,r(this,h).pos),r(this,f).fastStart==="in-memory")S(this,O,ge(!1));else if(r(this,f).fastStart!=="fragmented"){if(typeof r(this,f).fastStart=="object"){let e=p(this,_e,lt).call(this);r(this,h).seek(r(this,h).pos+e)}S(this,O,ge(!0)),r(this,h).writeBox(r(this,O))}p(this,K,pe).call(this)},_e=new WeakSet,lt=function(){if(typeof r(this,f).fastStart!="object")return;let e=0,s=[r(this,f).fastStart.expectedVideoChunks,r(this,f).fastStart.expectedAudioChunks];for(let i of s)i&&(e+=(4+4)*Math.ceil(2/3*i),e+=4*i,e+=(4+4+4)*Math.ceil(2/3*i),e+=4*i,e+=8*i);return e+=4096,e},Ie=new WeakSet,ht=function(){if(r(this,f).video&&S(this,y,{id:1,info:{type:"video",codec:r(this,f).video.codec,width:r(this,f).video.width,height:r(this,f).video.height,rotation:r(this,f).video.rotation??0},timescale:11520,codecPrivate:new Uint8Array(0),samples:[],finalizedChunks:[],currentChunk:null,firstDTS:void 0,lastDTS:-1,timeToSampleTable:[],compositionTimeOffsetTable:[],lastTimescaleUnits:null,lastSample:null,compactlyCodedChunkTable:[]}),r(this,f).audio){let e=p(this,Me,ut).call(this,2,r(this,f).audio.sampleRate,r(this,f).audio.numberOfChannels);S(this,g,{id:r(this,f).video?2:1,info:{type:"audio",codec:r(this,f).audio.codec,numberOfChannels:r(this,f).audio.numberOfChannels,sampleRate:r(this,f).audio.sampleRate},timescale:r(this,f).audio.sampleRate,codecPrivate:e,samples:[],finalizedChunks:[],currentChunk:null,firstDTS:void 0,lastDTS:-1,timeToSampleTable:[],compositionTimeOffsetTable:[],lastTimescaleUnits:null,lastSample:null,compactlyCodedChunkTable:[]})}},Me=new WeakSet,ut=function(e,s,i){let a=[96e3,88200,64e3,48e3,44100,32e3,24e3,22050,16e3,12e3,11025,8e3,7350].indexOf(s),l=i,u="";u+=e.toString(2).padStart(5,"0"),u+=a.toString(2).padStart(4,"0"),a===15&&(u+=s.toString(2).padStart(24,"0")),u+=l.toString(2).padStart(4,"0");let m=Math.ceil(u.length/8)*8;u=u.padEnd(m,"0");let b=new Uint8Array(u.length/8);for(let w=0;w<u.length;w+=8)b[w/8]=parseInt(u.slice(w,w+8),2);return b},Te=new WeakSet,Xe=function(e,s,i,n,a,l,u){let m=n/1e6,b=(n-a)/1e6,w=l/1e6,j=p(this,Pe,ft).call(this,m,b,e);return m=j.pts,b=j.dts,u?.decoderConfig?.description&&(e.codecPrivate=new Uint8Array(u.decoderConfig.description)),{pts:m,dts:b,duration:w,data:s,size:s.byteLength,type:i,timescaleUnitsToNextSample:B(w,e.timescale)}},D=new WeakSet,M=function(e,s){r(this,f).fastStart!=="fragmented"&&e.samples.push(s);let i=B(s.pts-s.dts,e.timescale);if(e.lastTimescaleUnits!==null){let a=B(s.dts,e.timescale,!1),l=Math.round(a-e.lastTimescaleUnits);if(e.lastTimescaleUnits+=l,e.lastSample.timescaleUnitsToNextSample=l,r(this,f).fastStart!=="fragmented"){let u=_(e.timeToSampleTable);u.sampleCount===1?(u.sampleDelta=l,u.sampleCount++):u.sampleDelta===l?u.sampleCount++:(u.sampleCount--,e.timeToSampleTable.push({sampleCount:2,sampleDelta:l}));let m=_(e.compositionTimeOffsetTable);m.sampleCount===1?(m.sampleCTO=i,m.sampleCount++):m.sampleCTO===i?m.sampleCount++:(m.sampleCount--,e.compositionTimeOffsetTable.push({sampleCount:2,sampleCTO:i}))}}else e.lastTimescaleUnits=0,r(this,f).fastStart!=="fragmented"&&(e.timeToSampleTable.push({sampleCount:1,sampleDelta:B(s.duration,e.timescale)}),e.compositionTimeOffsetTable.push({sampleCount:1,sampleCTO:i}));e.lastSample=s;let n=!1;if(!e.currentChunk)n=!0;else{let a=s.pts-e.currentChunk.startTimestamp;if(r(this,f).fastStart==="fragmented"){let l=r(this,y)??r(this,g);e===l&&s.type==="key"&&a>=1&&(n=!0,p(this,be,Ge).call(this))}else n=a>=.5}n&&(e.currentChunk&&p(this,te,Be).call(this,e),e.currentChunk={startTimestamp:s.pts,samples:[]}),e.currentChunk.samples.push(s)},Pe=new WeakSet,ft=function(e,s,i){if(r(this,f).firstTimestampBehavior==="strict"&&i.lastDTS===-1&&s!==0)throw new Error(`The first chunk for your media track must have a timestamp of 0 (received DTS=${s}). Non-zero first timestamps are often caused by directly piping frames or audio data from a MediaStreamTrack into the encoder. Their timestamps are typically relative to the age of the document, which is probably what you want.

If you want to offset all timestamps of a track such that the first one is zero, set firstTimestampBehavior: 'offset' in the options.
`);if(r(this,f).firstTimestampBehavior==="offset"){i.firstDTS===void 0&&(i.firstDTS=s);let n=Math.min(...[r(this,g),r(this,y)].filter(a=>(a?.firstDTS??null)!==null).map(a=>a.firstDTS));s-=n,e-=n}if(s<i.lastDTS)throw new Error(`Timestamps must be monotonically increasing (DTS went from ${i.lastDTS*1e6} to ${s*1e6}).`);return i.lastDTS=s,{pts:e,dts:s}},te=new WeakSet,Be=function(e){if(r(this,f).fastStart==="fragmented")throw new Error("Can't finalize individual chunks 'fastStart' is set to 'fragmented'.");if(e.currentChunk){if(e.finalizedChunks.push(e.currentChunk),r(this,G).push(e.currentChunk),(e.compactlyCodedChunkTable.length===0||_(e.compactlyCodedChunkTable).samplesPerChunk!==e.currentChunk.samples.length)&&e.compactlyCodedChunkTable.push({firstChunk:e.finalizedChunks.length,samplesPerChunk:e.currentChunk.samples.length}),r(this,f).fastStart==="in-memory"){e.currentChunk.offset=0;return}e.currentChunk.offset=r(this,h).pos;for(let s of e.currentChunk.samples)r(this,h).write(s.data),s.data=null;p(this,K,pe).call(this)}},be=new WeakSet,Ge=function(e=!0){if(r(this,f).fastStart!=="fragmented")throw new Error("Can't finalize a fragment unless 'fastStart' is set to 'fragmented'.");let s=[r(this,y),r(this,g)].filter(m=>m&&m.currentChunk);if(s.length===0)return;let i=Ye(this,Ue)._++;if(i===1){let m=re(s,r(this,X),!0);r(this,h).writeBox(m)}let n=r(this,h).pos,a=$e(i,s);r(this,h).writeBox(a);{let m=ge(!1),b=0;for(let j of s)for(let se of j.currentChunk.samples)b+=se.size;let w=r(this,h).measureBox(m)+b;w>=2**32&&(m.largeSize=!0,w=r(this,h).measureBox(m)+b),m.size=w,r(this,h).writeBox(m)}for(let m of s){m.currentChunk.offset=r(this,h).pos,m.currentChunk.moofOffset=n;for(let b of m.currentChunk.samples)r(this,h).write(b.data),b.data=null}let l=r(this,h).pos;r(this,h).seek(r(this,h).offsets.get(a));let u=$e(i,s);r(this,h).writeBox(u),r(this,h).seek(l);for(let m of s)m.finalizedChunks.push(m.currentChunk),r(this,G).push(m.currentChunk),m.currentChunk=null;e&&p(this,K,pe).call(this)},K=new WeakSet,pe=function(){r(this,h)instanceof oe&&r(this,h).flush()},Ce=new WeakSet,Ke=function(){if(r(this,ee))throw new Error("Cannot add new video or audio chunks after the file has been finalized.")};return bt(fs);})();
if (typeof module === "object" && typeof module.exports === "object") Object.assign(module.exports, Mp4Muxer)
