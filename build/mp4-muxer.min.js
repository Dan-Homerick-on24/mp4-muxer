"use strict";var Mp4Muxer=(()=>{var R=Object.defineProperty;var Dt=Object.getOwnPropertyDescriptor;var zt=Object.getOwnPropertyNames,ot=Object.getOwnPropertySymbols;var ft=Object.prototype.hasOwnProperty,Ft=Object.prototype.propertyIsEnumerable;var W=Math.pow,ut=(i,t,e)=>t in i?R(i,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):i[t]=e,mt=(i,t)=>{for(var e in t||={})ft.call(t,e)&&ut(i,e,t[e]);if(ot)for(var e of ot(t))Ft.call(t,e)&&ut(i,e,t[e]);return i};var It=(i,t)=>{for(var e in t)R(i,e,{get:t[e],enumerable:!0})},Ht=(i,t,e,s)=>{if(t&&typeof t=="object"||typeof t=="function")for(let n of zt(t))!ft.call(i,n)&&n!==e&&R(i,n,{get:()=>t[n],enumerable:!(s=Dt(t,n))||s.enumerable});return i};var Lt=i=>Ht(R({},"__esModule",{value:!0}),i);var it=(i,t,e)=>{if(!t.has(i))throw TypeError("Cannot "+e)};var r=(i,t,e)=>(it(i,t,"read from private field"),e?e.call(i):t.get(i)),o=(i,t,e)=>{if(t.has(i))throw TypeError("Cannot add the same private member more than once");t instanceof WeakSet?t.add(i):t.set(i,e)},d=(i,t,e,s)=>(it(i,t,"write to private field"),s?s.call(i,e):t.set(i,e),e);var x=(i,t,e)=>(it(i,t,"access private method"),e);var Rt={};It(Rt,{default:()=>Pt});var I=i=>{let t=new Uint8Array(2);return new DataView(t.buffer).setUint16(0,i,!1),[...t]},dt=i=>{let t=new Uint8Array(2);return new DataView(t.buffer).setInt16(0,i,!1),[...t]},l=i=>{let t=new Uint8Array(4);return new DataView(t.buffer).setUint32(0,i,!1),[...t]},rt=i=>{let t=new Uint8Array(2),e=new DataView(t.buffer);return e.setUint8(0,i),e.setUint8(1,i<<8),[...t]},N=i=>{let t=new Uint8Array(4),e=new DataView(t.buffer);return e.setUint16(0,i,!1),e.setUint16(2,i<<16,!1),[...t]},K=(i,t=!1)=>{let e=Array(i.length).fill(null).map((s,n)=>i.charCodeAt(n));return t&&e.push(0),e},S=(i,t)=>Math.floor(i*t),H=i=>i&&i[i.length-1];var C,U,L=class{constructor(){this.pos=0;o(this,C,new Uint8Array(8));o(this,U,new DataView(r(this,C).buffer));this.offsets=new WeakMap}writeU32(t){r(this,U).setUint32(0,t,!1),this.write(r(this,C).subarray(0,4))}writeU64(t){r(this,U).setUint32(0,Math.floor(t/W(2,32)),!1),r(this,U).setUint32(4,t,!1),this.write(r(this,C).subarray(0,8))}writeAscii(t){for(let e=0;e<t.length;e++)r(this,U).setUint8(e%8,t.charCodeAt(e)),e%8===7&&this.write(r(this,C));t.length%8!==0&&this.write(r(this,C).subarray(0,t.length%8))}writeBox(t){var e,s;if(this.offsets.set(t,this.pos),t.contents&&!t.children)this.writeBoxHeader(t,(e=t.size)!=null?e:t.contents.byteLength+8),this.write(t.contents);else{let n=this.pos;if(this.writeBoxHeader(t,0),t.contents&&this.write(t.contents),t.children)for(let h of t.children)h&&this.writeBox(h);let a=this.pos,u=(s=t.size)!=null?s:a-n;this.pos=n,this.writeBoxHeader(t,u),this.pos=a}}writeBoxHeader(t,e){this.writeU32(t.largeSize?1:e),this.writeAscii(t.type),t.largeSize&&this.writeU64(e)}patchBox(t){let e=this.pos;this.pos=this.offsets.get(t),this.writeBox(t),this.pos=e}};C=new WeakMap,U=new WeakMap;var k,M,G=class extends L{constructor(){super();o(this,k,new ArrayBuffer(W(2,16)));o(this,M,new Uint8Array(r(this,k)))}ensureSize(e){let s=r(this,k).byteLength;for(;s<e;)s*=2;if(s===r(this,k).byteLength)return;let n=new ArrayBuffer(s),a=new Uint8Array(n);a.set(r(this,M),0),d(this,k,n),d(this,M,a)}write(e){this.ensureSize(this.pos+e.byteLength),r(this,M).set(e,this.pos),this.pos+=e.byteLength}seek(e){this.pos=e}finalize(){return this.ensureSize(this.pos),r(this,k).slice(0,this.pos)}};k=new WeakMap,M=new WeakMap;var v=W(2,24),Et=2,E,p,X=class extends L{constructor(e){super();o(this,E,void 0);o(this,p,[]);d(this,E,e)}write(e){this.writeDataIntoChunks(e,this.pos),this.flushChunks(),this.pos+=e.byteLength}writeDataIntoChunks(e,s){let n=r(this,p).findIndex(c=>c.start<=s&&s<c.start+v);n===-1&&(n=this.createChunk(s));let a=r(this,p)[n],u=s-a.start,h=e.subarray(0,Math.min(v-u,e.byteLength));a.data.set(h,u);let B={start:u,end:u+h.byteLength};if(_t(a,B),a.written[0].start===0&&a.written[0].end===v&&(a.shouldFlush=!0),r(this,p).length>Et){for(let c=0;c<r(this,p).length-1;c++)r(this,p)[c].shouldFlush=!0;this.flushChunks()}h.byteLength<e.byteLength&&this.writeDataIntoChunks(e.subarray(h.byteLength),s+h.byteLength)}createChunk(e){let n={start:Math.floor(e/v)*v,data:new Uint8Array(v),written:[],shouldFlush:!1};return r(this,p).push(n),r(this,p).sort((a,u)=>a.start-u.start),r(this,p).indexOf(n)}flushChunks(e=!1){for(let s=0;s<r(this,p).length;s++){let n=r(this,p)[s];if(!(!n.shouldFlush&&!e)){for(let a of n.written)r(this,E).write({type:"write",data:n.data.subarray(a.start,a.end),position:n.start+a.start});r(this,p).splice(s--,1)}}}seek(e){this.pos=e}finalize(){this.flushChunks(!0)}};E=new WeakMap,p=new WeakMap;var _t=(i,t)=>{let e=0,s=i.written.length-1,n=-1;for(;e<=s;){let a=Math.floor(e+(s-e+1)/2);i.written[a].start<=t.start?(e=a+1,n=a):s=a-1}for(i.written.splice(n+1,0,t),(n===-1||i.written[n].end<t.start)&&n++;n<i.written.length-1&&i.written[n].end>=i.written[n+1].start;)i.written[n].end=Math.max(i.written[n].end,i.written[n+1].end),i.written.splice(n+1,1)},g,_,$=class extends L{constructor(e){super();o(this,g,[]);o(this,_,void 0);d(this,_,e)}write(e){r(this,g).push({data:e.slice(),start:this.pos}),this.pos+=e.byteLength}seek(e){this.pos=e}flush(e){if(r(this,g).length===0)return;let s=[],n=[...r(this,g)].sort((a,u)=>a.start-u.start);s.push({start:n[0].start,size:n[0].data.byteLength});for(let a=1;a<n.length;a++){let u=s[s.length-1],h=n[a];h.start<=u.start+u.size?u.size=Math.max(u.size,h.start+h.data.byteLength-u.start):s.push({start:h.start,size:h.data.byteLength})}for(let a of s){a.data=new Uint8Array(a.size);for(let h of r(this,g))a.start<=h.start&&h.start<a.start+a.size&&a.data.set(h.data,h.start-a.start);let u=e&&a===s[s.length-1];r(this,_).call(this,a.data,a.start,u)}r(this,g).length=0}};g=new WeakMap,_=new WeakMap;var T=2082848400,Vt=5e5,Ot=["strict","offset","permissive"],pt=1e3,w,m,A,V,y,b,j,q,xt,J,ct,Q,wt,Y,yt,D,Z,tt,bt,et,Ct,O,nt,st=class{constructor(t){o(this,q);o(this,J);o(this,Q);o(this,Y);o(this,D);o(this,tt);o(this,et);o(this,O);o(this,w,void 0);o(this,m,void 0);o(this,A,void 0);o(this,V,void 0);o(this,y,null);o(this,b,null);o(this,j,!1);if(x(this,q,xt).call(this,t),d(this,w,mt({firstTimestampBehavior:"strict"},t)),t.target==="buffer")d(this,m,new G);else if(t.target instanceof FileSystemWritableFileStream)d(this,m,new X(t.target));else if(typeof t.target=="function")d(this,m,new $(t.target));else throw new Error(`Invalid target: ${t.target}`);x(this,J,ct).call(this),x(this,Q,wt).call(this)}addVideoChunk(t,e){if(x(this,tt,bt).call(this),!r(this,w).video)throw new Error("No video track declared.");x(this,Y,yt).call(this,r(this,y),t,e)}finalize(){r(this,y)&&x(this,D,Z).call(this,r(this,y)),r(this,b)&&x(this,D,Z).call(this,r(this,b));let t=r(this,m).offsets.get(r(this,A)),e=r(this,m).pos-t;r(this,A).size=e,r(this,m).patchBox(r(this,A));let s=x(this,et,Ct).call(this);return r(this,m).writeBox(s),r(this,m).finalize()}};w=new WeakMap,m=new WeakMap,A=new WeakMap,V=new WeakMap,y=new WeakMap,b=new WeakMap,j=new WeakMap,q=new WeakSet,xt=function(t){if(t.firstTimestampBehavior&&!Ot.includes(t.firstTimestampBehavior))throw new Error(`Invalid first timestamp behavior: ${t.firstTimestampBehavior}`)},J=new WeakSet,ct=function(){r(this,m).writeBox({type:"ftyp",contents:new Uint8Array([109,112,52,50,0,0,0,0,105,115,111,109,97,118,99,49,109,112,52,50,109,112,52,49])}),d(this,A,{type:"mdat",largeSize:!0}),r(this,m).writeBox(r(this,A))},Q=new WeakSet,wt=function(){r(this,w).video&&d(this,y,{volume:0,samples:[],writtenChunks:[],currentChunk:null}),r(this,w).audio&&d(this,b,{volume:1,samples:[],writtenChunks:[],currentChunk:null})},Y=new WeakSet,yt=function(t,e,s){var a;(!t.currentChunk||e.timestamp-t.currentChunk.startTimestamp>=Vt)&&(t.currentChunk&&x(this,D,Z).call(this,t),t.currentChunk={startTimestamp:e.timestamp,sampleData:[],sampleCount:0});let n=new Uint8Array(e.byteLength);e.copyTo(n),t.currentChunk.sampleData.push(n),t.currentChunk.sampleCount++,(a=s.decoderConfig)!=null&&a.description&&d(this,V,new Uint8Array(s.decoderConfig.description)),t.samples.push({timestamp:e.timestamp/1e6,size:n.byteLength})},D=new WeakSet,Z=function(t){t.currentChunk.offset=r(this,m).pos;for(let e of t.currentChunk.sampleData)r(this,m).write(e);t.currentChunk.sampleData=null,t.writtenChunks.push(t.currentChunk)},tt=new WeakSet,bt=function(){if(r(this,j))throw new Error("Cannot add new video or audio chunks after the file has been finalized.")},et=new WeakSet,Ct=function(){var u,h,B,c,P,z;let t=S(Math.max((B=(h=H((u=r(this,y))==null?void 0:u.samples))==null?void 0:h.timestamp)!=null?B:0,(z=(P=H((c=r(this,b))==null?void 0:c.samples))==null?void 0:P.timestamp)!=null?z:0),pt),e=r(this,y)&&x(this,O,nt).call(this,r(this,y)),s=r(this,b)&&x(this,O,nt).call(this,r(this,b)),n={type:"mvhd",contents:new Uint8Array([0,0,0,0,l(Math.floor(Date.now()/1e3)+T),l(Math.floor(Date.now()/1e3)+T),l(pt),l(t),N(1),rt(1),Array(10).fill(0),[65536,0,0,0,65536,0,0,0,1073741824].flatMap(l),Array(24).fill(0),l(2)].flat())};return{type:"moov",children:[n,e,s]}},O=new WeakSet,nt=function(t){var at,lt;let s=[],n=[];for(let f of t.samples){if(s.push(f),s.length===1)continue;let F=S(s[1].timestamp-s[0].timestamp,1e3);S(f.timestamp-s[s.length-2].timestamp,1e3)!==F&&(n.push({sampleCount:s.length-1,sampleDelta:F}),s=s.slice(-2))}n.push({sampleCount:s.length,sampleDelta:Math.floor(S(((lt=(at=s[1])==null?void 0:at.timestamp)!=null?lt:s[0].timestamp)-s[0].timestamp,1e3))});let a={type:"stts",contents:new Uint8Array([0,0,0,0,l(n.length),...n.flatMap(f=>[l(f.sampleCount),l(f.sampleDelta)])].flat())},u={type:"stss",contents:new Uint8Array([0,0,0,0,l(1),l(1)].flat())},h=t.writtenChunks.reduce((f,F,ht)=>f.length===0||H(f).samplesPerChunk!==F.sampleCount?[...f,{firstChunk:ht+1,samplesPerChunk:F.sampleCount}]:f,[]),B={type:"stsc",contents:new Uint8Array([0,0,0,0,l(h.length),...h.flatMap(f=>[l(f.firstChunk),l(f.samplesPerChunk),l(1)])].flat())},c={type:"stsz",contents:new Uint8Array([0,0,0,0,l(0),l(t.samples.length),t.samples.flatMap(f=>l(f.size))].flat())},P={type:"stco",contents:new Uint8Array([0,0,0,0,l(t.writtenChunks.length),t.writtenChunks.flatMap(f=>l(f.offset))].flat())},z=S(H(t.samples).timestamp,1e3),kt={type:"mdhd",contents:new Uint8Array([0,0,0,0,l(Math.floor(Date.now()/1e3)+T),l(Math.floor(Date.now()/1e3)+T),l(1e3),l(z),85,196,0,0].flat())},gt={type:"hdlr",contents:new Uint8Array([0,0,0,0,l(0),K("vide"),Array(12).fill(0),K("Video track",!0)].flat())},At={type:"vmhd",contents:new Uint8Array([0,0,0,1,0,0,0,0,0,0,0,0])},Ut={type:"dinf",children:[{type:"dref",contents:new Uint8Array([0,0,0,0,l(1)].flat()),children:[{type:"url ",contents:new Uint8Array([0,0,0,K("",!0)].flat())}]}]},Bt={type:"stsd",contents:new Uint8Array([0,0,0,0,l(1)].flat()),children:[{type:"avc1",contents:new Uint8Array([Array(6).fill(0),0,0,0,0,0,0,Array(12).fill(0),I(r(this,w).video.width),I(r(this,w).video.height),l(4718592),l(4718592),l(0),I(1),Array(32).fill(0),I(24),dt(65535)].flat()),children:[{type:"avcC",contents:r(this,V)}]}]},St={type:"stbl",children:[Bt,a,u,B,c,P]},vt={type:"minf",children:[At,Ut,St]},Mt={type:"mdia",children:[kt,gt,vt]},Tt={type:"tkhd",contents:new Uint8Array([0,0,0,3,l(Math.floor(Date.now()/1e3)+T),l(Math.floor(Date.now()/1e3)+T),l(1),l(0),l(z),Array(8).fill(0),0,0,0,0,rt(t.volume),0,0,[65536,0,0,0,65536,0,0,0,1073741824].flatMap(l),N(r(this,w).video.width),N(r(this,w).video.height)].flat())};return{type:"trak",children:[Tt,Mt]}};var Pt=st;return Lt(Rt);})();
Mp4Muxer = Mp4Muxer.default;
if (typeof module === "object" && typeof module.exports === "object") module.exports = Mp4Muxer;
