<script src="../build/mp4-muxer.js"></script>

<script type="module">
	const width = 1280;
	const height = 720;

	let muxer = new Mp4Muxer({
		target: 'buffer',
		video: {
			width,
			height
		}
	});

	let canvas = document.createElement('canvas');
	canvas.width = width;
	canvas.height = height;
	let ctx = canvas.getContext('2d');

	let encoder = new VideoEncoder({
		output: (chunk, meta) => {
			console.log(chunk, meta);
			muxer.addVideoChunk(chunk, meta);
		},
		error: (e) => console.error(e)
	});
	encoder.configure({
		codec: 'avc1.4d002a',
		width: width,
		height: height,
		bitrate: 1e6,
		framerate: 10,
	});

	for (let i = 0; i < 100; i++) {
		ctx.fillStyle = ['red', 'lime', 'blue', 'yellow'][Math.floor(Math.random() * 4)];
		ctx.fillRect(Math.random() * width, Math.random() * height, Math.random() * width, Math.random() * height);

		let frame = new VideoFrame(canvas, { timestamp: 100000 * i });
		encoder.encode(frame);
	}

	await encoder.flush();

	let buffer = muxer.finalize();
	console.log(buffer);

	function download(blob, filename) {
		const a = document.createElement('a');
		a.href = URL.createObjectURL(blob);
		a.download = filename;
		a.click();
	}
	download(new Blob([buffer]), 'test.mp4');
</script>