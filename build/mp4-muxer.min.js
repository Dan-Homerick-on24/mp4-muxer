"use strict";var Mp4Muxer=(()=>{var Ie=Object.defineProperty;var lt=Object.getOwnPropertyDescriptor;var ht=Object.getOwnPropertyNames;var ut=Object.prototype.hasOwnProperty;var mt=(t,e)=>{for(var s in e)Ie(t,s,{get:e[s],enumerable:!0})},ft=(t,e,s,i)=>{if(e&&typeof e=="object"||typeof e=="function")for(let n of ht(e))!ut.call(t,n)&&n!==s&&Ie(t,n,{get:()=>e[n],enumerable:!(i=lt(e,n))||i.enumerable});return t};var dt=t=>ft(Ie({},"__esModule",{value:!0}),t);var Pe=(t,e,s)=>{if(!e.has(t))throw TypeError("Cannot "+s)};var r=(t,e,s)=>(Pe(t,e,"read from private field"),s?s.call(t):e.get(t)),m=(t,e,s)=>{if(e.has(t))throw TypeError("Cannot add the same private member more than once");e instanceof WeakSet?e.add(t):e.set(t,s)},x=(t,e,s,i)=>(Pe(t,e,"write to private field"),i?i.call(t,s):e.set(t,s),s),Ge=(t,e,s,i)=>({set _(n){x(t,e,n,s)},get _(){return r(t,e,i)}}),d=(t,e,s)=>(Pe(t,e,"access private method"),s);var as={};mt(as,{ArrayBufferTarget:()=>se,FileSystemWritableFileStreamTarget:()=>re,Muxer:()=>Ae,StreamTarget:()=>H});var c=new Uint8Array(8),_=new DataView(c.buffer),k=t=>[(t%256+256)%256],T=t=>(_.setUint16(0,t,!1),[c[0],c[1]]),Ke=t=>(_.setInt16(0,t,!1),[c[0],c[1]]),Re=t=>(_.setUint32(0,t,!1),[c[1],c[2],c[3]]),l=t=>(_.setUint32(0,t,!1),[c[0],c[1],c[2],c[3]]),P=t=>(_.setUint32(0,Math.floor(t/2**32),!1),_.setUint32(4,t,!1),[c[0],c[1],c[2],c[3],c[4],c[5],c[6],c[7]]),be=t=>(_.setInt16(0,2**8*t,!1),[c[0],c[1]]),O=t=>(_.setInt32(0,2**16*t,!1),[c[0],c[1],c[2],c[3]]),Le=t=>(_.setInt32(0,2**30*t,!1),[c[0],c[1],c[2],c[3]]),B=(t,e=!1)=>{let s=Array(t.length).fill(null).map((i,n)=>t.charCodeAt(n));return e&&s.push(0),s},D=t=>t&&t[t.length-1],E=(t,e,s=!0)=>{let i=t*e;return s?Math.round(i):i},Ve=t=>{let e=t*(Math.PI/180),s=Math.cos(e),i=Math.sin(e);return[s,i,0,-i,s,0,0,0,1]},Fe=Ve(0),Ne=t=>[O(t[0]),O(t[1]),Le(t[2]),O(t[3]),O(t[4]),Le(t[5]),O(t[6]),O(t[7]),Le(t[8])],K=t=>!t||typeof t!="object"?t:Array.isArray(t)?t.map(K):Object.fromEntries(Object.entries(t).map(([e,s])=>[e,K(s)])),j=t=>t>=0&&t<2**32;var y=(t,e,s)=>({type:t,contents:e&&new Uint8Array(e.flat(10)),children:s}),C=(t,e,s,i,n)=>y(t,[k(e),Re(s),i??[]],n),Qe=t=>{let e=512;return t.fragmented?y("ftyp",[B("iso5"),l(e),B("iso5"),B("iso6"),B("mp41")]):y("ftyp",[B("isom"),l(e),B("isom"),t.holdsAvc?B("avc1"):[],B("mp41")])},xe=t=>({type:"mdat",largeSize:t}),Ye=t=>({type:"free",size:t}),te=(t,e,s=!1)=>y("moov",null,[pt(e,t),...t.map(i=>ct(i,e)),s?Nt(t):null]),pt=(t,e)=>{let s=E(Math.max(0,...e.filter(o=>o.samples.length>0).map(o=>D(o.samples).timestamp+D(o.samples).duration)),Ce),i=Math.max(...e.map(o=>o.id))+1,n=!j(t)||!j(s),a=n?P:l;return C("mvhd",+n,0,[a(t),a(t),l(Ce),a(s),O(1),be(1),Array(10).fill(0),Ne(Fe),Array(24).fill(0),l(i)])},ct=(t,e)=>y("trak",null,[Tt(t,e),bt(t,e)]),Tt=(t,e)=>{let s=D(t.samples),i=E(s?s.timestamp+s.duration:0,Ce),n=!j(e)||!j(i),a=n?P:l,o;return t.info.type==="video"?o=typeof t.info.rotation=="number"?Ve(t.info.rotation):t.info.rotation:o=Fe,C("tkhd",+n,3,[a(e),a(e),l(t.id),l(0),a(i),Array(8).fill(0),T(0),T(0),be(t.info.type==="audio"?1:0),T(0),Ne(o),O(t.info.type==="video"?t.info.width:0),O(t.info.type==="video"?t.info.height:0)])},bt=(t,e)=>y("mdia",null,[Ct(t,e),xt(t.info.type==="video"?"vide":"soun"),yt(t)]),Ct=(t,e)=>{let s=D(t.samples),i=E(s?s.timestamp+s.duration:0,t.timescale),n=!j(e)||!j(i),a=n?P:l;return C("mdhd",+n,0,[a(e),a(e),l(t.timescale),a(i),T(21956),T(0)])},xt=t=>C("hdlr",0,0,[B("mhlr"),B(t),l(0),l(0),l(0),B("mp4-muxer-hdlr",!0)]),yt=t=>y("minf",null,[t.info.type==="video"?St():gt(),wt(),At(t)]),St=()=>C("vmhd",0,1,[T(0),T(0),T(0),T(0)]),gt=()=>C("smhd",0,0,[T(0),T(0)]),wt=()=>y("dinf",null,[vt()]),vt=()=>C("dref",0,0,[l(1)],[kt()]),kt=()=>C("url ",0,1),At=t=>y("stbl",null,[Bt(t),Pt(t),Lt(t),Rt(t),Vt(t),Ft(t)]),Bt=t=>C("stsd",0,0,[l(1)],[t.info.type==="video"?zt(Qt[t.info.codec],t):Dt(Zt[t.info.codec],t)]),zt=(t,e)=>y(t,[Array(6).fill(0),T(1),T(0),T(0),Array(12).fill(0),T(e.info.width),T(e.info.height),l(4718592),l(4718592),l(0),T(1),Array(32).fill(0),T(24),Ke(65535)],[Yt[e.info.codec](e)]),Ot=t=>t.codecPrivate&&y("avcC",[...t.codecPrivate]),Ut=t=>t.codecPrivate&&y("hvcC",[...t.codecPrivate]),Et=t=>t.codecPrivate&&y("vpcC",[...t.codecPrivate]),_t=t=>t.codecPrivate&&y("av1C",[...t.codecPrivate]),Dt=(t,e)=>y(t,[Array(6).fill(0),T(1),T(0),T(0),l(0),T(e.info.numberOfChannels),T(16),T(0),T(0),O(e.info.sampleRate)],[Jt[e.info.codec](e)]),Mt=t=>C("esds",0,0,[l(58753152),k(32+t.codecPrivate.byteLength),T(1),k(0),l(75530368),k(18+t.codecPrivate.byteLength),k(64),k(21),Re(0),l(130071),l(130071),l(92307584),k(t.codecPrivate.byteLength),...t.codecPrivate,l(109084800),k(1),k(2)]),It=t=>y("dOps",[k(0),k(t.info.numberOfChannels),T(3840),l(t.info.sampleRate),be(0),k(0)]),Pt=t=>C("stts",0,0,[l(t.timeToSampleTable.length),t.timeToSampleTable.map(e=>[l(e.sampleCount),l(e.sampleDelta)])]),Lt=t=>{if(t.samples.every(s=>s.type==="key"))return null;let e=[...t.samples.entries()].filter(([,s])=>s.type==="key");return C("stss",0,0,[l(e.length),e.map(([s])=>l(s+1))])},Rt=t=>C("stsc",0,0,[l(t.compactlyCodedChunkTable.length),t.compactlyCodedChunkTable.map(e=>[l(e.firstChunk),l(e.samplesPerChunk),l(1)])]),Vt=t=>C("stsz",0,0,[l(0),l(t.samples.length),t.samples.map(e=>l(e.size))]),Ft=t=>t.finalizedChunks.length>0&&D(t.finalizedChunks).offset>=2**32?C("co64",0,0,[l(t.finalizedChunks.length),t.finalizedChunks.map(e=>P(e.offset))]):C("stco",0,0,[l(t.finalizedChunks.length),t.finalizedChunks.map(e=>l(e.offset))]),Nt=t=>y("mvex",null,t.map(jt)),jt=t=>C("trex",0,0,[l(t.id),l(1),l(0),l(0),l(0)]),je=(t,e)=>y("moof",null,[Ht(t),...e.map($t)]),Ht=t=>C("mfhd",0,0,[l(t)]),Ze=t=>{let e=0,s=0,i=0,n=0,a=t.type==="delta";return s|=+a,a?e|=1:e|=2,e<<24|s<<16|i<<8|n},$t=t=>y("traf",null,[Wt(t),Xt(t),qt(t)]),Wt=t=>{let e=0;e|=8,e|=16,e|=32,e|=131072;let s=t.currentChunk.samples[1]??t.currentChunk.samples[0],i={duration:s.timescaleUnitsToNextSample,size:s.size,flags:Ze(s)};return C("tfhd",0,e,[l(t.id),l(i.duration),l(i.size),l(i.flags)])},Xt=t=>C("tfdt",1,0,[P(E(t.currentChunk.startTimestamp,t.timescale))]),qt=t=>{let e=t.currentChunk.samples.map(G=>G.timescaleUnitsToNextSample),s=t.currentChunk.samples.map(G=>G.size),i=t.currentChunk.samples.map(Ze),n=new Set(e),a=new Set(s),o=new Set(i),f=o.size===2&&i[0]!==i[1],p=n.size>1,b=a.size>1,A=!f&&o.size>1,I=0;return I|=1,I|=4*+f,I|=256*+p,I|=512*+b,I|=1024*+A,C("trun",0,I,[l(t.currentChunk.samples.length),l(t.currentChunk.offset-t.currentChunk.moofOffset||0),f?l(i[0]):[],t.currentChunk.samples.map((G,Me)=>[p?l(e[Me]):[],b?l(s[Me]):[],A?l(i[Me]):[]])])},Je=t=>y("mfra",null,[...t.map(Gt),Kt()]),Gt=(t,e)=>C("tfra",1,0,[l(t.id),l(63),l(t.finalizedChunks.length),t.finalizedChunks.map(i=>[P(E(i.startTimestamp,t.timescale)),P(i.moofOffset),l(e+1),l(1),l(1)])]),Kt=()=>C("mfro",0,0,[l(0)]),Qt={avc:"avc1",hevc:"hvc1",vp9:"vp09",av1:"av01"},Yt={avc:Ot,hevc:Ut,vp9:Et,av1:_t},Zt={aac:"mp4a",opus:"Opus"},Jt={aac:Mt,opus:It};var se=class{constructor(){this.buffer=null}},H=class{constructor(e){this.options=e}},re=class{constructor(e,s){this.stream=e;this.options=s}};var L,$,ie=class{constructor(){this.pos=0;m(this,L,new Uint8Array(8));m(this,$,new DataView(r(this,L).buffer));this.offsets=new WeakMap}seek(e){this.pos=e}writeU32(e){r(this,$).setUint32(0,e,!1),this.write(r(this,L).subarray(0,4))}writeU64(e){r(this,$).setUint32(0,Math.floor(e/2**32),!1),r(this,$).setUint32(4,e,!1),this.write(r(this,L).subarray(0,8))}writeAscii(e){for(let s=0;s<e.length;s++)r(this,$).setUint8(s%8,e.charCodeAt(s)),s%8===7&&this.write(r(this,L));e.length%8!==0&&this.write(r(this,L).subarray(0,e.length%8))}writeBox(e){if(this.offsets.set(e,this.pos),e.contents&&!e.children)this.writeBoxHeader(e,e.size??e.contents.byteLength+8),this.write(e.contents);else{let s=this.pos;if(this.writeBoxHeader(e,0),e.contents&&this.write(e.contents),e.children)for(let a of e.children)a&&this.writeBox(a);let i=this.pos,n=e.size??i-s;this.seek(s),this.writeBoxHeader(e,n),this.seek(i)}}writeBoxHeader(e,s){this.writeU32(e.largeSize?1:s),this.writeAscii(e.type),e.largeSize&&this.writeU64(s)}measureBoxHeader(e){return 8+(e.largeSize?8:0)}patchBox(e){let s=this.pos;this.seek(this.offsets.get(e)),this.writeBox(e),this.seek(s)}measureBox(e){if(e.contents&&!e.children)return this.measureBoxHeader(e)+e.contents.byteLength;{let s=this.measureBoxHeader(e);if(e.contents&&(s+=e.contents.byteLength),e.children)for(let i of e.children)i&&(s+=this.measureBox(i));return s}}};L=new WeakMap,$=new WeakMap;var oe,R,Q,Y,le,He,Se=class extends ie{constructor(s){super();m(this,le);m(this,oe,void 0);m(this,R,new ArrayBuffer(2**16));m(this,Q,new Uint8Array(r(this,R)));m(this,Y,0);x(this,oe,s)}write(s){d(this,le,He).call(this,this.pos+s.byteLength),r(this,Q).set(s,this.pos),this.pos+=s.byteLength,x(this,Y,Math.max(r(this,Y),this.pos))}finalize(){d(this,le,He).call(this,this.pos),r(this,oe).buffer=r(this,R).slice(0,Math.max(r(this,Y),this.pos))}};oe=new WeakMap,R=new WeakMap,Q=new WeakMap,Y=new WeakMap,le=new WeakSet,He=function(s){let i=r(this,R).byteLength;for(;i<s;)i*=2;if(i===r(this,R).byteLength)return;let n=new ArrayBuffer(i),a=new Uint8Array(n);a.set(r(this,Q),0),x(this,R,n),x(this,Q,a)};var he,V,ne=class extends ie{constructor(s){super();m(this,he,void 0);m(this,V,[]);x(this,he,s)}write(s){r(this,V).push({data:s.slice(),start:this.pos}),this.pos+=s.byteLength}flush(){if(r(this,V).length===0)return;let s=[],i=[...r(this,V)].sort((n,a)=>n.start-a.start);s.push({start:i[0].start,size:i[0].data.byteLength});for(let n=1;n<i.length;n++){let a=s[s.length-1],o=i[n];o.start<=a.start+a.size?a.size=Math.max(a.size,o.start+o.data.byteLength-a.start):s.push({start:o.start,size:o.data.byteLength})}for(let n of s){n.data=new Uint8Array(n.size);for(let a of r(this,V))n.start<=a.start&&a.start<n.start+n.size&&n.data.set(a.data,a.start-n.start);r(this,he).options.onData?.(n.data,n.start)}r(this,V).length=0}finalize(){}};he=new WeakMap,V=new WeakMap;var es=2**24,ts=2,ue,z,w,me,$e,we,et,ve,tt,Z,ye,ae=class extends ie{constructor(s){super();m(this,me);m(this,we);m(this,ve);m(this,Z);m(this,ue,void 0);m(this,z,void 0);m(this,w,[]);if(x(this,ue,s),x(this,z,s.options?.chunkSize??es),!Number.isInteger(r(this,z))||r(this,z)<2**10)throw new Error("Invalid StreamTarget options: chunkSize must be an integer not smaller than 1024.")}write(s){d(this,me,$e).call(this,s,this.pos),d(this,Z,ye).call(this),this.pos+=s.byteLength}finalize(){d(this,Z,ye).call(this,!0)}};ue=new WeakMap,z=new WeakMap,w=new WeakMap,me=new WeakSet,$e=function(s,i){let n=r(this,w).findIndex(b=>b.start<=i&&i<b.start+r(this,z));n===-1&&(n=d(this,ve,tt).call(this,i));let a=r(this,w)[n],o=i-a.start,f=s.subarray(0,Math.min(r(this,z)-o,s.byteLength));a.data.set(f,o);let p={start:o,end:o+f.byteLength};if(d(this,we,et).call(this,a,p),a.written[0].start===0&&a.written[0].end===r(this,z)&&(a.shouldFlush=!0),r(this,w).length>ts){for(let b=0;b<r(this,w).length-1;b++)r(this,w)[b].shouldFlush=!0;d(this,Z,ye).call(this)}f.byteLength<s.byteLength&&d(this,me,$e).call(this,s.subarray(f.byteLength),i+f.byteLength)},we=new WeakSet,et=function(s,i){let n=0,a=s.written.length-1,o=-1;for(;n<=a;){let f=Math.floor(n+(a-n+1)/2);s.written[f].start<=i.start?(n=f+1,o=f):a=f-1}for(s.written.splice(o+1,0,i),(o===-1||s.written[o].end<i.start)&&o++;o<s.written.length-1&&s.written[o].end>=s.written[o+1].start;)s.written[o].end=Math.max(s.written[o].end,s.written[o+1].end),s.written.splice(o+1,1)},ve=new WeakSet,tt=function(s){let n={start:Math.floor(s/r(this,z))*r(this,z),data:new Uint8Array(r(this,z)),written:[],shouldFlush:!1};return r(this,w).push(n),r(this,w).sort((a,o)=>a.start-o.start),r(this,w).indexOf(n)},Z=new WeakSet,ye=function(s=!1){for(let i=0;i<r(this,w).length;i++){let n=r(this,w)[i];if(!(!n.shouldFlush&&!s)){for(let a of n.written)r(this,ue).options.onData?.(n.data.subarray(a.start,a.end),n.start+a.start);r(this,w).splice(i--,1)}}};var ge=class extends ae{constructor(e){super(new H({onData:(s,i)=>e.stream.write({type:"write",data:s,position:i}),chunkSize:e.options?.chunkSize}))}};var Ce=1e3,ss=["avc","hevc","vp9","av1"],rs=["aac","opus"],is=2082844800,ns=["strict","offset"],u,h,de,v,S,g,W,X,Be,F,N,J,ze,st,Oe,rt,Ue,it,Ee,nt,_e,at,pe,We,U,M,De,ot,ee,ke,ce,Xe,q,fe,Te,qe,Ae=class{constructor(e){m(this,ze);m(this,Oe);m(this,Ue);m(this,Ee);m(this,_e);m(this,pe);m(this,U);m(this,De);m(this,ee);m(this,ce);m(this,q);m(this,Te);m(this,u,void 0);m(this,h,void 0);m(this,de,void 0);m(this,v,void 0);m(this,S,null);m(this,g,null);m(this,W,Math.floor(Date.now()/1e3)+is);m(this,X,[]);m(this,Be,1);m(this,F,[]);m(this,N,[]);m(this,J,!1);if(d(this,ze,st).call(this,e),e.video=K(e.video),e.audio=K(e.audio),e.fastStart=K(e.fastStart),this.target=e.target,x(this,u,{firstTimestampBehavior:"strict",...e}),e.target instanceof se)x(this,h,new Se(e.target));else if(e.target instanceof H)x(this,h,e.target.options?.chunked?new ae(e.target):new ne(e.target));else if(e.target instanceof re)x(this,h,new ge(e.target));else throw new Error(`Invalid target: ${e.target}`);d(this,Ee,nt).call(this),d(this,Oe,rt).call(this)}addVideoChunk(e,s,i){let n=new Uint8Array(e.byteLength);e.copyTo(n),this.addVideoChunkRaw(n,e.type,i??e.timestamp,e.duration,s)}addVideoChunkRaw(e,s,i,n,a){if(d(this,Te,qe).call(this),!r(this,u).video)throw new Error("No video track declared.");if(typeof r(this,u).fastStart=="object"&&r(this,S).samples.length===r(this,u).fastStart.expectedVideoChunks)throw new Error(`Cannot add more video chunks than specified in 'fastStart' (${r(this,u).fastStart.expectedVideoChunks}).`);let o=d(this,pe,We).call(this,r(this,S),e,s,i,n,a);if(r(this,u).fastStart==="fragmented"&&r(this,g)){for(;r(this,N).length>0&&r(this,N)[0].timestamp<=o.timestamp;){let f=r(this,N).shift();d(this,U,M).call(this,r(this,g),f)}o.timestamp<=r(this,g).lastTimestamp?d(this,U,M).call(this,r(this,S),o):r(this,F).push(o)}else d(this,U,M).call(this,r(this,S),o)}addAudioChunk(e,s,i){let n=new Uint8Array(e.byteLength);e.copyTo(n),this.addAudioChunkRaw(n,e.type,i??e.timestamp,e.duration,s)}addAudioChunkRaw(e,s,i,n,a){if(d(this,Te,qe).call(this),!r(this,u).audio)throw new Error("No audio track declared.");if(typeof r(this,u).fastStart=="object"&&r(this,g).samples.length===r(this,u).fastStart.expectedAudioChunks)throw new Error(`Cannot add more audio chunks than specified in 'fastStart' (${r(this,u).fastStart.expectedAudioChunks}).`);let o=d(this,pe,We).call(this,r(this,g),e,s,i,n,a);if(r(this,u).fastStart==="fragmented"&&r(this,S)){for(;r(this,F).length>0&&r(this,F)[0].timestamp<=o.timestamp;){let f=r(this,F).shift();d(this,U,M).call(this,r(this,S),f)}o.timestamp<=r(this,S).lastTimestamp?d(this,U,M).call(this,r(this,g),o):r(this,N).push(o)}else d(this,U,M).call(this,r(this,g),o)}finalize(){if(r(this,J))throw new Error("Cannot finalize a muxer more than once.");if(r(this,u).fastStart==="fragmented"){for(let s of r(this,F))d(this,U,M).call(this,r(this,S),s);for(let s of r(this,N))d(this,U,M).call(this,r(this,g),s);d(this,ce,Xe).call(this,!1)}else r(this,S)&&d(this,ee,ke).call(this,r(this,S)),r(this,g)&&d(this,ee,ke).call(this,r(this,g));let e=[r(this,S),r(this,g)].filter(Boolean);if(r(this,u).fastStart==="in-memory"){let s;for(let n=0;n<2;n++){let a=te(e,r(this,W)),o=r(this,h).measureBox(a);s=r(this,h).measureBox(r(this,v));let f=r(this,h).pos+o+s;for(let p of r(this,X)){p.offset=f;for(let{data:b}of p.samples)f+=b.byteLength,s+=b.byteLength}if(f<2**32)break;s>=2**32&&(r(this,v).largeSize=!0)}let i=te(e,r(this,W));r(this,h).writeBox(i),r(this,v).size=s,r(this,h).writeBox(r(this,v));for(let n of r(this,X))for(let a of n.samples)r(this,h).write(a.data),a.data=null}else if(r(this,u).fastStart==="fragmented"){let s=r(this,h).pos,i=Je(e);r(this,h).writeBox(i);let n=r(this,h).pos-s;r(this,h).seek(r(this,h).pos-4),r(this,h).writeU32(n)}else{let s=r(this,h).offsets.get(r(this,v)),i=r(this,h).pos-s;r(this,v).size=i,r(this,v).largeSize=i>=2**32,r(this,h).patchBox(r(this,v));let n=te(e,r(this,W));if(typeof r(this,u).fastStart=="object"){r(this,h).seek(r(this,de)),r(this,h).writeBox(n);let a=s-r(this,h).pos;r(this,h).writeBox(Ye(a))}else r(this,h).writeBox(n)}d(this,q,fe).call(this),r(this,h).finalize(),x(this,J,!0)}};u=new WeakMap,h=new WeakMap,de=new WeakMap,v=new WeakMap,S=new WeakMap,g=new WeakMap,W=new WeakMap,X=new WeakMap,Be=new WeakMap,F=new WeakMap,N=new WeakMap,J=new WeakMap,ze=new WeakSet,st=function(e){if(e.video){if(!ss.includes(e.video.codec))throw new Error(`Unsupported video codec: ${e.video.codec}`);let s=e.video.rotation;if(typeof s=="number"&&![0,90,180,270].includes(s))throw new Error(`Invalid video rotation: ${s}. Has to be 0, 90, 180 or 270.`);if(Array.isArray(s)&&(s.length!==9||s.some(i=>typeof i!="number")))throw new Error(`Invalid video transformation matrix: ${s.join()}`)}if(e.audio&&!rs.includes(e.audio.codec))throw new Error(`Unsupported audio codec: ${e.audio.codec}`);if(e.firstTimestampBehavior&&!ns.includes(e.firstTimestampBehavior))throw new Error(`Invalid first timestamp behavior: ${e.firstTimestampBehavior}`);if(typeof e.fastStart=="object"){if(e.video&&e.fastStart.expectedVideoChunks===void 0)throw new Error("'fastStart' is an object but is missing property 'expectedVideoChunks'.");if(e.audio&&e.fastStart.expectedAudioChunks===void 0)throw new Error("'fastStart' is an object but is missing property 'expectedAudioChunks'.")}else if(![!1,"in-memory","fragmented"].includes(e.fastStart))throw new Error("'fastStart' option must be false, 'in-memory', 'fragmented' or an object.")},Oe=new WeakSet,rt=function(){if(r(this,h).writeBox(Qe({holdsAvc:r(this,u).video?.codec==="avc",fragmented:r(this,u).fastStart==="fragmented"})),x(this,de,r(this,h).pos),r(this,u).fastStart==="in-memory")x(this,v,xe(!1));else if(r(this,u).fastStart!=="fragmented"){if(typeof r(this,u).fastStart=="object"){let e=d(this,Ue,it).call(this);r(this,h).seek(r(this,h).pos+e)}x(this,v,xe(!0)),r(this,h).writeBox(r(this,v))}d(this,q,fe).call(this)},Ue=new WeakSet,it=function(){if(typeof r(this,u).fastStart!="object")return;let e=0,s=[r(this,u).fastStart.expectedVideoChunks,r(this,u).fastStart.expectedAudioChunks];for(let i of s)i&&(e+=(4+4)*Math.ceil(2/3*i),e+=4*i,e+=(4+4+4)*Math.ceil(2/3*i),e+=4*i,e+=8*i);return e+=4096,e},Ee=new WeakSet,nt=function(){if(r(this,u).video&&x(this,S,{id:1,info:{type:"video",codec:r(this,u).video.codec,width:r(this,u).video.width,height:r(this,u).video.height,rotation:r(this,u).video.rotation??0},timescale:11520,codecPrivate:new Uint8Array(0),samples:[],finalizedChunks:[],currentChunk:null,firstTimestamp:void 0,lastTimestamp:-1,timeToSampleTable:[],lastTimescaleUnits:null,lastSample:null,compactlyCodedChunkTable:[]}),r(this,u).audio){let e=d(this,_e,at).call(this,2,r(this,u).audio.sampleRate,r(this,u).audio.numberOfChannels);x(this,g,{id:r(this,u).video?2:1,info:{type:"audio",codec:r(this,u).audio.codec,numberOfChannels:r(this,u).audio.numberOfChannels,sampleRate:r(this,u).audio.sampleRate},timescale:r(this,u).audio.sampleRate,codecPrivate:e,samples:[],finalizedChunks:[],currentChunk:null,firstTimestamp:void 0,lastTimestamp:-1,timeToSampleTable:[],lastTimescaleUnits:null,lastSample:null,compactlyCodedChunkTable:[]})}},_e=new WeakSet,at=function(e,s,i){let a=[96e3,88200,64e3,48e3,44100,32e3,24e3,22050,16e3,12e3,11025,8e3,7350].indexOf(s),o=i,f="";f+=e.toString(2).padStart(5,"0"),f+=a.toString(2).padStart(4,"0"),a===15&&(f+=s.toString(2).padStart(24,"0")),f+=o.toString(2).padStart(4,"0");let p=Math.ceil(f.length/8)*8;f=f.padEnd(p,"0");let b=new Uint8Array(f.length/8);for(let A=0;A<f.length;A+=8)b[A/8]=parseInt(f.slice(A,A+8),2);return b},pe=new WeakSet,We=function(e,s,i,n,a,o){let f=n/1e6,p=a/1e6;return f=d(this,De,ot).call(this,f,e),o?.decoderConfig?.description&&(e.codecPrivate=new Uint8Array(o.decoderConfig.description)),{timestamp:f,duration:p,data:s,size:s.byteLength,type:i,timescaleUnitsToNextSample:E(p,e.timescale)}},U=new WeakSet,M=function(e,s){if(r(this,u).fastStart!=="fragmented"&&e.samples.push(s),e.lastTimescaleUnits!==null){let n=E(s.timestamp,e.timescale,!1),a=Math.round(n-e.lastTimescaleUnits);if(e.lastTimescaleUnits+=a,e.lastSample.timescaleUnitsToNextSample=a,r(this,u).fastStart!=="fragmented"){let o=D(e.timeToSampleTable);o.sampleCount===1?(o.sampleDelta=a,o.sampleCount++):o.sampleDelta===a?o.sampleCount++:(o.sampleCount--,e.timeToSampleTable.push({sampleCount:2,sampleDelta:a}))}}else e.lastTimescaleUnits=0,r(this,u).fastStart!=="fragmented"&&e.timeToSampleTable.push({sampleCount:1,sampleDelta:E(s.duration,e.timescale)});e.lastSample=s;let i=!1;if(!e.currentChunk)i=!0;else{let n=s.timestamp-e.currentChunk.startTimestamp;if(r(this,u).fastStart==="fragmented"){let a=r(this,S)??r(this,g);e===a&&s.type==="key"&&n>=1&&(i=!0,d(this,ce,Xe).call(this))}else i=n>=.5}i&&(e.currentChunk&&d(this,ee,ke).call(this,e),e.currentChunk={startTimestamp:s.timestamp,samples:[]}),e.currentChunk.samples.push(s)},De=new WeakSet,ot=function(e,s){if(r(this,u).firstTimestampBehavior==="strict"&&s.lastTimestamp===-1&&e!==0)throw new Error(`The first chunk for your media track must have a timestamp of 0 (received ${e}). Non-zero first timestamps are often caused by directly piping frames or audio data from a MediaStreamTrack into the encoder. Their timestamps are typically relative to the age of the document, which is probably what you want.

If you want to offset all timestamps of a track such that the first one is zero, set firstTimestampBehavior: 'offset' in the options.
`);if(r(this,u).firstTimestampBehavior==="offset"&&(s.firstTimestamp===void 0&&(s.firstTimestamp=e),e-=s.firstTimestamp),e<s.lastTimestamp)throw new Error(`Timestamps must be monotonically increasing (went from ${s.lastTimestamp*1e6} to ${e*1e6}).`);return s.lastTimestamp=e,e},ee=new WeakSet,ke=function(e){if(r(this,u).fastStart==="fragmented")throw new Error("Can't finalize individual chunks 'fastStart' is set to 'fragmented'.");if(e.currentChunk){if(e.finalizedChunks.push(e.currentChunk),r(this,X).push(e.currentChunk),(e.compactlyCodedChunkTable.length===0||D(e.compactlyCodedChunkTable).samplesPerChunk!==e.currentChunk.samples.length)&&e.compactlyCodedChunkTable.push({firstChunk:e.finalizedChunks.length,samplesPerChunk:e.currentChunk.samples.length}),r(this,u).fastStart==="in-memory"){e.currentChunk.offset=0;return}e.currentChunk.offset=r(this,h).pos;for(let s of e.currentChunk.samples)r(this,h).write(s.data),s.data=null;d(this,q,fe).call(this)}},ce=new WeakSet,Xe=function(e=!0){if(r(this,u).fastStart!=="fragmented")throw new Error("Can't finalize a fragment unless 'fastStart' is set to 'fragmented'.");let s=[r(this,S),r(this,g)].filter(p=>p&&p.currentChunk);if(s.length===0)return;let i=Ge(this,Be)._++;if(i===1){let p=te(s,r(this,W),!0);r(this,h).writeBox(p)}let n=r(this,h).pos,a=je(i,s);r(this,h).writeBox(a);{let p=xe(!1),b=0;for(let I of s)for(let G of I.currentChunk.samples)b+=G.size;let A=r(this,h).measureBox(p)+b;A>=2**32&&(p.largeSize=!0,A=r(this,h).measureBox(p)+b),p.size=A,r(this,h).writeBox(p)}for(let p of s){p.currentChunk.offset=r(this,h).pos,p.currentChunk.moofOffset=n;for(let b of p.currentChunk.samples)r(this,h).write(b.data),b.data=null}let o=r(this,h).pos;r(this,h).seek(r(this,h).offsets.get(a));let f=je(i,s);r(this,h).writeBox(f),r(this,h).seek(o);for(let p of s)p.finalizedChunks.push(p.currentChunk),r(this,X).push(p.currentChunk),p.currentChunk=null;e&&d(this,q,fe).call(this)},q=new WeakSet,fe=function(){r(this,h)instanceof ne&&r(this,h).flush()},Te=new WeakSet,qe=function(){if(r(this,J))throw new Error("Cannot add new video or audio chunks after the file has been finalized.")};return dt(as);})();
if (typeof module === "object" && typeof module.exports === "object") Object.assign(module.exports, Mp4Muxer)
