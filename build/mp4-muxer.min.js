"use strict";var Mp4Muxer=(()=>{var j=Object.defineProperty;var Ut=Object.getOwnPropertyDescriptor;var Bt=Object.getOwnPropertyNames,pt=Object.getOwnPropertySymbols;var yt=Object.prototype.hasOwnProperty,Dt=Object.prototype.propertyIsEnumerable;var v=Math.pow,ct=(r,t,e)=>t in r?j(r,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):r[t]=e,wt=(r,t)=>{for(var e in t||={})yt.call(t,e)&&ct(r,e,t[e]);if(pt)for(var e of pt(t))Dt.call(t,e)&&ct(r,e,t[e]);return r};var Mt=(r,t)=>{for(var e in t)j(r,e,{get:t[e],enumerable:!0})},Et=(r,t,e,i)=>{if(t&&typeof t=="object"||typeof t=="function")for(let n of Bt(t))!yt.call(r,n)&&n!==e&&j(r,n,{get:()=>t[n],enumerable:!(i=Ut(t,n))||i.enumerable});return r};var zt=r=>Et(j({},"__esModule",{value:!0}),r);var ut=(r,t,e)=>{if(!t.has(r))throw TypeError("Cannot "+e)};var s=(r,t,e)=>(ut(r,t,"read from private field"),e?e.call(r):t.get(r)),d=(r,t,e)=>{if(t.has(r))throw TypeError("Cannot add the same private member more than once");t instanceof WeakSet?t.add(r):t.set(r,e)},y=(r,t,e,i)=>(ut(r,t,"write to private field"),i?i.call(r,e):t.set(r,e),e);var w=(r,t,e)=>(ut(r,t,"access private method"),e);var ue={};Mt(ue,{ArrayBufferTarget:()=>H,FileSystemWritableFileStreamTarget:()=>W,Muxer:()=>rt,StreamTarget:()=>z});var l=new Uint8Array(8),g=new DataView(l.buffer),T=r=>[(r%256+256)%256],u=r=>(g.setUint16(0,r,!1),[l[0],l[1]]),bt=r=>(g.setInt16(0,r,!1),[l[0],l[1]]),lt=r=>(g.setUint32(0,r,!1),[l[1],l[2],l[3]]),a=r=>(g.setUint32(0,r,!1),[l[0],l[1],l[2],l[3]]),xt=r=>(g.setUint32(0,r/v(2,32),!1),g.setUint32(4,r,!1),[l[0],l[1],l[2],l[3],l[4],l[5],l[6],l[7]]),dt=r=>(g.setUint8(0,r),g.setUint8(1,r<<8),[l[0],l[1]]),V=r=>(g.setUint16(0,r,!1),g.setUint16(2,r<<16,!1),[l[0],l[1],l[2],l[3]]),C=(r,t=!1)=>{let e=Array(r.length).fill(null).map((i,n)=>r.charCodeAt(n));return t&&e.push(0),e},E=r=>r&&r[r.length-1];var Ct=[65536,0,0,0,65536,0,0,0,1073741824].map(a),x=(r,t,e)=>({type:r,contents:t&&new Uint8Array(t.flat(10)),children:e}),c=(r,t,e,i,n)=>x(r,[T(t),lt(e),i!=null?i:[]],n),O=(r,t)=>Math.round(r*t),gt=r=>r?x("ftyp",[C("isom"),a(0),C("iso4"),C("hvc1")]):x("ftyp",[C("isom"),a(0),C("isom"),C("avc1"),C("mp41")]),Tt=()=>({type:"mdat",largeSize:!0}),At=(r,t)=>x("moov",null,[It(t,r),...r.map(e=>Ot(e,t))]),It=(r,t)=>{let e=O(Math.max(...t.map(n=>E(n.samples).timestamp+E(n.samples).duration)),q),i=Math.max(...t.map(n=>n.id))+1;return c("mvhd",0,0,[a(r),a(r),a(q),a(e),V(1),dt(1),Array(10).fill(0),Ct,Array(24).fill(0),a(i)])},Ot=(r,t)=>x("trak",null,[Pt(r,t),_t(r,t)]),Pt=(r,t)=>{let e=E(r.samples),i=O(e.timestamp+e.duration,q);return c("tkhd",0,3,[a(t),a(t),a(r.id),a(0),a(i),Array(8).fill(0),u(0),u(0),dt(r.info.type==="audio"?1:0),u(0),Ct,V(r.info.type==="video"?r.info.width:0),V(r.info.type==="video"?r.info.height:0)])},_t=(r,t)=>x("mdia",null,[Lt(r,t),Ft(r.info.type==="video"?"vide":"soun"),Rt(r)]),Lt=(r,t)=>{let e=E(r.samples),i=O(e.timestamp+e.duration,r.timescale);return c("mdhd",0,0,[a(t),a(t),a(r.timescale),a(i),u(21956),u(0)])},Ft=r=>c("hdlr",0,0,[C("mhlr"),C(r),a(0),a(0),a(0),C("mp4-muxer-hdlr")]),Rt=r=>x("minf",null,[r.info.type==="video"?Nt():Vt(),Ht(),Gt(r)]),Nt=()=>c("vmhd",0,1,[u(0),u(0),u(0),u(0)]),Vt=()=>c("smhd",0,0,[u(0),u(0)]),Ht=()=>x("dinf",null,[Wt()]),Wt=()=>c("dref",0,0,[a(1)],[$t()]),$t=()=>c("url ",0,1),Gt=r=>x("stbl",null,[Kt(r),Jt(r),Qt(r),te(r),ee(r),re(r)]),Kt=r=>c("stsd",0,0,[a(1)],[r.info.type==="video"?Xt(r.info.codec==="avc"?"avc1":"hvc1",r,r.info.codec==="avc"?Yt(r):Zt(r)):jt("mp4a",r,qt(r))]),Xt=(r,t,e)=>x(r,[Array(6).fill(0),u(1),u(0),u(0),Array(12).fill(0),u(t.info.width),u(t.info.height),a(4718592),a(4718592),a(0),u(1),Array(32).fill(0),u(24),bt(65535)],[e]),Yt=r=>x("avcC",[...r.codecPrivate]),Zt=r=>x("hvcC",[...r.codecPrivate]),jt=(r,t,e)=>x(r,[Array(6).fill(0),u(1),u(0),u(0),a(0),u(t.info.numberOfChannels),u(16),u(0),u(0),V(t.info.sampleRate)],[e]),qt=r=>c("esds",0,0,[a(58753152),T(34),u(1),T(0),a(75530368),T(20),T(64),T(21),lt(0),a(130071),a(130071),a(92307584),T(2),r.codecPrivate[0],r.codecPrivate[1],a(109084800),T(1),T(2)]),Jt=r=>{var i,n;let t=[],e=[];for(let o of r.samples){if(t.push(o),t.length===1)continue;let h=O(t[1].timestamp-t[0].timestamp,r.timescale);O(o.timestamp-t[t.length-2].timestamp,r.timescale)!==h&&(e.push({sampleCount:t.length-1,sampleDelta:h}),t=t.slice(-2))}return e.push({sampleCount:t.length,sampleDelta:O(((n=(i=t[1])==null?void 0:i.timestamp)!=null?n:t[0].timestamp)-t[0].timestamp,r.timescale)}),c("stts",0,0,[a(e.length),e.map(o=>[a(o.sampleCount),a(o.sampleDelta)])])},Qt=r=>{if(r.samples.every(e=>e.type==="key"))return null;let t=[...r.samples.entries()].filter(([,e])=>e.type==="key");return c("stss",0,0,[a(t.length),t.map(([e])=>a(e+1))])},te=r=>{let t=[];for(let e=0;e<r.writtenChunks.length;e++){let i=r.writtenChunks[e];(t.length===0||E(t).samplesPerChunk!==i.sampleCount)&&t.push({firstChunk:e+1,samplesPerChunk:i.sampleCount})}return c("stsc",0,0,[a(t.length),t.map(e=>[a(e.firstChunk),a(e.samplesPerChunk),a(1)])])},ee=r=>c("stsz",0,0,[a(0),a(r.samples.length),r.samples.map(t=>a(t.size))]),re=r=>E(r.writtenChunks).offset>=v(2,32)?c("co64",0,0,[a(r.writtenChunks.length),r.writtenChunks.map(t=>xt(t.offset))]):c("stco",0,0,[a(r.writtenChunks.length),r.writtenChunks.map(t=>a(t.offset))]);var H=class{constructor(){this.buffer=null}},z=class{constructor(t,e,i){this.onData=t;this.onDone=e;this.options=i}},W=class{constructor(t){this.stream=t}};var k,I,$=class{constructor(){this.pos=0;d(this,k,new Uint8Array(8));d(this,I,new DataView(s(this,k).buffer));this.offsets=new WeakMap}seek(t){this.pos=t}writeU32(t){s(this,I).setUint32(0,t,!1),this.write(s(this,k).subarray(0,4))}writeU64(t){s(this,I).setUint32(0,Math.floor(t/v(2,32)),!1),s(this,I).setUint32(4,t,!1),this.write(s(this,k).subarray(0,8))}writeAscii(t){for(let e=0;e<t.length;e++)s(this,I).setUint8(e%8,t.charCodeAt(e)),e%8===7&&this.write(s(this,k));t.length%8!==0&&this.write(s(this,k).subarray(0,t.length%8))}writeBox(t){var e,i;if(this.offsets.set(t,this.pos),t.contents&&!t.children)this.writeBoxHeader(t,(e=t.size)!=null?e:t.contents.byteLength+8),this.write(t.contents);else{let n=this.pos;if(this.writeBoxHeader(t,0),t.contents&&this.write(t.contents),t.children)for(let m of t.children)m&&this.writeBox(m);let o=this.pos,h=(i=t.size)!=null?i:o-n;this.pos=n,this.writeBoxHeader(t,h),this.pos=o}}writeBoxHeader(t,e){this.writeU32(t.largeSize?1:e),this.writeAscii(t.type),t.largeSize&&this.writeU64(e)}patchBox(t){let e=this.pos;this.pos=this.offsets.get(t),this.writeBox(t),this.pos=e}};k=new WeakMap,I=new WeakMap;var X,S,_,J=class extends ${constructor(e){super();d(this,X,void 0);d(this,S,new ArrayBuffer(v(2,16)));d(this,_,new Uint8Array(s(this,S)));y(this,X,e)}ensureSize(e){let i=s(this,S).byteLength;for(;i<e;)i*=2;if(i===s(this,S).byteLength)return;let n=new ArrayBuffer(i),o=new Uint8Array(n);o.set(s(this,_),0),y(this,S,n),y(this,_,o)}write(e){this.ensureSize(this.pos+e.byteLength),s(this,_).set(e,this.pos),this.pos+=e.byteLength}finalize(){this.ensureSize(this.pos),s(this,X).buffer=s(this,S).slice(0,this.pos)}};X=new WeakMap,S=new WeakMap,_=new WeakMap;var L,U,G=class extends ${constructor(e){super();d(this,L,void 0);d(this,U,[]);y(this,L,e)}write(e){s(this,U).push({data:e.slice(),start:this.pos}),this.pos+=e.byteLength}flush(){if(s(this,U).length===0)return;let e=[],i=[...s(this,U)].sort((n,o)=>n.start-o.start);e.push({start:i[0].start,size:i[0].data.byteLength});for(let n=1;n<i.length;n++){let o=e[e.length-1],h=i[n];h.start<=o.start+o.size?o.size=Math.max(o.size,h.start+h.data.byteLength-o.start):e.push({start:h.start,size:h.data.byteLength})}for(let n of e){n.data=new Uint8Array(n.size);for(let o of s(this,U))n.start<=o.start&&o.start<n.start+n.size&&n.data.set(o.data,o.start-n.start);s(this,L).onData(n.data,n.start)}s(this,U).length=0}finalize(){var e,i;(i=(e=s(this,L)).onDone)==null||i.call(e)}};L=new WeakMap,U=new WeakMap;var P=v(2,24),se=2,F,b,K=class extends ${constructor(e){super();d(this,F,void 0);d(this,b,[]);y(this,F,e)}write(e){this.writeDataIntoChunks(e,this.pos),this.flushChunks(),this.pos+=e.byteLength}writeDataIntoChunks(e,i){let n=s(this,b).findIndex(A=>A.start<=i&&i<A.start+P);n===-1&&(n=this.createChunk(i));let o=s(this,b)[n],h=i-o.start,m=e.subarray(0,Math.min(P-h,e.byteLength));o.data.set(m,h);let ht={start:h,end:h+m.byteLength};if(this.insertSectionIntoChunk(o,ht),o.written[0].start===0&&o.written[0].end===P&&(o.shouldFlush=!0),s(this,b).length>se){for(let A=0;A<s(this,b).length-1;A++)s(this,b)[A].shouldFlush=!0;this.flushChunks()}m.byteLength<e.byteLength&&this.writeDataIntoChunks(e.subarray(m.byteLength),i+m.byteLength)}insertSectionIntoChunk(e,i){let n=0,o=e.written.length-1,h=-1;for(;n<=o;){let m=Math.floor(n+(o-n+1)/2);e.written[m].start<=i.start?(n=m+1,h=m):o=m-1}for(e.written.splice(h+1,0,i),(h===-1||e.written[h].end<i.start)&&h++;h<e.written.length-1&&e.written[h].end>=e.written[h+1].start;)e.written[h].end=Math.max(e.written[h].end,e.written[h+1].end),e.written.splice(h+1,1)}createChunk(e){let n={start:Math.floor(e/P)*P,data:new Uint8Array(P),written:[],shouldFlush:!1};return s(this,b).push(n),s(this,b).sort((o,h)=>o.start-h.start),s(this,b).indexOf(n)}flushChunks(e=!1){for(let i=0;i<s(this,b).length;i++){let n=s(this,b)[i];if(!(!n.shouldFlush&&!e)){for(let o of n.written)s(this,F).onData(n.data.subarray(o.start,o.end),n.start+o.start);s(this,b).splice(i--,1)}}}finalize(){var e,i;this.flushChunks(!0),(i=(e=s(this,F)).onDone)==null||i.call(e)}};F=new WeakMap,b=new WeakMap;var Q=class extends K{constructor(t){super(new z((e,i)=>t.stream.write({type:"write",data:e,position:i})))}};var q=1e3,ie=2082848400,ne=.5,ae=["avc","hevc"],oe=["aac"],he=["strict","offset","permissive"],f,p,B,D,M,st,it,nt,vt,at,kt,ot,St,Y,mt,R,tt,N,et,Z,ft,rt=class{constructor(t){d(this,nt);d(this,at);d(this,ot);d(this,Y);d(this,R);d(this,N);d(this,Z);d(this,f,void 0);d(this,p,void 0);d(this,B,void 0);d(this,D,null);d(this,M,null);d(this,st,Math.floor(Date.now()/1e3)+ie);d(this,it,!1);var e;if(w(this,nt,vt).call(this,t),this.target=t.target,y(this,f,wt({firstTimestampBehavior:"strict"},t)),t.target instanceof H)y(this,p,new J(t.target));else if(t.target instanceof z)y(this,p,(e=t.target.options)!=null&&e.chunked?new K(t.target):new G(t.target));else if(t.target instanceof W)y(this,p,new Q(t.target));else throw new Error(`Invalid target: ${t.target}`);w(this,at,kt).call(this),w(this,ot,St).call(this)}addVideoChunk(t,e){let i=new Uint8Array(t.byteLength);t.copyTo(i),this.addVideoChunkRaw(i,t.type,t.timestamp,t.duration,e)}addVideoChunkRaw(t,e,i,n,o){if(w(this,Z,ft).call(this),!s(this,f).video)throw new Error("No video track declared.");w(this,Y,mt).call(this,s(this,D),t,e,i,n,o)}addAudioChunk(t,e){let i=new Uint8Array(t.byteLength);t.copyTo(i),this.addAudioChunkRaw(i,t.type,t.timestamp,t.duration,e)}addAudioChunkRaw(t,e,i,n,o){if(w(this,Z,ft).call(this),!s(this,f).audio)throw new Error("No audio track declared.");w(this,Y,mt).call(this,s(this,M),t,e,i,n,o)}finalize(){s(this,D)&&w(this,R,tt).call(this,s(this,D)),s(this,M)&&w(this,R,tt).call(this,s(this,M));let t=s(this,p).offsets.get(s(this,B)),e=s(this,p).pos-t;s(this,B).size=e,s(this,p).patchBox(s(this,B));let i=At([s(this,D),s(this,M)].filter(Boolean),s(this,st));s(this,p).writeBox(i),w(this,N,et).call(this),s(this,p).finalize()}};f=new WeakMap,p=new WeakMap,B=new WeakMap,D=new WeakMap,M=new WeakMap,st=new WeakMap,it=new WeakMap,nt=new WeakSet,vt=function(t){if(t.video&&!ae.includes(t.video.codec))throw new Error(`Unsupported video codec: ${t.video.codec}`);if(t.audio&&!oe.includes(t.audio.codec))throw new Error(`Unsupported audio codec: ${t.audio.codec}`);if(t.firstTimestampBehavior&&!he.includes(t.firstTimestampBehavior))throw new Error(`Invalid first timestamp behavior: ${t.firstTimestampBehavior}`)},at=new WeakSet,kt=function(){var e;let t=((e=s(this,f).video)==null?void 0:e.codec)==="hevc";s(this,p).writeBox(gt(t)),y(this,B,Tt()),s(this,p).writeBox(s(this,B)),w(this,N,et).call(this)},ot=new WeakSet,St=function(){s(this,f).video&&y(this,D,{id:1,info:{type:"video",codec:s(this,f).video.codec,width:s(this,f).video.width,height:s(this,f).video.height},timescale:720,codecPrivate:null,samples:[],writtenChunks:[],currentChunk:null}),s(this,f).audio&&y(this,M,{id:s(this,f).video?2:1,info:{type:"audio",codec:s(this,f).audio.codec,numberOfChannels:s(this,f).audio.numberOfChannels,sampleRate:s(this,f).audio.sampleRate},timescale:s(this,f).audio.sampleRate,codecPrivate:null,samples:[],writtenChunks:[],currentChunk:null})},Y=new WeakSet,mt=function(t,e,i,n,o,h){var A;let m=n/1e6,ht=o/1e6;(!t.currentChunk||m-t.currentChunk.startTimestamp>=ne)&&(t.currentChunk&&w(this,R,tt).call(this,t),t.currentChunk={startTimestamp:m,sampleData:[],sampleCount:0}),t.currentChunk.sampleData.push(e),t.currentChunk.sampleCount++,(A=h==null?void 0:h.decoderConfig)!=null&&A.description&&(t.codecPrivate=new Uint8Array(h.decoderConfig.description)),t.samples.push({timestamp:m,duration:ht,size:e.byteLength,type:i})},R=new WeakSet,tt=function(t){if(t.currentChunk){t.currentChunk.offset=s(this,p).pos;for(let e of t.currentChunk.sampleData)s(this,p).write(e);t.currentChunk.sampleData=null,t.writtenChunks.push(t.currentChunk),w(this,N,et).call(this)}},N=new WeakSet,et=function(){s(this,p)instanceof G&&s(this,p).flush()},Z=new WeakSet,ft=function(){if(s(this,it))throw new Error("Cannot add new video or audio chunks after the file has been finalized.")};return zt(ue);})();
if (typeof module === "object" && typeof module.exports === "object") module.exports = Mp4Muxer;
