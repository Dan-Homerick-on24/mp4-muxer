"use strict";var Mp4Muxer=(()=>{var Q=Object.defineProperty;var Re=Object.getOwnPropertyDescriptor;var Ne=Object.getOwnPropertyNames,ve=Object.getOwnPropertySymbols;var Se=Object.prototype.hasOwnProperty,Ve=Object.prototype.propertyIsEnumerable;var A=Math.pow,Ae=(r,e,t)=>e in r?Q(r,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):r[e]=t,Ue=(r,e)=>{for(var t in e||={})Se.call(e,t)&&Ae(r,t,e[t]);if(ve)for(var t of ve(e))Ve.call(e,t)&&Ae(r,t,e[t]);return r};var He=(r,e)=>{for(var t in e)Q(r,t,{get:e[t],enumerable:!0})},We=(r,e,t,i)=>{if(e&&typeof e=="object"||typeof e=="function")for(let n of Ne(e))!Se.call(r,n)&&n!==t&&Q(r,n,{get:()=>e[n],enumerable:!(i=Re(e,n))||i.enumerable});return r};var $e=r=>We(Q({},"__esModule",{value:!0}),r);var ye=(r,e,t)=>{if(!e.has(r))throw TypeError("Cannot "+t)};var s=(r,e,t)=>(ye(r,e,"read from private field"),t?t.call(r):e.get(r)),u=(r,e,t)=>{if(e.has(r))throw TypeError("Cannot add the same private member more than once");e instanceof WeakSet?e.add(r):e.set(r,t)},w=(r,e,t,i)=>(ye(r,e,"write to private field"),i?i.call(r,t):e.set(r,t),t);var m=(r,e,t)=>(ye(r,e,"access private method"),t);var Tt={};He(Tt,{ArrayBufferTarget:()=>W,FileSystemWritableFileStreamTarget:()=>$,Muxer:()=>he,StreamTarget:()=>O});var d=new Uint8Array(8),T=new DataView(d.buffer),C=r=>[(r%256+256)%256],l=r=>(T.setUint16(0,r,!1),[d[0],d[1]]),ke=r=>(T.setInt16(0,r,!1),[d[0],d[1]]),we=r=>(T.setUint32(0,r,!1),[d[1],d[2],d[3]]),a=r=>(T.setUint32(0,r,!1),[d[0],d[1],d[2],d[3]]),Be=r=>(T.setUint32(0,Math.floor(r/A(2,32)),!1),T.setUint32(4,r,!1),[d[0],d[1],d[2],d[3],d[4],d[5],d[6],d[7]]),be=r=>(T.setUint8(0,r),T.setUint8(1,r<<8),[d[0],d[1]]),H=r=>(T.setUint16(0,r,!1),T.setUint16(2,r<<16,!1),[d[0],d[1],d[2],d[3]]),x=(r,e=!1)=>{let t=Array(r.length).fill(null).map((i,n)=>r.charCodeAt(n));return e&&t.push(0),t},D=r=>r&&r[r.length-1];var Me=[65536,0,0,0,65536,0,0,0,1073741824].map(a),g=(r,e,t)=>({type:r,contents:e&&new Uint8Array(e.flat(10)),children:t}),y=(r,e,t,i,n)=>g(r,[C(e),we(t),i!=null?i:[]],n),z=(r,e)=>Math.round(r*e),Ee=r=>r?g("ftyp",[x("isom"),a(0),x("iso4"),x("hvc1")]):g("ftyp",[x("isom"),a(0),x("isom"),x("avc1"),x("mp41")]),De=()=>({type:"mdat",largeSize:!0}),ze=(r,e)=>g("moov",null,[Ge(e,r),...r.map(t=>Ke(t,e))]),Ge=(r,e)=>{let t=z(Math.max(0,...e.filter(n=>n.samples.length>0).map(n=>D(n.samples).timestamp+D(n.samples).duration)),ee),i=Math.max(...e.map(n=>n.id))+1;return y("mvhd",0,0,[a(r),a(r),a(ee),a(t),H(1),be(1),Array(10).fill(0),Me,Array(24).fill(0),a(i)])},Ke=(r,e)=>g("trak",null,[Xe(r,e),Ye(r,e)]),Xe=(r,e)=>{let t=D(r.samples),i=z(t?t.timestamp+t.duration:0,ee);return y("tkhd",0,3,[a(e),a(e),a(r.id),a(0),a(i),Array(8).fill(0),l(0),l(0),be(r.info.type==="audio"?1:0),l(0),Me,H(r.info.type==="video"?r.info.width:0),H(r.info.type==="video"?r.info.height:0)])},Ye=(r,e)=>g("mdia",null,[Ze(r,e),je(r.info.type==="video"?"vide":"soun"),qe(r)]),Ze=(r,e)=>{let t=D(r.samples),i=z(t?t.timestamp+t.duration:0,r.timescale);return y("mdhd",0,0,[a(e),a(e),a(r.timescale),a(i),l(21956),l(0)])},je=r=>y("hdlr",0,0,[x("mhlr"),x(r),a(0),a(0),a(0),x("mp4-muxer-hdlr")]),qe=r=>g("minf",null,[r.info.type==="video"?Je():Qe(),et(),it(r)]),Je=()=>y("vmhd",0,1,[l(0),l(0),l(0),l(0)]),Qe=()=>y("smhd",0,0,[l(0),l(0)]),et=()=>g("dinf",null,[tt()]),tt=()=>y("dref",0,0,[a(1)],[rt()]),rt=()=>y("url ",0,1),it=r=>g("stbl",null,[st(r),lt(r),dt(r),mt(r),ft(r),pt(r)]),st=r=>y("stsd",0,0,[a(1)],[r.info.type==="video"?nt(r.info.codec==="avc"?"avc1":"hvc1",r,r.info.codec==="avc"?at(r):ot(r)):ht("mp4a",r,ut(r))]),nt=(r,e,t)=>g(r,[Array(6).fill(0),l(1),l(0),l(0),Array(12).fill(0),l(e.info.width),l(e.info.height),a(4718592),a(4718592),a(0),l(1),Array(32).fill(0),l(24),ke(65535)],[t]),at=r=>r.codecPrivate&&g("avcC",[...r.codecPrivate]),ot=r=>r.codecPrivate&&g("hvcC",[...r.codecPrivate]),ht=(r,e,t)=>g(r,[Array(6).fill(0),l(1),l(0),l(0),a(0),l(e.info.numberOfChannels),l(16),l(0),l(0),H(e.info.sampleRate)],[t]),ut=r=>y("esds",0,0,[a(58753152),C(32+r.codecPrivate.byteLength),l(1),C(0),a(75530368),C(18+r.codecPrivate.byteLength),C(64),C(21),we(0),a(130071),a(130071),a(92307584),C(r.codecPrivate.byteLength),...r.codecPrivate,a(109084800),C(1),C(2)]),lt=r=>{let e=[],t=[];for(let i of r.samples){if(e.push(i),e.length<=2)continue;let n=z(e[1].timestamp-e[0].timestamp,r.timescale);z(i.timestamp-e[e.length-2].timestamp,r.timescale)!==n&&(t.push({sampleCount:e.length-1,sampleDelta:n}),e=e.slice(-2))}return e.length>0&&t.push({sampleCount:e.length,sampleDelta:e.length===1?z(e[0].duration,r.timescale):z(e[1].timestamp-e[0].timestamp,r.timescale)}),y("stts",0,0,[a(t.length),t.map(i=>[a(i.sampleCount),a(i.sampleDelta)])])},dt=r=>{if(r.samples.every(t=>t.type==="key"))return null;let e=[...r.samples.entries()].filter(([,t])=>t.type==="key");return y("stss",0,0,[a(e.length),e.map(([t])=>a(t+1))])},mt=r=>{let e=[];for(let t=0;t<r.writtenChunks.length;t++){let i=r.writtenChunks[t];(e.length===0||D(e).samplesPerChunk!==i.sampleCount)&&e.push({firstChunk:t+1,samplesPerChunk:i.sampleCount})}return y("stsc",0,0,[a(e.length),e.map(t=>[a(t.firstChunk),a(t.samplesPerChunk),a(1)])])},ft=r=>y("stsz",0,0,[a(0),a(r.samples.length),r.samples.map(e=>a(e.size))]),pt=r=>r.writtenChunks.length>0&&D(r.writtenChunks).offset>=A(2,32)?y("co64",0,0,[a(r.writtenChunks.length),r.writtenChunks.map(e=>Be(e.offset))]):y("stco",0,0,[a(r.writtenChunks.length),r.writtenChunks.map(e=>a(e.offset))]);var W=class{constructor(){this.buffer=null}},O=class{constructor(e,t,i){this.onData=e;this.onDone=t;this.options=i}},$=class{constructor(e){this.stream=e}};var S,P,G=class{constructor(){this.pos=0;u(this,S,new Uint8Array(8));u(this,P,new DataView(s(this,S).buffer));this.offsets=new WeakMap}seek(e){this.pos=e}writeU32(e){s(this,P).setUint32(0,e,!1),this.write(s(this,S).subarray(0,4))}writeU64(e){s(this,P).setUint32(0,Math.floor(e/A(2,32)),!1),s(this,P).setUint32(4,e,!1),this.write(s(this,S).subarray(0,8))}writeAscii(e){for(let t=0;t<e.length;t++)s(this,P).setUint8(t%8,e.charCodeAt(t)),t%8===7&&this.write(s(this,S));e.length%8!==0&&this.write(s(this,S).subarray(0,e.length%8))}writeBox(e){var t,i;if(this.offsets.set(e,this.pos),e.contents&&!e.children)this.writeBoxHeader(e,(t=e.size)!=null?t:e.contents.byteLength+8),this.write(e.contents);else{let n=this.pos;if(this.writeBoxHeader(e,0),e.contents&&this.write(e.contents),e.children)for(let f of e.children)f&&this.writeBox(f);let o=this.pos,h=(i=e.size)!=null?i:o-n;this.pos=n,this.writeBoxHeader(e,h),this.pos=o}}writeBoxHeader(e,t){this.writeU32(e.largeSize?1:t),this.writeAscii(e.type),e.largeSize&&this.writeU64(t)}patchBox(e){let t=this.pos;this.pos=this.offsets.get(e),this.writeBox(e),this.pos=t}};S=new WeakMap,P=new WeakMap;var Y,U,L,Z,ge,re=class extends G{constructor(t){super();u(this,Z);u(this,Y,void 0);u(this,U,new ArrayBuffer(A(2,16)));u(this,L,new Uint8Array(s(this,U)));w(this,Y,t)}write(t){m(this,Z,ge).call(this,this.pos+t.byteLength),s(this,L).set(t,this.pos),this.pos+=t.byteLength}finalize(){m(this,Z,ge).call(this,this.pos),s(this,Y).buffer=s(this,U).slice(0,this.pos)}};Y=new WeakMap,U=new WeakMap,L=new WeakMap,Z=new WeakSet,ge=function(t){let i=s(this,U).byteLength;for(;i<t;)i*=2;if(i===s(this,U).byteLength)return;let n=new ArrayBuffer(i),o=new Uint8Array(n);o.set(s(this,L),0),w(this,U,n),w(this,L,o)};var _,k,K=class extends G{constructor(t){super();u(this,_,void 0);u(this,k,[]);w(this,_,t)}write(t){s(this,k).push({data:t.slice(),start:this.pos}),this.pos+=t.byteLength}flush(){if(s(this,k).length===0)return;let t=[],i=[...s(this,k)].sort((n,o)=>n.start-o.start);t.push({start:i[0].start,size:i[0].data.byteLength});for(let n=1;n<i.length;n++){let o=t[t.length-1],h=i[n];h.start<=o.start+o.size?o.size=Math.max(o.size,h.start+h.data.byteLength-o.start):t.push({start:h.start,size:h.data.byteLength})}for(let n of t){n.data=new Uint8Array(n.size);for(let o of s(this,k))n.start<=o.start&&o.start<n.start+n.size&&n.data.set(o.data,o.start-n.start);s(this,_).onData(n.data,n.start)}s(this,k).length=0}finalize(){var t,i;(i=(t=s(this,_)).onDone)==null||i.call(t)}};_=new WeakMap,k=new WeakMap;var I=A(2,24),ct=2,F,b,j,xe,se,Oe,ne,Pe,R,te,X=class extends G{constructor(t){super();u(this,j);u(this,se);u(this,ne);u(this,R);u(this,F,void 0);u(this,b,[]);w(this,F,t)}write(t){m(this,j,xe).call(this,t,this.pos),m(this,R,te).call(this),this.pos+=t.byteLength}finalize(){var t,i;m(this,R,te).call(this,!0),(i=(t=s(this,F)).onDone)==null||i.call(t)}};F=new WeakMap,b=new WeakMap,j=new WeakSet,xe=function(t,i){let n=s(this,b).findIndex(v=>v.start<=i&&i<v.start+I);n===-1&&(n=m(this,ne,Pe).call(this,i));let o=s(this,b)[n],h=i-o.start,f=t.subarray(0,Math.min(I-h,t.byteLength));o.data.set(f,h);let ce={start:h,end:h+f.byteLength};if(m(this,se,Oe).call(this,o,ce),o.written[0].start===0&&o.written[0].end===I&&(o.shouldFlush=!0),s(this,b).length>ct){for(let v=0;v<s(this,b).length-1;v++)s(this,b)[v].shouldFlush=!0;m(this,R,te).call(this)}f.byteLength<t.byteLength&&m(this,j,xe).call(this,t.subarray(f.byteLength),i+f.byteLength)},se=new WeakSet,Oe=function(t,i){let n=0,o=t.written.length-1,h=-1;for(;n<=o;){let f=Math.floor(n+(o-n+1)/2);t.written[f].start<=i.start?(n=f+1,h=f):o=f-1}for(t.written.splice(h+1,0,i),(h===-1||t.written[h].end<i.start)&&h++;h<t.written.length-1&&t.written[h].end>=t.written[h+1].start;)t.written[h].end=Math.max(t.written[h].end,t.written[h+1].end),t.written.splice(h+1,1)},ne=new WeakSet,Pe=function(t){let n={start:Math.floor(t/I)*I,data:new Uint8Array(I),written:[],shouldFlush:!1};return s(this,b).push(n),s(this,b).sort((o,h)=>o.start-h.start),s(this,b).indexOf(n)},R=new WeakSet,te=function(t=!1){for(let i=0;i<s(this,b).length;i++){let n=s(this,b)[i];if(!(!n.shouldFlush&&!t)){for(let o of n.written)s(this,F).onData(n.data.subarray(o.start,o.end),n.start+o.start);s(this,b).splice(i--,1)}}};var ie=class extends X{constructor(e){super(new O((t,i)=>e.stream.write({type:"write",data:t,position:i})))}};var ee=1e3,yt=2082844800,wt=.5,bt=["avc","hevc"],gt=["aac"],xt=["strict","offset","permissive"],p,c,B,M,E,ue,le,de,Ie,me,Le,fe,_e,q,Te,pe,Fe,N,ae,V,oe,J,Ce,he=class{constructor(e){u(this,de);u(this,me);u(this,fe);u(this,q);u(this,pe);u(this,N);u(this,V);u(this,J);u(this,p,void 0);u(this,c,void 0);u(this,B,void 0);u(this,M,null);u(this,E,null);u(this,ue,Math.floor(Date.now()/1e3)+yt);u(this,le,!1);var t;if(m(this,de,Ie).call(this,e),this.target=e.target,w(this,p,Ue({firstTimestampBehavior:"strict"},e)),e.target instanceof W)w(this,c,new re(e.target));else if(e.target instanceof O)w(this,c,(t=e.target.options)!=null&&t.chunked?new X(e.target):new K(e.target));else if(e.target instanceof $)w(this,c,new ie(e.target));else throw new Error(`Invalid target: ${e.target}`);m(this,me,Le).call(this),m(this,fe,_e).call(this)}addVideoChunk(e,t,i){let n=new Uint8Array(e.byteLength);e.copyTo(n),this.addVideoChunkRaw(n,e.type,i!=null?i:e.timestamp,e.duration,t)}addVideoChunkRaw(e,t,i,n,o){if(m(this,J,Ce).call(this),!s(this,p).video)throw new Error("No video track declared.");m(this,q,Te).call(this,s(this,M),e,t,i,n,o)}addAudioChunk(e,t,i){let n=new Uint8Array(e.byteLength);e.copyTo(n),this.addAudioChunkRaw(n,e.type,i!=null?i:e.timestamp,e.duration,t)}addAudioChunkRaw(e,t,i,n,o){if(m(this,J,Ce).call(this),!s(this,p).audio)throw new Error("No audio track declared.");m(this,q,Te).call(this,s(this,E),e,t,i,n,o)}finalize(){s(this,M)&&m(this,N,ae).call(this,s(this,M)),s(this,E)&&m(this,N,ae).call(this,s(this,E));let e=s(this,c).offsets.get(s(this,B)),t=s(this,c).pos-e;s(this,B).size=t,s(this,c).patchBox(s(this,B));let i=ze([s(this,M),s(this,E)].filter(Boolean),s(this,ue));s(this,c).writeBox(i),m(this,V,oe).call(this),s(this,c).finalize()}};p=new WeakMap,c=new WeakMap,B=new WeakMap,M=new WeakMap,E=new WeakMap,ue=new WeakMap,le=new WeakMap,de=new WeakSet,Ie=function(e){if(e.video&&!bt.includes(e.video.codec))throw new Error(`Unsupported video codec: ${e.video.codec}`);if(e.audio&&!gt.includes(e.audio.codec))throw new Error(`Unsupported audio codec: ${e.audio.codec}`);if(e.firstTimestampBehavior&&!xt.includes(e.firstTimestampBehavior))throw new Error(`Invalid first timestamp behavior: ${e.firstTimestampBehavior}`)},me=new WeakSet,Le=function(){var t;let e=((t=s(this,p).video)==null?void 0:t.codec)==="hevc";s(this,c).writeBox(Ee(e)),w(this,B,De()),s(this,c).writeBox(s(this,B)),m(this,V,oe).call(this)},fe=new WeakSet,_e=function(){s(this,p).video&&w(this,M,{id:1,info:{type:"video",codec:s(this,p).video.codec,width:s(this,p).video.width,height:s(this,p).video.height},timescale:720,codecPrivate:new Uint8Array(0),samples:[],writtenChunks:[],currentChunk:null,firstTimestamp:void 0,lastTimestamp:-1}),s(this,p).audio&&w(this,E,{id:s(this,p).video?2:1,info:{type:"audio",codec:s(this,p).audio.codec,numberOfChannels:s(this,p).audio.numberOfChannels,sampleRate:s(this,p).audio.sampleRate},timescale:s(this,p).audio.sampleRate,codecPrivate:new Uint8Array(0),samples:[],writtenChunks:[],currentChunk:null,firstTimestamp:void 0,lastTimestamp:-1})},q=new WeakSet,Te=function(e,t,i,n,o,h){var v;let f=n/1e6,ce=o/1e6;e.firstTimestamp===void 0&&(e.firstTimestamp=f),f=m(this,pe,Fe).call(this,f,e),(!e.currentChunk||f-e.currentChunk.startTimestamp>=wt)&&(e.currentChunk&&m(this,N,ae).call(this,e),e.currentChunk={startTimestamp:f,sampleData:[],sampleCount:0}),e.currentChunk.sampleData.push(t),e.currentChunk.sampleCount++,(v=h==null?void 0:h.decoderConfig)!=null&&v.description&&(e.codecPrivate=new Uint8Array(h.decoderConfig.description)),e.samples.push({timestamp:f,duration:ce,size:t.byteLength,type:i})},pe=new WeakSet,Fe=function(e,t){if(s(this,p).firstTimestampBehavior==="strict"&&t.lastTimestamp===-1&&e!==0)throw new Error(`The first chunk for your media track must have a timestamp of 0 (received ${e}). Non-zero first timestamps are often caused by directly piping frames or audio data from a MediaStreamTrack into the encoder. Their timestamps are typically relative to the age of the document, which is probably what you want.

If you want to offset all timestamps of a track such that the first one is zero, set firstTimestampBehavior: 'offset' in the options.
If you want to allow non-zero first timestamps, set firstTimestampBehavior: 'permissive'.
`);if(s(this,p).firstTimestampBehavior==="offset"&&(e-=t.firstTimestamp),e<t.lastTimestamp)throw new Error(`Timestamps must be monotonically increasing (went from ${t.lastTimestamp*1e6} to ${e*1e6}).`);return e},N=new WeakSet,ae=function(e){if(e.currentChunk){e.currentChunk.offset=s(this,c).pos;for(let t of e.currentChunk.sampleData)s(this,c).write(t);e.currentChunk.sampleData=null,e.writtenChunks.push(e.currentChunk),m(this,V,oe).call(this)}},V=new WeakSet,oe=function(){s(this,c)instanceof K&&s(this,c).flush()},J=new WeakSet,Ce=function(){if(s(this,le))throw new Error("Cannot add new video or audio chunks after the file has been finalized.")};return $e(Tt);})();
if (typeof module === "object" && typeof module.exports === "object") {
	module.exports.Muxer = Mp4Muxer.Muxer;
	module.exports.ArrayBufferTarget = Mp4Muxer.ArrayBufferTarget;
	module.exports.StreamTarget = Mp4Muxer.StreamTarget;
	module.exports.FileSystemWritableFileStreamTarget = Mp4Muxer.FileSystemWritableFileStreamTarget;
}
