var He=Object.defineProperty;var Ue=Object.getOwnPropertySymbols;var We=Object.prototype.hasOwnProperty,Xe=Object.prototype.propertyIsEnumerable;var A=Math.pow,Oe=(t,e,r)=>e in t?He(t,e,{enumerable:!0,configurable:!0,writable:!0,value:r}):t[e]=r,ke=(t,e)=>{for(var r in e||={})We.call(e,r)&&Oe(t,r,e[r]);if(Ue)for(var r of Ue(e))Xe.call(e,r)&&Oe(t,r,e[r]);return t};var Ce=(t,e,r)=>{if(!e.has(t))throw TypeError("Cannot "+r)};var i=(t,e,r)=>(Ce(t,e,"read from private field"),r?r.call(t):e.get(t)),u=(t,e,r)=>{if(e.has(t))throw TypeError("Cannot add the same private member more than once");e instanceof WeakSet?e.add(t):e.set(t,r)},T=(t,e,r,s)=>(Ce(t,e,"write to private field"),s?s.call(t,r):e.set(t,r),r);var m=(t,e,r)=>(Ce(t,e,"access private method"),r);var c=new Uint8Array(8),S=new DataView(c.buffer),w=t=>[(t%256+256)%256],d=t=>(S.setUint16(0,t,!1),[c[0],c[1]]),Ee=t=>(S.setInt16(0,t,!1),[c[0],c[1]]),we=t=>(S.setUint32(0,t,!1),[c[1],c[2],c[3]]),a=t=>(S.setUint32(0,t,!1),[c[0],c[1],c[2],c[3]]),De=t=>(S.setUint32(0,Math.floor(t/A(2,32)),!1),S.setUint32(4,t,!1),[c[0],c[1],c[2],c[3],c[4],c[5],c[6],c[7]]),re=t=>(S.setUint8(0,t),S.setUint8(1,t<<8),[c[0],c[1]]),$=t=>(S.setUint16(0,t,!1),S.setUint16(2,t<<16,!1),[c[0],c[1],c[2],c[3]]),v=(t,e=!1)=>{let r=Array(t.length).fill(null).map((s,n)=>t.charCodeAt(n));return e&&r.push(0),r},U=t=>t&&t[t.length-1],P=(t,e,r=!0)=>{let s=t*e;return r?Math.round(s):s};var Be=[65536,0,0,0,65536,0,0,0,1073741824].map(a),b=(t,e,r)=>({type:t,contents:e&&new Uint8Array(e.flat(10)),children:r}),y=(t,e,r,s,n)=>b(t,[w(e),we(r),s!=null?s:[]],n),_e=t=>t?b("ftyp",[v("isom"),a(0),v("iso4"),v("hvc1")]):b("ftyp",[v("isom"),a(0),v("isom"),v("avc1"),v("mp41")]),Ie=()=>({type:"mdat",largeSize:!0}),Pe=(t,e)=>b("moov",null,[$e(e,t),...t.map(r=>Ge(r,e))]),$e=(t,e)=>{let r=P(Math.max(0,...e.filter(n=>n.samples.length>0).map(n=>U(n.samples).timestamp+U(n.samples).duration)),ie),s=Math.max(...e.map(n=>n.id))+1;return y("mvhd",0,0,[a(t),a(t),a(ie),a(r),$(1),re(1),Array(10).fill(0),Be,Array(24).fill(0),a(s)])},Ge=(t,e)=>b("trak",null,[qe(t,e),Ke(t,e)]),qe=(t,e)=>{let r=U(t.samples),s=P(r?r.timestamp+r.duration:0,ie);return y("tkhd",0,3,[a(e),a(e),a(t.id),a(0),a(s),Array(8).fill(0),d(0),d(0),re(t.info.type==="audio"?1:0),d(0),Be,$(t.info.type==="video"?t.info.width:0),$(t.info.type==="video"?t.info.height:0)])},Ke=(t,e)=>b("mdia",null,[Ye(t,e),Ze(t.info.type==="video"?"vide":"soun"),je(t)]),Ye=(t,e)=>{let r=U(t.samples),s=P(r?r.timestamp+r.duration:0,t.timescale);return y("mdhd",0,0,[a(e),a(e),a(t.timescale),a(s),d(21956),d(0)])},Ze=t=>y("hdlr",0,0,[v("mhlr"),v(t),a(0),a(0),a(0),v("mp4-muxer-hdlr")]),je=t=>b("minf",null,[t.info.type==="video"?Je():Qe(),et(),it(t)]),Je=()=>y("vmhd",0,1,[d(0),d(0),d(0),d(0)]),Qe=()=>y("smhd",0,0,[d(0),d(0)]),et=()=>b("dinf",null,[tt()]),tt=()=>y("dref",0,0,[a(1)],[rt()]),rt=()=>y("url ",0,1),it=t=>b("stbl",null,[st(t),ct(t),pt(t),ft(t),Tt(t),bt(t)]),st=t=>y("stsd",0,0,[a(1)],[t.info.type==="video"?nt(yt[t.info.codec],t):ut(wt[t.info.codec],t)]),nt=(t,e)=>b(t,[Array(6).fill(0),d(1),d(0),d(0),Array(12).fill(0),d(e.info.width),d(e.info.height),a(4718592),a(4718592),a(0),d(1),Array(32).fill(0),d(24),Ee(65535)],[Ct[e.info.codec](e)]),at=t=>t.codecPrivate&&b("avcC",[...t.codecPrivate]),ot=t=>t.codecPrivate&&b("hvcC",[...t.codecPrivate]),ht=t=>t.codecPrivate&&b("vpcC",[...t.codecPrivate]),lt=t=>t.codecPrivate&&b("av1C",[...t.codecPrivate]),ut=(t,e)=>b(t,[Array(6).fill(0),d(1),d(0),d(0),a(0),d(e.info.numberOfChannels),d(16),d(0),d(0),$(e.info.sampleRate)],[gt[e.info.codec](e)]),dt=t=>y("esds",0,0,[a(58753152),w(32+t.codecPrivate.byteLength),d(1),w(0),a(75530368),w(18+t.codecPrivate.byteLength),w(64),w(21),we(0),a(130071),a(130071),a(92307584),w(t.codecPrivate.byteLength),...t.codecPrivate,a(109084800),w(1),w(2)]),mt=t=>b("dOps",[w(0),w(t.info.numberOfChannels),d(3840),a(t.info.sampleRate),re(0),w(0)]),ct=t=>y("stts",0,0,[a(t.timeToSampleTable.length),t.timeToSampleTable.map(e=>[a(e.sampleCount),a(e.sampleDelta)])]),pt=t=>{if(t.samples.every(r=>r.type==="key"))return null;let e=[...t.samples.entries()].filter(([,r])=>r.type==="key");return y("stss",0,0,[a(e.length),e.map(([r])=>a(r+1))])},ft=t=>y("stsc",0,0,[a(t.compactlyCodedChunkTable.length),t.compactlyCodedChunkTable.map(e=>[a(e.firstChunk),a(e.samplesPerChunk),a(1)])]),Tt=t=>y("stsz",0,0,[a(0),a(t.samples.length),t.samples.map(e=>a(e.size))]),bt=t=>t.writtenChunks.length>0&&U(t.writtenChunks).offset>=A(2,32)?y("co64",0,0,[a(t.writtenChunks.length),t.writtenChunks.map(e=>De(e.offset))]):y("stco",0,0,[a(t.writtenChunks.length),t.writtenChunks.map(e=>a(e.offset))]),yt={avc:"avc1",hevc:"hvc1",vp9:"vp09",av1:"av01"},Ct={avc:at,hevc:ot,vp9:ht,av1:lt},wt={aac:"mp4a",opus:"opus"},gt={aac:dt,opus:mt};var se=class{constructor(){this.buffer=null}},L=class{constructor(e,r,s){this.onData=e;this.onDone=r;this.options=s}},ne=class{constructor(e,r){this.stream=e;this.options=r}};var O,M,G=class{constructor(){this.pos=0;u(this,O,new Uint8Array(8));u(this,M,new DataView(i(this,O).buffer));this.offsets=new WeakMap}seek(e){this.pos=e}writeU32(e){i(this,M).setUint32(0,e,!1),this.write(i(this,O).subarray(0,4))}writeU64(e){i(this,M).setUint32(0,Math.floor(e/A(2,32)),!1),i(this,M).setUint32(4,e,!1),this.write(i(this,O).subarray(0,8))}writeAscii(e){for(let r=0;r<e.length;r++)i(this,M).setUint8(r%8,e.charCodeAt(r)),r%8===7&&this.write(i(this,O));e.length%8!==0&&this.write(i(this,O).subarray(0,e.length%8))}writeBox(e){var r,s;if(this.offsets.set(e,this.pos),e.contents&&!e.children)this.writeBoxHeader(e,(r=e.size)!=null?r:e.contents.byteLength+8),this.write(e.contents);else{let n=this.pos;if(this.writeBoxHeader(e,0),e.contents&&this.write(e.contents),e.children)for(let l of e.children)l&&this.writeBox(l);let o=this.pos,h=(s=e.size)!=null?s:o-n;this.seek(n),this.writeBoxHeader(e,h),this.seek(o)}}writeBoxHeader(e,r){this.writeU32(e.largeSize?1:r),this.writeAscii(e.type),e.largeSize&&this.writeU64(r)}patchBox(e){let r=this.pos;this.seek(this.offsets.get(e)),this.writeBox(e),this.seek(r)}};O=new WeakMap,M=new WeakMap;var Y,k,N,Z,ge,oe=class extends G{constructor(r){super();u(this,Z);u(this,Y,void 0);u(this,k,new ArrayBuffer(A(2,16)));u(this,N,new Uint8Array(i(this,k)));T(this,Y,r)}write(r){m(this,Z,ge).call(this,this.pos+r.byteLength),i(this,N).set(r,this.pos),this.pos+=r.byteLength}finalize(){m(this,Z,ge).call(this,this.pos),i(this,Y).buffer=i(this,k).slice(0,this.pos)}};Y=new WeakMap,k=new WeakMap,N=new WeakMap,Z=new WeakSet,ge=function(r){let s=i(this,k).byteLength;for(;s<r;)s*=2;if(s===i(this,k).byteLength)return;let n=new ArrayBuffer(s),o=new Uint8Array(n);o.set(i(this,N),0),T(this,k,n),T(this,N,o)};var F,E,q=class extends G{constructor(r){super();u(this,F,void 0);u(this,E,[]);T(this,F,r)}write(r){i(this,E).push({data:r.slice(),start:this.pos}),this.pos+=r.byteLength}flush(){if(i(this,E).length===0)return;let r=[],s=[...i(this,E)].sort((n,o)=>n.start-o.start);r.push({start:s[0].start,size:s[0].data.byteLength});for(let n=1;n<s.length;n++){let o=r[r.length-1],h=s[n];h.start<=o.start+o.size?o.size=Math.max(o.size,h.start+h.data.byteLength-o.start):r.push({start:h.start,size:h.data.byteLength})}for(let n of r){n.data=new Uint8Array(n.size);for(let o of i(this,E))n.start<=o.start&&o.start<n.start+n.size&&n.data.set(o.data,o.start-n.start);i(this,F).onData(n.data,n.start)}i(this,E).length=0}finalize(){var r,s;(s=(r=i(this,F)).onDone)==null||s.call(r)}};F=new WeakMap,E=new WeakMap;var xt=A(2,24),vt=2,V,x,C,j,xe,le,Me,ue,ze,H,ae,K=class extends G{constructor(r){var s,n;super();u(this,j);u(this,le);u(this,ue);u(this,H);u(this,V,void 0);u(this,x,void 0);u(this,C,[]);if(T(this,V,r),T(this,x,(n=(s=r.options)==null?void 0:s.chunkSize)!=null?n:xt),!Number.isInteger(i(this,x))||i(this,x)<A(2,10))throw new Error("Invalid StreamTarget options: chunkSize must be an integer not smaller than 1024.")}write(r){m(this,j,xe).call(this,r,this.pos),m(this,H,ae).call(this),this.pos+=r.byteLength}finalize(){var r,s;m(this,H,ae).call(this,!0),(s=(r=i(this,V)).onDone)==null||s.call(r)}};V=new WeakMap,x=new WeakMap,C=new WeakMap,j=new WeakSet,xe=function(r,s){let n=i(this,C).findIndex(g=>g.start<=s&&s<g.start+i(this,x));n===-1&&(n=m(this,ue,ze).call(this,s));let o=i(this,C)[n],h=s-o.start,l=r.subarray(0,Math.min(i(this,x)-h,r.byteLength));o.data.set(l,h);let z={start:h,end:h+l.byteLength};if(m(this,le,Me).call(this,o,z),o.written[0].start===0&&o.written[0].end===i(this,x)&&(o.shouldFlush=!0),i(this,C).length>vt){for(let g=0;g<i(this,C).length-1;g++)i(this,C)[g].shouldFlush=!0;m(this,H,ae).call(this)}l.byteLength<r.byteLength&&m(this,j,xe).call(this,r.subarray(l.byteLength),s+l.byteLength)},le=new WeakSet,Me=function(r,s){let n=0,o=r.written.length-1,h=-1;for(;n<=o;){let l=Math.floor(n+(o-n+1)/2);r.written[l].start<=s.start?(n=l+1,h=l):o=l-1}for(r.written.splice(h+1,0,s),(h===-1||r.written[h].end<s.start)&&h++;h<r.written.length-1&&r.written[h].end>=r.written[h+1].start;)r.written[h].end=Math.max(r.written[h].end,r.written[h+1].end),r.written.splice(h+1,1)},ue=new WeakSet,ze=function(r){let n={start:Math.floor(r/i(this,x))*i(this,x),data:new Uint8Array(i(this,x)),written:[],shouldFlush:!1};return i(this,C).push(n),i(this,C).sort((o,h)=>o.start-h.start),i(this,C).indexOf(n)},H=new WeakSet,ae=function(r=!1){for(let s=0;s<i(this,C).length;s++){let n=i(this,C)[s];if(!(!n.shouldFlush&&!r)){for(let o of n.written)i(this,V).onData(n.data.subarray(o.start,o.end),n.start+o.start);i(this,C).splice(s--,1)}}};var he=class extends K{constructor(e){var r;super(new L((s,n)=>e.stream.write({type:"write",data:s,position:n}),void 0,{chunkSize:(r=e.options)==null?void 0:r.chunkSize}))}};var ie=1e3,St=["avc","hevc","vp9","av1"],At=["aac","opus"],Ut=2082844800,Ot=.5,kt=["strict","offset"],p,f,D,B,_,ce,J,pe,Re,fe,Le,Te,Ne,be,Fe,Q,Se,ye,Ve,W,de,X,me,ee,Ae,ve=class{constructor(e){u(this,pe);u(this,fe);u(this,Te);u(this,be);u(this,Q);u(this,ye);u(this,W);u(this,X);u(this,ee);u(this,p,void 0);u(this,f,void 0);u(this,D,void 0);u(this,B,null);u(this,_,null);u(this,ce,Math.floor(Date.now()/1e3)+Ut);u(this,J,!1);var r;if(m(this,pe,Re).call(this,e),this.target=e.target,T(this,p,ke({firstTimestampBehavior:"strict"},e)),e.target instanceof se)T(this,f,new oe(e.target));else if(e.target instanceof L)T(this,f,(r=e.target.options)!=null&&r.chunked?new K(e.target):new q(e.target));else if(e.target instanceof ne)T(this,f,new he(e.target));else throw new Error(`Invalid target: ${e.target}`);m(this,fe,Le).call(this),m(this,Te,Ne).call(this)}addVideoChunk(e,r,s){let n=new Uint8Array(e.byteLength);e.copyTo(n),this.addVideoChunkRaw(n,e.type,s!=null?s:e.timestamp,e.duration,r)}addVideoChunkRaw(e,r,s,n,o){if(m(this,ee,Ae).call(this),!i(this,p).video)throw new Error("No video track declared.");m(this,Q,Se).call(this,i(this,B),e,r,s,n,o)}addAudioChunk(e,r,s){let n=new Uint8Array(e.byteLength);e.copyTo(n),this.addAudioChunkRaw(n,e.type,s!=null?s:e.timestamp,e.duration,r)}addAudioChunkRaw(e,r,s,n,o){if(m(this,ee,Ae).call(this),!i(this,p).audio)throw new Error("No audio track declared.");m(this,Q,Se).call(this,i(this,_),e,r,s,n,o)}finalize(){i(this,B)&&m(this,W,de).call(this,i(this,B)),i(this,_)&&m(this,W,de).call(this,i(this,_));let e=i(this,f).offsets.get(i(this,D)),r=i(this,f).pos-e;i(this,D).size=r,i(this,f).patchBox(i(this,D));let s=Pe([i(this,B),i(this,_)].filter(Boolean),i(this,ce));i(this,f).writeBox(s),m(this,X,me).call(this),i(this,f).finalize(),T(this,J,!0)}};p=new WeakMap,f=new WeakMap,D=new WeakMap,B=new WeakMap,_=new WeakMap,ce=new WeakMap,J=new WeakMap,pe=new WeakSet,Re=function(e){if(e.video&&!St.includes(e.video.codec))throw new Error(`Unsupported video codec: ${e.video.codec}`);if(e.audio&&!At.includes(e.audio.codec))throw new Error(`Unsupported audio codec: ${e.audio.codec}`);if(e.firstTimestampBehavior&&!kt.includes(e.firstTimestampBehavior))throw new Error(`Invalid first timestamp behavior: ${e.firstTimestampBehavior}`)},fe=new WeakSet,Le=function(){var r;let e=((r=i(this,p).video)==null?void 0:r.codec)==="hevc";i(this,f).writeBox(_e(e)),T(this,D,Ie()),i(this,f).writeBox(i(this,D)),m(this,X,me).call(this)},Te=new WeakSet,Ne=function(){if(i(this,p).video&&T(this,B,{id:1,info:{type:"video",codec:i(this,p).video.codec,width:i(this,p).video.width,height:i(this,p).video.height},timescale:720,codecPrivate:new Uint8Array(0),samples:[],writtenChunks:[],currentChunk:null,firstTimestamp:void 0,lastTimestamp:-1,timeToSampleTable:[],lastTimescaleUnits:null,compactlyCodedChunkTable:[]}),i(this,p).audio){let e=m(this,be,Fe).call(this,2,i(this,p).audio.sampleRate,i(this,p).audio.numberOfChannels);T(this,_,{id:i(this,p).video?2:1,info:{type:"audio",codec:i(this,p).audio.codec,numberOfChannels:i(this,p).audio.numberOfChannels,sampleRate:i(this,p).audio.sampleRate},timescale:i(this,p).audio.sampleRate,codecPrivate:e,samples:[],writtenChunks:[],currentChunk:null,firstTimestamp:void 0,lastTimestamp:-1,timeToSampleTable:[],lastTimescaleUnits:null,compactlyCodedChunkTable:[]})}},be=new WeakSet,Fe=function(e,r,s){let o=[96e3,88200,64e3,48e3,44100,32e3,24e3,22050,16e3,12e3,11025,8e3,7350].indexOf(r),h=s,l="";l+=e.toString(2).padStart(5,"0"),l+=o.toString(2).padStart(4,"0"),o===15&&(l+=r.toString(2).padStart(24,"0")),l+=h.toString(2).padStart(4,"0");let z=Math.ceil(l.length/8)*8;l=l.padEnd(z,"0");let g=new Uint8Array(l.length/8);for(let I=0;I<l.length;I+=8)g[I/8]=parseInt(l.slice(I,I+8),2);return g},Q=new WeakSet,Se=function(e,r,s,n,o,h){var g;let l=n/1e6,z=o/1e6;if(e.firstTimestamp===void 0&&(e.firstTimestamp=l),l=m(this,ye,Ve).call(this,l,e),e.lastTimestamp=l,(!e.currentChunk||l-e.currentChunk.startTimestamp>=Ot)&&(e.currentChunk&&m(this,W,de).call(this,e),e.currentChunk={startTimestamp:l,sampleData:[],sampleCount:0}),e.currentChunk.sampleData.push(r),e.currentChunk.sampleCount++,(g=h==null?void 0:h.decoderConfig)!=null&&g.description&&(e.codecPrivate=new Uint8Array(h.decoderConfig.description)),e.samples.push({timestamp:l,duration:z,size:r.byteLength,type:s}),e.lastTimescaleUnits!==null){let I=P(l,e.timescale,!1),te=Math.round(I-e.lastTimescaleUnits);e.lastTimescaleUnits+=te;let R=U(e.timeToSampleTable);R.sampleCount===1?(R.sampleDelta=te,R.sampleCount++):R.sampleDelta===te?R.sampleCount++:(R.sampleCount--,e.timeToSampleTable.push({sampleCount:2,sampleDelta:te}))}else e.lastTimescaleUnits=0,e.timeToSampleTable.push({sampleCount:1,sampleDelta:P(z,e.timescale)})},ye=new WeakSet,Ve=function(e,r){if(i(this,p).firstTimestampBehavior==="strict"&&r.lastTimestamp===-1&&e!==0)throw new Error(`The first chunk for your media track must have a timestamp of 0 (received ${e}). Non-zero first timestamps are often caused by directly piping frames or audio data from a MediaStreamTrack into the encoder. Their timestamps are typically relative to the age of the document, which is probably what you want.

If you want to offset all timestamps of a track such that the first one is zero, set firstTimestampBehavior: 'offset' in the options.
`);if(i(this,p).firstTimestampBehavior==="offset"&&(e-=r.firstTimestamp),e<r.lastTimestamp)throw new Error(`Timestamps must be monotonically increasing (went from ${r.lastTimestamp*1e6} to ${e*1e6}).`);return e},W=new WeakSet,de=function(e){if(e.currentChunk){e.currentChunk.offset=i(this,f).pos;for(let r of e.currentChunk.sampleData)i(this,f).write(r);e.currentChunk.sampleData=null,(e.compactlyCodedChunkTable.length===0||U(e.compactlyCodedChunkTable).samplesPerChunk!==e.currentChunk.sampleCount)&&e.compactlyCodedChunkTable.push({firstChunk:e.writtenChunks.length+1,samplesPerChunk:e.currentChunk.sampleCount}),e.writtenChunks.push(e.currentChunk),m(this,X,me).call(this)}},X=new WeakSet,me=function(){i(this,f)instanceof q&&i(this,f).flush()},ee=new WeakSet,Ae=function(){if(i(this,J))throw new Error("Cannot add new video or audio chunks after the file has been finalized.")};export{se as ArrayBufferTarget,ne as FileSystemWritableFileStreamTarget,ve as Muxer,L as StreamTarget};
