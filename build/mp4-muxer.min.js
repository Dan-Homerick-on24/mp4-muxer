"use strict";var Mp4Muxer=(()=>{var V=Object.defineProperty;var we=Object.getOwnPropertyDescriptor;var ye=Object.getOwnPropertyNames,re=Object.getOwnPropertySymbols;var ne=Object.prototype.hasOwnProperty,be=Object.prototype.propertyIsEnumerable;var N=Math.pow,se=(t,e,i)=>e in t?V(t,e,{enumerable:!0,configurable:!0,writable:!0,value:i}):t[e]=i,ae=(t,e)=>{for(var i in e||={})ne.call(e,i)&&se(t,i,e[i]);if(re)for(var i of re(e))be.call(e,i)&&se(t,i,e[i]);return t};var xe=(t,e)=>{for(var i in e)V(t,i,{get:e[i],enumerable:!0})},Ce=(t,e,i,s)=>{if(e&&typeof e=="object"||typeof e=="function")for(let n of ye(e))!ne.call(t,n)&&n!==i&&V(t,n,{get:()=>e[n],enumerable:!(s=we(e,n))||s.enumerable});return t};var ve=t=>Ce(V({},"__esModule",{value:!0}),t);var J=(t,e,i)=>{if(!e.has(t))throw TypeError("Cannot "+i)};var r=(t,e,i)=>(J(t,e,"read from private field"),i?i.call(t):e.get(t)),u=(t,e,i)=>{if(e.has(t))throw TypeError("Cannot add the same private member more than once");e instanceof WeakSet?e.add(t):e.set(t,i)},w=(t,e,i,s)=>(J(t,e,"write to private field"),s?s.call(t,i):e.set(t,i),i);var b=(t,e,i)=>(J(t,e,"access private method"),i);var et={};xe(et,{GLOBAL_TIMESCALE:()=>I,default:()=>Qe});var d=t=>{let e=new Uint8Array(2);return new DataView(e.buffer).setUint16(0,t,!1),[...e]},oe=t=>{let e=new Uint8Array(2);return new DataView(e.buffer).setInt16(0,t,!1),[...e]},he=t=>{let e=new Uint8Array(4);return new DataView(e.buffer).setUint32(0,t,!1),[...e].slice(1)},o=t=>{let e=new Uint8Array(4);return new DataView(e.buffer).setUint32(0,t,!1),[...e]},Q=t=>{let e=new Uint8Array(2),i=new DataView(e.buffer);return i.setUint8(0,t),i.setUint8(1,t<<8),[...e]},F=t=>{let e=new Uint8Array(4),i=new DataView(e.buffer);return i.setUint16(0,t,!1),i.setUint16(2,t<<16,!1),[...e]},x=(t,e=!1)=>{let i=Array(t.length).fill(null).map((s,n)=>t.charCodeAt(n));return e&&i.push(0),i},S=(t,e)=>Math.round(t*e),D=t=>t&&t[t.length-1];var le=[65536,0,0,0,65536,0,0,0,1073741824].map(o),y=(t,e,i)=>({type:t,contents:e&&new Uint8Array(e.flat(10)),children:i}),f=(t,e,i,s,n)=>y(t,[e,he(i),s!=null?s:[]],n),ue=t=>t?y("ftyp",[x("isom"),o(0),x("iso4"),x("hvc1")]):y("ftyp",[x("isom"),o(0),x("isom"),x("avc1"),x("mp41")]),de=()=>({type:"mdat",largeSize:!0}),me=(t,e)=>y("moov",null,[ge(e,t),...t.map(i=>Ae(i,e))]),ge=(t,e)=>{let i=S(Math.max(...e.map(n=>D(n.samples).timestamp+D(n.samples).duration)),I),s=Math.max(...e.map(n=>n.id))+1;return f("mvhd",0,0,[o(t),o(t),o(I),o(i),F(1),Q(1),Array(10).fill(0),le,Array(24).fill(0),o(s)])},Ae=(t,e)=>y("trak",null,[Te(t,e),ke(t,e)]),Te=(t,e)=>{let i=D(t.samples),s=S(i.timestamp+i.duration,I);return f("tkhd",0,3,[o(e),o(e),o(t.id),o(0),o(s),Array(8).fill(0),0,0,0,0,Q(t.info.type==="audio"?1:0),0,0,le,F(t.info.type==="video"?t.info.width:0),F(t.info.type==="video"?t.info.height:0)])},ke=(t,e)=>y("mdia",null,[Ue(t,e),Se(t.info.type==="video"?"vide":"soun"),Be(t)]),Ue=(t,e)=>{let i=D(t.samples),s=S(i.timestamp+i.duration,t.timescale);return f("mdhd",0,0,[o(e),o(e),o(t.timescale),o(s),85,196,d(0)])},Se=t=>f("hdlr",0,0,[x("mhlr"),x(t),o(0),o(0),o(0),x("mp4-muxer-hdlr")]),Be=t=>y("minf",null,[t.info.type==="video"?De():Ee(),Me(),Ie(t)]),De=()=>f("vmhd",0,1,[d(0),d(0),d(0),d(0)]),Ee=()=>f("smhd",0,0,[0,0,0,0]),Me=()=>y("dinf",null,[ze()]),ze=()=>f("dref",0,0,[o(1)],[Fe()]),Fe=()=>f("url ",0,1),Ie=t=>y("stbl",null,[Oe(t),Ne(t),He(t),We(t),$e(t),Ge(t)]),Oe=t=>f("stsd",0,0,[o(1)],[t.info.type==="video"?Pe(t.info.codec==="avc"?"avc1":"hvc1",t,t.info.codec==="avc"?Le(t):_e(t)):Re("mp4a",t,Ve(t))]),Pe=(t,e,i)=>y(t,[Array(6).fill(0),0,1,0,0,0,0,Array(12).fill(0),d(e.info.width),d(e.info.height),o(4718592),o(4718592),o(0),d(1),Array(32).fill(0),d(24),oe(65535)],[i]),Le=t=>y("avcC",[...t.codecPrivate]),_e=t=>y("hvcC",[...t.codecPrivate]),Re=(t,e,i)=>y("compressionType",[Array(6).fill(0),d(1),d(0),d(0),o(0),d(e.info.numberOfChannels),d(16),d(0),d(0),F(e.info.sampleRate)],[i]),Ve=t=>f("esds",0,0,[o(58753152),34,d(1),0,o(75530368),20,64,21,0,0,0,o(130071),o(130071),o(92307584),2,t.codecPrivate[0],t.codecPrivate[1],o(109084800),1,2]),Ne=t=>{var s,n;let e=[],i=[];for(let a of t.samples){if(e.push(a),e.length===1)continue;let h=S(e[1].timestamp-e[0].timestamp,t.timescale);S(a.timestamp-e[e.length-2].timestamp,t.timescale)!==h&&(i.push({sampleCount:e.length-1,sampleDelta:h}),e=e.slice(-2))}return i.push({sampleCount:e.length,sampleDelta:S(((n=(s=e[1])==null?void 0:s.timestamp)!=null?n:e[0].timestamp)-e[0].timestamp,t.timescale)}),f("stts",0,0,[o(i.length),i.map(a=>[o(a.sampleCount),o(a.sampleDelta)])])},He=t=>{if(t.samples.every(i=>i.type==="key"))return null;let e=[...t.samples.entries()].filter(([,i])=>i.type==="key");return f("stss",0,0,[o(e.length),e.map(([i])=>o(i+1))])},We=t=>{let e=[];for(let i=0;i<t.writtenChunks.length;i++){let s=t.writtenChunks[i];(e.length===0||D(e).samplesPerChunk!==s.sampleCount)&&e.push({firstChunk:i+1,samplesPerChunk:s.sampleCount})}return f("stsc",0,0,[o(e.length),e.map(i=>[o(i.firstChunk),o(i.samplesPerChunk),o(1)])])},$e=t=>f("stsz",0,0,[o(0),o(t.samples.length),t.samples.map(e=>o(e.size))]),Ge=t=>f("stco",0,0,[o(t.writtenChunks.length),t.writtenChunks.map(e=>o(e.offset))]);var v,B,O=class{constructor(){this.pos=0;u(this,v,new Uint8Array(8));u(this,B,new DataView(r(this,v).buffer));this.offsets=new WeakMap}writeU32(e){r(this,B).setUint32(0,e,!1),this.write(r(this,v).subarray(0,4))}writeU64(e){r(this,B).setUint32(0,Math.floor(e/N(2,32)),!1),r(this,B).setUint32(4,e,!1),this.write(r(this,v).subarray(0,8))}writeAscii(e){for(let i=0;i<e.length;i++)r(this,B).setUint8(i%8,e.charCodeAt(i)),i%8===7&&this.write(r(this,v));e.length%8!==0&&this.write(r(this,v).subarray(0,e.length%8))}writeBox(e){var i,s;if(this.offsets.set(e,this.pos),e.contents&&!e.children)this.writeBoxHeader(e,(i=e.size)!=null?i:e.contents.byteLength+8),this.write(e.contents);else{let n=this.pos;if(this.writeBoxHeader(e,0),e.contents&&this.write(e.contents),e.children)for(let l of e.children)l&&this.writeBox(l);let a=this.pos,h=(s=e.size)!=null?s:a-n;this.pos=n,this.writeBoxHeader(e,h),this.pos=a}}writeBoxHeader(e,i){this.writeU32(e.largeSize?1:i),this.writeAscii(e.type),e.largeSize&&this.writeU64(i)}patchBox(e){let i=this.pos;this.pos=this.offsets.get(e),this.writeBox(e),this.pos=i}};v=new WeakMap,B=new WeakMap;var g,M,H=class extends O{constructor(){super();u(this,g,new ArrayBuffer(N(2,16)));u(this,M,new Uint8Array(r(this,g)))}ensureSize(i){let s=r(this,g).byteLength;for(;s<i;)s*=2;if(s===r(this,g).byteLength)return;let n=new ArrayBuffer(s),a=new Uint8Array(n);a.set(r(this,M),0),w(this,g,n),w(this,M,a)}write(i){this.ensureSize(this.pos+i.byteLength),r(this,M).set(i,this.pos),this.pos+=i.byteLength}seek(i){this.pos=i}finalize(){return this.ensureSize(this.pos),r(this,g).slice(0,this.pos)}};g=new WeakMap,M=new WeakMap;var E=N(2,24),Ke=2,P,c,W=class extends O{constructor(i){super();u(this,P,void 0);u(this,c,[]);w(this,P,i)}write(i){this.writeDataIntoChunks(i,this.pos),this.flushChunks(),this.pos+=i.byteLength}writeDataIntoChunks(i,s){let n=r(this,c).findIndex(C=>C.start<=s&&s<C.start+E);n===-1&&(n=this.createChunk(s));let a=r(this,c)[n],h=s-a.start,l=i.subarray(0,Math.min(E-h,i.byteLength));a.data.set(l,h);let q={start:h,end:h+l.byteLength};if(Xe(a,q),a.written[0].start===0&&a.written[0].end===E&&(a.shouldFlush=!0),r(this,c).length>Ke){for(let C=0;C<r(this,c).length-1;C++)r(this,c)[C].shouldFlush=!0;this.flushChunks()}l.byteLength<i.byteLength&&this.writeDataIntoChunks(i.subarray(l.byteLength),s+l.byteLength)}createChunk(i){let n={start:Math.floor(i/E)*E,data:new Uint8Array(E),written:[],shouldFlush:!1};return r(this,c).push(n),r(this,c).sort((a,h)=>a.start-h.start),r(this,c).indexOf(n)}flushChunks(i=!1){for(let s=0;s<r(this,c).length;s++){let n=r(this,c)[s];if(!(!n.shouldFlush&&!i)){for(let a of n.written)r(this,P).write({type:"write",data:n.data.subarray(a.start,a.end),position:n.start+a.start});r(this,c).splice(s--,1)}}}seek(i){this.pos=i}finalize(){this.flushChunks(!0)}};P=new WeakMap,c=new WeakMap;var Xe=(t,e)=>{let i=0,s=t.written.length-1,n=-1;for(;i<=s;){let a=Math.floor(i+(s-i+1)/2);t.written[a].start<=e.start?(i=a+1,n=a):s=a-1}for(t.written.splice(n+1,0,e),(n===-1||t.written[n].end<e.start)&&n++;n<t.written.length-1&&t.written[n].end>=t.written[n+1].start;)t.written[n].end=Math.max(t.written[n].end,t.written[n+1].end),t.written.splice(n+1,1)},A,L,$=class extends O{constructor(i){super();u(this,A,[]);u(this,L,void 0);w(this,L,i)}write(i){r(this,A).push({data:i.slice(),start:this.pos}),this.pos+=i.byteLength}seek(i){this.pos=i}flush(i){if(r(this,A).length===0)return;let s=[],n=[...r(this,A)].sort((a,h)=>a.start-h.start);s.push({start:n[0].start,size:n[0].data.byteLength});for(let a=1;a<n.length;a++){let h=s[s.length-1],l=n[a];l.start<=h.start+h.size?h.size=Math.max(h.size,l.start+l.data.byteLength-h.start):s.push({start:l.start,size:l.data.byteLength})}for(let a of s){a.data=new Uint8Array(a.size);for(let l of r(this,A))a.start<=l.start&&l.start<a.start+a.size&&a.data.set(l.data,l.start-a.start);let h=i&&a===s[s.length-1];r(this,L).call(this,a.data,a.start,h)}r(this,A).length=0}};A=new WeakMap,L=new WeakMap;var Ye=2082848400,Ze=.5,je=["avc","hevc"],qe=["aac"],Je=["strict","offset","permissive"],I=1e3,m,p,T,k,U,K,X,Y,fe,Z,pe,j,ce,_,te,z,G,R,ie,ee=class{constructor(e){u(this,Y);u(this,Z);u(this,j);u(this,_);u(this,z);u(this,R);u(this,m,void 0);u(this,p,void 0);u(this,T,void 0);u(this,k,null);u(this,U,null);u(this,K,Math.floor(Date.now()/1e3)+Ye);u(this,X,!1);if(b(this,Y,fe).call(this,e),w(this,m,ae({firstTimestampBehavior:"strict"},e)),e.target==="buffer")w(this,p,new H);else if(e.target instanceof FileSystemWritableFileStream)w(this,p,new W(e.target));else if(typeof e.target=="function")w(this,p,new $(e.target));else throw new Error(`Invalid target: ${e.target}`);b(this,Z,pe).call(this),b(this,j,ce).call(this)}addVideoChunk(e,i){let s=new Uint8Array(e.byteLength);e.copyTo(s),this.addVideoChunkRaw(s,e.type,e.timestamp,e.duration,i)}addVideoChunkRaw(e,i,s,n,a){if(b(this,R,ie).call(this),!r(this,m).video)throw new Error("No video track declared.");b(this,_,te).call(this,r(this,k),e,i,s,n,a)}addAudioChunk(e,i){let s=new Uint8Array(e.byteLength);e.copyTo(s),this.addAudioChunkRaw(s,e.type,e.timestamp,e.duration,i)}addAudioChunkRaw(e,i,s,n,a){if(b(this,R,ie).call(this),!r(this,m).audio)throw new Error("No audio track declared.");b(this,_,te).call(this,r(this,U),e,i,s,n,a)}finalize(){r(this,k)&&b(this,z,G).call(this,r(this,k)),r(this,U)&&b(this,z,G).call(this,r(this,U));let e=r(this,p).offsets.get(r(this,T)),i=r(this,p).pos-e;r(this,T).size=i,r(this,p).patchBox(r(this,T));let s=me([r(this,k),r(this,U)].filter(Boolean),r(this,K));return r(this,p).writeBox(s),r(this,p).finalize()}};m=new WeakMap,p=new WeakMap,T=new WeakMap,k=new WeakMap,U=new WeakMap,K=new WeakMap,X=new WeakMap,Y=new WeakSet,fe=function(e){if(e.video&&!je.includes(e.video.codec))throw new Error(`Unsupported video codec: ${e.video.codec}`);if(e.audio&&!qe.includes(e.audio.codec))throw new Error(`Unsupported audio codec: ${e.audio.codec}`);if(e.firstTimestampBehavior&&!Je.includes(e.firstTimestampBehavior))throw new Error(`Invalid first timestamp behavior: ${e.firstTimestampBehavior}`)},Z=new WeakSet,pe=function(){var i;let e=((i=r(this,m).video)==null?void 0:i.codec)==="hevc";r(this,p).writeBox(ue(e)),w(this,T,de()),r(this,p).writeBox(r(this,T))},j=new WeakSet,ce=function(){r(this,m).video&&w(this,k,{id:1,info:{type:"video",codec:r(this,m).video.codec,width:r(this,m).video.width,height:r(this,m).video.height},timescale:720,codecPrivate:null,samples:[],writtenChunks:[],currentChunk:null}),r(this,m).audio&&w(this,U,{id:r(this,m).video?2:1,info:{type:"audio",codec:r(this,m).audio.codec,numberOfChannels:r(this,m).audio.numberOfChannels,sampleRate:r(this,m).audio.sampleRate},timescale:r(this,m).audio.sampleRate,codecPrivate:null,samples:[],writtenChunks:[],currentChunk:null})},_=new WeakSet,te=function(e,i,s,n,a,h){var C;let l=n/1e6,q=a/1e6;(!e.currentChunk||l-e.currentChunk.startTimestamp>=Ze)&&(e.currentChunk&&b(this,z,G).call(this,e),e.currentChunk={startTimestamp:l,sampleData:[],sampleCount:0}),e.currentChunk.sampleData.push(i),e.currentChunk.sampleCount++,(C=h==null?void 0:h.decoderConfig)!=null&&C.description&&(e.codecPrivate=new Uint8Array(h.decoderConfig.description)),e.samples.push({timestamp:l,duration:q,size:i.byteLength,type:s})},z=new WeakSet,G=function(e){if(e.currentChunk){e.currentChunk.offset=r(this,p).pos;for(let i of e.currentChunk.sampleData)r(this,p).write(i);e.currentChunk.sampleData=null,e.writtenChunks.push(e.currentChunk)}},R=new WeakSet,ie=function(){if(r(this,X))throw new Error("Cannot add new video or audio chunks after the file has been finalized.")};var Qe=ee;return ve(et);})();
Mp4Muxer = Mp4Muxer.default;
if (typeof module === "object" && typeof module.exports === "object") module.exports = Mp4Muxer;
