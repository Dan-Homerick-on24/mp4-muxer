"use strict";var Mp4Muxer=(()=>{var te=Object.defineProperty;var He=Object.getOwnPropertyDescriptor;var We=Object.getOwnPropertyNames,Se=Object.getOwnPropertySymbols;var Be=Object.prototype.hasOwnProperty,$e=Object.prototype.propertyIsEnumerable;var A=Math.pow,Ue=(r,e,t)=>e in r?te(r,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):r[e]=t,ke=(r,e)=>{for(var t in e||={})Be.call(e,t)&&Ue(r,t,e[t]);if(Se)for(var t of Se(e))$e.call(e,t)&&Ue(r,t,e[t]);return r};var qe=(r,e)=>{for(var t in e)te(r,t,{get:e[t],enumerable:!0})},Ge=(r,e,t,i)=>{if(e&&typeof e=="object"||typeof e=="function")for(let n of We(e))!Be.call(r,n)&&n!==t&&te(r,n,{get:()=>e[n],enumerable:!(i=He(e,n))||i.enumerable});return r};var Ke=r=>Ge(te({},"__esModule",{value:!0}),r);var ge=(r,e,t)=>{if(!e.has(r))throw TypeError("Cannot "+t)};var s=(r,e,t)=>(ge(r,e,"read from private field"),t?t.call(r):e.get(r)),u=(r,e,t)=>{if(e.has(r))throw TypeError("Cannot add the same private member more than once");e instanceof WeakSet?e.add(r):e.set(r,t)},w=(r,e,t,i)=>(ge(r,e,"write to private field"),i?i.call(r,t):e.set(r,t),t);var m=(r,e,t)=>(ge(r,e,"access private method"),t);var At={};qe(At,{ArrayBufferTarget:()=>q,FileSystemWritableFileStreamTarget:()=>G,Muxer:()=>le,StreamTarget:()=>I});var f=new Uint8Array(8),T=new DataView(f.buffer),v=r=>[(r%256+256)%256],d=r=>(T.setUint16(0,r,!1),[f[0],f[1]]),Me=r=>(T.setInt16(0,r,!1),[f[0],f[1]]),be=r=>(T.setUint32(0,r,!1),[f[1],f[2],f[3]]),a=r=>(T.setUint32(0,r,!1),[f[0],f[1],f[2],f[3]]),Ee=r=>(T.setUint32(0,Math.floor(r/A(2,32)),!1),T.setUint32(4,r,!1),[f[0],f[1],f[2],f[3],f[4],f[5],f[6],f[7]]),xe=r=>(T.setUint8(0,r),T.setUint8(1,r<<8),[f[0],f[1]]),$=r=>(T.setUint16(0,r,!1),T.setUint16(2,r<<16,!1),[f[0],f[1],f[2],f[3]]),C=(r,e=!1)=>{let t=Array(r.length).fill(null).map((i,n)=>r.charCodeAt(n));return e&&t.push(0),t},D=r=>r&&r[r.length-1];var De=[65536,0,0,0,65536,0,0,0,1073741824].map(a),b=(r,e,t)=>({type:r,contents:e&&new Uint8Array(e.flat(10)),children:t}),y=(r,e,t,i,n)=>b(r,[v(e),be(t),i!=null?i:[]],n),z=(r,e)=>Math.round(r*e),ze=r=>r?b("ftyp",[C("isom"),a(0),C("iso4"),C("hvc1")]):b("ftyp",[C("isom"),a(0),C("isom"),C("avc1"),C("mp41")]),Ie=()=>({type:"mdat",largeSize:!0}),Oe=(r,e)=>b("moov",null,[Xe(e,r),...r.map(t=>Ye(t,e))]),Xe=(r,e)=>{let t=z(Math.max(0,...e.filter(n=>n.samples.length>0).map(n=>D(n.samples).timestamp+D(n.samples).duration)),re),i=Math.max(...e.map(n=>n.id))+1;return y("mvhd",0,0,[a(r),a(r),a(re),a(t),$(1),xe(1),Array(10).fill(0),De,Array(24).fill(0),a(i)])},Ye=(r,e)=>b("trak",null,[Ze(r,e),je(r,e)]),Ze=(r,e)=>{let t=D(r.samples),i=z(t?t.timestamp+t.duration:0,re);return y("tkhd",0,3,[a(e),a(e),a(r.id),a(0),a(i),Array(8).fill(0),d(0),d(0),xe(r.info.type==="audio"?1:0),d(0),De,$(r.info.type==="video"?r.info.width:0),$(r.info.type==="video"?r.info.height:0)])},je=(r,e)=>b("mdia",null,[Je(r,e),Qe(r.info.type==="video"?"vide":"soun"),et(r)]),Je=(r,e)=>{let t=D(r.samples),i=z(t?t.timestamp+t.duration:0,r.timescale);return y("mdhd",0,0,[a(e),a(e),a(r.timescale),a(i),d(21956),d(0)])},Qe=r=>y("hdlr",0,0,[C("mhlr"),C(r),a(0),a(0),a(0),C("mp4-muxer-hdlr")]),et=r=>b("minf",null,[r.info.type==="video"?tt():rt(),it(),at(r)]),tt=()=>y("vmhd",0,1,[d(0),d(0),d(0),d(0)]),rt=()=>y("smhd",0,0,[d(0),d(0)]),it=()=>b("dinf",null,[st()]),st=()=>y("dref",0,0,[a(1)],[nt()]),nt=()=>y("url ",0,1),at=r=>b("stbl",null,[ot(r),ft(r),pt(r),ct(r),yt(r),wt(r)]),ot=r=>y("stsd",0,0,[a(1)],[r.info.type==="video"?ht(r.info.codec==="avc"?"avc1":"hvc1",r,r.info.codec==="avc"?ut(r):lt(r)):dt("mp4a",r,mt(r))]),ht=(r,e,t)=>b(r,[Array(6).fill(0),d(1),d(0),d(0),Array(12).fill(0),d(e.info.width),d(e.info.height),a(4718592),a(4718592),a(0),d(1),Array(32).fill(0),d(24),Me(65535)],[t]),ut=r=>r.codecPrivate&&b("avcC",[...r.codecPrivate]),lt=r=>r.codecPrivate&&b("hvcC",[...r.codecPrivate]),dt=(r,e,t)=>b(r,[Array(6).fill(0),d(1),d(0),d(0),a(0),d(e.info.numberOfChannels),d(16),d(0),d(0),$(e.info.sampleRate)],[t]),mt=r=>y("esds",0,0,[a(58753152),v(32+r.codecPrivate.byteLength),d(1),v(0),a(75530368),v(18+r.codecPrivate.byteLength),v(64),v(21),be(0),a(130071),a(130071),a(92307584),v(r.codecPrivate.byteLength),...r.codecPrivate,a(109084800),v(1),v(2)]),ft=r=>{let e=[],t=[];for(let i of r.samples){if(e.push(i),e.length<=2)continue;let n=z(e[1].timestamp-e[0].timestamp,r.timescale);z(i.timestamp-e[e.length-2].timestamp,r.timescale)!==n&&(t.push({sampleCount:e.length-1,sampleDelta:n}),e=e.slice(-2))}return e.length>0&&t.push({sampleCount:e.length,sampleDelta:e.length===1?z(e[0].duration,r.timescale):z(e[1].timestamp-e[0].timestamp,r.timescale)}),y("stts",0,0,[a(t.length),t.map(i=>[a(i.sampleCount),a(i.sampleDelta)])])},pt=r=>{if(r.samples.every(t=>t.type==="key"))return null;let e=[...r.samples.entries()].filter(([,t])=>t.type==="key");return y("stss",0,0,[a(e.length),e.map(([t])=>a(t+1))])},ct=r=>{let e=[];for(let t=0;t<r.writtenChunks.length;t++){let i=r.writtenChunks[t];(e.length===0||D(e).samplesPerChunk!==i.sampleCount)&&e.push({firstChunk:t+1,samplesPerChunk:i.sampleCount})}return y("stsc",0,0,[a(e.length),e.map(t=>[a(t.firstChunk),a(t.samplesPerChunk),a(1)])])},yt=r=>y("stsz",0,0,[a(0),a(r.samples.length),r.samples.map(e=>a(e.size))]),wt=r=>r.writtenChunks.length>0&&D(r.writtenChunks).offset>=A(2,32)?y("co64",0,0,[a(r.writtenChunks.length),r.writtenChunks.map(e=>Ee(e.offset))]):y("stco",0,0,[a(r.writtenChunks.length),r.writtenChunks.map(e=>a(e.offset))]);var q=class{constructor(){this.buffer=null}},I=class{constructor(e,t,i){this.onData=e;this.onDone=t;this.options=i}},G=class{constructor(e){this.stream=e}};var S,O,K=class{constructor(){this.pos=0;u(this,S,new Uint8Array(8));u(this,O,new DataView(s(this,S).buffer));this.offsets=new WeakMap}seek(e){this.pos=e}writeU32(e){s(this,O).setUint32(0,e,!1),this.write(s(this,S).subarray(0,4))}writeU64(e){s(this,O).setUint32(0,Math.floor(e/A(2,32)),!1),s(this,O).setUint32(4,e,!1),this.write(s(this,S).subarray(0,8))}writeAscii(e){for(let t=0;t<e.length;t++)s(this,O).setUint8(t%8,e.charCodeAt(t)),t%8===7&&this.write(s(this,S));e.length%8!==0&&this.write(s(this,S).subarray(0,e.length%8))}writeBox(e){var t,i;if(this.offsets.set(e,this.pos),e.contents&&!e.children)this.writeBoxHeader(e,(t=e.size)!=null?t:e.contents.byteLength+8),this.write(e.contents);else{let n=this.pos;if(this.writeBoxHeader(e,0),e.contents&&this.write(e.contents),e.children)for(let l of e.children)l&&this.writeBox(l);let o=this.pos,h=(i=e.size)!=null?i:o-n;this.pos=n,this.writeBoxHeader(e,h),this.pos=o}}writeBoxHeader(e,t){this.writeU32(e.largeSize?1:t),this.writeAscii(e.type),e.largeSize&&this.writeU64(t)}patchBox(e){let t=this.pos;this.pos=this.offsets.get(e),this.writeBox(e),this.pos=t}};S=new WeakMap,O=new WeakMap;var Z,U,L,j,Ce,se=class extends K{constructor(t){super();u(this,j);u(this,Z,void 0);u(this,U,new ArrayBuffer(A(2,16)));u(this,L,new Uint8Array(s(this,U)));w(this,Z,t)}write(t){m(this,j,Ce).call(this,this.pos+t.byteLength),s(this,L).set(t,this.pos),this.pos+=t.byteLength}finalize(){m(this,j,Ce).call(this,this.pos),s(this,Z).buffer=s(this,U).slice(0,this.pos)}};Z=new WeakMap,U=new WeakMap,L=new WeakMap,j=new WeakSet,Ce=function(t){let i=s(this,U).byteLength;for(;i<t;)i*=2;if(i===s(this,U).byteLength)return;let n=new ArrayBuffer(i),o=new Uint8Array(n);o.set(s(this,L),0),w(this,U,n),w(this,L,o)};var _,B,X=class extends K{constructor(t){super();u(this,_,void 0);u(this,B,[]);w(this,_,t)}write(t){s(this,B).push({data:t.slice(),start:this.pos}),this.pos+=t.byteLength}flush(){if(s(this,B).length===0)return;let t=[],i=[...s(this,B)].sort((n,o)=>n.start-o.start);t.push({start:i[0].start,size:i[0].data.byteLength});for(let n=1;n<i.length;n++){let o=t[t.length-1],h=i[n];h.start<=o.start+o.size?o.size=Math.max(o.size,h.start+h.data.byteLength-o.start):t.push({start:h.start,size:h.data.byteLength})}for(let n of t){n.data=new Uint8Array(n.size);for(let o of s(this,B))n.start<=o.start&&o.start<n.start+n.size&&n.data.set(o.data,o.start-n.start);s(this,_).onData(n.data,n.start)}s(this,B).length=0}finalize(){var t,i;(i=(t=s(this,_)).onDone)==null||i.call(t)}};_=new WeakMap,B=new WeakMap;var P=A(2,24),gt=2,F,g,J,Te,ae,Pe,oe,Le,R,ie,Y=class extends K{constructor(t){super();u(this,J);u(this,ae);u(this,oe);u(this,R);u(this,F,void 0);u(this,g,[]);w(this,F,t)}write(t){m(this,J,Te).call(this,t,this.pos),m(this,R,ie).call(this),this.pos+=t.byteLength}finalize(){var t,i;m(this,R,ie).call(this,!0),(i=(t=s(this,F)).onDone)==null||i.call(t)}};F=new WeakMap,g=new WeakMap,J=new WeakSet,Te=function(t,i){let n=s(this,g).findIndex(x=>x.start<=i&&i<x.start+P);n===-1&&(n=m(this,oe,Le).call(this,i));let o=s(this,g)[n],h=i-o.start,l=t.subarray(0,Math.min(P-h,t.byteLength));o.data.set(l,h);let H={start:h,end:h+l.byteLength};if(m(this,ae,Pe).call(this,o,H),o.written[0].start===0&&o.written[0].end===P&&(o.shouldFlush=!0),s(this,g).length>gt){for(let x=0;x<s(this,g).length-1;x++)s(this,g)[x].shouldFlush=!0;m(this,R,ie).call(this)}l.byteLength<t.byteLength&&m(this,J,Te).call(this,t.subarray(l.byteLength),i+l.byteLength)},ae=new WeakSet,Pe=function(t,i){let n=0,o=t.written.length-1,h=-1;for(;n<=o;){let l=Math.floor(n+(o-n+1)/2);t.written[l].start<=i.start?(n=l+1,h=l):o=l-1}for(t.written.splice(h+1,0,i),(h===-1||t.written[h].end<i.start)&&h++;h<t.written.length-1&&t.written[h].end>=t.written[h+1].start;)t.written[h].end=Math.max(t.written[h].end,t.written[h+1].end),t.written.splice(h+1,1)},oe=new WeakSet,Le=function(t){let n={start:Math.floor(t/P)*P,data:new Uint8Array(P),written:[],shouldFlush:!1};return s(this,g).push(n),s(this,g).sort((o,h)=>o.start-h.start),s(this,g).indexOf(n)},R=new WeakSet,ie=function(t=!1){for(let i=0;i<s(this,g).length;i++){let n=s(this,g)[i];if(!(!n.shouldFlush&&!t)){for(let o of n.written)s(this,F).onData(n.data.subarray(o.start,o.end),n.start+o.start);s(this,g).splice(i--,1)}}};var ne=class extends Y{constructor(e){super(new I((t,i)=>e.stream.write({type:"write",data:t,position:i})))}};var re=1e3,bt=2082844800,xt=.5,Ct=["avc","hevc"],Tt=["aac"],vt=["strict","offset","permissive"],p,c,k,M,E,de,me,fe,_e,pe,Fe,ce,Re,ye,Ne,Q,ve,we,Ve,N,he,V,ue,ee,Ae,le=class{constructor(e){u(this,fe);u(this,pe);u(this,ce);u(this,ye);u(this,Q);u(this,we);u(this,N);u(this,V);u(this,ee);u(this,p,void 0);u(this,c,void 0);u(this,k,void 0);u(this,M,null);u(this,E,null);u(this,de,Math.floor(Date.now()/1e3)+bt);u(this,me,!1);var t;if(m(this,fe,_e).call(this,e),this.target=e.target,w(this,p,ke({firstTimestampBehavior:"strict"},e)),e.target instanceof q)w(this,c,new se(e.target));else if(e.target instanceof I)w(this,c,(t=e.target.options)!=null&&t.chunked?new Y(e.target):new X(e.target));else if(e.target instanceof G)w(this,c,new ne(e.target));else throw new Error(`Invalid target: ${e.target}`);m(this,pe,Fe).call(this),m(this,ce,Re).call(this)}addVideoChunk(e,t,i){let n=new Uint8Array(e.byteLength);e.copyTo(n),this.addVideoChunkRaw(n,e.type,i!=null?i:e.timestamp,e.duration,t)}addVideoChunkRaw(e,t,i,n,o){if(m(this,ee,Ae).call(this),!s(this,p).video)throw new Error("No video track declared.");m(this,Q,ve).call(this,s(this,M),e,t,i,n,o)}addAudioChunk(e,t,i){let n=new Uint8Array(e.byteLength);e.copyTo(n),this.addAudioChunkRaw(n,e.type,i!=null?i:e.timestamp,e.duration,t)}addAudioChunkRaw(e,t,i,n,o){if(m(this,ee,Ae).call(this),!s(this,p).audio)throw new Error("No audio track declared.");m(this,Q,ve).call(this,s(this,E),e,t,i,n,o)}finalize(){s(this,M)&&m(this,N,he).call(this,s(this,M)),s(this,E)&&m(this,N,he).call(this,s(this,E));let e=s(this,c).offsets.get(s(this,k)),t=s(this,c).pos-e;s(this,k).size=t,s(this,c).patchBox(s(this,k));let i=Oe([s(this,M),s(this,E)].filter(Boolean),s(this,de));s(this,c).writeBox(i),m(this,V,ue).call(this),s(this,c).finalize()}};p=new WeakMap,c=new WeakMap,k=new WeakMap,M=new WeakMap,E=new WeakMap,de=new WeakMap,me=new WeakMap,fe=new WeakSet,_e=function(e){if(e.video&&!Ct.includes(e.video.codec))throw new Error(`Unsupported video codec: ${e.video.codec}`);if(e.audio&&!Tt.includes(e.audio.codec))throw new Error(`Unsupported audio codec: ${e.audio.codec}`);if(e.firstTimestampBehavior&&!vt.includes(e.firstTimestampBehavior))throw new Error(`Invalid first timestamp behavior: ${e.firstTimestampBehavior}`)},pe=new WeakSet,Fe=function(){var t;let e=((t=s(this,p).video)==null?void 0:t.codec)==="hevc";s(this,c).writeBox(ze(e)),w(this,k,Ie()),s(this,c).writeBox(s(this,k)),m(this,V,ue).call(this)},ce=new WeakSet,Re=function(){if(s(this,p).video&&w(this,M,{id:1,info:{type:"video",codec:s(this,p).video.codec,width:s(this,p).video.width,height:s(this,p).video.height},timescale:720,codecPrivate:new Uint8Array(0),samples:[],writtenChunks:[],currentChunk:null,firstTimestamp:void 0,lastTimestamp:-1}),s(this,p).audio){let e=m(this,ye,Ne).call(this,2,s(this,p).audio.sampleRate,s(this,p).audio.numberOfChannels);w(this,E,{id:s(this,p).video?2:1,info:{type:"audio",codec:s(this,p).audio.codec,numberOfChannels:s(this,p).audio.numberOfChannels,sampleRate:s(this,p).audio.sampleRate},timescale:s(this,p).audio.sampleRate,codecPrivate:e,samples:[],writtenChunks:[],currentChunk:null,firstTimestamp:void 0,lastTimestamp:-1})}},ye=new WeakSet,Ne=function(e,t,i){let o=[96e3,88200,64e3,48e3,44100,32e3,24e3,22050,16e3,12e3,11025,8e3,7350].indexOf(t),h=i,l="";l+=e.toString(2).padStart(5,"0"),l+=o.toString(2).padStart(4,"0"),o===15&&(l+=t.toString(2).padStart(24,"0")),l+=h.toString(2).padStart(4,"0");let H=Math.ceil(l.length/8)*8;l=l.padEnd(H,"0");let x=new Uint8Array(l.length/8);for(let W=0;W<l.length;W+=8)x[W/8]=parseInt(l.slice(W,W+8),2);return x},Q=new WeakSet,ve=function(e,t,i,n,o,h){var x;let l=n/1e6,H=o/1e6;e.firstTimestamp===void 0&&(e.firstTimestamp=l),l=m(this,we,Ve).call(this,l,e),(!e.currentChunk||l-e.currentChunk.startTimestamp>=xt)&&(e.currentChunk&&m(this,N,he).call(this,e),e.currentChunk={startTimestamp:l,sampleData:[],sampleCount:0}),e.currentChunk.sampleData.push(t),e.currentChunk.sampleCount++,(x=h==null?void 0:h.decoderConfig)!=null&&x.description&&(e.codecPrivate=new Uint8Array(h.decoderConfig.description)),e.samples.push({timestamp:l,duration:H,size:t.byteLength,type:i})},we=new WeakSet,Ve=function(e,t){if(s(this,p).firstTimestampBehavior==="strict"&&t.lastTimestamp===-1&&e!==0)throw new Error(`The first chunk for your media track must have a timestamp of 0 (received ${e}). Non-zero first timestamps are often caused by directly piping frames or audio data from a MediaStreamTrack into the encoder. Their timestamps are typically relative to the age of the document, which is probably what you want.

If you want to offset all timestamps of a track such that the first one is zero, set firstTimestampBehavior: 'offset' in the options.
If you want to allow non-zero first timestamps, set firstTimestampBehavior: 'permissive'.
`);if(s(this,p).firstTimestampBehavior==="offset"&&(e-=t.firstTimestamp),e<t.lastTimestamp)throw new Error(`Timestamps must be monotonically increasing (went from ${t.lastTimestamp*1e6} to ${e*1e6}).`);return e},N=new WeakSet,he=function(e){if(e.currentChunk){e.currentChunk.offset=s(this,c).pos;for(let t of e.currentChunk.sampleData)s(this,c).write(t);e.currentChunk.sampleData=null,e.writtenChunks.push(e.currentChunk),m(this,V,ue).call(this)}},V=new WeakSet,ue=function(){s(this,c)instanceof X&&s(this,c).flush()},ee=new WeakSet,Ae=function(){if(s(this,me))throw new Error("Cannot add new video or audio chunks after the file has been finalized.")};return Ke(At);})();
if (typeof module === "object" && typeof module.exports === "object") {
	module.exports.Muxer = Mp4Muxer.Muxer;
	module.exports.ArrayBufferTarget = Mp4Muxer.ArrayBufferTarget;
	module.exports.StreamTarget = Mp4Muxer.StreamTarget;
	module.exports.FileSystemWritableFileStreamTarget = Mp4Muxer.FileSystemWritableFileStreamTarget;
}
