"use strict";var Mp4Muxer=(()=>{var Q=Object.defineProperty;var _t=Object.getOwnPropertyDescriptor;var Ft=Object.getOwnPropertyNames,Tt=Object.getOwnPropertySymbols;var At=Object.prototype.hasOwnProperty,Rt=Object.prototype.propertyIsEnumerable;var A=Math.pow,vt=(r,t,e)=>t in r?Q(r,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):r[t]=e,St=(r,t)=>{for(var e in t||={})At.call(t,e)&&vt(r,e,t[e]);if(Tt)for(var e of Tt(t))Rt.call(t,e)&&vt(r,e,t[e]);return r};var Nt=(r,t)=>{for(var e in t)Q(r,e,{get:t[e],enumerable:!0})},Vt=(r,t,e,i)=>{if(t&&typeof t=="object"||typeof t=="function")for(let n of Ft(t))!At.call(r,n)&&n!==e&&Q(r,n,{get:()=>t[n],enumerable:!(i=_t(t,n))||i.enumerable});return r};var Ht=r=>Vt(Q({},"__esModule",{value:!0}),r);var ct=(r,t,e)=>{if(!t.has(r))throw TypeError("Cannot "+e)};var s=(r,t,e)=>(ct(r,t,"read from private field"),e?e.call(r):t.get(r)),u=(r,t,e)=>{if(t.has(r))throw TypeError("Cannot add the same private member more than once");t instanceof WeakSet?t.add(r):t.set(r,e)},w=(r,t,e,i)=>(ct(r,t,"write to private field"),i?i.call(r,e):t.set(r,e),e);var m=(r,t,e)=>(ct(r,t,"access private method"),e);var ge={};Nt(ge,{ArrayBufferTarget:()=>W,FileSystemWritableFileStreamTarget:()=>$,Muxer:()=>ht,StreamTarget:()=>O});var d=new Uint8Array(8),C=new DataView(d.buffer),T=r=>[(r%256+256)%256],l=r=>(C.setUint16(0,r,!1),[d[0],d[1]]),Ut=r=>(C.setInt16(0,r,!1),[d[0],d[1]]),yt=r=>(C.setUint32(0,r,!1),[d[1],d[2],d[3]]),a=r=>(C.setUint32(0,r,!1),[d[0],d[1],d[2],d[3]]),kt=r=>(C.setUint32(0,Math.floor(r/A(2,32)),!1),C.setUint32(4,r,!1),[d[0],d[1],d[2],d[3],d[4],d[5],d[6],d[7]]),wt=r=>(C.setUint8(0,r),C.setUint8(1,r<<8),[d[0],d[1]]),H=r=>(C.setUint16(0,r,!1),C.setUint16(2,r<<16,!1),[d[0],d[1],d[2],d[3]]),x=(r,t=!1)=>{let e=Array(r.length).fill(null).map((i,n)=>r.charCodeAt(n));return t&&e.push(0),e},E=r=>r&&r[r.length-1];var Bt=[65536,0,0,0,65536,0,0,0,1073741824].map(a),g=(r,t,e)=>({type:r,contents:t&&new Uint8Array(t.flat(10)),children:e}),y=(r,t,e,i,n)=>g(r,[T(t),yt(e),i!=null?i:[]],n),z=(r,t)=>Math.round(r*t),Mt=r=>r?g("ftyp",[x("isom"),a(0),x("iso4"),x("hvc1")]):g("ftyp",[x("isom"),a(0),x("isom"),x("avc1"),x("mp41")]),Dt=()=>({type:"mdat",largeSize:!0}),Et=(r,t)=>g("moov",null,[Wt(t,r),...r.map(e=>$t(e,t))]),Wt=(r,t)=>{let e=z(Math.max(0,...t.filter(n=>n.samples.length>0).map(n=>E(n.samples).timestamp+E(n.samples).duration)),tt),i=Math.max(...t.map(n=>n.id))+1;return y("mvhd",0,0,[a(r),a(r),a(tt),a(e),H(1),wt(1),Array(10).fill(0),Bt,Array(24).fill(0),a(i)])},$t=(r,t)=>g("trak",null,[Gt(r,t),Kt(r,t)]),Gt=(r,t)=>{let e=E(r.samples),i=z(e?e.timestamp+e.duration:0,tt);return y("tkhd",0,3,[a(t),a(t),a(r.id),a(0),a(i),Array(8).fill(0),l(0),l(0),wt(r.info.type==="audio"?1:0),l(0),Bt,H(r.info.type==="video"?r.info.width:0),H(r.info.type==="video"?r.info.height:0)])},Kt=(r,t)=>g("mdia",null,[Xt(r,t),Yt(r.info.type==="video"?"vide":"soun"),Zt(r)]),Xt=(r,t)=>{let e=E(r.samples),i=z(e?e.timestamp+e.duration:0,r.timescale);return y("mdhd",0,0,[a(t),a(t),a(r.timescale),a(i),l(21956),l(0)])},Yt=r=>y("hdlr",0,0,[x("mhlr"),x(r),a(0),a(0),a(0),x("mp4-muxer-hdlr")]),Zt=r=>g("minf",null,[r.info.type==="video"?jt():qt(),Jt(),ee(r)]),jt=()=>y("vmhd",0,1,[l(0),l(0),l(0),l(0)]),qt=()=>y("smhd",0,0,[l(0),l(0)]),Jt=()=>g("dinf",null,[Qt()]),Qt=()=>y("dref",0,0,[a(1)],[te()]),te=()=>y("url ",0,1),ee=r=>g("stbl",null,[re(r),he(r),ue(r),le(r),de(r),me(r)]),re=r=>y("stsd",0,0,[a(1)],[r.info.type==="video"?ie(r.info.codec==="avc"?"avc1":"hvc1",r,r.info.codec==="avc"?se(r):ne(r)):ae("mp4a",r,oe(r))]),ie=(r,t,e)=>g(r,[Array(6).fill(0),l(1),l(0),l(0),Array(12).fill(0),l(t.info.width),l(t.info.height),a(4718592),a(4718592),a(0),l(1),Array(32).fill(0),l(24),Ut(65535)],[e]),se=r=>r.codecPrivate&&g("avcC",[...r.codecPrivate]),ne=r=>r.codecPrivate&&g("hvcC",[...r.codecPrivate]),ae=(r,t,e)=>g(r,[Array(6).fill(0),l(1),l(0),l(0),a(0),l(t.info.numberOfChannels),l(16),l(0),l(0),H(t.info.sampleRate)],[e]),oe=r=>y("esds",0,0,[a(58753152),T(32+r.codecPrivate.byteLength),l(1),T(0),a(75530368),T(18+r.codecPrivate.byteLength),T(64),T(21),yt(0),a(130071),a(130071),a(92307584),T(r.codecPrivate.byteLength),...r.codecPrivate,a(109084800),T(1),T(2)]),he=r=>{let t=[],e=[];for(let i of r.samples){if(t.push(i),t.length<=2)continue;let n=z(t[1].timestamp-t[0].timestamp,r.timescale);z(i.timestamp-t[t.length-2].timestamp,r.timescale)!==n&&(e.push({sampleCount:t.length-1,sampleDelta:n}),t=t.slice(-2))}return t.length>0&&e.push({sampleCount:t.length,sampleDelta:t.length===1?z(t[0].duration,r.timescale):z(t[1].timestamp-t[0].timestamp,r.timescale)}),y("stts",0,0,[a(e.length),e.map(i=>[a(i.sampleCount),a(i.sampleDelta)])])},ue=r=>{if(r.samples.every(e=>e.type==="key"))return null;let t=[...r.samples.entries()].filter(([,e])=>e.type==="key");return y("stss",0,0,[a(t.length),t.map(([e])=>a(e+1))])},le=r=>{let t=[];for(let e=0;e<r.writtenChunks.length;e++){let i=r.writtenChunks[e];(t.length===0||E(t).samplesPerChunk!==i.sampleCount)&&t.push({firstChunk:e+1,samplesPerChunk:i.sampleCount})}return y("stsc",0,0,[a(t.length),t.map(e=>[a(e.firstChunk),a(e.samplesPerChunk),a(1)])])},de=r=>y("stsz",0,0,[a(0),a(r.samples.length),r.samples.map(t=>a(t.size))]),me=r=>r.writtenChunks.length>0&&E(r.writtenChunks).offset>=A(2,32)?y("co64",0,0,[a(r.writtenChunks.length),r.writtenChunks.map(t=>kt(t.offset))]):y("stco",0,0,[a(r.writtenChunks.length),r.writtenChunks.map(t=>a(t.offset))]);var W=class{constructor(){this.buffer=null}},O=class{constructor(t,e,i){this.onData=t;this.onDone=e;this.options=i}},$=class{constructor(t){this.stream=t}};var S,P,G=class{constructor(){this.pos=0;u(this,S,new Uint8Array(8));u(this,P,new DataView(s(this,S).buffer));this.offsets=new WeakMap}seek(t){this.pos=t}writeU32(t){s(this,P).setUint32(0,t,!1),this.write(s(this,S).subarray(0,4))}writeU64(t){s(this,P).setUint32(0,Math.floor(t/A(2,32)),!1),s(this,P).setUint32(4,t,!1),this.write(s(this,S).subarray(0,8))}writeAscii(t){for(let e=0;e<t.length;e++)s(this,P).setUint8(e%8,t.charCodeAt(e)),e%8===7&&this.write(s(this,S));t.length%8!==0&&this.write(s(this,S).subarray(0,t.length%8))}writeBox(t){var e,i;if(this.offsets.set(t,this.pos),t.contents&&!t.children)this.writeBoxHeader(t,(e=t.size)!=null?e:t.contents.byteLength+8),this.write(t.contents);else{let n=this.pos;if(this.writeBoxHeader(t,0),t.contents&&this.write(t.contents),t.children)for(let f of t.children)f&&this.writeBox(f);let o=this.pos,h=(i=t.size)!=null?i:o-n;this.pos=n,this.writeBoxHeader(t,h),this.pos=o}}writeBoxHeader(t,e){this.writeU32(t.largeSize?1:e),this.writeAscii(t.type),t.largeSize&&this.writeU64(e)}patchBox(t){let e=this.pos;this.pos=this.offsets.get(t),this.writeBox(t),this.pos=e}};S=new WeakMap,P=new WeakMap;var Y,U,L,Z,bt,rt=class extends G{constructor(e){super();u(this,Z);u(this,Y,void 0);u(this,U,new ArrayBuffer(A(2,16)));u(this,L,new Uint8Array(s(this,U)));w(this,Y,e)}write(e){m(this,Z,bt).call(this,this.pos+e.byteLength),s(this,L).set(e,this.pos),this.pos+=e.byteLength}finalize(){m(this,Z,bt).call(this,this.pos),s(this,Y).buffer=s(this,U).slice(0,this.pos)}};Y=new WeakMap,U=new WeakMap,L=new WeakMap,Z=new WeakSet,bt=function(e){let i=s(this,U).byteLength;for(;i<e;)i*=2;if(i===s(this,U).byteLength)return;let n=new ArrayBuffer(i),o=new Uint8Array(n);o.set(s(this,L),0),w(this,U,n),w(this,L,o)};var _,k,K=class extends G{constructor(e){super();u(this,_,void 0);u(this,k,[]);w(this,_,e)}write(e){s(this,k).push({data:e.slice(),start:this.pos}),this.pos+=e.byteLength}flush(){if(s(this,k).length===0)return;let e=[],i=[...s(this,k)].sort((n,o)=>n.start-o.start);e.push({start:i[0].start,size:i[0].data.byteLength});for(let n=1;n<i.length;n++){let o=e[e.length-1],h=i[n];h.start<=o.start+o.size?o.size=Math.max(o.size,h.start+h.data.byteLength-o.start):e.push({start:h.start,size:h.data.byteLength})}for(let n of e){n.data=new Uint8Array(n.size);for(let o of s(this,k))n.start<=o.start&&o.start<n.start+n.size&&n.data.set(o.data,o.start-n.start);s(this,_).onData(n.data,n.start)}s(this,k).length=0}finalize(){var e,i;(i=(e=s(this,_)).onDone)==null||i.call(e)}};_=new WeakMap,k=new WeakMap;var I=A(2,24),fe=2,F,b,j,gt,st,zt,nt,Ot,R,et,X=class extends G{constructor(e){super();u(this,j);u(this,st);u(this,nt);u(this,R);u(this,F,void 0);u(this,b,[]);w(this,F,e)}write(e){m(this,j,gt).call(this,e,this.pos),m(this,R,et).call(this),this.pos+=e.byteLength}finalize(){var e,i;m(this,R,et).call(this,!0),(i=(e=s(this,F)).onDone)==null||i.call(e)}};F=new WeakMap,b=new WeakMap,j=new WeakSet,gt=function(e,i){let n=s(this,b).findIndex(v=>v.start<=i&&i<v.start+I);n===-1&&(n=m(this,nt,Ot).call(this,i));let o=s(this,b)[n],h=i-o.start,f=e.subarray(0,Math.min(I-h,e.byteLength));o.data.set(f,h);let pt={start:h,end:h+f.byteLength};if(m(this,st,zt).call(this,o,pt),o.written[0].start===0&&o.written[0].end===I&&(o.shouldFlush=!0),s(this,b).length>fe){for(let v=0;v<s(this,b).length-1;v++)s(this,b)[v].shouldFlush=!0;m(this,R,et).call(this)}f.byteLength<e.byteLength&&m(this,j,gt).call(this,e.subarray(f.byteLength),i+f.byteLength)},st=new WeakSet,zt=function(e,i){let n=0,o=e.written.length-1,h=-1;for(;n<=o;){let f=Math.floor(n+(o-n+1)/2);e.written[f].start<=i.start?(n=f+1,h=f):o=f-1}for(e.written.splice(h+1,0,i),(h===-1||e.written[h].end<i.start)&&h++;h<e.written.length-1&&e.written[h].end>=e.written[h+1].start;)e.written[h].end=Math.max(e.written[h].end,e.written[h+1].end),e.written.splice(h+1,1)},nt=new WeakSet,Ot=function(e){let n={start:Math.floor(e/I)*I,data:new Uint8Array(I),written:[],shouldFlush:!1};return s(this,b).push(n),s(this,b).sort((o,h)=>o.start-h.start),s(this,b).indexOf(n)},R=new WeakSet,et=function(e=!1){for(let i=0;i<s(this,b).length;i++){let n=s(this,b)[i];if(!(!n.shouldFlush&&!e)){for(let o of n.written)s(this,F).onData(n.data.subarray(o.start,o.end),n.start+o.start);s(this,b).splice(i--,1)}}};var it=class extends X{constructor(t){super(new O((e,i)=>t.stream.write({type:"write",data:e,position:i})))}};var tt=1e3,pe=2082844800,ce=.5,ye=["avc","hevc"],we=["aac"],be=["strict","offset","permissive"],p,c,B,M,D,ut,lt,dt,Pt,mt,It,ft,Lt,q,xt,N,at,V,ot,J,Ct,ht=class{constructor(t){u(this,dt);u(this,mt);u(this,ft);u(this,q);u(this,N);u(this,V);u(this,J);u(this,p,void 0);u(this,c,void 0);u(this,B,void 0);u(this,M,null);u(this,D,null);u(this,ut,Math.floor(Date.now()/1e3)+pe);u(this,lt,!1);var e;if(m(this,dt,Pt).call(this,t),this.target=t.target,w(this,p,St({firstTimestampBehavior:"strict"},t)),t.target instanceof W)w(this,c,new rt(t.target));else if(t.target instanceof O)w(this,c,(e=t.target.options)!=null&&e.chunked?new X(t.target):new K(t.target));else if(t.target instanceof $)w(this,c,new it(t.target));else throw new Error(`Invalid target: ${t.target}`);m(this,mt,It).call(this),m(this,ft,Lt).call(this)}addVideoChunk(t,e){let i=new Uint8Array(t.byteLength);t.copyTo(i),this.addVideoChunkRaw(i,t.type,t.timestamp,t.duration,e)}addVideoChunkRaw(t,e,i,n,o){if(m(this,J,Ct).call(this),!s(this,p).video)throw new Error("No video track declared.");m(this,q,xt).call(this,s(this,M),t,e,i,n,o)}addAudioChunk(t,e){let i=new Uint8Array(t.byteLength);t.copyTo(i),this.addAudioChunkRaw(i,t.type,t.timestamp,t.duration,e)}addAudioChunkRaw(t,e,i,n,o){if(m(this,J,Ct).call(this),!s(this,p).audio)throw new Error("No audio track declared.");m(this,q,xt).call(this,s(this,D),t,e,i,n,o)}finalize(){s(this,M)&&m(this,N,at).call(this,s(this,M)),s(this,D)&&m(this,N,at).call(this,s(this,D));let t=s(this,c).offsets.get(s(this,B)),e=s(this,c).pos-t;s(this,B).size=e,s(this,c).patchBox(s(this,B));let i=Et([s(this,M),s(this,D)].filter(Boolean),s(this,ut));s(this,c).writeBox(i),m(this,V,ot).call(this),s(this,c).finalize()}};p=new WeakMap,c=new WeakMap,B=new WeakMap,M=new WeakMap,D=new WeakMap,ut=new WeakMap,lt=new WeakMap,dt=new WeakSet,Pt=function(t){if(t.video&&!ye.includes(t.video.codec))throw new Error(`Unsupported video codec: ${t.video.codec}`);if(t.audio&&!we.includes(t.audio.codec))throw new Error(`Unsupported audio codec: ${t.audio.codec}`);if(t.firstTimestampBehavior&&!be.includes(t.firstTimestampBehavior))throw new Error(`Invalid first timestamp behavior: ${t.firstTimestampBehavior}`)},mt=new WeakSet,It=function(){var e;let t=((e=s(this,p).video)==null?void 0:e.codec)==="hevc";s(this,c).writeBox(Mt(t)),w(this,B,Dt()),s(this,c).writeBox(s(this,B)),m(this,V,ot).call(this)},ft=new WeakSet,Lt=function(){s(this,p).video&&w(this,M,{id:1,info:{type:"video",codec:s(this,p).video.codec,width:s(this,p).video.width,height:s(this,p).video.height},timescale:720,codecPrivate:new Uint8Array(0),samples:[],writtenChunks:[],currentChunk:null}),s(this,p).audio&&w(this,D,{id:s(this,p).video?2:1,info:{type:"audio",codec:s(this,p).audio.codec,numberOfChannels:s(this,p).audio.numberOfChannels,sampleRate:s(this,p).audio.sampleRate},timescale:s(this,p).audio.sampleRate,codecPrivate:new Uint8Array(0),samples:[],writtenChunks:[],currentChunk:null})},q=new WeakSet,xt=function(t,e,i,n,o,h){var v;let f=n/1e6,pt=o/1e6;(!t.currentChunk||f-t.currentChunk.startTimestamp>=ce)&&(t.currentChunk&&m(this,N,at).call(this,t),t.currentChunk={startTimestamp:f,sampleData:[],sampleCount:0}),t.currentChunk.sampleData.push(e),t.currentChunk.sampleCount++,(v=h==null?void 0:h.decoderConfig)!=null&&v.description&&(t.codecPrivate=new Uint8Array(h.decoderConfig.description)),t.samples.push({timestamp:f,duration:pt,size:e.byteLength,type:i})},N=new WeakSet,at=function(t){if(t.currentChunk){t.currentChunk.offset=s(this,c).pos;for(let e of t.currentChunk.sampleData)s(this,c).write(e);t.currentChunk.sampleData=null,t.writtenChunks.push(t.currentChunk),m(this,V,ot).call(this)}},V=new WeakSet,ot=function(){s(this,c)instanceof K&&s(this,c).flush()},J=new WeakSet,Ct=function(){if(s(this,lt))throw new Error("Cannot add new video or audio chunks after the file has been finalized.")};return Ht(ge);})();
if (typeof module === "object" && typeof module.exports === "object") module.exports = Mp4Muxer;
